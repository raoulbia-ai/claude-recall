{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/queue-system.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/queue-system.ts"],"sourcesContent":["import Database from 'better-sqlite3';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { ConfigService } from './config';\nimport { LoggingService } from './logging';\n\nexport interface QueueMessage {\n  id?: number;\n  queue_name: string;\n  payload: any;\n  priority: number;\n  scheduled_at: number;\n  created_at: number;\n  status: 'pending' | 'processing' | 'completed' | 'failed' | 'retrying';\n  retry_count: number;\n  max_retries: number;\n  error_message?: string;\n  processed_at?: number;\n  next_retry_at?: number;\n  correlation_id?: string;\n  message_type: string;\n  metadata?: any;\n}\n\nexport interface QueueStats {\n  queueName: string;\n  pending: number;\n  processing: number;\n  completed: number;\n  failed: number;\n  retrying: number;\n  totalProcessed: number;\n  avgProcessingTime: number;\n}\n\nexport interface RetryConfig {\n  maxRetries: number;\n  baseDelayMs: number;\n  maxDelayMs: number;\n  useJitter: boolean;\n  backoffMultiplier: number;\n}\n\nexport interface QueueProcessorConfig {\n  batchSize: number;\n  processingTimeout: number;\n  cleanupInterval: number;\n  retentionPeriod: number;\n}\n\nexport interface QueueConfiguration {\n  retryConfig: RetryConfig;\n  processorConfig: QueueProcessorConfig;\n}\n\nexport class QueueSystem {\n  private static instance: QueueSystem;\n  private db: Database.Database;\n  private config = ConfigService.getInstance();\n  private logger = LoggingService.getInstance();\n  private processors = new Map<string, QueueProcessor>();\n  private cleanupInterval?: NodeJS.Timeout;\n  private isShuttingDown = false;\n  private preparedStatements = new Map<string, Database.Statement>();\n  private supportsReturning = false;\n\n  private constructor() {\n    try {\n      const dbPath = this.config.getDatabasePath();\n      this.db = new Database(dbPath);\n      this.configureDatabase();\n      this.checkSQLiteVersion();\n      this.initializeSchema();\n      this.startCleanupProcess();\n      \n      this.logger.info('QueueSystem', `Initialized with database: ${dbPath}`);\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to initialize', error);\n      throw new Error(`Failed to initialize QueueSystem: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  private configureDatabase(): void {\n    try {\n      this.db.pragma('journal_mode = WAL');\n      this.db.pragma('synchronous = NORMAL');\n      this.db.pragma('foreign_keys = ON');\n      this.db.pragma('cache_size = 10000');\n      this.db.pragma('temp_store = MEMORY');\n      this.db.pragma('wal_autocheckpoint = 1000');\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to configure database', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Reinitialize database connection if closed\n   */\n  private reinitializeDatabase(): void {\n    try {\n      const dbPath = this.config.getDatabasePath();\n      this.db = new Database(dbPath);\n      this.configureDatabase();\n      this.checkSQLiteVersion();\n      this.initializeSchema();\n      // Clear prepared statements cache as they're no longer valid\n      this.preparedStatements.clear();\n      this.logger.info('QueueSystem', 'Database connection reinitialized');\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to reinitialize database', error);\n      throw new Error(`Failed to reinitialize database: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Check SQLite version for RETURNING clause support\n   */\n  private checkSQLiteVersion(): void {\n    try {\n      const result = this.db.prepare('SELECT sqlite_version() as version').get() as { version: string };\n      const version = result.version;\n      const [major, minor, patch] = version.split('.').map(Number);\n      \n      // RETURNING clause requires SQLite 3.35.0+\n      this.supportsReturning = major > 3 || (major === 3 && minor >= 35);\n      \n      this.logger.info('QueueSystem', `SQLite version: ${version}, RETURNING support: ${this.supportsReturning}`);\n      \n      if (!this.supportsReturning) {\n        this.logger.warn('QueueSystem', 'SQLite version does not support RETURNING clause. Using fallback method.');\n      }\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to check SQLite version', error);\n      this.supportsReturning = false;\n    }\n  }\n\n  /**\n   * Get or create a prepared statement with caching\n   * Includes automatic cleanup of unused statements to prevent memory leaks\n   */\n  private getPreparedStatement(key: string, sql: string): Database.Statement {\n    // Check if database is open and reinitialize if needed\n    if (!this.db || !this.db.open) {\n      this.logger.warn('QueueSystem', 'Database connection closed, reinitializing...');\n      this.reinitializeDatabase();\n    }\n    \n    // Limit cache size to prevent unbounded growth\n    const MAX_CACHE_SIZE = 100;\n    \n    if (!this.preparedStatements.has(key)) {\n      // Clear old entries if cache is too large\n      if (this.preparedStatements.size >= MAX_CACHE_SIZE) {\n        const entriesToRemove = Math.floor(MAX_CACHE_SIZE * 0.2); // Remove 20% of oldest entries\n        const keysToRemove = Array.from(this.preparedStatements.keys()).slice(0, entriesToRemove);\n        keysToRemove.forEach(k => {\n          // Remove from cache - better-sqlite3 handles cleanup automatically\n          this.preparedStatements.delete(k);\n        });\n        this.logger.debug('QueueSystem', 'Cleared prepared statement cache', { removed: entriesToRemove });\n      }\n      \n      this.preparedStatements.set(key, this.db.prepare(sql));\n    }\n    return this.preparedStatements.get(key)!;\n  }\n\n  static getInstance(): QueueSystem {\n    if (!QueueSystem.instance) {\n      QueueSystem.instance = new QueueSystem();\n    }\n    return QueueSystem.instance;\n  }\n\n  /**\n   * Reset the singleton instance (for testing only)\n   * @internal\n   */\n  static resetInstance(): void {\n    if (QueueSystem.instance) {\n      QueueSystem.instance.close();\n      QueueSystem.instance = null as any;\n    }\n  }\n\n  /**\n   * Initialize the queue database schema\n   */\n  private initializeSchema(): void {\n    const transaction = this.db.transaction(() => {\n      // Main queue messages table\n      this.db.exec(`\n        CREATE TABLE IF NOT EXISTS queue_messages (\n          id INTEGER PRIMARY KEY AUTOINCREMENT,\n          queue_name TEXT NOT NULL,\n          payload TEXT NOT NULL,\n          priority INTEGER DEFAULT 0,\n          scheduled_at INTEGER NOT NULL,\n          created_at INTEGER NOT NULL,\n          status TEXT NOT NULL DEFAULT 'pending',\n          retry_count INTEGER DEFAULT 0,\n          max_retries INTEGER DEFAULT 3,\n          error_message TEXT,\n          processed_at INTEGER,\n          next_retry_at INTEGER,\n          correlation_id TEXT,\n          message_type TEXT NOT NULL,\n          metadata TEXT,\n          \n          CONSTRAINT chk_status CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'retrying'))\n        );\n      `);\n\n      // Queue configuration table\n      this.db.exec(`\n        CREATE TABLE IF NOT EXISTS queue_configs (\n          queue_name TEXT PRIMARY KEY,\n          max_retries INTEGER DEFAULT 3,\n          base_delay_ms INTEGER DEFAULT 1000,\n          max_delay_ms INTEGER DEFAULT 300000,\n          use_jitter INTEGER DEFAULT 1,\n          backoff_multiplier REAL DEFAULT 2.0,\n          batch_size INTEGER DEFAULT 10,\n          processing_timeout INTEGER DEFAULT 30000,\n          retention_period INTEGER DEFAULT 604800000,\n          enabled INTEGER DEFAULT 1,\n          created_at INTEGER NOT NULL,\n          updated_at INTEGER NOT NULL\n        );\n      `);\n\n      // Dead letter queue for failed messages\n      this.db.exec(`\n        CREATE TABLE IF NOT EXISTS dead_letter_queue (\n          id INTEGER PRIMARY KEY AUTOINCREMENT,\n          original_queue_name TEXT NOT NULL,\n          original_message_id INTEGER NOT NULL,\n          payload TEXT NOT NULL,\n          error_message TEXT NOT NULL,\n          retry_count INTEGER NOT NULL,\n          failed_at INTEGER NOT NULL,\n          correlation_id TEXT,\n          message_type TEXT NOT NULL,\n          metadata TEXT\n        );\n      `);\n\n      // Performance indexes\n      this.db.exec(`\n        CREATE INDEX IF NOT EXISTS idx_queue_messages_queue_status \n        ON queue_messages(queue_name, status);\n        \n        CREATE INDEX IF NOT EXISTS idx_queue_messages_scheduled \n        ON queue_messages(scheduled_at) WHERE status IN ('pending', 'retrying');\n        \n        CREATE INDEX IF NOT EXISTS idx_queue_messages_priority \n        ON queue_messages(queue_name, priority DESC, created_at ASC) \n        WHERE status IN ('pending', 'retrying');\n        \n        CREATE INDEX IF NOT EXISTS idx_queue_messages_correlation \n        ON queue_messages(correlation_id) WHERE correlation_id IS NOT NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_queue_messages_message_type\n        ON queue_messages(queue_name, message_type);\n        \n        CREATE INDEX IF NOT EXISTS idx_queue_messages_cleanup \n        ON queue_messages(status, processed_at) WHERE status IN ('completed', 'failed');\n        \n        CREATE INDEX IF NOT EXISTS idx_queue_messages_next_retry \n        ON queue_messages(next_retry_at) \n        WHERE status = 'retrying' AND next_retry_at IS NOT NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_dead_letter_failed_at \n        ON dead_letter_queue(failed_at);\n        \n        CREATE INDEX IF NOT EXISTS idx_dead_letter_composite\n        ON dead_letter_queue(original_queue_name, failed_at DESC);\n      `);\n\n      this.logger.info('QueueSystem', 'Database schema initialized successfully');\n    });\n\n    try {\n      transaction();\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to initialize schema', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Enqueue a message with validation\n   */\n  enqueue(\n    queueName: string,\n    messageType: string,\n    payload: any,\n    options: {\n      priority?: number;\n      scheduledAt?: number;\n      maxRetries?: number;\n      correlationId?: string;\n      metadata?: any;\n    } = {}\n  ): number {\n    // Validate inputs\n    if (!queueName || !messageType) {\n      throw new Error('Queue name and message type are required');\n    }\n\n    // Check queue size limit\n    const maxQueueSize = 10000; // Maximum messages per queue\n    const currentSize = this.getQueueSize(queueName);\n    \n    if (currentSize >= maxQueueSize) {\n      this.logger.error('QueueSystem', 'Queue size limit exceeded', {\n        queueName,\n        currentSize,\n        maxQueueSize\n      });\n      \n      // Try to cleanup old completed messages\n      this.cleanupOldMessages();\n      \n      // Check again after cleanup\n      const sizeAfterCleanup = this.getQueueSize(queueName);\n      if (sizeAfterCleanup >= maxQueueSize) {\n        throw new Error(`Queue ${queueName} has reached maximum size of ${maxQueueSize} messages`);\n      }\n    }\n\n    // Validate payload size (limit to 1MB)\n    const payloadStr = JSON.stringify(payload);\n    if (payloadStr.length > 1048576) {\n      throw new Error('Payload size exceeds 1MB limit');\n    }\n\n    const now = Date.now();\n    const message: Partial<QueueMessage> = {\n      queue_name: queueName,\n      message_type: messageType,\n      payload: payloadStr,\n      priority: Math.max(0, Math.min(100, options.priority || 0)), // Clamp priority 0-100\n      scheduled_at: options.scheduledAt || now,\n      created_at: now,\n      status: 'pending',\n      retry_count: 0,\n      max_retries: Math.max(0, Math.min(10, options.maxRetries || 3)), // Clamp retries 0-10\n      correlation_id: options.correlationId,\n      metadata: options.metadata ? JSON.stringify(options.metadata) : null\n    };\n\n    try {\n      const stmt = this.getPreparedStatement('enqueue', `\n        INSERT INTO queue_messages (\n          queue_name, message_type, payload, priority, scheduled_at, \n          created_at, status, retry_count, max_retries, correlation_id, metadata\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `);\n\n      const result = stmt.run(\n        message.queue_name,\n        message.message_type,\n        message.payload,\n        message.priority,\n        message.scheduled_at,\n        message.created_at,\n        message.status,\n        message.retry_count,\n        message.max_retries,\n        message.correlation_id,\n        message.metadata\n      );\n\n      const messageId = result.lastInsertRowid as number;\n      \n      this.logger.info('QueueSystem', 'Message enqueued', {\n        messageId,\n        queueName,\n        messageType,\n        priority: message.priority,\n        scheduledAt: message.scheduled_at\n      });\n\n      return messageId;\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to enqueue message', error);\n      throw new Error(`Failed to enqueue message: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Batch enqueue multiple messages efficiently\n   */\n  enqueueBatch(messages: Array<{\n    queueName: string;\n    messageType: string;\n    payload: any;\n    options?: {\n      priority?: number;\n      scheduledAt?: number;\n      maxRetries?: number;\n      correlationId?: string;\n      metadata?: any;\n    };\n  }>): number[] {\n    if (messages.length === 0) {\n      return [];\n    }\n\n    // Use transaction for batch insert with prepared statement\n    const transaction = this.db.transaction(() => {\n      const messageIds: number[] = [];\n      const now = Date.now();\n      \n      // Prepare statement once for all inserts\n      const stmt = this.db.prepare(`\n        INSERT INTO queue_messages (\n          queue_name, message_type, payload, priority, scheduled_at, \n          created_at, status, retry_count, max_retries, correlation_id, metadata\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `);\n      \n      for (const msg of messages) {\n        try {\n          // Validate inputs\n          if (!msg.queueName || !msg.messageType) {\n            throw new Error('Queue name and message type are required');\n          }\n\n          // Validate payload size (limit to 1MB)\n          const payloadStr = JSON.stringify(msg.payload);\n          if (payloadStr.length > 1048576) {\n            throw new Error('Payload size exceeds 1MB limit');\n          }\n\n          const result = stmt.run(\n            msg.queueName,\n            msg.messageType,\n            payloadStr,\n            Math.max(0, Math.min(100, msg.options?.priority || 0)),\n            msg.options?.scheduledAt || now,\n            now,\n            'pending',\n            0,\n            Math.max(0, Math.min(10, msg.options?.maxRetries || 3)),\n            msg.options?.correlationId || null,\n            msg.options?.metadata ? JSON.stringify(msg.options.metadata) : null\n          );\n          \n          messageIds.push(result.lastInsertRowid as number);\n        } catch (error) {\n          this.logger.error('QueueSystem', 'Failed to enqueue message in batch', {\n            queueName: msg.queueName,\n            messageType: msg.messageType,\n            error: error instanceof Error ? error.message : 'Unknown error'\n          });\n          throw error; // Rollback entire transaction on error\n        }\n      }\n      \n      return messageIds;\n    });\n\n    try {\n      const ids = transaction();\n      this.logger.info('QueueSystem', 'Batch enqueue completed', {\n        count: ids.length,\n        messageIds: ids\n      });\n      return ids;\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Batch enqueue failed', error);\n      throw new Error(`Failed to enqueue batch: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Dequeue messages for processing (FIXED: Atomic claim with no race condition)\n   */\n  dequeue(queueName: string, batchSize: number = 1): QueueMessage[] {\n    if (this.isShuttingDown) {\n      return [];\n    }\n\n    const now = Date.now();\n    \n    // Use different strategies based on SQLite version\n    const transaction = this.db.transaction(() => {\n      try {\n        let messages: QueueMessage[];\n        \n        if (this.supportsReturning) {\n          // Use atomic UPDATE...RETURNING for newer SQLite versions\n          const updateStmt = this.getPreparedStatement('dequeue_returning', `\n            UPDATE queue_messages \n            SET status = 'processing', processed_at = ?\n            WHERE id IN (\n              SELECT id FROM queue_messages \n              WHERE queue_name = ? \n                AND status IN ('pending', 'retrying')\n                AND scheduled_at <= ?\n                AND (next_retry_at IS NULL OR next_retry_at <= ?)\n              ORDER BY priority DESC, created_at ASC \n              LIMIT ?\n            )\n            RETURNING *\n          `);\n\n          messages = updateStmt.all(now, queueName, now, now, batchSize) as QueueMessage[];\n        } else {\n          // Fallback for older SQLite versions - select then update\n          const selectStmt = this.getPreparedStatement('dequeue_select', `\n            SELECT * FROM queue_messages \n            WHERE queue_name = ? \n              AND status IN ('pending', 'retrying')\n              AND scheduled_at <= ?\n              AND (next_retry_at IS NULL OR next_retry_at <= ?)\n            ORDER BY priority DESC, created_at ASC \n            LIMIT ?\n          `);\n          \n          messages = selectStmt.all(queueName, now, now, batchSize) as QueueMessage[];\n          \n          if (messages.length > 0) {\n            const ids = messages.map(m => m.id);\n            const placeholders = ids.map(() => '?').join(',');\n            const updateStmt = this.db.prepare(`\n              UPDATE queue_messages \n              SET status = 'processing', processed_at = ?\n              WHERE id IN (${placeholders})\n            `);\n            updateStmt.run(now, ...ids);\n          }\n        }\n        \n        // Sort messages by priority if RETURNING was used (it doesn't preserve ORDER BY)\n        if (this.supportsReturning) {\n          messages.sort((a, b) => {\n            if (b.priority !== a.priority) {\n              return b.priority - a.priority; // Higher priority first\n            }\n            return a.created_at - b.created_at; // Earlier created first for same priority\n          });\n        }\n        \n        // Parse JSON fields\n        return messages.map(message => {\n          try {\n            return {\n              ...message,\n              payload: typeof message.payload === 'string' ? JSON.parse(message.payload) : message.payload,\n              metadata: message.metadata && typeof message.metadata === 'string' \n                ? JSON.parse(message.metadata) \n                : message.metadata\n            };\n          } catch (error) {\n            this.logger.warn('QueueSystem', 'Failed to parse message JSON', { \n              messageId: message.id, \n              error: error instanceof Error ? error.message : 'Unknown error' \n            });\n            return message;\n          }\n        });\n      } catch (error) {\n        this.logger.error('QueueSystem', 'Failed to dequeue messages', error);\n        return [];\n      }\n    });\n\n    const messages = transaction();\n    \n    if (messages.length > 0) {\n      this.logger.info('QueueSystem', 'Messages dequeued', {\n        queueName,\n        count: messages.length,\n        messageIds: messages.map(m => m.id)\n      });\n    }\n\n    return messages;\n  }\n\n  /**\n   * Mark message as completed\n   */\n  markCompleted(messageId: number): void {\n    try {\n      const stmt = this.getPreparedStatement('markCompleted', `\n        UPDATE queue_messages \n        SET status = 'completed', processed_at = ?\n        WHERE id = ?\n      `);\n\n      const result = stmt.run(Date.now(), messageId);\n      \n      if (result.changes > 0) {\n        this.logger.info('QueueSystem', 'Message marked as completed', { messageId });\n      } else {\n        this.logger.warn('QueueSystem', 'Failed to mark message as completed', { messageId });\n      }\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Error marking message as completed', error);\n    }\n  }\n\n  /**\n   * Mark message as failed with exponential backoff retry logic\n   */\n  markFailed(messageId: number, errorMessage: string): void {\n    const now = Date.now();\n    \n    const transaction = this.db.transaction(() => {\n      try {\n        // Get current message\n        const selectStmt = this.db.prepare('SELECT * FROM queue_messages WHERE id = ?');\n        const message = selectStmt.get(messageId) as QueueMessage | undefined;\n        \n        if (!message) {\n          this.logger.warn('QueueSystem', 'Message not found for failure marking', { messageId });\n          return;\n        }\n\n        // Get queue configuration\n        const config = this.getQueueConfig(message.queue_name);\n        const newRetryCount = message.retry_count + 1;\n        \n        if (newRetryCount <= config.maxRetries) {\n          // Calculate exponential backoff with jitter\n          const retryDelayMs = this.calculateExponentialBackoff(\n            newRetryCount, \n            config.baseDelayMs, \n            config.maxDelayMs, \n            config.useJitter,\n            config.backoffMultiplier\n          );\n          const nextRetryAt = now + retryDelayMs;\n          \n          const updateStmt = this.db.prepare(`\n            UPDATE queue_messages \n            SET status = 'retrying', \n                retry_count = ?, \n                error_message = ?,\n                next_retry_at = ?\n            WHERE id = ?\n          `);\n          \n          updateStmt.run(newRetryCount, errorMessage, nextRetryAt, messageId);\n          \n          this.logger.info('QueueSystem', 'Message scheduled for retry', {\n            messageId,\n            retryCount: newRetryCount,\n            nextRetryAt,\n            delayMs: retryDelayMs\n          });\n        } else {\n          // Move to dead letter queue\n          this.moveToDeadLetterQueue(message, errorMessage);\n          \n          // Mark as failed\n          const updateStmt = this.db.prepare(`\n            UPDATE queue_messages \n            SET status = 'failed', \n                retry_count = ?, \n                error_message = ?,\n                processed_at = ?\n            WHERE id = ?\n          `);\n          \n          updateStmt.run(newRetryCount, errorMessage, now, messageId);\n          \n          this.logger.error('QueueSystem', 'Message moved to dead letter queue', {\n            messageId,\n            retryCount: newRetryCount,\n            errorMessage\n          });\n        }\n      } catch (error) {\n        this.logger.error('QueueSystem', 'Error in markFailed transaction', error);\n        throw error;\n      }\n    });\n\n    try {\n      transaction();\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to mark message as failed', error);\n    }\n  }\n\n  /**\n   * Calculate exponential backoff with jitter\n   */\n  private calculateExponentialBackoff(\n    retryCount: number, \n    baseDelayMs: number, \n    maxDelayMs: number,\n    useJitter: boolean,\n    backoffMultiplier: number\n  ): number {\n    // Calculate exponential delay\n    let delay = baseDelayMs * Math.pow(backoffMultiplier, retryCount - 1);\n    \n    // Add jitter if enabled (25% randomization)\n    if (useJitter) {\n      const jitterRange = delay * 0.25;\n      const jitter = (Math.random() * 2 - 1) * jitterRange;\n      delay += jitter;\n    }\n    \n    // Clamp to max delay\n    return Math.min(Math.max(0, delay), maxDelayMs);\n  }\n\n  /**\n   * Get queue configuration (with caching)\n   */\n  private queueConfigCache = new Map<string, RetryConfig & QueueProcessorConfig>();\n  \n  getQueueConfig(queueName: string): RetryConfig & QueueProcessorConfig {\n    // Check cache first\n    if (this.queueConfigCache.has(queueName)) {\n      return this.queueConfigCache.get(queueName)!;\n    }\n\n    try {\n      const stmt = this.db.prepare('SELECT * FROM queue_configs WHERE queue_name = ?');\n      const config = stmt.get(queueName) as any;\n      \n      if (config) {\n        const parsedConfig = {\n          maxRetries: config.max_retries,\n          baseDelayMs: config.base_delay_ms,\n          maxDelayMs: config.max_delay_ms,\n          useJitter: !!config.use_jitter,\n          backoffMultiplier: config.backoff_multiplier,\n          batchSize: config.batch_size,\n          processingTimeout: config.processing_timeout,\n          cleanupInterval: 5000,\n          retentionPeriod: config.retention_period\n        };\n        \n        this.queueConfigCache.set(queueName, parsedConfig);\n        return parsedConfig;\n      }\n    } catch (error) {\n      this.logger.warn('QueueSystem', 'Failed to get queue config, using defaults', { queueName, error });\n    }\n\n    // Return defaults if no config found\n    const defaultConfig = {\n      maxRetries: 3,\n      baseDelayMs: 1000,\n      maxDelayMs: 300000,\n      useJitter: true,\n      backoffMultiplier: 2.0,\n      batchSize: 10,\n      processingTimeout: 30000,\n      cleanupInterval: 5000,\n      retentionPeriod: 7 * 24 * 60 * 60 * 1000\n    };\n    \n    // Cache the default config\n    this.queueConfigCache.set(queueName, defaultConfig);\n    return defaultConfig;\n  }\n\n  /**\n   * Configure a queue\n   */\n  configureQueue(queueName: string, config: Partial<RetryConfig & QueueProcessorConfig>): void {\n    const now = Date.now();\n    \n    try {\n      const stmt = this.db.prepare(`\n        INSERT OR REPLACE INTO queue_configs (\n          queue_name, max_retries, base_delay_ms, max_delay_ms, use_jitter,\n          backoff_multiplier, batch_size, processing_timeout, retention_period,\n          enabled, created_at, updated_at\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `);\n\n      stmt.run(\n        queueName,\n        config.maxRetries ?? 3,\n        config.baseDelayMs ?? 1000,\n        config.maxDelayMs ?? 300000,\n        (config.useJitter ?? true) ? 1 : 0,\n        config.backoffMultiplier ?? 2.0,\n        config.batchSize ?? 10,\n        config.processingTimeout ?? 30000,\n        config.retentionPeriod ?? (7 * 24 * 60 * 60 * 1000),\n        1, // enabled\n        now,\n        now\n      );\n\n      // Clear cache for this queue\n      this.queueConfigCache.delete(queueName);\n      \n      this.logger.info('QueueSystem', 'Queue configured', { queueName, config });\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to configure queue', error);\n      throw new Error(`Failed to configure queue: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Move message to dead letter queue\n   */\n  private moveToDeadLetterQueue(message: QueueMessage, errorMessage: string): void {\n    try {\n      const stmt = this.db.prepare(`\n        INSERT INTO dead_letter_queue (\n          original_queue_name, original_message_id, payload, error_message,\n          retry_count, failed_at, correlation_id, message_type, metadata\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n      `);\n\n      stmt.run(\n        message.queue_name,\n        message.id,\n        typeof message.payload === 'string' ? message.payload : JSON.stringify(message.payload),\n        errorMessage,\n        message.retry_count,\n        Date.now(),\n        message.correlation_id,\n        message.message_type,\n        typeof message.metadata === 'string' ? message.metadata : JSON.stringify(message.metadata)\n      );\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to move message to DLQ', error);\n    }\n  }\n\n  /**\n   * Get queue statistics\n   */\n  getQueueStats(queueName: string): QueueStats {\n    try {\n      const stmt = this.db.prepare(`\n        SELECT \n          status,\n          COUNT(*) as count,\n          AVG(CASE WHEN processed_at IS NOT NULL AND created_at IS NOT NULL \n               THEN processed_at - created_at END) as avg_processing_time\n        FROM queue_messages \n        WHERE queue_name = ?\n        GROUP BY status\n      `);\n\n      const results = stmt.all(queueName) as Array<{ \n        status: string; \n        count: number; \n        avg_processing_time: number | null \n      }>;\n      \n      const stats: QueueStats = {\n        queueName,\n        pending: 0,\n        processing: 0,\n        completed: 0,\n        failed: 0,\n        retrying: 0,\n        totalProcessed: 0,\n        avgProcessingTime: 0\n      };\n\n      let totalTime = 0;\n      let timeCount = 0;\n\n      for (const result of results) {\n        switch (result.status) {\n          case 'pending':\n            stats.pending = result.count;\n            break;\n          case 'processing':\n            stats.processing = result.count;\n            break;\n          case 'completed':\n            stats.completed = result.count;\n            stats.totalProcessed += result.count;\n            break;\n          case 'failed':\n            stats.failed = result.count;\n            stats.totalProcessed += result.count;\n            break;\n          case 'retrying':\n            stats.retrying = result.count;\n            break;\n        }\n        \n        if (result.avg_processing_time !== null) {\n          totalTime += result.avg_processing_time * result.count;\n          timeCount += result.count;\n        }\n      }\n\n      if (timeCount > 0) {\n        stats.avgProcessingTime = totalTime / timeCount;\n      }\n\n      return stats;\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to get queue stats', error);\n      return {\n        queueName,\n        pending: 0,\n        processing: 0,\n        completed: 0,\n        failed: 0,\n        retrying: 0,\n        totalProcessed: 0,\n        avgProcessingTime: 0\n      };\n    }\n  }\n\n  /**\n   * Peek at messages without dequeuing\n   */\n  peekMessages(queueName: string, limit: number = 10): QueueMessage[] {\n    try {\n      const stmt = this.db.prepare(`\n        SELECT * FROM queue_messages \n        WHERE queue_name = ? \n          AND status IN ('pending', 'retrying')\n          AND scheduled_at <= ?\n          AND (next_retry_at IS NULL OR next_retry_at <= ?)\n        ORDER BY priority DESC, created_at ASC \n        LIMIT ?\n      `);\n\n      const now = Date.now();\n      const messages = stmt.all(queueName, now, now, limit) as QueueMessage[];\n      \n      // Parse JSON fields for display\n      return messages.map(message => ({\n        ...message,\n        payload: this.safeJsonParse(message.payload),\n        metadata: message.metadata ? this.safeJsonParse(message.metadata) : null\n      }));\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to peek messages', error);\n      return [];\n    }\n  }\n\n  /**\n   * Safe JSON parse helper\n   */\n  private safeJsonParse(value: any): any {\n    if (typeof value !== 'string') return value;\n    \n    try {\n      return JSON.parse(value);\n    } catch {\n      return value;\n    }\n  }\n\n  /**\n   * Start background cleanup process\n   */\n  private startCleanupProcess(): void {\n    this.cleanupInterval = setInterval(() => {\n      if (!this.isShuttingDown) {\n        this.cleanupOldMessages();\n      }\n    }, 60000); // Run every minute\n  }\n\n  /**\n   * Cleanup old completed messages\n   */\n  private cleanupOldMessages(): void {\n    try {\n      // Get retention periods for each queue\n      const queuesStmt = this.db.prepare(`\n        SELECT DISTINCT q.queue_name, COALESCE(c.retention_period, 604800000) as retention_period\n        FROM queue_messages q\n        LEFT JOIN queue_configs c ON q.queue_name = c.queue_name\n      `);\n      \n      const queues = queuesStmt.all() as Array<{ queue_name: string; retention_period: number }>;\n      \n      for (const queue of queues) {\n        const cutoffTime = Date.now() - queue.retention_period;\n        \n        const stmt = this.db.prepare(`\n          DELETE FROM queue_messages \n          WHERE queue_name = ?\n            AND status IN ('completed', 'failed') \n            AND processed_at < ?\n        `);\n        \n        const result = stmt.run(queue.queue_name, cutoffTime);\n        \n        if (result.changes > 0) {\n          this.logger.info('QueueSystem', 'Cleaned up old messages', { \n            queueName: queue.queue_name,\n            count: result.changes \n          });\n        }\n      }\n      \n      // Also cleanup old dead letter queue entries (30 days retention)\n      const dlqCutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);\n      const dlqStmt = this.db.prepare('DELETE FROM dead_letter_queue WHERE failed_at < ?');\n      const dlqResult = dlqStmt.run(dlqCutoff);\n      \n      if (dlqResult.changes > 0) {\n        this.logger.info('QueueSystem', 'Cleaned up old DLQ messages', { count: dlqResult.changes });\n      }\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Failed to cleanup old messages', error);\n    }\n  }\n\n  /**\n   * Register a queue processor\n   */\n  registerProcessor(queueName: string, processor: QueueProcessor): void {\n    if (this.processors.has(queueName)) {\n      this.logger.warn('QueueSystem', 'Processor already registered', { queueName });\n      return;\n    }\n    \n    this.processors.set(queueName, processor);\n    processor.start();\n    this.logger.info('QueueSystem', 'Processor registered', { queueName });\n  }\n\n  /**\n   * Unregister a queue processor\n   */\n  unregisterProcessor(queueName: string): void {\n    const processor = this.processors.get(queueName);\n    if (processor) {\n      processor.stop();\n      this.processors.delete(queueName);\n      this.logger.info('QueueSystem', 'Processor unregistered', { queueName });\n    }\n  }\n\n  /**\n   * Execute a read-only query on the database\n   * This method is provided for safe read-only access to the database\n   */\n  executeQuery<T = any>(sql: string, params: any[] = []): T[] {\n    try {\n      const stmt = this.db.prepare(sql);\n      return stmt.all(...params) as T[];\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Query execution failed', { sql, error });\n      throw error;\n    }\n  }\n\n  /**\n   * Execute a single read-only query that returns one row\n   */\n  executeQuerySingle<T = any>(sql: string, params: any[] = []): T | undefined {\n    try {\n      const stmt = this.db.prepare(sql);\n      return stmt.get(...params) as T | undefined;\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Single query execution failed', { sql, error });\n      throw error;\n    }\n  }\n\n  /**\n   * Execute a write operation on the database within a transaction\n   */\n  executeTransaction<T = any>(fn: (db: Database.Database) => T): T {\n    try {\n      const transaction = this.db.transaction(fn);\n      return transaction(this.db);\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Transaction execution failed', error);\n      \n      // Ensure any pending transaction is rolled back\n      try {\n        this.db.exec('ROLLBACK');\n      } catch (rollbackError) {\n        // Ignore rollback errors as transaction may have already been rolled back\n        this.logger.debug('QueueSystem', 'Rollback attempted after transaction error', rollbackError);\n      }\n      \n      // Clear any cached statements that might be in an invalid state\n      if (this.preparedStatements.size > 0) {\n        this.logger.info('QueueSystem', 'Clearing prepared statements cache after transaction error');\n        // Simply clear the cache - better-sqlite3 handles cleanup\n        this.preparedStatements.clear();\n      }\n      \n      throw error;\n    }\n  }\n\n  /**\n   * Get all distinct queue names\n   */\n  getQueueNames(): string[] {\n    const stmt = this.db.prepare('SELECT DISTINCT queue_name FROM queue_messages');\n    const results = stmt.all() as Array<{ queue_name: string }>;\n    return results.map(r => r.queue_name);\n  }\n\n  /**\n   * Get the current size of a specific queue\n   */\n  getQueueSize(queueName: string): number {\n    const stmt = this.getPreparedStatement('queueSize', `\n      SELECT COUNT(*) as count \n      FROM queue_messages \n      WHERE queue_name = ? \n      AND status IN ('pending', 'processing', 'retrying')\n    `);\n    const result = stmt.get(queueName) as { count: number };\n    return result?.count || 0;\n  }\n\n  /**\n   * Graceful shutdown\n   */\n  async shutdown(): Promise<void> {\n    this.isShuttingDown = true;\n    \n    // Clear cleanup interval\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval);\n      this.cleanupInterval = undefined;\n    }\n    \n    // Stop all processors gracefully\n    const stopPromises: Promise<void>[] = [];\n    for (const [queueName, processor] of this.processors.entries()) {\n      this.logger.info('QueueSystem', 'Stopping processor', { queueName });\n      stopPromises.push(processor.stop());\n    }\n    \n    await Promise.all(stopPromises);\n    this.processors.clear();\n    \n    // Clear prepared statements cache\n    try {\n      // Simply clear the cache - better-sqlite3 handles cleanup automatically when DB is closed\n      this.preparedStatements.clear();\n      this.logger.info('QueueSystem', 'Prepared statements cache cleared');\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Error clearing prepared statements cache', error);\n    }\n    \n    // Close database connection\n    try {\n      this.db.close();\n      this.logger.info('QueueSystem', 'Database connection closed');\n    } catch (error) {\n      this.logger.error('QueueSystem', 'Error closing database', error);\n    }\n  }\n\n  /**\n   * Close database connection (deprecated, use shutdown instead)\n   * @deprecated Use shutdown() for graceful shutdown\n   */\n  close(): void {\n    this.logger.warn('QueueSystem', 'close() is deprecated, use shutdown() instead');\n    this.shutdown().catch(error => {\n      this.logger.error('QueueSystem', 'Error during close/shutdown', error);\n    });\n  }\n}\n\n/**\n * Base class for queue processors\n */\nexport abstract class QueueProcessor {\n  protected queueName: string;\n  protected queueSystem: QueueSystem;\n  protected config: QueueProcessorConfig;\n  protected logger = LoggingService.getInstance();\n  protected isRunning = false;\n  protected processInterval?: NodeJS.Timeout;\n  protected activeProcessing = new Set<Promise<void>>();\n  protected maxConcurrentProcessing = 10;\n\n  constructor(\n    queueName: string,\n    config: Partial<QueueProcessorConfig> = {}\n  ) {\n    this.queueName = queueName;\n    this.queueSystem = QueueSystem.getInstance();\n    this.config = {\n      batchSize: config.batchSize || 10,\n      processingTimeout: config.processingTimeout || 30000,\n      cleanupInterval: config.cleanupInterval || 5000,\n      retentionPeriod: config.retentionPeriod || 7 * 24 * 60 * 60 * 1000\n    };\n  }\n\n  /**\n   * Start the processor\n   */\n  start(): void {\n    if (this.isRunning) {\n      return;\n    }\n\n    this.isRunning = true;\n    this.processInterval = setInterval(() => {\n      this.processMessages().catch(error => {\n        this.logger.error('QueueProcessor', 'Error in process loop', error);\n      });\n    }, this.config.cleanupInterval);\n\n    // Process immediately on start\n    this.processMessages().catch(error => {\n      this.logger.error('QueueProcessor', 'Error in initial process', error);\n    });\n\n    this.logger.info('QueueProcessor', 'Started', { queueName: this.queueName });\n  }\n\n  /**\n   * Stop the processor gracefully\n   */\n  async stop(): Promise<void> {\n    this.isRunning = false;\n    \n    if (this.processInterval) {\n      clearInterval(this.processInterval);\n      this.processInterval = undefined;\n    }\n    \n    // Wait for all active processing to complete\n    if (this.activeProcessing.size > 0) {\n      this.logger.info('QueueProcessor', 'Waiting for active processing to complete', {\n        queueName: this.queueName,\n        activeCount: this.activeProcessing.size\n      });\n      \n      try {\n        // Wait with timeout to prevent hanging\n        await Promise.race([\n          Promise.all(Array.from(this.activeProcessing)),\n          new Promise<void>((resolve) => setTimeout(() => {\n            this.logger.warn('QueueProcessor', 'Timeout waiting for processing to complete', {\n              queueName: this.queueName,\n              remainingCount: this.activeProcessing.size\n            });\n            resolve();\n          }, 30000)) // 30 second timeout\n        ]);\n      } catch (error) {\n        this.logger.error('QueueProcessor', 'Error waiting for active processing', error);\n      }\n    }\n    \n    // Clear any remaining references\n    this.activeProcessing.clear();\n    \n    // Wait for any custom cleanup\n    await this.onStop();\n    \n    this.logger.info('QueueProcessor', 'Stopped', { queueName: this.queueName });\n  }\n\n  /**\n   * Hook for cleanup on stop (override in subclasses if needed)\n   */\n  protected async onStop(): Promise<void> {\n    // Override in subclasses if cleanup is needed\n  }\n\n  /**\n   * Process messages from the queue\n   */\n  private async processMessages(): Promise<void> {\n    if (!this.isRunning) {\n      return;\n    }\n\n    // Don't start new processing if we're at capacity\n    if (this.activeProcessing.size >= this.maxConcurrentProcessing) {\n      this.logger.debug('QueueProcessor', 'At max concurrent processing capacity', {\n        queueName: this.queueName,\n        activeCount: this.activeProcessing.size\n      });\n      return;\n    }\n\n    try {\n      // Calculate how many messages we can process\n      const availableSlots = this.maxConcurrentProcessing - this.activeProcessing.size;\n      const batchSize = Math.min(this.config.batchSize, availableSlots);\n      \n      if (batchSize <= 0) {\n        return;\n      }\n      \n      const messages = this.queueSystem.dequeue(this.queueName, batchSize);\n      \n      // Process messages in parallel with timeout and tracking\n      const processingPromises = messages.map(message => {\n        const promise = this.processMessageWithTimeout(message);\n        \n        // Track active processing\n        this.activeProcessing.add(promise);\n        promise.finally(() => {\n          this.activeProcessing.delete(promise);\n        });\n        \n        return promise;\n      });\n      \n      await Promise.allSettled(processingPromises);\n    } catch (error) {\n      this.logger.error('QueueProcessor', 'Error processing messages', error);\n    }\n  }\n\n  /**\n   * Process a single message with timeout\n   */\n  private async processMessageWithTimeout(message: QueueMessage): Promise<void> {\n    try {\n      await Promise.race([\n        this.processMessage(message),\n        new Promise<never>((_, reject) => \n          setTimeout(\n            () => reject(new Error(`Processing timeout after ${this.config.processingTimeout}ms`)), \n            this.config.processingTimeout\n          )\n        )\n      ]);\n      \n      this.queueSystem.markCompleted(message.id!);\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      this.logger.error('QueueProcessor', 'Message processing failed', {\n        messageId: message.id,\n        error: errorMessage\n      });\n      this.queueSystem.markFailed(message.id!, errorMessage);\n    }\n  }\n\n  /**\n   * Abstract method to process a single message\n   */\n  protected abstract processMessage(message: QueueMessage): Promise<void>;\n}"],"version":3}