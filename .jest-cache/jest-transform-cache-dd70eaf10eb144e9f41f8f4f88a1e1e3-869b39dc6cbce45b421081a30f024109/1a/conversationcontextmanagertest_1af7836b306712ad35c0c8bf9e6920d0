741f2b4933a9f482f0c54bf4f8297d5c
"use strict";
/**
 * Tests for ConversationContextManager
 * Phase 4: Duplicate detection and conversation context tracking
 */
Object.defineProperty(exports, "__esModule", { value: true });
const conversation_context_manager_1 = require("../../src/services/conversation-context-manager");
describe('ConversationContextManager', () => {
    let manager;
    beforeEach(() => {
        manager = conversation_context_manager_1.ConversationContextManager.getInstance();
        // Clear any existing data
        const stats = manager.getStats();
        if (stats.activeSessions > 0) {
            // Manually clean up if needed (cleanup method is available)
            manager.cleanup();
        }
    });
    afterEach(() => {
        // Cleanup after each test
        manager.cleanup();
    });
    describe('recordAction', () => {
        it('should record an action successfully', () => {
            const sessionId = 'test-session-1';
            const action = 'analyze_preferences';
            const input = { query: 'test' };
            const result = { preferences: [] };
            manager.recordAction(sessionId, action, input, result);
            const recentActions = manager.getRecentActions(sessionId);
            expect(recentActions).toHaveLength(1);
            expect(recentActions[0].action).toBe(action);
            expect(recentActions[0].sessionId).toBe(sessionId);
        });
        it('should maintain action order (most recent first)', () => {
            const sessionId = 'test-session-2';
            manager.recordAction(sessionId, 'action1', {}, { result: 1 });
            manager.recordAction(sessionId, 'action2', {}, { result: 2 });
            manager.recordAction(sessionId, 'action3', {}, { result: 3 });
            const recentActions = manager.getRecentActions(sessionId);
            expect(recentActions[0].action).toBe('action3'); // Most recent
            expect(recentActions[1].action).toBe('action2');
            expect(recentActions[2].action).toBe('action1');
        });
        it('should limit actions per session to prevent memory bloat', () => {
            const sessionId = 'test-session-3';
            // Record more than MAX_ACTIONS_PER_SESSION (50)
            for (let i = 0; i < 60; i++) {
                manager.recordAction(sessionId, `action${i}`, {}, { result: i });
            }
            const allActions = manager.getRecentActions(sessionId, 100);
            expect(allActions.length).toBeLessThanOrEqual(50);
        });
    });
    describe('checkForDuplicate', () => {
        it('should detect duplicate with identical action and input', () => {
            const sessionId = 'test-session-4';
            const action = 'analyze_preferences';
            const input = { conversation: 'Can you analyze our conversation for preferences?' };
            // First call - record it
            manager.recordAction(sessionId, action, input, { preferences: [] });
            // Second call - should detect duplicate
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(true);
            expect(duplicateCheck.previousAction).toBeDefined();
            expect(duplicateCheck.suggestion).toBeDefined();
            expect(duplicateCheck.turnsSince).toBeDefined();
        });
        it('should NOT detect duplicate with different action', () => {
            const sessionId = 'test-session-5';
            const input = { query: 'test' };
            manager.recordAction(sessionId, 'action1', input, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, 'action2', input);
            expect(duplicateCheck.isDuplicate).toBe(false);
        });
        it('should NOT detect duplicate with different input', () => {
            const sessionId = 'test-session-6';
            const action = 'search_memories';
            manager.recordAction(sessionId, action, { query: 'first query' }, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, { query: 'different query' });
            expect(duplicateCheck.isDuplicate).toBe(false);
        });
        it('should NOT detect duplicate if outside detection window', () => {
            const sessionId = 'test-session-7';
            const action = 'test_action';
            const input = { data: 'test' };
            // Record 4 actions to move the first one outside the window (window = 3)
            manager.recordAction(sessionId, action, input, {});
            manager.recordAction(sessionId, 'other1', {}, {});
            manager.recordAction(sessionId, 'other2', {}, {});
            manager.recordAction(sessionId, 'other3', {}, {});
            // Now check for duplicate - should not find it (outside window)
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(false);
        });
        it('should provide helpful suggestion when duplicate detected', () => {
            const sessionId = 'test-session-8';
            const action = 'analyze_preferences';
            const input = { conversation: 'test' };
            manager.recordAction(sessionId, action, input, { preferences: [] });
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.suggestion).toContain('performed this action');
            expect(duplicateCheck.suggestion).toContain('analyze');
        });
    });
    describe('getRecentActions', () => {
        it('should return empty array for non-existent session', () => {
            const actions = manager.getRecentActions('non-existent-session');
            expect(actions).toEqual([]);
        });
        it('should respect limit parameter', () => {
            const sessionId = 'test-session-9';
            for (let i = 0; i < 20; i++) {
                manager.recordAction(sessionId, `action${i}`, {}, {});
            }
            const actions = manager.getRecentActions(sessionId, 5);
            expect(actions).toHaveLength(5);
        });
    });
    describe('getRecentResult', () => {
        it('should return most recent result for given action', () => {
            const sessionId = 'test-session-10';
            const action = 'test_action';
            manager.recordAction(sessionId, action, {}, { value: 1 });
            manager.recordAction(sessionId, 'other_action', {}, { value: 99 });
            manager.recordAction(sessionId, action, {}, { value: 2 });
            const result = manager.getRecentResult(sessionId, action);
            expect(result).toEqual({ value: 2 }); // Most recent
        });
        it('should return null if action not found', () => {
            const sessionId = 'test-session-11';
            const result = manager.getRecentResult(sessionId, 'non_existent_action');
            expect(result).toBeNull();
        });
    });
    describe('clearSession', () => {
        it('should clear all data for a session', () => {
            const sessionId = 'test-session-12';
            manager.recordAction(sessionId, 'action1', {}, {});
            manager.recordAction(sessionId, 'action2', {}, {});
            expect(manager.getRecentActions(sessionId)).toHaveLength(2);
            manager.clearSession(sessionId);
            expect(manager.getRecentActions(sessionId)).toHaveLength(0);
        });
    });
    describe('cleanup', () => {
        it('should remove timed-out sessions', async () => {
            const sessionId = 'test-session-13';
            manager.recordAction(sessionId, 'action1', {}, {});
            const statsBefore = manager.getStats();
            expect(statsBefore.activeSessions).toBeGreaterThan(0);
            // Wait for session to timeout (this would take 30 minutes in production)
            // For testing, we'll just call cleanup and verify it works
            manager.cleanup();
            // In a real test, we'd mock the timestamp to simulate timeout
            // For now, just verify cleanup doesn't error
            const statsAfter = manager.getStats();
            expect(statsAfter.activeSessions).toBeGreaterThanOrEqual(0);
        });
    });
    describe('getStats', () => {
        it('should return correct statistics', () => {
            const session1 = 'test-session-14';
            const session2 = 'test-session-15';
            manager.recordAction(session1, 'action1', {}, {});
            manager.recordAction(session1, 'action2', {}, {});
            manager.recordAction(session2, 'action3', {}, {});
            const stats = manager.getStats();
            expect(stats.activeSessions).toBe(2);
            expect(stats.totalActions).toBe(3);
            expect(stats.averageActionsPerSession).toBe(1.5);
        });
    });
    describe('Edge cases', () => {
        it('should handle string input normalization', () => {
            const sessionId = 'test-session-16';
            const action = 'test_action';
            // Record with extra whitespace
            manager.recordAction(sessionId, action, '  Test   String  ', {});
            // Check with normalized string
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, 'Test String');
            expect(duplicateCheck.isDuplicate).toBe(true);
        });
        it('should handle case-insensitive action matching', () => {
            const sessionId = 'test-session-17';
            manager.recordAction(sessionId, 'ANALYZE_PREFERENCES', { query: 'test' }, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, 'analyze_preferences', { query: 'test' });
            expect(duplicateCheck.isDuplicate).toBe(true);
        });
        it('should handle object input with relevant fields', () => {
            const sessionId = 'test-session-18';
            const action = 'search';
            const input1 = { query: 'test query', irrelevant: 'data' };
            const input2 = { query: 'test query', differentIrrelevant: 'data' };
            manager.recordAction(sessionId, action, input1, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input2);
            expect(duplicateCheck.isDuplicate).toBe(true);
        });
    });
    describe('Real-world scenario: Duplicate question detection', () => {
        it('should detect when user asks same question twice in a row', () => {
            const sessionId = 'user-session-1';
            const action = 'mcp__claude-recall__store_preferences';
            const input = {
                conversation: 'Can you analyze our conversation for preferences?'
            };
            const result = {
                stored: true,
                preferences: [
                    { key: 'testing_framework', value: 'jest' }
                ]
            };
            // User asks first time
            manager.recordAction(sessionId, action, input, result);
            // User asks same question immediately
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(true);
            expect(duplicateCheck.turnsSince).toBe(0);
            expect(duplicateCheck.suggestion).toContain('just performed');
            expect(duplicateCheck.previousAction?.result).toEqual(result);
        });
        it('should handle multiple different actions between duplicates', () => {
            const sessionId = 'user-session-2';
            const action = 'analyze';
            const input = { query: 'analyze this' };
            // First action
            manager.recordAction(sessionId, action, input, { result: 'first' });
            // Different actions in between
            manager.recordAction(sessionId, 'other1', {}, {});
            manager.recordAction(sessionId, 'other2', {}, {});
            // Duplicate within window
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(true);
            expect(duplicateCheck.turnsSince).toBe(2);
            expect(duplicateCheck.suggestion).toContain('2 turns ago');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy91bml0L2NvbnZlcnNhdGlvbi1jb250ZXh0LW1hbmFnZXIudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQUVILGtHQUE2RjtBQUU3RixRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQzFDLElBQUksT0FBbUMsQ0FBQztJQUV4QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxHQUFHLHlEQUEwQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25ELDBCQUEwQjtRQUMxQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakMsSUFBSSxLQUFLLENBQUMsY0FBYyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzdCLDREQUE0RDtZQUM1RCxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDcEIsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLDBCQUEwQjtRQUMxQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUM1QixFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQzlDLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDO1lBQ25DLE1BQU0sTUFBTSxHQUFHLHFCQUFxQixDQUFDO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDO1lBQ2hDLE1BQU0sTUFBTSxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDO1lBRW5DLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFdkQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxD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LENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2REFBNkQsRUFBRSxHQUFHLEVBQUU7WUFDckUsTUFBTSxTQUFTLEdBQUcsZ0JBQWdCLENBQUM7WUFDbkMsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDO1lBQ3pCLE1BQU0sS0FBSyxHQUFHLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBRSxDQUFDO1lBRXhDLGVBQWU7WUFDZixPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFFcEUsK0JBQStCO1lBQy9CLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDbEQsT0FBTyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUVsRCwwQkFBMEI7WUFDMUIsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFM0UsTUFBTSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDN0QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9lYmlhcmFvL3JlcG9zL2NsYXVkZS1yZWNhbGwvdGVzdHMvdW5pdC9jb252ZXJzYXRpb24tY29udGV4dC1tYW5hZ2VyLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUZXN0cyBmb3IgQ29udmVyc2F0aW9uQ29udGV4dE1hbmFnZXJcbiAqIFBoYXNlIDQ6IER1cGxpY2F0ZSBkZXRlY3Rpb24gYW5kIGNvbnZlcnNhdGlvbiBjb250ZXh0IHRyYWNraW5nXG4gKi9cblxuaW1wb3J0IHsgQ29udmVyc2F0aW9uQ29udGV4dE1hbmFnZXIgfSBmcm9tICcuLi8uLi9zcmMvc2VydmljZXMvY29udmVyc2F0aW9uLWNvbnRleHQtbWFuYWdlcic7XG5cbmRlc2NyaWJlKCdDb252ZXJzYXRpb25Db250ZXh0TWFuYWdlcicsICgpID0+IHtcbiAgbGV0IG1hbmFnZXI6IENvbnZlcnNhdGlvbkNvbnRleHRNYW5hZ2VyO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1hbmFnZXIgPSBDb252ZXJzYXRpb25Db250ZXh0TWFuYWdlci5nZXRJbnN0YW5jZSgpO1xuICAgIC8vIENsZWFyIGFueSBleGlzdGluZyBkYXRhXG4gICAgY29uc3Qgc3RhdHMgPSBtYW5hZ2VyLmdldFN0YXRzKCk7XG4gICAgaWYgKHN0YXRzLmFjdGl2ZVNlc3Npb25zID4gMCkge1xuICAgICAgLy8gTWFudWFsbHkgY2xlYW4gdXAgaWYgbmVlZGVkIChjbGVhbnVwIG1ldGhvZCBpcyBhdmFpbGFibGUpXG4gICAgICBtYW5hZ2VyLmNsZWFudXAoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgLy8gQ2xlYW51cCBhZnRlciBlYWNoIHRlc3RcbiAgICBtYW5hZ2VyLmNsZWFudXAoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JlY29yZEFjdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJlY29yZCBhbiBhY3Rpb24gc3VjY2Vzc2Z1bGx5JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0xJztcbiAgICAgIGNvbnN0IGFjdGlvbiA9ICdhbmFseXplX3ByZWZlcmVuY2VzJztcbiAgICAgIGNvbnN0IGlucHV0ID0geyBxdWVyeTogJ3Rlc3QnIH07XG4gICAgICBjb25zdCByZXN1bHQgPSB7IHByZWZlcmVuY2VzOiBbXSB9O1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQsIHJlc3VsdCk7XG5cbiAgICAgIGNvbnN0IHJlY2VudEFjdGlvbnMgPSBtYW5hZ2VyLmdldFJlY2VudEFjdGlvbnMoc2Vzc2lvbklkKTtcbiAgICAgIGV4cGVjdChyZWNlbnRBY3Rpb25zKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QocmVjZW50QWN0aW9uc1swXS5hY3Rpb24pLnRvQmUoYWN0aW9uKTtcbiAgICAgIGV4cGVjdChyZWNlbnRBY3Rpb25zWzBdLnNlc3Npb25JZCkudG9CZShzZXNzaW9uSWQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBtYWludGFpbiBhY3Rpb24gb3JkZXIgKG1vc3QgcmVjZW50IGZpcnN0KScsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMic7XG5cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ2FjdGlvbjEnLCB7fSwgeyByZXN1bHQ6IDEgfSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdhY3Rpb24yJywge30sIHsgcmVzdWx0OiAyIH0pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnYWN0aW9uMycsIHt9LCB7IHJlc3VsdDogMyB9KTtcblxuICAgICAgY29uc3QgcmVjZW50QWN0aW9ucyA9IG1hbmFnZXIuZ2V0UmVjZW50QWN0aW9ucyhzZXNzaW9uSWQpO1xuICAgICAgZXhwZWN0KHJlY2VudEFjdGlvbnNbMF0uYWN0aW9uKS50b0JlKCdhY3Rpb24zJyk7IC8vIE1vc3QgcmVjZW50XG4gICAgICBleHBlY3QocmVjZW50QWN0aW9uc1sxXS5hY3Rpb24pLnRvQmUoJ2FjdGlvbjInKTtcbiAgICAgIGV4cGVjdChyZWNlbnRBY3Rpb25zWzJdLmFjdGlvbikudG9CZSgnYWN0aW9uMScpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsaW1pdCBhY3Rpb25zIHBlciBzZXNzaW9uIHRvIHByZXZlbnQgbWVtb3J5IGJsb2F0JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0zJztcblxuICAgICAgLy8gUmVjb3JkIG1vcmUgdGhhbiBNQVhfQUNUSU9OU19QRVJfU0VTU0lPTiAoNTApXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDYwOyBpKyspIHtcbiAgICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBgYWN0aW9uJHtpfWAsIHt9LCB7IHJlc3VsdDogaSB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYWxsQWN0aW9ucyA9IG1hbmFnZXIuZ2V0UmVjZW50QWN0aW9ucyhzZXNzaW9uSWQsIDEwMCk7XG4gICAgICBleHBlY3QoYWxsQWN0aW9ucy5sZW5ndGgpLnRvQmVMZXNzVGhhbk9yRXF1YWwoNTApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2hlY2tGb3JEdXBsaWNhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBkZXRlY3QgZHVwbGljYXRlIHdpdGggaWRlbnRpY2FsIGFjdGlvbiBhbmQgaW5wdXQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTQnO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ2FuYWx5emVfcHJlZmVyZW5jZXMnO1xuICAgICAgY29uc3QgaW5wdXQgPSB7IGNvbnZlcnNhdGlvbjogJ0NhbiB5b3UgYW5hbHl6ZSBvdXIgY29udmVyc2F0aW9uIGZvciBwcmVmZXJlbmNlcz8nIH07XG5cbiAgICAgIC8vIEZpcnN0IGNhbGwgLSByZWNvcmQgaXRcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCwgeyBwcmVmZXJlbmNlczogW10gfSk7XG5cbiAgICAgIC8vIFNlY29uZCBjYWxsIC0gc2hvdWxkIGRldGVjdCBkdXBsaWNhdGVcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2sucHJldmlvdXNBY3Rpb24pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suc3VnZ2VzdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay50dXJuc1NpbmNlKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBOT1QgZGV0ZWN0IGR1cGxpY2F0ZSB3aXRoIGRpZmZlcmVudCBhY3Rpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTUnO1xuICAgICAgY29uc3QgaW5wdXQgPSB7IHF1ZXJ5OiAndGVzdCcgfTtcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnYWN0aW9uMScsIGlucHV0LCB7fSk7XG5cbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsICdhY3Rpb24yJywgaW5wdXQpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBOT1QgZGV0ZWN0IGR1cGxpY2F0ZSB3aXRoIGRpZmZlcmVudCBpbnB1dCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tNic7XG4gICAgICBjb25zdCBhY3Rpb24gPSAnc2VhcmNoX21lbW9yaWVzJztcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIHsgcXVlcnk6ICdmaXJzdCBxdWVyeScgfSwge30pO1xuXG4gICAgICBjb25zdCBkdXBsaWNhdGVDaGVjayA9IG1hbmFnZXIuY2hlY2tGb3JEdXBsaWNhdGUoc2Vzc2lvbklkLCBhY3Rpb24sIHsgcXVlcnk6ICdkaWZmZXJlbnQgcXVlcnknIH0pO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBOT1QgZGV0ZWN0IGR1cGxpY2F0ZSBpZiBvdXRzaWRlIGRldGVjdGlvbiB3aW5kb3cnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTcnO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ3Rlc3RfYWN0aW9uJztcbiAgICAgIGNvbnN0IGlucHV0ID0geyBkYXRhOiAndGVzdCcgfTtcblxuICAgICAgLy8gUmVjb3JkIDQgYWN0aW9ucyB0byBtb3ZlIHRoZSBmaXJzdCBvbmUgb3V0c2lkZSB0aGUgd2luZG93ICh3aW5kb3cgPSAzKVxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIGlucHV0LCB7fSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdvdGhlcjEnLCB7fSwge30pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnb3RoZXIyJywge30sIHt9KTtcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ290aGVyMycsIHt9LCB7fSk7XG5cbiAgICAgIC8vIE5vdyBjaGVjayBmb3IgZHVwbGljYXRlIC0gc2hvdWxkIG5vdCBmaW5kIGl0IChvdXRzaWRlIHdpbmRvdylcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIGhlbHBmdWwgc3VnZ2VzdGlvbiB3aGVuIGR1cGxpY2F0ZSBkZXRlY3RlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tOCc7XG4gICAgICBjb25zdCBhY3Rpb24gPSAnYW5hbHl6ZV9wcmVmZXJlbmNlcyc7XG4gICAgICBjb25zdCBpbnB1dCA9IHsgY29udmVyc2F0aW9uOiAndGVzdCcgfTtcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIGlucHV0LCB7IHByZWZlcmVuY2VzOiBbXSB9KTtcblxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5zdWdnZXN0aW9uKS50b0NvbnRhaW4oJ3BlcmZvcm1lZCB0aGlzIGFjdGlvbicpO1xuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLnN1Z2dlc3Rpb24pLnRvQ29udGFpbignYW5hbHl6ZScpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0UmVjZW50QWN0aW9ucycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBlbXB0eSBhcnJheSBmb3Igbm9uLWV4aXN0ZW50IHNlc3Npb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBhY3Rpb25zID0gbWFuYWdlci5nZXRSZWNlbnRBY3Rpb25zKCdub24tZXhpc3RlbnQtc2Vzc2lvbicpO1xuICAgICAgZXhwZWN0KGFjdGlvbnMpLnRvRXF1YWwoW10pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXNwZWN0IGxpbWl0IHBhcmFtZXRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tOSc7XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjA7IGkrKykge1xuICAgICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGBhY3Rpb24ke2l9YCwge30sIHt9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYWN0aW9ucyA9IG1hbmFnZXIuZ2V0UmVjZW50QWN0aW9ucyhzZXNzaW9uSWQsIDUpO1xuICAgICAgZXhwZWN0KGFjdGlvbnMpLnRvSGF2ZUxlbmd0aCg1KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldFJlY2VudFJlc3VsdCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBtb3N0IHJlY2VudCByZXN1bHQgZm9yIGdpdmVuIGFjdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMTAnO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ3Rlc3RfYWN0aW9uJztcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIHt9LCB7IHZhbHVlOiAxIH0pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnb3RoZXJfYWN0aW9uJywge30sIHsgdmFsdWU6IDk5IH0pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIHt9LCB7IHZhbHVlOiAyIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBtYW5hZ2VyLmdldFJlY2VudFJlc3VsdChzZXNzaW9uSWQsIGFjdGlvbik7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgdmFsdWU6IDIgfSk7IC8vIE1vc3QgcmVjZW50XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGlmIGFjdGlvbiBub3QgZm91bmQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTExJztcblxuICAgICAgY29uc3QgcmVzdWx0ID0gbWFuYWdlci5nZXRSZWNlbnRSZXN1bHQoc2Vzc2lvbklkLCAnbm9uX2V4aXN0ZW50X2FjdGlvbicpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NsZWFyU2Vzc2lvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNsZWFyIGFsbCBkYXRhIGZvciBhIHNlc3Npb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTEyJztcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnYWN0aW9uMScsIHt9LCB7fSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdhY3Rpb24yJywge30sIHt9KTtcblxuICAgICAgZXhwZWN0KG1hbmFnZXIuZ2V0UmVjZW50QWN0aW9ucyhzZXNzaW9uSWQpKS50b0hhdmVMZW5ndGgoMik7XG5cbiAgICAgIG1hbmFnZXIuY2xlYXJTZXNzaW9uKHNlc3Npb25JZCk7XG5cbiAgICAgIGV4cGVjdChtYW5hZ2VyLmdldFJlY2VudEFjdGlvbnMoc2Vzc2lvbklkKSkudG9IYXZlTGVuZ3RoKDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2xlYW51cCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJlbW92ZSB0aW1lZC1vdXQgc2Vzc2lvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTEzJztcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnYWN0aW9uMScsIHt9LCB7fSk7XG5cbiAgICAgIGNvbnN0IHN0YXRzQmVmb3JlID0gbWFuYWdlci5nZXRTdGF0cygpO1xuICAgICAgZXhwZWN0KHN0YXRzQmVmb3JlLmFjdGl2ZVNlc3Npb25zKS50b0JlR3JlYXRlclRoYW4oMCk7XG5cbiAgICAgIC8vIFdhaXQgZm9yIHNlc3Npb24gdG8gdGltZW91dCAodGhpcyB3b3VsZCB0YWtlIDMwIG1pbnV0ZXMgaW4gcHJvZHVjdGlvbilcbiAgICAgIC8vIEZvciB0ZXN0aW5nLCB3ZSdsbCBqdXN0IGNhbGwgY2xlYW51cCBhbmQgdmVyaWZ5IGl0IHdvcmtzXG4gICAgICBtYW5hZ2VyLmNsZWFudXAoKTtcblxuICAgICAgLy8gSW4gYSByZWFsIHRlc3QsIHdlJ2QgbW9jayB0aGUgdGltZXN0YW1wIHRvIHNpbXVsYXRlIHRpbWVvdXRcbiAgICAgIC8vIEZvciBub3csIGp1c3QgdmVyaWZ5IGNsZWFudXAgZG9lc24ndCBlcnJvclxuICAgICAgY29uc3Qgc3RhdHNBZnRlciA9IG1hbmFnZXIuZ2V0U3RhdHMoKTtcbiAgICAgIGV4cGVjdChzdGF0c0FmdGVyLmFjdGl2ZVNlc3Npb25zKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0U3RhdHMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29ycmVjdCBzdGF0aXN0aWNzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbjEgPSAndGVzdC1zZXNzaW9uLTE0JztcbiAgICAgIGNvbnN0IHNlc3Npb24yID0gJ3Rlc3Qtc2Vzc2lvbi0xNSc7XG5cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb24xLCAnYWN0aW9uMScsIHt9LCB7fSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uMSwgJ2FjdGlvbjInLCB7fSwge30pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbjIsICdhY3Rpb24zJywge30sIHt9KTtcblxuICAgICAgY29uc3Qgc3RhdHMgPSBtYW5hZ2VyLmdldFN0YXRzKCk7XG5cbiAgICAgIGV4cGVjdChzdGF0cy5hY3RpdmVTZXNzaW9ucykudG9CZSgyKTtcbiAgICAgIGV4cGVjdChzdGF0cy50b3RhbEFjdGlvbnMpLnRvQmUoMyk7XG4gICAgICBleHBlY3Qoc3RhdHMuYXZlcmFnZUFjdGlvbnNQZXJTZXNzaW9uKS50b0JlKDEuNSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFZGdlIGNhc2VzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIHN0cmluZyBpbnB1dCBub3JtYWxpemF0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0xNic7XG4gICAgICBjb25zdCBhY3Rpb24gPSAndGVzdF9hY3Rpb24nO1xuXG4gICAgICAvLyBSZWNvcmQgd2l0aCBleHRyYSB3aGl0ZXNwYWNlXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwgJyAgVGVzdCAgIFN0cmluZyAgJywge30pO1xuXG4gICAgICAvLyBDaGVjayB3aXRoIG5vcm1hbGl6ZWQgc3RyaW5nXG4gICAgICBjb25zdCBkdXBsaWNhdGVDaGVjayA9IG1hbmFnZXIuY2hlY2tGb3JEdXBsaWNhdGUoc2Vzc2lvbklkLCBhY3Rpb24sICdUZXN0IFN0cmluZycpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBjYXNlLWluc2Vuc2l0aXZlIGFjdGlvbiBtYXRjaGluZycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMTcnO1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdBTkFMWVpFX1BSRUZFUkVOQ0VTJywgeyBxdWVyeTogJ3Rlc3QnIH0sIHt9KTtcblxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgJ2FuYWx5emVfcHJlZmVyZW5jZXMnLCB7IHF1ZXJ5OiAndGVzdCcgfSk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG9iamVjdCBpbnB1dCB3aXRoIHJlbGV2YW50IGZpZWxkcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMTgnO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ3NlYXJjaCc7XG5cbiAgICAgIGNvbnN0IGlucHV0MSA9IHsgcXVlcnk6ICd0ZXN0IHF1ZXJ5JywgaXJyZWxldmFudDogJ2RhdGEnIH07XG4gICAgICBjb25zdCBpbnB1dDIgPSB7IHF1ZXJ5OiAndGVzdCBxdWVyeScsIGRpZmZlcmVudElycmVsZXZhbnQ6ICdkYXRhJyB9O1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQxLCB7fSk7XG5cbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQyKTtcblxuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLmlzRHVwbGljYXRlKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUmVhbC13b3JsZCBzY2VuYXJpbzogRHVwbGljYXRlIHF1ZXN0aW9uIGRldGVjdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRldGVjdCB3aGVuIHVzZXIgYXNrcyBzYW1lIHF1ZXN0aW9uIHR3aWNlIGluIGEgcm93JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3VzZXItc2Vzc2lvbi0xJztcbiAgICAgIGNvbnN0IGFjdGlvbiA9ICdtY3BfX2NsYXVkZS1yZWNhbGxfX3N0b3JlX3ByZWZlcmVuY2VzJztcbiAgICAgIGNvbnN0IGlucHV0ID0ge1xuICAgICAgICBjb252ZXJzYXRpb246ICdDYW4geW91IGFuYWx5emUgb3VyIGNvbnZlcnNhdGlvbiBmb3IgcHJlZmVyZW5jZXM/J1xuICAgICAgfTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgc3RvcmVkOiB0cnVlLFxuICAgICAgICBwcmVmZXJlbmNlczogW1xuICAgICAgICAgIHsga2V5OiAndGVzdGluZ19mcmFtZXdvcmsnLCB2YWx1ZTogJ2plc3QnIH1cbiAgICAgICAgXVxuICAgICAgfTtcblxuICAgICAgLy8gVXNlciBhc2tzIGZpcnN0IHRpbWVcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCwgcmVzdWx0KTtcblxuICAgICAgLy8gVXNlciBhc2tzIHNhbWUgcXVlc3Rpb24gaW1tZWRpYXRlbHlcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2sudHVybnNTaW5jZSkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5zdWdnZXN0aW9uKS50b0NvbnRhaW4oJ2p1c3QgcGVyZm9ybWVkJyk7XG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2sucHJldmlvdXNBY3Rpb24/LnJlc3VsdCkudG9FcXVhbChyZXN1bHQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbXVsdGlwbGUgZGlmZmVyZW50IGFjdGlvbnMgYmV0d2VlbiBkdXBsaWNhdGVzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3VzZXItc2Vzc2lvbi0yJztcbiAgICAgIGNvbnN0IGFjdGlvbiA9ICdhbmFseXplJztcbiAgICAgIGNvbnN0IGlucHV0ID0geyBxdWVyeTogJ2FuYWx5emUgdGhpcycgfTtcblxuICAgICAgLy8gRmlyc3QgYWN0aW9uXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQsIHsgcmVzdWx0OiAnZmlyc3QnIH0pO1xuXG4gICAgICAvLyBEaWZmZXJlbnQgYWN0aW9ucyBpbiBiZXR3ZWVuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdvdGhlcjEnLCB7fSwge30pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnb3RoZXIyJywge30sIHt9KTtcblxuICAgICAgLy8gRHVwbGljYXRlIHdpdGhpbiB3aW5kb3dcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2sudHVybnNTaW5jZSkudG9CZSgyKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5zdWdnZXN0aW9uKS50b0NvbnRhaW4oJzIgdHVybnMgYWdvJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=