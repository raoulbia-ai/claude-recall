{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/tests/unit/memory-enhancer.test.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/tests/unit/memory-enhancer.test.ts"],"sourcesContent":["import { MemoryEnhancer } from '../../src/services/memory-enhancer';\nimport { MemoryService } from '../../src/services/memory';\nimport { PatternService } from '../../src/services/pattern-service';\nimport { ScoredMemory } from '../../src/core/retrieval';\n\n// Mock dependencies\njest.mock('../../src/services/memory');\njest.mock('../../src/services/pattern-service');\n\ndescribe('MemoryEnhancer', () => {\n  let memoryEnhancer: MemoryEnhancer;\n  let mockMemoryService: jest.Mocked<MemoryService>;\n  let mockPatternService: jest.Mocked<PatternService>;\n  \n  beforeEach(() => {\n    // Clear all mocks\n    jest.clearAllMocks();\n    \n    // Setup mocks\n    mockMemoryService = {\n      search: jest.fn(),\n      findRelevant: jest.fn(),\n    } as any;\n    \n    mockPatternService = {\n      analyzePrompt: jest.fn(),\n    } as any;\n    \n    // Mock getInstance methods\n    (MemoryService.getInstance as jest.Mock).mockReturnValue(mockMemoryService);\n    (PatternService.getInstance as jest.Mock).mockReturnValue(mockPatternService);\n    \n    // Create instance\n    memoryEnhancer = new MemoryEnhancer();\n  });\n  \n  describe('Core Search Enhancement', () => {\n    it('should return direct matches when no patterns detected', async () => {\n      const prompt = 'find user authentication code';\n      const directMatches: ScoredMemory[] = [\n        { key: 'auth_1', value: 'auth code', type: 'project-knowledge', score: 0.9 }\n      ];\n      \n      mockMemoryService.search.mockReturnValue(directMatches);\n      mockPatternService.analyzePrompt.mockReturnValue({});\n      \n      const result = await memoryEnhancer.enhanceSearch(prompt);\n      \n      expect(result).toEqual(directMatches);\n      expect(mockMemoryService.search).toHaveBeenCalledWith(prompt);\n    });\n    \n    it('should enhance search based on detected task patterns', async () => {\n      // Test create_test enhancement\n      const testDirMemory: ScoredMemory = {\n        key: 'pref_test_dir',\n        value: { pattern: 'test directory', value: 'tests/' },\n        type: 'preference',\n        score: 0.8\n      };\n      \n      mockMemoryService.search.mockImplementation((query: string) => {\n        if (query === 'test directory') return [testDirMemory];\n        return [];\n      });\n      mockMemoryService.findRelevant.mockReturnValue([]);\n      mockPatternService.analyzePrompt.mockReturnValue({ taskType: 'create_test' });\n      \n      const result = await memoryEnhancer.enhanceSearch('create a test for the user service');\n      \n      expect(result).toContainEqual(expect.objectContaining({\n        key: 'pref_test_dir',\n        type: 'preference'\n      }));\n      \n      // Test fix_bug enhancement\n      const errorMemory: ScoredMemory = {\n        key: 'error_1',\n        value: { error: 'TypeError', fix: 'check null' },\n        type: 'project-knowledge',\n        score: 0.9\n      };\n      \n      mockMemoryService.search.mockImplementation((query: string) => {\n        if (query === 'TypeError') return [errorMemory];\n        return [];\n      });\n      mockPatternService.analyzePrompt.mockReturnValue({ taskType: 'fix_bug' });\n      \n      const bugResult = await memoryEnhancer.enhanceSearch('fix TypeError in auth.js');\n      \n      expect(bugResult).toContainEqual(expect.objectContaining({\n        key: 'error_1',\n        type: 'project-knowledge'\n      }));\n    });\n    \n    it('should deduplicate and rank memories correctly', async () => {\n      const prompt = 'test query';\n      const memory1 = { key: 'dup_1', value: 'duplicate', type: 'project-knowledge', score: 0.8 };\n      const memory2 = { key: 'dup_1', value: 'duplicate', type: 'project-knowledge', score: 0.7 };\n      \n      mockMemoryService.search.mockReturnValue([memory1]);\n      mockMemoryService.findRelevant.mockReturnValue([]);\n      mockPatternService.analyzePrompt.mockReturnValue({ taskType: 'create_test' });\n      \n      // Mock the task-specific search to return the duplicate with lower score\n      mockMemoryService.search.mockImplementation((query: string) => {\n        if (query === prompt) return [memory1];\n        return [memory2]; // Additional searches return duplicate with lower score\n      });\n      \n      const result = await memoryEnhancer.enhanceSearch(prompt);\n      \n      // Should only have one instance, keeping the direct match\n      const dupMemories = result.filter(m => m.key === 'dup_1');\n      expect(dupMemories).toHaveLength(1);\n      expect(dupMemories[0].score).toBe(0.8); // Direct match score is preserved\n    });\n    \n    it('should handle empty results gracefully', async () => {\n      mockMemoryService.search.mockReturnValue([]);\n      mockMemoryService.findRelevant.mockReturnValue([]);\n      mockPatternService.analyzePrompt.mockReturnValue({ taskType: 'create_test' });\n      \n      const result = await memoryEnhancer.enhanceSearch('any prompt');\n      \n      expect(result).toEqual([]);\n      expect(() => memoryEnhancer.enhanceSearch('any prompt')).not.toThrow();\n    });\n  });\n  \n});"],"version":3}