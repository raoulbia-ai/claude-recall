{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/context-enhancer.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/context-enhancer.ts"],"sourcesContent":["/**\n * Context Enhancer Service\n * Phase 3A: Dynamic tool description enhancement with relevant memories\n *\n * This service:\n * 1. Fetches relevant memories for specific tools\n * 2. Enhances tool descriptions with memory context\n * 3. Filters memories by relevance threshold\n * 4. Formats memories for easy reading\n */\n\nimport { LoggingService } from './logging';\nimport { MemoryService } from './memory';\nimport { MemoryStorage, Memory } from '../memory/storage';\n\nexport interface ToolMemoryMapping {\n  toolPattern: RegExp;\n  memoryTypes: string[];\n  keywords: string[];\n}\n\nexport class ContextEnhancer {\n  private static instance: ContextEnhancer;\n  private logger: LoggingService;\n  private memoryService: MemoryService;\n  private memoryStorage: MemoryStorage;\n\n  // Map tool names/patterns to relevant memory types\n  private readonly TOOL_MEMORY_MAPPINGS: ToolMemoryMapping[] = [\n    {\n      toolPattern: /file|create|write|edit/i,\n      memoryTypes: ['preference'],\n      keywords: ['language', 'typescript', 'javascript', 'style', 'format', 'indentation']\n    },\n    {\n      toolPattern: /test|spec/i,\n      memoryTypes: ['preference'],\n      keywords: ['test', 'testing', 'jest', 'framework', 'location']\n    },\n    {\n      toolPattern: /git|commit|push/i,\n      memoryTypes: ['preference'],\n      keywords: ['git', 'commit', 'workflow', 'branch']\n    },\n    {\n      toolPattern: /database|db|sql/i,\n      memoryTypes: ['project-knowledge', 'preference'],\n      keywords: ['database', 'connection', 'orm', 'schema']\n    },\n    {\n      toolPattern: /api|http|fetch/i,\n      memoryTypes: ['project-knowledge', 'preference'],\n      keywords: ['api', 'endpoint', 'http', 'rest', 'graphql']\n    }\n  ];\n\n  private constructor() {\n    this.logger = LoggingService.getInstance();\n    this.memoryService = MemoryService.getInstance();\n    this.memoryStorage = (this.memoryService as any).storage;\n  }\n\n  static getInstance(): ContextEnhancer {\n    if (!ContextEnhancer.instance) {\n      ContextEnhancer.instance = new ContextEnhancer();\n    }\n    return ContextEnhancer.instance;\n  }\n\n  /**\n   * Get relevant memories for a specific tool\n   * Filters by relevance threshold and limits to top 3\n   */\n  async getRelevantMemories(toolName: string, sessionId?: string): Promise<Memory[]> {\n    try {\n      // Find matching tool mapping\n      const mapping = this.TOOL_MEMORY_MAPPINGS.find(m => m.toolPattern.test(toolName));\n\n      if (!mapping) {\n        // No specific mapping, return general preferences\n        return this.getGeneralPreferences();\n      }\n\n      // Search by keywords\n      const searchQuery = mapping.keywords.join(' ');\n      const results = this.memoryService.search(searchQuery);\n\n      // Filter by memory types and confidence\n      const relevantMemories = results\n        .filter(m => mapping.memoryTypes.includes(m.type || ''))\n        .filter(m => this.getConfidence(m) >= 0.7) // Relevance threshold\n        .slice(0, 3); // Limit to top 3\n\n      this.logger.debug('ContextEnhancer', 'Got relevant memories for tool', {\n        toolName,\n        mapping: mapping.toolPattern.source,\n        foundCount: relevantMemories.length\n      });\n\n      return relevantMemories;\n\n    } catch (error) {\n      this.logger.error('ContextEnhancer', 'Failed to get relevant memories', error);\n      return [];\n    }\n  }\n\n  /**\n   * Get general high-confidence preferences\n   */\n  private getGeneralPreferences(): Memory[] {\n    try {\n      const allPreferences = this.memoryStorage.searchByContext({ type: 'preference' });\n\n      return allPreferences\n        .filter(m => this.getConfidence(m) >= 0.8) // Higher threshold for general prefs\n        .sort((a, b) => this.getConfidence(b) - this.getConfidence(a))\n        .slice(0, 3);\n\n    } catch (error) {\n      this.logger.error('ContextEnhancer', 'Failed to get general preferences', error);\n      return [];\n    }\n  }\n\n  /**\n   * Extract confidence score from memory value\n   */\n  private getConfidence(memory: Memory): number {\n    if (typeof memory.value === 'object' && memory.value !== null) {\n      return (memory.value as any).confidence || 0.5;\n    }\n    return 0.5;\n  }\n\n  /**\n   * Enhance tool description with memory context\n   * Returns original description if no relevant memories\n   */\n  enhanceDescription(originalDescription: string, memories: Memory[]): string {\n    if (memories.length === 0) {\n      return originalDescription;\n    }\n\n    const memoryContext = this.formatMemoriesForToolDescription(memories);\n\n    return `${originalDescription}\\n\\n${memoryContext}`;\n  }\n\n  /**\n   * Format memories as a concise, readable context block\n   */\n  private formatMemoriesForToolDescription(memories: Memory[]): string {\n    const lines: string[] = ['üìù Remember:'];\n\n    for (const memory of memories) {\n      const formatted = this.formatSingleMemory(memory);\n      if (formatted) {\n        lines.push(`- ${formatted}`);\n      }\n    }\n\n    return lines.join('\\n');\n  }\n\n  /**\n   * Format a single memory into a concise string\n   */\n  private formatSingleMemory(memory: Memory): string | null {\n    try {\n      const value = memory.value;\n\n      // Handle different value formats\n      if (typeof value === 'string') {\n        return value;\n      }\n\n      if (typeof value === 'object' && value !== null) {\n        // Prefer specific fields\n        if ((value as any).preference) {\n          return (value as any).preference;\n        }\n        if ((value as any).value) {\n          const val = (value as any).value;\n          if (typeof val === 'string') {\n            return val;\n          }\n          if (typeof val === 'object' && (val as any).framework) {\n            return `Use ${(val as any).framework}`;\n          }\n        }\n        if ((value as any).message) {\n          return (value as any).message;\n        }\n        if ((value as any).content) {\n          return (value as any).content;\n        }\n\n        // Fallback: extract key info\n        return this.extractKeyInfo(memory.key, value);\n      }\n\n      return null;\n\n    } catch (error) {\n      this.logger.error('ContextEnhancer', 'Failed to format memory', error);\n      return null;\n    }\n  }\n\n  /**\n   * Extract key information from memory key and value\n   */\n  private extractKeyInfo(key: string, value: any): string {\n    // Extract from key\n    const cleanKey = key\n      .replace(/pref_/g, '')\n      .replace(/_\\d+$/g, '') // Remove timestamps\n      .replace(/_/g, ' ');\n\n    // Try to get value from object\n    if (value.framework) return `${cleanKey}: ${value.framework}`;\n    if (value.location) return `${cleanKey}: ${value.location}`;\n    if (value.style) return `${cleanKey}: ${value.style}`;\n\n    return cleanKey;\n  }\n\n  /**\n   * Get enhanced tool descriptions for all tools\n   * Used by MCP server to enrich tools/list response\n   */\n  async enhanceToolsList(\n    tools: Array<{ name: string; description: string; inputSchema: any }>,\n    sessionId?: string\n  ): Promise<Array<{ name: string; description: string; inputSchema: any }>> {\n    const enhanced = await Promise.all(\n      tools.map(async (tool) => {\n        const memories = await this.getRelevantMemories(tool.name, sessionId);\n        const enhancedDesc = this.enhanceDescription(tool.description, memories);\n\n        return {\n          ...tool,\n          description: enhancedDesc\n        };\n      })\n    );\n\n    this.logger.info('ContextEnhancer', 'Enhanced tools list', {\n      totalTools: tools.length,\n      enhancedTools: enhanced.filter(t => t.description !== tools.find(orig => orig.name === t.name)?.description).length\n    });\n\n    return enhanced;\n  }\n}\n"],"version":3}