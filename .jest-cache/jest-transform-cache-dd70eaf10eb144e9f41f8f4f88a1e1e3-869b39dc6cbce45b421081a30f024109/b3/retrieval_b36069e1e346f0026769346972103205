edc4d9ac4f8db787bff4cafb2fec0cd2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryRetrieval = void 0;
class MemoryRetrieval {
    constructor(storage) {
        this.storage = storage;
    }
    // Extract keywords from user query for better semantic search
    extractKeywords(query) {
        if (!query)
            return [];
        // Common database-related keywords
        const dbKeywords = ['database', 'db', 'postgres', 'postgresql', 'mysql', 'sqlite',
            'mongodb', 'redis', 'sql', 'nosql', 'storage'];
        // Convert query to lowercase for matching
        const lowerQuery = query.toLowerCase();
        // Extract matching database keywords
        const keywords = dbKeywords.filter(keyword => lowerQuery.includes(keyword));
        // Also extract significant words (3+ chars, not common words)
        const commonWords = ['the', 'what', 'which', 'how', 'when', 'where', 'are', 'is',
            'do', 'we', 'use', 'using', 'for', 'and', 'or', 'in', 'to'];
        const words = lowerQuery.split(/\s+/)
            .filter(word => word.length >= 3 && !commonWords.includes(word));
        // Combine keywords and significant words
        return [...new Set([...keywords, ...words])];
    }
    findRelevant(context, sortBy = 'relevance') {
        // Extract keywords from query if provided
        if (context.query && !context.keywords) {
            context.keywords = this.extractKeywords(context.query);
        }
        // Use enhanced search that looks for keywords in memory values
        const candidates = this.storage.searchByContext(context);
        if (sortBy === 'timestamp') {
            // Sort by timestamp DESC (newest first)
            const sorted = candidates
                .map(memory => ({
                ...memory,
                score: 1.0 // Placeholder score for timestamp sorting
            }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            // Return top results (no limit applied here, caller controls via slice)
            return sorted;
        }
        // Default: relevance sorting
        // Score and prioritize by memory type
        const scored = candidates
            .map(memory => ({
            ...memory,
            score: this.calculateRelevance(memory, context)
        }))
            .sort((a, b) => {
            // First priority: memory type (project-knowledge > preference > tool-use)
            const typeOrder = { 'project-knowledge': 3, 'preference': 2, 'tool-use': 1 };
            const aTypeScore = typeOrder[a.type] || 0;
            const bTypeScore = typeOrder[b.type] || 0;
            if (aTypeScore !== bTypeScore) {
                return bTypeScore - aTypeScore;
            }
            // Second priority: relevance score
            return b.score - a.score;
        });
        // Return top 5 most relevant memories
        return scored.slice(0, 5);
    }
    calculateRelevance(memory, context) {
        let score = memory.relevance_score || 1.0;
        // Boost for keyword matches in memory value
        if (context.keywords && context.keywords.length > 0) {
            const memoryStr = JSON.stringify(memory.value).toLowerCase();
            let keywordMatches = 0;
            for (const keyword of context.keywords) {
                if (memoryStr.includes(keyword.toLowerCase())) {
                    keywordMatches++;
                    score *= 2.0; // Double score for each keyword match
                }
            }
            // Extra boost if all keywords match
            if (keywordMatches === context.keywords.length) {
                score *= 1.5;
            }
        }
        // Decay over time (forgetting curve) - less aggressive for project-knowledge
        const timestamp = memory.timestamp || Date.now();
        const daysSince = (Date.now() - timestamp) / (1000 * 60 * 60 * 24);
        const decayFactor = memory.type === 'project-knowledge' ? 0.9 : 0.5;
        const halfLife = memory.type === 'project-knowledge' ? 30 : 7;
        score *= Math.pow(decayFactor, daysSince / halfLife);
        // Boost for same project/file
        if (memory.project_id && context.project_id && memory.project_id === context.project_id) {
            score *= 1.5;
        }
        if (memory.file_path && context.file_path && memory.file_path === context.file_path) {
            score *= 2.0;
        }
        // Boost for frequently accessed memories
        if (memory.access_count && memory.access_count > 0) {
            score *= 1 + Math.log10(memory.access_count) * 0.1;
        }
        // Boost for recent access
        if (memory.last_accessed) {
            const hoursSinceAccess = (Date.now() - memory.last_accessed) / (1000 * 60 * 60);
            if (hoursSinceAccess < 24) {
                score *= 1.2;
            }
        }
        return score;
    }
    searchByKeyword(keyword) {
        const results = this.storage.search(keyword);
        const context = { timestamp: Date.now() };
        return results
            .map(memory => ({
            ...memory,
            score: this.calculateRelevance(memory, context)
        }))
            .sort((a, b) => b.score - a.score);
    }
}
exports.MemoryRetrieval = MemoryRetrieval;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvY29yZS9yZXRyaWV2YWwudHMiLCJtYXBwaW5ncyI6Ijs7O0FBZ0JBLE1BQWEsZUFBZTtJQUMxQixZQUFvQixPQUFzQjtRQUF0QixZQUFPLEdBQVAsT0FBTyxDQUFlO0lBQUcsQ0FBQztJQUU5Qyw4REFBOEQ7SUFDdEQsZUFBZSxDQUFDLEtBQWE7UUFDbkMsSUFBSSxDQUFDLEtBQUs7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUV0QixtQ0FBbUM7UUFDbkMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFFBQVE7WUFDN0QsU0FBUyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRW5FLDBDQUEwQztRQUMxQyxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFdkMscUNBQXFDO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFNUUsOERBQThEO1FBQzlELE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUk7WUFDM0QsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVqRixNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQzthQUNsQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLFdB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RSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkMsQ0FBQztDQUNGO0FBMUlELDBDQTBJQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvbW50L2MvVXNlcnMvZWJpYXJhby9yZXBvcy9jbGF1ZGUtcmVjYWxsL3NyYy9jb3JlL3JldHJpZXZhbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZW1vcnlTdG9yYWdlLCBNZW1vcnkgfSBmcm9tICcuLi9tZW1vcnkvc3RvcmFnZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGV4dCB7XG4gIHByb2plY3RfaWQ/OiBzdHJpbmc7XG4gIGZpbGVfcGF0aD86IHN0cmluZztcbiAgdG9vbD86IHN0cmluZztcbiAgdHlwZT86IHN0cmluZztcbiAgdGltZXN0YW1wPzogbnVtYmVyO1xuICBxdWVyeT86IHN0cmluZzsgIC8vIFVzZXIncyBhY3R1YWwgcXVlcnkgY29udGVudFxuICBrZXl3b3Jkcz86IHN0cmluZ1tdOyAgLy8gRXh0cmFjdGVkIGtleXdvcmRzIGZyb20gcXVlcnlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTY29yZWRNZW1vcnkgZXh0ZW5kcyBNZW1vcnkge1xuICBzY29yZTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTWVtb3J5UmV0cmlldmFsIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzdG9yYWdlOiBNZW1vcnlTdG9yYWdlKSB7fVxuICBcbiAgLy8gRXh0cmFjdCBrZXl3b3JkcyBmcm9tIHVzZXIgcXVlcnkgZm9yIGJldHRlciBzZW1hbnRpYyBzZWFyY2hcbiAgcHJpdmF0ZSBleHRyYWN0S2V5d29yZHMocXVlcnk6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBpZiAoIXF1ZXJ5KSByZXR1cm4gW107XG4gICAgXG4gICAgLy8gQ29tbW9uIGRhdGFiYXNlLXJlbGF0ZWQga2V5d29yZHNcbiAgICBjb25zdCBkYktleXdvcmRzID0gWydkYXRhYmFzZScsICdkYicsICdwb3N0Z3JlcycsICdwb3N0Z3Jlc3FsJywgJ215c3FsJywgJ3NxbGl0ZScsIFxuICAgICAgICAgICAgICAgICAgICAgICAgJ21vbmdvZGInLCAncmVkaXMnLCAnc3FsJywgJ25vc3FsJywgJ3N0b3JhZ2UnXTtcbiAgICBcbiAgICAvLyBDb252ZXJ0IHF1ZXJ5IHRvIGxvd2VyY2FzZSBmb3IgbWF0Y2hpbmdcbiAgICBjb25zdCBsb3dlclF1ZXJ5ID0gcXVlcnkudG9Mb3dlckNhc2UoKTtcbiAgICBcbiAgICAvLyBFeHRyYWN0IG1hdGNoaW5nIGRhdGFiYXNlIGtleXdvcmRzXG4gICAgY29uc3Qga2V5d29yZHMgPSBkYktleXdvcmRzLmZpbHRlcihrZXl3b3JkID0+IGxvd2VyUXVlcnkuaW5jbHVkZXMoa2V5d29yZCkpO1xuICAgIFxuICAgIC8vIEFsc28gZXh0cmFjdCBzaWduaWZpY2FudCB3b3JkcyAoMysgY2hhcnMsIG5vdCBjb21tb24gd29yZHMpXG4gICAgY29uc3QgY29tbW9uV29yZHMgPSBbJ3RoZScsICd3aGF0JywgJ3doaWNoJywgJ2hvdycsICd3aGVuJywgJ3doZXJlJywgJ2FyZScsICdpcycsIFxuICAgICAgICAgICAgICAgICAgICAgICAgICdkbycsICd3ZScsICd1c2UnLCAndXNpbmcnLCAnZm9yJywgJ2FuZCcsICdvcicsICdpbicsICd0byddO1xuICAgIFxuICAgIGNvbnN0IHdvcmRzID0gbG93ZXJRdWVyeS5zcGxpdCgvXFxzKy8pXG4gICAgICAuZmlsdGVyKHdvcmQgPT4gd29yZC5sZW5ndGggPj0gMyAmJiAhY29tbW9uV29yZHMuaW5jbHVkZXMod29yZCkpO1xuICAgIFxuICAgIC8vIENvbWJpbmUga2V5d29yZHMgYW5kIHNpZ25pZmljYW50IHdvcmRzXG4gICAgcmV0dXJuIFsuLi5uZXcgU2V0KFsuLi5rZXl3b3JkcywgLi4ud29yZHNdKV07XG4gIH1cbiAgXG4gIGZpbmRSZWxldmFudChjb250ZXh0OiBDb250ZXh0LCBzb3J0Qnk6ICdyZWxldmFuY2UnIHwgJ3RpbWVzdGFtcCcgPSAncmVsZXZhbmNlJyk6IFNjb3JlZE1lbW9yeVtdIHtcbiAgICAvLyBFeHRyYWN0IGtleXdvcmRzIGZyb20gcXVlcnkgaWYgcHJvdmlkZWRcbiAgICBpZiAoY29udGV4dC5xdWVyeSAmJiAhY29udGV4dC5rZXl3b3Jkcykge1xuICAgICAgY29udGV4dC5rZXl3b3JkcyA9IHRoaXMuZXh0cmFjdEtleXdvcmRzKGNvbnRleHQucXVlcnkpO1xuICAgIH1cblxuICAgIC8vIFVzZSBlbmhhbmNlZCBzZWFyY2ggdGhhdCBsb29rcyBmb3Iga2V5d29yZHMgaW4gbWVtb3J5IHZhbHVlc1xuICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSB0aGlzLnN0b3JhZ2Uuc2VhcmNoQnlDb250ZXh0KGNvbnRleHQpO1xuXG4gICAgaWYgKHNvcnRCeSA9PT0gJ3RpbWVzdGFtcCcpIHtcbiAgICAgIC8vIFNvcnQgYnkgdGltZXN0YW1wIERFU0MgKG5ld2VzdCBmaXJzdClcbiAgICAgIGNvbnN0IHNvcnRlZCA9IGNhbmRpZGF0ZXNcbiAgICAgICAgLm1hcChtZW1vcnkgPT4gKHtcbiAgICAgICAgICAuLi5tZW1vcnksXG4gICAgICAgICAgc2NvcmU6IDEuMCAvLyBQbGFjZWhvbGRlciBzY29yZSBmb3IgdGltZXN0YW1wIHNvcnRpbmdcbiAgICAgICAgfSkpXG4gICAgICAgIC5zb3J0KChhLCBiKSA9PiAoYi50aW1lc3RhbXAgfHwgMCkgLSAoYS50aW1lc3RhbXAgfHwgMCkpO1xuXG4gICAgICAvLyBSZXR1cm4gdG9wIHJlc3VsdHMgKG5vIGxpbWl0IGFwcGxpZWQgaGVyZSwgY2FsbGVyIGNvbnRyb2xzIHZpYSBzbGljZSlcbiAgICAgIHJldHVybiBzb3J0ZWQ7XG4gICAgfVxuXG4gICAgLy8gRGVmYXVsdDogcmVsZXZhbmNlIHNvcnRpbmdcbiAgICAvLyBTY29yZSBhbmQgcHJpb3JpdGl6ZSBieSBtZW1vcnkgdHlwZVxuICAgIGNvbnN0IHNjb3JlZCA9IGNhbmRpZGF0ZXNcbiAgICAgIC5tYXAobWVtb3J5ID0+ICh7XG4gICAgICAgIC4uLm1lbW9yeSxcbiAgICAgICAgc2NvcmU6IHRoaXMuY2FsY3VsYXRlUmVsZXZhbmNlKG1lbW9yeSwgY29udGV4dClcbiAgICAgIH0pKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgLy8gRmlyc3QgcHJpb3JpdHk6IG1lbW9yeSB0eXBlIChwcm9qZWN0LWtub3dsZWRnZSA+IHByZWZlcmVuY2UgPiB0b29sLXVzZSlcbiAgICAgICAgY29uc3QgdHlwZU9yZGVyOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0geyAncHJvamVjdC1rbm93bGVkZ2UnOiAzLCAncHJlZmVyZW5jZSc6IDIsICd0b29sLXVzZSc6IDEgfTtcbiAgICAgICAgY29uc3QgYVR5cGVTY29yZSA9IHR5cGVPcmRlclthLnR5cGVdIHx8IDA7XG4gICAgICAgIGNvbnN0IGJUeXBlU2NvcmUgPSB0eXBlT3JkZXJbYi50eXBlXSB8fCAwO1xuXG4gICAgICAgIGlmIChhVHlwZVNjb3JlICE9PSBiVHlwZVNjb3JlKSB7XG4gICAgICAgICAgcmV0dXJuIGJUeXBlU2NvcmUgLSBhVHlwZVNjb3JlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2Vjb25kIHByaW9yaXR5OiByZWxldmFuY2Ugc2NvcmVcbiAgICAgICAgcmV0dXJuIGIuc2NvcmUgLSBhLnNjb3JlO1xuICAgICAgfSk7XG5cbiAgICAvLyBSZXR1cm4gdG9wIDUgbW9zdCByZWxldmFudCBtZW1vcmllc1xuICAgIHJldHVybiBzY29yZWQuc2xpY2UoMCwgNSk7XG4gIH1cbiAgXG4gIHByaXZhdGUgY2FsY3VsYXRlUmVsZXZhbmNlKG1lbW9yeTogTWVtb3J5LCBjb250ZXh0OiBDb250ZXh0KTogbnVtYmVyIHtcbiAgICBsZXQgc2NvcmUgPSBtZW1vcnkucmVsZXZhbmNlX3Njb3JlIHx8IDEuMDtcbiAgICBcbiAgICAvLyBCb29zdCBmb3Iga2V5d29yZCBtYXRjaGVzIGluIG1lbW9yeSB2YWx1ZVxuICAgIGlmIChjb250ZXh0LmtleXdvcmRzICYmIGNvbnRleHQua2V5d29yZHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgbWVtb3J5U3RyID0gSlNPTi5zdHJpbmdpZnkobWVtb3J5LnZhbHVlKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgbGV0IGtleXdvcmRNYXRjaGVzID0gMDtcbiAgICAgIFxuICAgICAgZm9yIChjb25zdCBrZXl3b3JkIG9mIGNvbnRleHQua2V5d29yZHMpIHtcbiAgICAgICAgaWYgKG1lbW9yeVN0ci5pbmNsdWRlcyhrZXl3b3JkLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICAgICAga2V5d29yZE1hdGNoZXMrKztcbiAgICAgICAgICBzY29yZSAqPSAyLjA7ICAvLyBEb3VibGUgc2NvcmUgZm9yIGVhY2gga2V5d29yZCBtYXRjaFxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEV4dHJhIGJvb3N0IGlmIGFsbCBrZXl3b3JkcyBtYXRjaFxuICAgICAgaWYgKGtleXdvcmRNYXRjaGVzID09PSBjb250ZXh0LmtleXdvcmRzLmxlbmd0aCkge1xuICAgICAgICBzY29yZSAqPSAxLjU7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8vIERlY2F5IG92ZXIgdGltZSAoZm9yZ2V0dGluZyBjdXJ2ZSkgLSBsZXNzIGFnZ3Jlc3NpdmUgZm9yIHByb2plY3Qta25vd2xlZGdlXG4gICAgY29uc3QgdGltZXN0YW1wID0gbWVtb3J5LnRpbWVzdGFtcCB8fCBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGRheXNTaW5jZSA9IChEYXRlLm5vdygpIC0gdGltZXN0YW1wKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgICBjb25zdCBkZWNheUZhY3RvciA9IG1lbW9yeS50eXBlID09PSAncHJvamVjdC1rbm93bGVkZ2UnID8gMC45IDogMC41O1xuICAgIGNvbnN0IGhhbGZMaWZlID0gbWVtb3J5LnR5cGUgPT09ICdwcm9qZWN0LWtub3dsZWRnZScgPyAzMCA6IDc7XG4gICAgc2NvcmUgKj0gTWF0aC5wb3coZGVjYXlGYWN0b3IsIGRheXNTaW5jZSAvIGhhbGZMaWZlKTtcbiAgICBcbiAgICAvLyBCb29zdCBmb3Igc2FtZSBwcm9qZWN0L2ZpbGVcbiAgICBpZiAobWVtb3J5LnByb2plY3RfaWQgJiYgY29udGV4dC5wcm9qZWN0X2lkICYmIG1lbW9yeS5wcm9qZWN0X2lkID09PSBjb250ZXh0LnByb2plY3RfaWQpIHtcbiAgICAgIHNjb3JlICo9IDEuNTtcbiAgICB9XG4gICAgaWYgKG1lbW9yeS5maWxlX3BhdGggJiYgY29udGV4dC5maWxlX3BhdGggJiYgbWVtb3J5LmZpbGVfcGF0aCA9PT0gY29udGV4dC5maWxlX3BhdGgpIHtcbiAgICAgIHNjb3JlICo9IDIuMDtcbiAgICB9XG4gICAgXG4gICAgLy8gQm9vc3QgZm9yIGZyZXF1ZW50bHkgYWNjZXNzZWQgbWVtb3JpZXNcbiAgICBpZiAobWVtb3J5LmFjY2Vzc19jb3VudCAmJiBtZW1vcnkuYWNjZXNzX2NvdW50ID4gMCkge1xuICAgICAgc2NvcmUgKj0gMSArIE1hdGgubG9nMTAobWVtb3J5LmFjY2Vzc19jb3VudCkgKiAwLjE7XG4gICAgfVxuICAgIFxuICAgIC8vIEJvb3N0IGZvciByZWNlbnQgYWNjZXNzXG4gICAgaWYgKG1lbW9yeS5sYXN0X2FjY2Vzc2VkKSB7XG4gICAgICBjb25zdCBob3Vyc1NpbmNlQWNjZXNzID0gKERhdGUubm93KCkgLSBtZW1vcnkubGFzdF9hY2Nlc3NlZCkgLyAoMTAwMCAqIDYwICogNjApO1xuICAgICAgaWYgKGhvdXJzU2luY2VBY2Nlc3MgPCAyNCkge1xuICAgICAgICBzY29yZSAqPSAxLjI7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBzY29yZTtcbiAgfVxuICBcbiAgc2VhcmNoQnlLZXl3b3JkKGtleXdvcmQ6IHN0cmluZyk6IFNjb3JlZE1lbW9yeVtdIHtcbiAgICBjb25zdCByZXN1bHRzID0gdGhpcy5zdG9yYWdlLnNlYXJjaChrZXl3b3JkKTtcbiAgICBjb25zdCBjb250ZXh0OiBDb250ZXh0ID0geyB0aW1lc3RhbXA6IERhdGUubm93KCkgfTtcbiAgICBcbiAgICByZXR1cm4gcmVzdWx0c1xuICAgICAgLm1hcChtZW1vcnkgPT4gKHtcbiAgICAgICAgLi4ubWVtb3J5LFxuICAgICAgICBzY29yZTogdGhpcy5jYWxjdWxhdGVSZWxldmFuY2UobWVtb3J5LCBjb250ZXh0KVxuICAgICAgfSkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpO1xuICB9XG59Il0sInZlcnNpb24iOjN9