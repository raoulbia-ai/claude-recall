{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/memory-usage-tracker.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/memory-usage-tracker.ts"],"sourcesContent":["/**\n * Memory Usage Tracker Service\n * Phase 3C: Track which memories are actually used and adjust relevance scores\n *\n * This service:\n * 1. Records when memories are injected into tool calls\n * 2. Tracks if memories are actually useful (usage patterns)\n * 3. Boosts relevance scores for useful memories\n * 4. Reduces scores for ignored memories\n * 5. Provides statistics on memory effectiveness\n */\n\nimport { LoggingService } from './logging';\nimport { MemoryService } from './memory';\n\nexport interface MemoryInjectionRecord {\n  memoryId: string;\n  toolName: string;\n  sessionId: string;\n  timestamp: number;\n  wasUseful?: boolean;\n}\n\nexport interface MemoryEffectivenessStats {\n  memoryId: string;\n  injectionCount: number;\n  useCount: number;\n  effectiveness: number; // useCount / injectionCount\n  lastInjected: number;\n  lastUsed: number;\n}\n\nexport class MemoryUsageTracker {\n  private static instance: MemoryUsageTracker;\n  private logger: LoggingService;\n  private memoryService: MemoryService;\n\n  // Track injections: memoryId -> injection records\n  private injections: Map<string, MemoryInjectionRecord[]> = new Map();\n\n  // Track usage: memoryId -> use count\n  private usageCount: Map<string, number> = new Map();\n\n  // Relevance adjustment thresholds\n  private readonly BOOST_AMOUNT = 0.1;\n  private readonly REDUCE_AMOUNT = 0.05;\n  private readonly MIN_INJECTIONS_FOR_SCORING = 3; // Need at least 3 injections to judge effectiveness\n\n  private constructor() {\n    this.logger = LoggingService.getInstance();\n    this.memoryService = MemoryService.getInstance();\n  }\n\n  static getInstance(): MemoryUsageTracker {\n    if (!MemoryUsageTracker.instance) {\n      MemoryUsageTracker.instance = new MemoryUsageTracker();\n    }\n    return MemoryUsageTracker.instance;\n  }\n\n  /**\n   * Record that a memory was injected into a tool call\n   */\n  recordInjection(\n    memoryId: string,\n    toolName: string,\n    sessionId: string\n  ): void {\n    try {\n      const record: MemoryInjectionRecord = {\n        memoryId,\n        toolName,\n        sessionId,\n        timestamp: Date.now()\n      };\n\n      const records = this.injections.get(memoryId) || [];\n      records.push(record);\n      this.injections.set(memoryId, records);\n\n      this.logger.debug('MemoryUsageTracker', 'Recorded memory injection', {\n        memoryId,\n        toolName,\n        totalInjections: records.length\n      });\n\n    } catch (error) {\n      this.logger.error('MemoryUsageTracker', 'Failed to record injection', error);\n    }\n  }\n\n  /**\n   * Record that an injected memory was actually used\n   * Call this when you detect the memory was referenced in the response\n   */\n  recordUsage(memoryId: string, wasUseful: boolean = true): void {\n    try {\n      if (wasUseful) {\n        const currentCount = this.usageCount.get(memoryId) || 0;\n        this.usageCount.set(memoryId, currentCount + 1);\n\n        // Update the last injection record\n        const records = this.injections.get(memoryId);\n        if (records && records.length > 0) {\n          records[records.length - 1].wasUseful = true;\n        }\n\n        this.logger.debug('MemoryUsageTracker', 'Recorded memory usage', {\n          memoryId,\n          totalUses: currentCount + 1\n        });\n\n        // Check if we should boost relevance\n        this.checkAndAdjustRelevance(memoryId);\n      }\n\n    } catch (error) {\n      this.logger.error('MemoryUsageTracker', 'Failed to record usage', error);\n    }\n  }\n\n  /**\n   * Check effectiveness and adjust relevance score if needed\n   */\n  private async checkAndAdjustRelevance(memoryId: string): Promise<void> {\n    const stats = this.getEffectivenessStats(memoryId);\n\n    if (!stats || stats.injectionCount < this.MIN_INJECTIONS_FOR_SCORING) {\n      return; // Need more data\n    }\n\n    // Highly effective memory (used >70% of the time)\n    if (stats.effectiveness > 0.7) {\n      await this.boostRelevance(memoryId);\n    }\n    // Rarely used memory (used <30% of the time)\n    else if (stats.effectiveness < 0.3) {\n      await this.reduceRelevance(memoryId);\n    }\n  }\n\n  /**\n   * Boost relevance score for a useful memory\n   */\n  private async boostRelevance(memoryId: string): Promise<void> {\n    try {\n      // Note: MemoryService doesn't currently have a boostRelevance method\n      // This would need to be added to the MemoryService\n      // For now, log the action\n\n      this.logger.info('MemoryUsageTracker', 'Memory marked for relevance boost', {\n        memoryId,\n        boostAmount: this.BOOST_AMOUNT\n      });\n\n      // TODO: Implement when MemoryService.updateRelevanceScore() is available\n      // await this.memoryService.updateRelevanceScore(memoryId, this.BOOST_AMOUNT);\n\n    } catch (error) {\n      this.logger.error('MemoryUsageTracker', 'Failed to boost relevance', error);\n    }\n  }\n\n  /**\n   * Reduce relevance score for an ignored memory\n   */\n  private async reduceRelevance(memoryId: string): Promise<void> {\n    try {\n      this.logger.info('MemoryUsageTracker', 'Memory marked for relevance reduction', {\n        memoryId,\n        reduceAmount: this.REDUCE_AMOUNT\n      });\n\n      // TODO: Implement when MemoryService.updateRelevanceScore() is available\n      // await this.memoryService.updateRelevanceScore(memoryId, -this.REDUCE_AMOUNT);\n\n    } catch (error) {\n      this.logger.error('MemoryUsageTracker', 'Failed to reduce relevance', error);\n    }\n  }\n\n  /**\n   * Get effectiveness statistics for a memory\n   */\n  getEffectivenessStats(memoryId: string): MemoryEffectivenessStats | null {\n    const records = this.injections.get(memoryId);\n    if (!records || records.length === 0) {\n      return null;\n    }\n\n    const injectionCount = records.length;\n    const useCount = this.usageCount.get(memoryId) || 0;\n    const effectiveness = useCount / injectionCount;\n\n    const timestamps = records.map(r => r.timestamp);\n    const lastInjected = Math.max(...timestamps);\n\n    const usedRecords = records.filter(r => r.wasUseful);\n    const lastUsed = usedRecords.length > 0\n      ? Math.max(...usedRecords.map(r => r.timestamp))\n      : 0;\n\n    return {\n      memoryId,\n      injectionCount,\n      useCount,\n      effectiveness,\n      lastInjected,\n      lastUsed\n    };\n  }\n\n  /**\n   * Get all effectiveness statistics\n   * Useful for debugging and monitoring\n   */\n  getAllStats(): MemoryEffectivenessStats[] {\n    const stats: MemoryEffectivenessStats[] = [];\n\n    for (const memoryId of this.injections.keys()) {\n      const memoryStat = this.getEffectivenessStats(memoryId);\n      if (memoryStat) {\n        stats.push(memoryStat);\n      }\n    }\n\n    // Sort by effectiveness (most effective first)\n    return stats.sort((a, b) => b.effectiveness - a.effectiveness);\n  }\n\n  /**\n   * Get statistics summary\n   */\n  getSummary(): {\n    totalMemoriesTracked: number;\n    totalInjections: number;\n    totalUses: number;\n    averageEffectiveness: number;\n    highlyEffectiveMemories: number;\n    ineffectiveMemories: number;\n  } {\n    const allStats = this.getAllStats();\n\n    const totalInjections = Array.from(this.injections.values())\n      .reduce((sum, records) => sum + records.length, 0);\n\n    const totalUses = Array.from(this.usageCount.values())\n      .reduce((sum, count) => sum + count, 0);\n\n    const averageEffectiveness = allStats.length > 0\n      ? allStats.reduce((sum, s) => sum + s.effectiveness, 0) / allStats.length\n      : 0;\n\n    const highlyEffective = allStats.filter(s => s.effectiveness > 0.7).length;\n    const ineffective = allStats.filter(s => s.effectiveness < 0.3 && s.injectionCount >= this.MIN_INJECTIONS_FOR_SCORING).length;\n\n    return {\n      totalMemoriesTracked: this.injections.size,\n      totalInjections,\n      totalUses,\n      averageEffectiveness,\n      highlyEffectiveMemories: highlyEffective,\n      ineffectiveMemories: ineffective\n    };\n  }\n\n  /**\n   * Clean up old tracking data\n   * Remove records older than 7 days\n   */\n  cleanup(): void {\n    const cutoffTime = Date.now() - (7 * 24 * 60 * 60 * 1000); // 7 days\n    let removedCount = 0;\n\n    for (const [memoryId, records] of this.injections.entries()) {\n      const filteredRecords = records.filter(r => r.timestamp > cutoffTime);\n\n      if (filteredRecords.length === 0) {\n        this.injections.delete(memoryId);\n        this.usageCount.delete(memoryId);\n        removedCount++;\n      } else {\n        this.injections.set(memoryId, filteredRecords);\n      }\n    }\n\n    if (removedCount > 0) {\n      this.logger.info('MemoryUsageTracker', 'Cleaned up old tracking data', {\n        removedMemories: removedCount\n      });\n    }\n  }\n}\n"],"version":3}