ae4d308f9e21e6497af59f16921d8d3d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock LoggingService
jest.mock('../../src/services/logging');
const rate_limiter_1 = require("../../src/mcp/rate-limiter");
describe('RateLimiter', () => {
    let rateLimiter;
    let mockLogger;
    beforeEach(() => {
        mockLogger = {
            info: jest.fn(),
            debug: jest.fn(),
            error: jest.fn(),
            warn: jest.fn(),
            logServiceError: jest.fn()
        };
    });
    afterEach(() => {
        if (rateLimiter) {
            rateLimiter.shutdown();
        }
    });
    describe('checkLimit', () => {
        it('should allow requests within limit', async () => {
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 60000,
                maxRequests: 5
            });
            const sessionId = 'test-session';
            // Should allow first 5 requests
            for (let i = 0; i < 5; i++) {
                const allowed = await rateLimiter.checkLimit(sessionId);
                expect(allowed).toBe(true);
                rateLimiter.recordRequest(sessionId);
            }
            // 6th request should be denied
            const allowed = await rateLimiter.checkLimit(sessionId);
            expect(allowed).toBe(false);
            expect(mockLogger.warn).toHaveBeenCalledWith('RateLimiter', 'Rate limit exceeded', expect.objectContaining({
                sessionId,
                requests: 5,
                maxRequests: 5
            }));
        });
        it('should reset limit after time window', async () => {
            jest.useFakeTimers();
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 1000, // 1 second window
                maxRequests: 2
            });
            const sessionId = 'test-session';
            // Use up the limit
            await rateLimiter.checkLimit(sessionId);
            rateLimiter.recordRequest(sessionId);
            await rateLimiter.checkLimit(sessionId);
            rateLimiter.recordRequest(sessionId);
            // Should be blocked
            let allowed = await rateLimiter.checkLimit(sessionId);
            expect(allowed).toBe(false);
            // Advance time past window
            jest.advanceTimersByTime(1100);
            // Should be allowed again
            allowed = await rateLimiter.checkLimit(sessionId);
            expect(allowed).toBe(true);
            jest.useRealTimers();
        });
    });
    describe('recordRequest', () => {
        it('should track successful and failed requests', () => {
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 60000,
                maxRequests: 10
            });
            const sessionId = 'test-session';
            rateLimiter.recordRequest(sessionId, true);
            rateLimiter.recordRequest(sessionId, false);
            expect(mockLogger.debug).toHaveBeenCalledWith('RateLimiter', 'Request recorded', expect.objectContaining({
                sessionId,
                successful: true
            }));
        });
        it('should skip successful requests when configured', async () => {
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 60000,
                maxRequests: 2,
                skipSuccessfulRequests: true
            });
            const sessionId = 'test-session';
            // Record successful requests (should not count)
            rateLimiter.recordRequest(sessionId, true);
            rateLimiter.recordRequest(sessionId, true);
            rateLimiter.recordRequest(sessionId, true);
            // Should still allow requests
            const allowed = await rateLimiter.checkLimit(sessionId);
            expect(allowed).toBe(true);
            // Record failed requests (should count)
            rateLimiter.recordRequest(sessionId, false);
            rateLimiter.recordRequest(sessionId, false);
            // Now should be blocked
            const blocked = await rateLimiter.checkLimit(sessionId);
            expect(blocked).toBe(false);
        });
    });
    describe('getRemainingRequests', () => {
        it('should return correct remaining request count', () => {
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 60000,
                maxRequests: 5
            });
            const sessionId = 'test-session';
            expect(rateLimiter.getRemainingRequests(sessionId)).toBe(5);
            rateLimiter.recordRequest(sessionId);
            expect(rateLimiter.getRemainingRequests(sessionId)).toBe(4);
            rateLimiter.recordRequest(sessionId);
            rateLimiter.recordRequest(sessionId);
            expect(rateLimiter.getRemainingRequests(sessionId)).toBe(2);
        });
    });
    describe('resetLimit', () => {
        it('should clear rate limit for session', () => {
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 60000,
                maxRequests: 2
            });
            const sessionId = 'test-session';
            // Use up limit
            rateLimiter.recordRequest(sessionId);
            rateLimiter.recordRequest(sessionId);
            expect(rateLimiter.getRemainingRequests(sessionId)).toBe(0);
            // Reset limit
            rateLimiter.resetLimit(sessionId);
            expect(rateLimiter.getRemainingRequests(sessionId)).toBe(2);
            expect(mockLogger.info).toHaveBeenCalledWith('RateLimiter', 'Rate limit reset', { sessionId });
        });
    });
    describe('getStats', () => {
        it('should return rate limiter statistics', () => {
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 60000,
                maxRequests: 10
            });
            // Create some activity
            rateLimiter.recordRequest('session1');
            rateLimiter.recordRequest('session1');
            rateLimiter.recordRequest('session1');
            rateLimiter.recordRequest('session2');
            rateLimiter.recordRequest('session2');
            rateLimiter.recordRequest('session3');
            const stats = rateLimiter.getStats();
            expect(stats.activeSessions).toBe(3);
            expect(stats.totalRequests).toBe(6);
            expect(stats.topSessions).toHaveLength(3);
            expect(stats.topSessions[0]).toEqual({ sessionId: 'session1', requests: 3 });
            expect(stats.topSessions[1]).toEqual({ sessionId: 'session2', requests: 2 });
            expect(stats.topSessions[2]).toEqual({ sessionId: 'session3', requests: 1 });
        });
    });
    describe('cleanup', () => {
        it('should automatically clean up expired entries', () => {
            jest.useFakeTimers();
            rateLimiter = new rate_limiter_1.RateLimiter(mockLogger, {
                windowMs: 1000, // 1 second
                maxRequests: 10
            });
            // Create some requests
            rateLimiter.recordRequest('session1');
            rateLimiter.recordRequest('session2');
            expect(rateLimiter.getStats().activeSessions).toBe(2);
            // Advance time past window
            jest.advanceTimersByTime(2000);
            // Trigger cleanup
            jest.runOnlyPendingTimers();
            // Old entries should be cleaned up
            expect(rateLimiter.getStats().activeSessions).toBe(0);
            jest.useRealTimers();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy9tY3AvcmF0ZS1saW1pdGVyLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFHQSxzQkFBc0I7QUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBSnhDLDZEQUF5RDtBQU16RCxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtJQUMzQixJQUFJLFdBQXdCLENBQUM7SUFDN0IsSUFBSSxVQUF1QyxDQUFDO0lBRTVDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxVQUFVLEdBQUc7WUFDWCxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2hCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2hCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2YsZUFBZSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDcEIsQ0FBQztJQUNYLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pCLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO1FBQzFCLEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRCxXQUFXLEdBQUcsSUFBSSwwQkFBVyxDQUFDLFVBQVUsRUFBRTtnQkFDeEMsUUFBUSxFQUFFLEtBQUs7Z0JBQ2YsV0FBVyxFQUFFLENBQUM7YUFDZixDQUFDLENBQUM7WUFFSCxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUM7WUFFakMsZ0NBQWdDO1lBQ2hDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FB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bkMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdEQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvbW50L2MvVXNlcnMvZWJpYXJhby9yZXBvcy9jbGF1ZGUtcmVjYWxsL3Rlc3RzL21jcC9yYXRlLWxpbWl0ZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSYXRlTGltaXRlciB9IGZyb20gJy4uLy4uL3NyYy9tY3AvcmF0ZS1saW1pdGVyJztcbmltcG9ydCB7IExvZ2dpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc3JjL3NlcnZpY2VzL2xvZ2dpbmcnO1xuXG4vLyBNb2NrIExvZ2dpbmdTZXJ2aWNlXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9zZXJ2aWNlcy9sb2dnaW5nJyk7XG5cbmRlc2NyaWJlKCdSYXRlTGltaXRlcicsICgpID0+IHtcbiAgbGV0IHJhdGVMaW1pdGVyOiBSYXRlTGltaXRlcjtcbiAgbGV0IG1vY2tMb2dnZXI6IGplc3QuTW9ja2VkPExvZ2dpbmdTZXJ2aWNlPjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtb2NrTG9nZ2VyID0ge1xuICAgICAgaW5mbzogamVzdC5mbigpLFxuICAgICAgZGVidWc6IGplc3QuZm4oKSxcbiAgICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgICB3YXJuOiBqZXN0LmZuKCksXG4gICAgICBsb2dTZXJ2aWNlRXJyb3I6IGplc3QuZm4oKVxuICAgIH0gYXMgYW55O1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGlmIChyYXRlTGltaXRlcikge1xuICAgICAgcmF0ZUxpbWl0ZXIuc2h1dGRvd24oKTtcbiAgICB9XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjaGVja0xpbWl0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYWxsb3cgcmVxdWVzdHMgd2l0aGluIGxpbWl0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIobW9ja0xvZ2dlciwge1xuICAgICAgICB3aW5kb3dNczogNjAwMDAsXG4gICAgICAgIG1heFJlcXVlc3RzOiA1XG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbic7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBhbGxvdyBmaXJzdCA1IHJlcXVlc3RzXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykge1xuICAgICAgICBjb25zdCBhbGxvd2VkID0gYXdhaXQgcmF0ZUxpbWl0ZXIuY2hlY2tMaW1pdChzZXNzaW9uSWQpO1xuICAgICAgICBleHBlY3QoYWxsb3dlZCkudG9CZSh0cnVlKTtcbiAgICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQpO1xuICAgICAgfVxuXG4gICAgICAvLyA2dGggcmVxdWVzdCBzaG91bGQgYmUgZGVuaWVkXG4gICAgICBjb25zdCBhbGxvd2VkID0gYXdhaXQgcmF0ZUxpbWl0ZXIuY2hlY2tMaW1pdChzZXNzaW9uSWQpO1xuICAgICAgZXhwZWN0KGFsbG93ZWQpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KG1vY2tMb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdSYXRlTGltaXRlcicsXG4gICAgICAgICdSYXRlIGxpbWl0IGV4Y2VlZGVkJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHNlc3Npb25JZCxcbiAgICAgICAgICByZXF1ZXN0czogNSxcbiAgICAgICAgICBtYXhSZXF1ZXN0czogNVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVzZXQgbGltaXQgYWZ0ZXIgdGltZSB3aW5kb3cnLCBhc3luYyAoKSA9PiB7XG4gICAgICBqZXN0LnVzZUZha2VUaW1lcnMoKTtcbiAgICAgIFxuICAgICAgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIobW9ja0xvZ2dlciwge1xuICAgICAgICB3aW5kb3dNczogMTAwMCwgLy8gMSBzZWNvbmQgd2luZG93XG4gICAgICAgIG1heFJlcXVlc3RzOiAyXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbic7XG4gICAgICBcbiAgICAgIC8vIFVzZSB1cCB0aGUgbGltaXRcbiAgICAgIGF3YWl0IHJhdGVMaW1pdGVyLmNoZWNrTGltaXQoc2Vzc2lvbklkKTtcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3Qoc2Vzc2lvbklkKTtcbiAgICAgIGF3YWl0IHJhdGVMaW1pdGVyLmNoZWNrTGltaXQoc2Vzc2lvbklkKTtcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3Qoc2Vzc2lvbklkKTtcblxuICAgICAgLy8gU2hvdWxkIGJlIGJsb2NrZWRcbiAgICAgIGxldCBhbGxvd2VkID0gYXdhaXQgcmF0ZUxpbWl0ZXIuY2hlY2tMaW1pdChzZXNzaW9uSWQpO1xuICAgICAgZXhwZWN0KGFsbG93ZWQpLnRvQmUoZmFsc2UpO1xuXG4gICAgICAvLyBBZHZhbmNlIHRpbWUgcGFzdCB3aW5kb3dcbiAgICAgIGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZSgxMTAwKTtcblxuICAgICAgLy8gU2hvdWxkIGJlIGFsbG93ZWQgYWdhaW5cbiAgICAgIGFsbG93ZWQgPSBhd2FpdCByYXRlTGltaXRlci5jaGVja0xpbWl0KHNlc3Npb25JZCk7XG4gICAgICBleHBlY3QoYWxsb3dlZCkudG9CZSh0cnVlKTtcblxuICAgICAgamVzdC51c2VSZWFsVGltZXJzKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZWNvcmRSZXF1ZXN0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdHJhY2sgc3VjY2Vzc2Z1bCBhbmQgZmFpbGVkIHJlcXVlc3RzJywgKCkgPT4ge1xuICAgICAgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIobW9ja0xvZ2dlciwge1xuICAgICAgICB3aW5kb3dNczogNjAwMDAsXG4gICAgICAgIG1heFJlcXVlc3RzOiAxMFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24nO1xuXG4gICAgICByYXRlTGltaXRlci5yZWNvcmRSZXF1ZXN0KHNlc3Npb25JZCwgdHJ1ZSk7XG4gICAgICByYXRlTGltaXRlci5yZWNvcmRSZXF1ZXN0KHNlc3Npb25JZCwgZmFsc2UpO1xuXG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5kZWJ1ZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdSYXRlTGltaXRlcicsXG4gICAgICAgICdSZXF1ZXN0IHJlY29yZGVkJyxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHNlc3Npb25JZCxcbiAgICAgICAgICBzdWNjZXNzZnVsOiB0cnVlXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBza2lwIHN1Y2Nlc3NmdWwgcmVxdWVzdHMgd2hlbiBjb25maWd1cmVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIobW9ja0xvZ2dlciwge1xuICAgICAgICB3aW5kb3dNczogNjAwMDAsXG4gICAgICAgIG1heFJlcXVlc3RzOiAyLFxuICAgICAgICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzOiB0cnVlXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbic7XG5cbiAgICAgIC8vIFJlY29yZCBzdWNjZXNzZnVsIHJlcXVlc3RzIChzaG91bGQgbm90IGNvdW50KVxuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQsIHRydWUpO1xuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQsIHRydWUpO1xuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQsIHRydWUpO1xuXG4gICAgICAvLyBTaG91bGQgc3RpbGwgYWxsb3cgcmVxdWVzdHNcbiAgICAgIGNvbnN0IGFsbG93ZWQgPSBhd2FpdCByYXRlTGltaXRlci5jaGVja0xpbWl0KHNlc3Npb25JZCk7XG4gICAgICBleHBlY3QoYWxsb3dlZCkudG9CZSh0cnVlKTtcblxuICAgICAgLy8gUmVjb3JkIGZhaWxlZCByZXF1ZXN0cyAoc2hvdWxkIGNvdW50KVxuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQsIGZhbHNlKTtcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3Qoc2Vzc2lvbklkLCBmYWxzZSk7XG5cbiAgICAgIC8vIE5vdyBzaG91bGQgYmUgYmxvY2tlZFxuICAgICAgY29uc3QgYmxvY2tlZCA9IGF3YWl0IHJhdGVMaW1pdGVyLmNoZWNrTGltaXQoc2Vzc2lvbklkKTtcbiAgICAgIGV4cGVjdChibG9ja2VkKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldFJlbWFpbmluZ1JlcXVlc3RzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvcnJlY3QgcmVtYWluaW5nIHJlcXVlc3QgY291bnQnLCAoKSA9PiB7XG4gICAgICByYXRlTGltaXRlciA9IG5ldyBSYXRlTGltaXRlcihtb2NrTG9nZ2VyLCB7XG4gICAgICAgIHdpbmRvd01zOiA2MDAwMCxcbiAgICAgICAgbWF4UmVxdWVzdHM6IDVcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uJztcblxuICAgICAgZXhwZWN0KHJhdGVMaW1pdGVyLmdldFJlbWFpbmluZ1JlcXVlc3RzKHNlc3Npb25JZCkpLnRvQmUoNSk7XG5cbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3Qoc2Vzc2lvbklkKTtcbiAgICAgIGV4cGVjdChyYXRlTGltaXRlci5nZXRSZW1haW5pbmdSZXF1ZXN0cyhzZXNzaW9uSWQpKS50b0JlKDQpO1xuXG4gICAgICByYXRlTGltaXRlci5yZWNvcmRSZXF1ZXN0KHNlc3Npb25JZCk7XG4gICAgICByYXRlTGltaXRlci5yZWNvcmRSZXF1ZXN0KHNlc3Npb25JZCk7XG4gICAgICBleHBlY3QocmF0ZUxpbWl0ZXIuZ2V0UmVtYWluaW5nUmVxdWVzdHMoc2Vzc2lvbklkKSkudG9CZSgyKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3Jlc2V0TGltaXQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjbGVhciByYXRlIGxpbWl0IGZvciBzZXNzaW9uJywgKCkgPT4ge1xuICAgICAgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIobW9ja0xvZ2dlciwge1xuICAgICAgICB3aW5kb3dNczogNjAwMDAsXG4gICAgICAgIG1heFJlcXVlc3RzOiAyXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbic7XG5cbiAgICAgIC8vIFVzZSB1cCBsaW1pdFxuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQpO1xuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdChzZXNzaW9uSWQpO1xuXG4gICAgICBleHBlY3QocmF0ZUxpbWl0ZXIuZ2V0UmVtYWluaW5nUmVxdWVzdHMoc2Vzc2lvbklkKSkudG9CZSgwKTtcblxuICAgICAgLy8gUmVzZXQgbGltaXRcbiAgICAgIHJhdGVMaW1pdGVyLnJlc2V0TGltaXQoc2Vzc2lvbklkKTtcblxuICAgICAgZXhwZWN0KHJhdGVMaW1pdGVyLmdldFJlbWFpbmluZ1JlcXVlc3RzKHNlc3Npb25JZCkpLnRvQmUoMik7XG4gICAgICBleHBlY3QobW9ja0xvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ1JhdGVMaW1pdGVyJyxcbiAgICAgICAgJ1JhdGUgbGltaXQgcmVzZXQnLFxuICAgICAgICB7IHNlc3Npb25JZCB9XG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0U3RhdHMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gcmF0ZSBsaW1pdGVyIHN0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgICByYXRlTGltaXRlciA9IG5ldyBSYXRlTGltaXRlcihtb2NrTG9nZ2VyLCB7XG4gICAgICAgIHdpbmRvd01zOiA2MDAwMCxcbiAgICAgICAgbWF4UmVxdWVzdHM6IDEwXG4gICAgICB9KTtcblxuICAgICAgLy8gQ3JlYXRlIHNvbWUgYWN0aXZpdHlcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3QoJ3Nlc3Npb24xJyk7XG4gICAgICByYXRlTGltaXRlci5yZWNvcmRSZXF1ZXN0KCdzZXNzaW9uMScpO1xuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdCgnc2Vzc2lvbjEnKTtcbiAgICAgIFxuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdCgnc2Vzc2lvbjInKTtcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3QoJ3Nlc3Npb24yJyk7XG4gICAgICBcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3QoJ3Nlc3Npb24zJyk7XG5cbiAgICAgIGNvbnN0IHN0YXRzID0gcmF0ZUxpbWl0ZXIuZ2V0U3RhdHMoKTtcblxuICAgICAgZXhwZWN0KHN0YXRzLmFjdGl2ZVNlc3Npb25zKS50b0JlKDMpO1xuICAgICAgZXhwZWN0KHN0YXRzLnRvdGFsUmVxdWVzdHMpLnRvQmUoNik7XG4gICAgICBleHBlY3Qoc3RhdHMudG9wU2Vzc2lvbnMpLnRvSGF2ZUxlbmd0aCgzKTtcbiAgICAgIGV4cGVjdChzdGF0cy50b3BTZXNzaW9uc1swXSkudG9FcXVhbCh7IHNlc3Npb25JZDogJ3Nlc3Npb24xJywgcmVxdWVzdHM6IDMgfSk7XG4gICAgICBleHBlY3Qoc3RhdHMudG9wU2Vzc2lvbnNbMV0pLnRvRXF1YWwoeyBzZXNzaW9uSWQ6ICdzZXNzaW9uMicsIHJlcXVlc3RzOiAyIH0pO1xuICAgICAgZXhwZWN0KHN0YXRzLnRvcFNlc3Npb25zWzJdKS50b0VxdWFsKHsgc2Vzc2lvbklkOiAnc2Vzc2lvbjMnLCByZXF1ZXN0czogMSB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NsZWFudXAnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhdXRvbWF0aWNhbGx5IGNsZWFuIHVwIGV4cGlyZWQgZW50cmllcycsICgpID0+IHtcbiAgICAgIGplc3QudXNlRmFrZVRpbWVycygpO1xuICAgICAgXG4gICAgICByYXRlTGltaXRlciA9IG5ldyBSYXRlTGltaXRlcihtb2NrTG9nZ2VyLCB7XG4gICAgICAgIHdpbmRvd01zOiAxMDAwLCAvLyAxIHNlY29uZFxuICAgICAgICBtYXhSZXF1ZXN0czogMTBcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDcmVhdGUgc29tZSByZXF1ZXN0c1xuICAgICAgcmF0ZUxpbWl0ZXIucmVjb3JkUmVxdWVzdCgnc2Vzc2lvbjEnKTtcbiAgICAgIHJhdGVMaW1pdGVyLnJlY29yZFJlcXVlc3QoJ3Nlc3Npb24yJyk7XG5cbiAgICAgIGV4cGVjdChyYXRlTGltaXRlci5nZXRTdGF0cygpLmFjdGl2ZVNlc3Npb25zKS50b0JlKDIpO1xuXG4gICAgICAvLyBBZHZhbmNlIHRpbWUgcGFzdCB3aW5kb3dcbiAgICAgIGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZSgyMDAwKTtcblxuICAgICAgLy8gVHJpZ2dlciBjbGVhbnVwXG4gICAgICBqZXN0LnJ1bk9ubHlQZW5kaW5nVGltZXJzKCk7XG5cbiAgICAgIC8vIE9sZCBlbnRyaWVzIHNob3VsZCBiZSBjbGVhbmVkIHVwXG4gICAgICBleHBlY3QocmF0ZUxpbWl0ZXIuZ2V0U3RhdHMoKS5hY3RpdmVTZXNzaW9ucykudG9CZSgwKTtcblxuICAgICAgamVzdC51c2VSZWFsVGltZXJzKCk7XG4gICAgfSk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9