{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/project-registry.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/project-registry.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport { LoggingService } from './logging';\nimport { ConfigService } from './config';\n\n/**\n * Project Registry Entry\n */\nexport interface ProjectRegistryEntry {\n  path: string;\n  registeredAt: string; // ISO timestamp\n  version: string;\n  lastSeen: string; // ISO timestamp\n}\n\n/**\n * Project Registry Format\n */\nexport interface ProjectRegistryData {\n  version: number;\n  projects: Record<string, ProjectRegistryEntry>;\n}\n\n/**\n * ProjectRegistry\n *\n * Manages a registry of projects that have claude-recall installed.\n * Stored in ~/.claude-recall/projects.json\n *\n * Features:\n * - Auto-registration on MCP server start\n * - Manual registration via CLI commands\n * - Discovery of registered projects\n * - Cleanup of stale entries\n */\nexport class ProjectRegistry {\n  private static instance: ProjectRegistry;\n  private logger: LoggingService;\n  private registryPath: string;\n\n  private constructor() {\n    this.logger = LoggingService.getInstance();\n    const config = ConfigService.getInstance();\n    const baseDir = path.dirname(config.getDatabasePath());\n    this.registryPath = path.join(baseDir, 'projects.json');\n  }\n\n  static getInstance(): ProjectRegistry {\n    if (!ProjectRegistry.instance) {\n      ProjectRegistry.instance = new ProjectRegistry();\n    }\n    return ProjectRegistry.instance;\n  }\n\n  /**\n   * Read the project registry from disk\n   */\n  private readRegistry(): ProjectRegistryData {\n    if (!fs.existsSync(this.registryPath)) {\n      return { version: 1, projects: {} };\n    }\n\n    try {\n      const content = fs.readFileSync(this.registryPath, 'utf-8');\n      const data = JSON.parse(content) as ProjectRegistryData;\n\n      // Validate structure\n      if (typeof data.version !== 'number' || typeof data.projects !== 'object') {\n        this.logger.warn('ProjectRegistry', 'Invalid registry format, resetting');\n        return { version: 1, projects: {} };\n      }\n\n      return data;\n    } catch (error) {\n      this.logger.error('ProjectRegistry', `Failed to read registry: ${error}`);\n      return { version: 1, projects: {} };\n    }\n  }\n\n  /**\n   * Write the project registry to disk atomically\n   */\n  private writeRegistry(data: ProjectRegistryData): void {\n    try {\n      // Ensure directory exists\n      const dir = path.dirname(this.registryPath);\n      if (!fs.existsSync(dir)) {\n        fs.mkdirSync(dir, { recursive: true });\n      }\n\n      // Atomic write: temp file + rename\n      const tempPath = `${this.registryPath}.tmp`;\n      fs.writeFileSync(tempPath, JSON.stringify(data, null, 2), 'utf-8');\n      fs.renameSync(tempPath, this.registryPath);\n\n      this.logger.debug('ProjectRegistry', `Wrote registry with ${Object.keys(data.projects).length} projects`);\n    } catch (error) {\n      this.logger.error('ProjectRegistry', `Failed to write registry: ${error}`);\n      throw error;\n    }\n  }\n\n  /**\n   * Register a project in the registry\n   * @param projectId Project identifier (usually directory basename)\n   * @param projectPath Absolute path to project directory\n   * @param version Claude Recall version\n   */\n  register(projectId: string, projectPath: string, version: string): void {\n    try {\n      const registry = this.readRegistry();\n      const now = new Date().toISOString();\n\n      // Check if already registered\n      const existing = registry.projects[projectId];\n      if (existing && existing.path === projectPath) {\n        // Already registered, just update version and lastSeen\n        registry.projects[projectId].version = version;\n        registry.projects[projectId].lastSeen = now;\n        this.logger.debug('ProjectRegistry', `Updated existing project: ${projectId}`);\n      } else {\n        // New registration\n        registry.projects[projectId] = {\n          path: projectPath,\n          registeredAt: now,\n          version: version,\n          lastSeen: now\n        };\n        this.logger.info('ProjectRegistry', `Registered new project: ${projectId} at ${projectPath}`);\n      }\n\n      this.writeRegistry(registry);\n    } catch (error) {\n      this.logger.error('ProjectRegistry', `Failed to register project ${projectId}: ${error}`);\n      // Don't throw - registration failure shouldn't break MCP server startup\n    }\n  }\n\n  /**\n   * Unregister a project from the registry\n   */\n  unregister(projectId: string): boolean {\n    try {\n      const registry = this.readRegistry();\n\n      if (!registry.projects[projectId]) {\n        this.logger.warn('ProjectRegistry', `Project not found: ${projectId}`);\n        return false;\n      }\n\n      delete registry.projects[projectId];\n      this.writeRegistry(registry);\n\n      this.logger.info('ProjectRegistry', `Unregistered project: ${projectId}`);\n      return true;\n    } catch (error) {\n      this.logger.error('ProjectRegistry', `Failed to unregister project ${projectId}: ${error}`);\n      return false;\n    }\n  }\n\n  /**\n   * Update lastSeen timestamp for a project\n   */\n  updateLastSeen(projectId: string): void {\n    try {\n      const registry = this.readRegistry();\n\n      if (!registry.projects[projectId]) {\n        this.logger.debug('ProjectRegistry', `Cannot update lastSeen for unknown project: ${projectId}`);\n        return;\n      }\n\n      registry.projects[projectId].lastSeen = new Date().toISOString();\n      this.writeRegistry(registry);\n    } catch (error) {\n      this.logger.error('ProjectRegistry', `Failed to update lastSeen for ${projectId}: ${error}`);\n      // Don't throw - this is non-critical\n    }\n  }\n\n  /**\n   * Get all registered projects\n   */\n  list(): Array<{ projectId: string; entry: ProjectRegistryEntry }> {\n    const registry = this.readRegistry();\n    return Object.entries(registry.projects).map(([projectId, entry]) => ({\n      projectId,\n      entry\n    }));\n  }\n\n  /**\n   * Get a specific project entry\n   */\n  get(projectId: string): ProjectRegistryEntry | null {\n    const registry = this.readRegistry();\n    return registry.projects[projectId] || null;\n  }\n\n  /**\n   * Clean stale registry entries (not seen in X days)\n   * @param daysOld Number of days without activity to consider stale\n   * @param dryRun If true, don't actually remove entries\n   * @returns Number of entries that would be/were removed\n   */\n  clean(daysOld: number = 30, dryRun: boolean = false): number {\n    try {\n      const registry = this.readRegistry();\n      const now = Date.now();\n      const cutoff = now - (daysOld * 24 * 60 * 60 * 1000);\n      let removed = 0;\n\n      for (const [projectId, entry] of Object.entries(registry.projects)) {\n        const lastSeenTime = new Date(entry.lastSeen).getTime();\n\n        if (lastSeenTime < cutoff) {\n          if (dryRun) {\n            this.logger.info('ProjectRegistry', `[DRY RUN] Would remove stale project: ${projectId} (last seen: ${entry.lastSeen})`);\n          } else {\n            this.logger.info('ProjectRegistry', `Removing stale project: ${projectId} (last seen: ${entry.lastSeen})`);\n            delete registry.projects[projectId];\n          }\n          removed++;\n        }\n      }\n\n      if (!dryRun && removed > 0) {\n        this.writeRegistry(registry);\n      }\n\n      return removed;\n    } catch (error) {\n      this.logger.error('ProjectRegistry', `Failed to clean registry: ${error}`);\n      return 0;\n    }\n  }\n\n  /**\n   * Get the registry file path (for debugging/inspection)\n   */\n  getRegistryPath(): string {\n    return this.registryPath;\n  }\n}\n"],"version":3}