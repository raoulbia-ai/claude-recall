{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/mcp/server.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/mcp/server.ts"],"sourcesContent":["import { StdioTransport } from './transports/stdio';\nimport { MemoryTools } from './tools/memory-tools';\nimport { TestTools } from './tools/test-tools';\nimport { LiveTestingTools } from './tools/live-testing-tools';\nimport { MemoryService } from '../services/memory';\nimport { LoggingService } from '../services/logging';\nimport { SessionManager } from './session-manager';\nimport { RateLimiter } from './rate-limiter';\nimport { MemoryCaptureMiddleware } from './memory-capture-middleware';\nimport { QueueIntegrationService } from '../services/queue-integration';\nimport { ResourcesHandler } from './resources-handler';\nimport { PromptsHandler } from './prompts-handler';\nimport { PreferenceAnalyzer } from '../services/preference-analyzer';\nimport { ContextEnhancer } from '../services/context-enhancer';\nimport { ConversationContextManager } from '../services/conversation-context-manager';\nimport { ProcessManager } from '../services/process-manager';\nimport { ConfigService } from '../services/config';\nimport { ProjectRegistry } from '../services/project-registry';\nimport * as path from 'path';\nimport * as fs from 'fs';\n\nexport interface MCPRequest {\n  jsonrpc: \"2.0\";\n  id: string | number;\n  method: string;\n  params?: any;\n}\n\nexport interface MCPResponse {\n  jsonrpc: \"2.0\";\n  id: string | number;\n  result?: any;\n  error?: {\n    code: number;\n    message: string;\n    data?: any;\n  };\n}\n\nexport interface MCPTool {\n  name: string;\n  description: string;\n  inputSchema: {\n    type: \"object\";\n    properties: Record<string, any>;\n    required?: string[];\n  };\n  handler: (input: any, context: MCPContext) => Promise<any>;\n}\n\nexport interface MCPContext {\n  sessionId: string;\n  timestamp: number;\n  projectId?: string;\n}\n\nexport class MCPServer {\n  private transport: StdioTransport;\n  private tools: Map<string, MCPTool> = new Map();\n  private memoryService: MemoryService;\n  private logger: LoggingService;\n  private sessions: Map<string, MCPContext> = new Map();\n  private sessionManager: SessionManager;\n  private rateLimiter: RateLimiter;\n  private memoryCaptureMiddleware: MemoryCaptureMiddleware;\n  private queueIntegration: QueueIntegrationService;\n  private resourcesHandler: ResourcesHandler;\n  private promptsHandler: PromptsHandler;\n  private preferenceAnalyzer: PreferenceAnalyzer;\n  private contextEnhancer: ContextEnhancer;\n  private conversationContext: ConversationContextManager;\n  private processManager: ProcessManager;\n  private config: ConfigService;\n  private isInitialized = false;\n\n  constructor() {\n    this.transport = new StdioTransport();\n    this.memoryService = MemoryService.getInstance();\n    this.logger = LoggingService.getInstance();\n    this.sessionManager = new SessionManager(this.logger);\n    this.rateLimiter = new RateLimiter(this.logger, {\n      windowMs: 60000,      // 1 minute\n      maxRequests: 100,     // 100 requests per minute\n      skipSuccessfulRequests: false\n    });\n    this.memoryCaptureMiddleware = new MemoryCaptureMiddleware();\n    this.queueIntegration = QueueIntegrationService.getInstance();\n    this.resourcesHandler = new ResourcesHandler();\n    this.promptsHandler = new PromptsHandler();\n    this.preferenceAnalyzer = new PreferenceAnalyzer(\n      this.logger,\n      this.memoryService,\n      this.sessionManager\n    );\n    this.contextEnhancer = ContextEnhancer.getInstance();\n    this.conversationContext = ConversationContextManager.getInstance();\n    this.processManager = ProcessManager.getInstance();\n    this.config = ConfigService.getInstance();\n\n    this.setupRequestHandlers();\n    this.registerTools();\n  }\n\n  private setupRequestHandlers(): void {\n    this.transport.onRequest(async (request: MCPRequest): Promise<MCPResponse> => {\n      let response: MCPResponse;\n      try {\n        switch (request.method) {\n          case 'initialize':\n            response = await this.handleInitialize(request);\n            break;\n          case 'tools/list':\n            response = await this.handleToolsList(request);\n            break;\n          case 'tools/call':\n            response = await this.handleToolCall(request);\n            break;\n          case 'notifications/initialized':\n            response = await this.handleInitialized(request);\n            break;\n          case 'resources/list':\n            response = await this.resourcesHandler.handleResourcesList(request);\n            break;\n          case 'resources/read':\n            response = await this.resourcesHandler.handleResourcesRead(request);\n            break;\n          case 'prompts/list':\n            response = await this.promptsHandler.handlePromptsList(request);\n            break;\n          case 'prompts/get':\n            response = await this.promptsHandler.handlePromptsGet(request);\n            break;\n          case 'health/check':\n            response = await this.handleHealthCheck(request);\n            break;\n          default:\n            response = this.createErrorResponse(request.id, -32601, `Method not found: ${request.method}`);\n        }\n      } catch (error) {\n        this.logger.logServiceError('MCPServer', 'handleRequest', error as Error, { method: request.method });\n        response = this.createErrorResponse(\n          request.id,\n          -32603,\n          'Internal error',\n          { message: (error as Error).message }\n        );\n      }\n\n      // Process for automatic memory capture (non-blocking)\n      if (this.isInitialized && request.method === 'tools/call') {\n        const sessionId = request.params?.arguments?.sessionId || this.generateSessionId();\n        this.memoryCaptureMiddleware.processForMemoryCapture(request, response, sessionId)\n          .catch(err => this.logger.error('MCPServer', 'Memory capture failed', err));\n      }\n\n      return response;\n    });\n  }\n\n  private registerTools(): void {\n    const memoryTools = new MemoryTools(this.memoryService, this.logger);\n    const testTools = new TestTools(this.memoryService, this.logger);\n    const liveTestingTools = new LiveTestingTools();\n    \n    // Register memory tools\n    for (const tool of memoryTools.getTools()) {\n      this.tools.set(tool.name, tool);\n    }\n    \n    // Register test tools\n    for (const tool of testTools.getTools()) {\n      this.tools.set(tool.name, tool);\n    }\n    \n    // Register live testing tools\n    for (const toolDef of liveTestingTools.getToolDefinitions()) {\n      const tool: MCPTool = {\n        name: toolDef.name,\n        description: toolDef.description,\n        inputSchema: {\n          type: \"object\",\n          properties: toolDef.parameters.properties,\n          required: toolDef.parameters.required\n        },\n        handler: async (input: any, context: MCPContext) => {\n          return await liveTestingTools.handleToolCall(toolDef.name, input);\n        }\n      };\n      this.tools.set(tool.name, tool);\n    }\n    \n    this.logger.info('MCPServer', `Registered ${this.tools.size} tools`, {\n      tools: Array.from(this.tools.keys())\n    });\n  }\n\n  private async handleInitialize(request: MCPRequest): Promise<MCPResponse> {\n    const params = request.params || {};\n\n    this.logger.info('MCPServer', 'Initializing MCP server', params);\n\n    return {\n      jsonrpc: \"2.0\",\n      id: request.id,\n      result: {\n        protocolVersion: \"2024-11-05\",\n        capabilities: {\n          tools: {},\n          resources: {},\n          prompts: {},\n          logging: {}\n        },\n        serverInfo: {\n          name: \"claude-recall\",\n          version: \"0.2.0\"\n        }\n      }\n    };\n  }\n\n  private async handleInitialized(request: MCPRequest): Promise<MCPResponse> {\n    this.isInitialized = true;\n    this.logger.info('MCPServer', 'MCP server initialized successfully');\n    \n    // Note: initialized is a notification, no response required\n    return {\n      jsonrpc: \"2.0\",\n      id: request.id,\n      result: null\n    };\n  }\n\n  private async handleToolsList(request: MCPRequest): Promise<MCPResponse> {\n    // Phase 3A: Get tool list with basic descriptions\n    const toolList = Array.from(this.tools.values()).map(tool => ({\n      name: tool.name,\n      description: tool.description,\n      inputSchema: tool.inputSchema\n    }));\n\n    // Phase 3A: Enhance tool descriptions with relevant memories\n    const sessionId = request.params?.sessionId || this.generateSessionId();\n    const enhancedTools = await this.contextEnhancer.enhanceToolsList(toolList, sessionId);\n\n    this.logger.debug('MCPServer', `Listing ${enhancedTools.length} tools (enhanced with memories)`);\n\n    return {\n      jsonrpc: \"2.0\",\n      id: request.id,\n      result: {\n        tools: enhancedTools\n      }\n    };\n  }\n\n  private async handleToolCall(request: MCPRequest): Promise<MCPResponse> {\n    // Phase 3B: Proactively inject relevant memories before tool execution\n    request = await this.memoryCaptureMiddleware.enhanceRequestWithMemories(request);\n\n    const { name, arguments: toolArgs } = request.params || {};\n\n    if (!name || typeof name !== 'string') {\n      return this.createErrorResponse(request.id, -32602, 'Invalid params: tool name required');\n    }\n\n    const tool = this.tools.get(name);\n    if (!tool) {\n      return this.createErrorResponse(request.id, -32601, `Tool not found: ${name}`);\n    }\n\n    const startTime = Date.now();\n\n    try {\n      // Create or get session context\n      const sessionId = toolArgs?.sessionId || this.generateSessionId();\n\n      // Phase 4: Check for duplicate requests\n      const duplicateCheck = this.conversationContext.checkForDuplicate(\n        sessionId,\n        name,\n        toolArgs\n      );\n\n      if (duplicateCheck.isDuplicate && duplicateCheck.previousAction) {\n        this.logger.info('MCPServer', 'Duplicate request detected', {\n          sessionId,\n          tool: name,\n          turnsSince: duplicateCheck.turnsSince\n        });\n\n        // Return helpful response instead of re-executing\n        return {\n          jsonrpc: \"2.0\",\n          id: request.id,\n          result: {\n            content: [\n              {\n                type: \"text\",\n                text: `${duplicateCheck.suggestion}\\n\\nPrevious result:\\n${JSON.stringify(duplicateCheck.previousAction.result, null, 2)}`\n              }\n            ],\n            isError: false,\n            metadata: {\n              toolName: name,\n              duration: Date.now() - startTime,\n              sessionId,\n              wasDuplicate: true,\n              previousTimestamp: duplicateCheck.previousAction.timestamp\n            }\n          }\n        };\n      }\n      \n      // Get or create session\n      let session = this.sessionManager.getSession(sessionId);\n      if (!session) {\n        session = this.sessionManager.createSession(sessionId);\n      }\n      \n      // Check rate limit\n      const withinLimit = await this.rateLimiter.checkLimit(sessionId);\n      if (!withinLimit) {\n        const remaining = this.rateLimiter.getRemainingRequests(sessionId);\n        return this.createErrorResponse(\n          request.id,\n          -32000, // Custom error code for rate limit\n          'Rate limit exceeded',\n          {\n            sessionId,\n            remainingRequests: remaining,\n            windowMs: 60000,\n            message: 'Too many requests. Please wait before trying again.'\n          }\n        );\n      }\n      \n      // Update session activity\n      this.sessionManager.incrementToolCalls(sessionId);\n      \n      const context: MCPContext = {\n        sessionId,\n        timestamp: Date.now(),\n        projectId: toolArgs?.projectId\n      };\n\n      this.logger.info('MCPServer', `Executing tool: ${name}`, {\n        sessionId,\n        args: toolArgs,\n        toolCallCount: session.toolCalls\n      });\n\n      const result = await tool.handler(toolArgs || {}, context);\n\n      // Record successful request for rate limiting\n      this.rateLimiter.recordRequest(sessionId, true);\n\n      // Phase 2: Track conversation and detect preference signals\n      this.trackConversationTurn(sessionId, name, toolArgs, result);\n\n      // Phase 4: Record action for duplicate detection\n      this.conversationContext.recordAction(sessionId, name, toolArgs, result);\n\n      // Claude-flow pattern: Enhanced response format\n      return {\n        jsonrpc: \"2.0\",\n        id: request.id,\n        result: {\n          content: [\n            {\n              type: \"text\",\n              text: typeof result === 'string' ? result : JSON.stringify(result, null, 2)\n            }\n          ],\n          isError: false,\n          metadata: {\n            toolName: name,\n            duration: Date.now() - startTime,\n            sessionId: context.sessionId\n          }\n        }\n      };\n    } catch (error) {\n      this.logger.logServiceError('MCPServer', `tool:${name}`, error as Error, toolArgs);\n      \n      // Record failed request for rate limiting\n      const sessionId = toolArgs?.sessionId || this.generateSessionId();\n      this.rateLimiter.recordRequest(sessionId, false);\n      \n      // Claude-flow pattern: Enhanced error response\n      return {\n        jsonrpc: \"2.0\",\n        id: request.id,\n        result: {\n          content: [\n            {\n              type: \"text\",\n              text: `Tool execution failed: ${(error as Error).message}`\n            }\n          ],\n          isError: true,\n          metadata: {\n            toolName: name,\n            duration: Date.now() - startTime,\n            sessionId: this.generateSessionId(),\n            error: {\n              message: (error as Error).message,\n              stack: (error as Error).stack\n            }\n          }\n        }\n      };\n    }\n  }\n\n  private createErrorResponse(\n    id: string | number,\n    code: number,\n    message: string,\n    data?: any\n  ): MCPResponse {\n    return {\n      jsonrpc: \"2.0\",\n      id,\n      error: {\n        code,\n        message,\n        ...(data && { data })\n      }\n    };\n  }\n\n  private generateSessionId(): string {\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * Phase 2: Track conversation turns and detect preference signals\n   */\n  private trackConversationTurn(\n    sessionId: string,\n    toolName: string,\n    input: any,\n    output: any\n  ): void {\n    try {\n      // Detect preference signals in the conversation\n      const signals = this.preferenceAnalyzer.detectPreferenceSignals(input, output);\n      const hasSignals = signals.length > 0;\n\n      // Add turn to session history\n      this.sessionManager.addConversationTurn(\n        sessionId,\n        toolName,\n        input,\n        output,\n        hasSignals\n      );\n\n      // Check if we should suggest analysis\n      this.preferenceAnalyzer.checkAndSuggestAnalysis(sessionId)\n        .catch(err => {\n          this.logger.error('MCPServer', 'Failed to check analysis suggestion', err);\n        });\n\n      if (hasSignals) {\n        this.logger.debug('MCPServer', 'Preference signals detected', {\n          sessionId,\n          tool: toolName,\n          signalCount: signals.length\n        });\n      }\n    } catch (error) {\n      this.logger.error('MCPServer', 'Failed to track conversation turn', error);\n    }\n  }\n\n  private async handleHealthCheck(request: MCPRequest): Promise<MCPResponse> {\n    const rateLimiterStats = this.rateLimiter.getStats();\n    const conversationStats = this.conversationContext.getStats();\n\n    const health = {\n      status: 'healthy',\n      version: '0.2.0',\n      uptime: process.uptime(),\n      memory: process.memoryUsage(),\n      sessions: {\n        total: this.sessionManager.getAllSessions().length,\n        active: this.sessionManager.getActiveSessionCount()\n      },\n      toolsRegistered: this.tools.size,\n      database: this.memoryService.isConnected() ? 'connected' : 'disconnected',\n      rateLimiter: {\n        activeSessions: rateLimiterStats.activeSessions,\n        totalRequests: rateLimiterStats.totalRequests,\n        topSessions: rateLimiterStats.topSessions\n      },\n      conversationContext: {\n        activeSessions: conversationStats.activeSessions,\n        totalActions: conversationStats.totalActions,\n        averageActionsPerSession: conversationStats.averageActionsPerSession\n      }\n    };\n\n    this.logger.info('MCPServer', 'Health check performed', health);\n\n    return {\n      jsonrpc: \"2.0\",\n      id: request.id,\n      result: health\n    };\n  }\n\n  async start(): Promise<void> {\n    try {\n      this.logger.info('MCPServer', 'Starting Claude Recall MCP server...');\n\n      // Get project ID for PID tracking\n      const projectId = this.config.getProjectId();\n\n      // Auto-register project in registry\n      const rootDir = this.config.getConfig().project.rootDir;\n      const version = this.getVersion();\n      const projectRegistry = ProjectRegistry.getInstance();\n\n      projectRegistry.register(projectId, rootDir, version);\n      projectRegistry.updateLastSeen(projectId);\n\n      this.logger.debug('MCPServer', `Project registered: ${projectId} at ${rootDir} (v${version})`);\n\n      // Check for existing MCP server process\n      const existingPid = this.processManager.readPidFile(projectId);\n\n      if (existingPid) {\n        // Validate if process is actually running\n        if (this.processManager.isProcessRunning(existingPid)) {\n          // Check environment variable for auto-cleanup behavior\n          const autoCleanup = process.env.CLAUDE_RECALL_AUTO_CLEANUP === 'true';\n\n          if (autoCleanup) {\n            this.logger.warn('MCPServer', `Killing stale MCP server (PID: ${existingPid}) before starting...`);\n            this.processManager.killProcess(existingPid, false);\n            this.processManager.removePidFile(projectId);\n            // Give it a moment to shut down\n            await new Promise(resolve => setTimeout(resolve, 1000));\n          } else {\n            throw new Error(\n              `MCP server already running for project \"${projectId}\" (PID: ${existingPid}). ` +\n              `Stop it first with: npx claude-recall mcp stop`\n            );\n          }\n        } else {\n          // Clean up stale PID file\n          this.logger.info('MCPServer', 'Removing stale PID file...');\n          this.processManager.removePidFile(projectId);\n        }\n      }\n\n      // Initialize queue integration for background processing\n      await this.queueIntegration.initialize();\n      this.logger.info('MCPServer', 'Queue integration initialized');\n\n      await this.transport.start();\n\n      // Write PID file after successful startup\n      this.processManager.writePidFile(projectId, process.pid);\n      this.logger.info('MCPServer', `MCP server started successfully (PID: ${process.pid}, Project: ${projectId})`);\n    } catch (error) {\n      this.logger.logServiceError('MCPServer', 'start', error as Error);\n      throw error;\n    }\n  }\n\n  async stop(): Promise<void> {\n    try {\n      this.logger.info('MCPServer', 'Stopping MCP server...');\n\n      // Clean up old sessions before shutdown\n      this.sessionManager.cleanupOldSessions();\n\n      // Shutdown session manager (persists sessions)\n      this.sessionManager.shutdown();\n\n      // Shutdown rate limiter\n      this.rateLimiter.shutdown();\n\n      // Clean up memory capture middleware\n      this.memoryCaptureMiddleware.cleanupSessions();\n\n      // Clean up conversation context\n      this.conversationContext.cleanup();\n\n      await this.transport.stop();\n      this.memoryService.close();\n\n      // Remove PID file on clean shutdown\n      const projectId = this.config.getProjectId();\n      this.processManager.removePidFile(projectId);\n\n      this.logger.info('MCPServer', 'MCP server stopped');\n    } catch (error) {\n      this.logger.logServiceError('MCPServer', 'stop', error as Error);\n      throw error;\n    }\n  }\n\n  // Graceful shutdown handling\n  setupSignalHandlers(): void {\n    process.on('SIGINT', async () => {\n      this.logger.info('MCPServer', 'Received SIGINT, shutting down gracefully...');\n      await this.stop();\n      process.exit(0);\n    });\n\n    process.on('SIGTERM', async () => {\n      this.logger.info('MCPServer', 'Received SIGTERM, shutting down gracefully...');\n      await this.stop();\n      process.exit(0);\n    });\n  }\n\n  /**\n   * Get current version from package.json\n   */\n  private getVersion(): string {\n    try {\n      const packageJsonPath = path.join(__dirname, '../../package.json');\n      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n      return packageJson.version;\n    } catch (error) {\n      return 'unknown';\n    }\n  }\n}"],"version":3}