dceba96f77c113afe2c7c86df812eb7c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimiter = void 0;
class RateLimiter {
    constructor(logger, config = {}) {
        this.logger = logger;
        this.requests = new Map();
        this.cleanupInterval = null;
        this.windowMs = config.windowMs || 60000; // 1 minute default
        this.maxRequests = config.maxRequests || 100; // 100 requests default
        this.skipSuccessfulRequests = config.skipSuccessfulRequests || false;
        // Clean up old entries periodically
        this.cleanupInterval = setInterval(() => {
            this.cleanup();
        }, this.windowMs);
        this.logger.info('RateLimiter', 'Rate limiter initialized', {
            windowMs: this.windowMs,
            maxRequests: this.maxRequests,
            skipSuccessfulRequests: this.skipSuccessfulRequests
        });
    }
    async checkLimit(sessionId) {
        const now = Date.now();
        const requests = this.requests.get(sessionId) || [];
        // Remove old requests outside window
        const validRequests = requests.filter(time => now - time < this.windowMs);
        if (validRequests.length >= this.maxRequests) {
            this.logger.warn('RateLimiter', 'Rate limit exceeded', {
                sessionId,
                requests: validRequests.length,
                window: this.windowMs,
                maxRequests: this.maxRequests
            });
            return false;
        }
        // Don't add to count yet - wait for recordRequest
        this.requests.set(sessionId, validRequests);
        return true;
    }
    recordRequest(sessionId, successful = true) {
        if (this.skipSuccessfulRequests && successful) {
            return; // Don't count successful requests if configured
        }
        const now = Date.now();
        const requests = this.requests.get(sessionId) || [];
        // Add new request
        requests.push(now);
        // Keep only requests within window
        const validRequests = requests.filter(time => now - time < this.windowMs);
        this.requests.set(sessionId, validRequests);
        this.logger.debug('RateLimiter', 'Request recorded', {
            sessionId,
            requestCount: validRequests.length,
            successful
        });
    }
    getRemainingRequests(sessionId) {
        const now = Date.now();
        const requests = this.requests.get(sessionId) || [];
        const validRequests = requests.filter(time => now - time < this.windowMs);
        return Math.max(0, this.maxRequests - validRequests.length);
    }
    resetLimit(sessionId) {
        this.requests.delete(sessionId);
        this.logger.info('RateLimiter', 'Rate limit reset', { sessionId });
    }
    cleanup() {
        const now = Date.now();
        let cleaned = 0;
        for (const [sessionId, requests] of this.requests) {
            const validRequests = requests.filter(time => now - time < this.windowMs);
            if (validRequests.length === 0) {
                this.requests.delete(sessionId);
                cleaned++;
            }
            else if (validRequests.length < requests.length) {
                this.requests.set(sessionId, validRequests);
            }
        }
        if (cleaned > 0) {
            this.logger.debug('RateLimiter', `Cleaned up ${cleaned} expired session limits`);
        }
    }
    getStats() {
        const now = Date.now();
        const stats = {
            activeSessions: this.requests.size,
            totalRequests: 0,
            topSessions: []
        };
        const sessionRequests = [];
        for (const [sessionId, requests] of this.requests) {
            const validRequests = requests.filter(time => now - time < this.windowMs);
            const count = validRequests.length;
            stats.totalRequests += count;
            sessionRequests.push({ sessionId, requests: count });
        }
        // Get top 5 sessions by request count
        stats.topSessions = sessionRequests
            .sort((a, b) => b.requests - a.requests)
            .slice(0, 5);
        return stats;
    }
    shutdown() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
            this.cleanupInterval = null;
        }
        this.logger.info('RateLimiter', 'Rate limiter shut down', {
            activeSessions: this.requests.size
        });
    }
}
exports.RateLimiter = RateLimiter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvbWNwL3JhdGUtbGltaXRlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFRQSxNQUFhLFdBQVc7SUFPdEIsWUFDVSxNQUFzQixFQUM5QixTQUEwQixFQUFFO1FBRHBCLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBUHhCLGFBQVEsR0FBMEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUk1QyxvQkFBZSxHQUEwQixJQUFJLENBQUM7UUFNcEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQyxDQUFDLG1CQUFtQjtRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDLENBQUMsdUJBQXVCO1FBQ3JFLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxNQUFNLENBQUMsc0JBQXNCLElBQUksS0FBSyxDQUFDO1FBRXJFLG9DQUFvQztRQUNwQyxJQUFJLENBQUMsZUFBZSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDdEMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2pCLENBQUMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLDBCQUEwQixFQUFFO1lBQzFELFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0Isc0JBQXNCLEVBQUUsSUFBSSxDQUFDLHNCQUFzQjtTQUNwRCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxTQUFpQjtRQUNoQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXBELHFD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LGFBQWEsSUFBSSxLQUFLLENBQUM7WUFDN0IsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUN2RCxDQUFDO1FBRUQsc0NBQXNDO1FBQ3RDLEtBQUssQ0FBQyxXQUFXLEdBQUcsZUFBZTthQUNoQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUM7YUFDdkMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVmLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QixhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzlCLENBQUM7UUFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsd0JBQXdCLEVBQUU7WUFDeEQsY0FBYyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSTtTQUNuQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFoSkQsa0NBZ0pDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9lYmlhcmFvL3JlcG9zL2NsYXVkZS1yZWNhbGwvc3JjL21jcC9yYXRlLWxpbWl0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nZ2luZ1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9sb2dnaW5nJztcblxuZXhwb3J0IGludGVyZmFjZSBSYXRlTGltaXRDb25maWcge1xuICB3aW5kb3dNcz86IG51bWJlcjsgICAgICAgLy8gVGltZSB3aW5kb3cgaW4gbWlsbGlzZWNvbmRzXG4gIG1heFJlcXVlc3RzPzogbnVtYmVyOyAgICAvLyBNYXggcmVxdWVzdHMgcGVyIHdpbmRvd1xuICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzPzogYm9vbGVhbjsgLy8gT25seSBjb3VudCBmYWlsZWQgcmVxdWVzdHNcbn1cblxuZXhwb3J0IGNsYXNzIFJhdGVMaW1pdGVyIHtcbiAgcHJpdmF0ZSByZXF1ZXN0czogTWFwPHN0cmluZywgbnVtYmVyW10+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHJlYWRvbmx5IHdpbmRvd01zOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWF4UmVxdWVzdHM6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzOiBib29sZWFuO1xuICBwcml2YXRlIGNsZWFudXBJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcbiAgXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbG9nZ2VyOiBMb2dnaW5nU2VydmljZSxcbiAgICBjb25maWc6IFJhdGVMaW1pdENvbmZpZyA9IHt9XG4gICkge1xuICAgIHRoaXMud2luZG93TXMgPSBjb25maWcud2luZG93TXMgfHwgNjAwMDA7IC8vIDEgbWludXRlIGRlZmF1bHRcbiAgICB0aGlzLm1heFJlcXVlc3RzID0gY29uZmlnLm1heFJlcXVlc3RzIHx8IDEwMDsgLy8gMTAwIHJlcXVlc3RzIGRlZmF1bHRcbiAgICB0aGlzLnNraXBTdWNjZXNzZnVsUmVxdWVzdHMgPSBjb25maWcuc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cyB8fCBmYWxzZTtcbiAgICBcbiAgICAvLyBDbGVhbiB1cCBvbGQgZW50cmllcyBwZXJpb2RpY2FsbHlcbiAgICB0aGlzLmNsZWFudXBJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuY2xlYW51cCgpO1xuICAgIH0sIHRoaXMud2luZG93TXMpO1xuICAgIFxuICAgIHRoaXMubG9nZ2VyLmluZm8oJ1JhdGVMaW1pdGVyJywgJ1JhdGUgbGltaXRlciBpbml0aWFsaXplZCcsIHtcbiAgICAgIHdpbmRvd01zOiB0aGlzLndpbmRvd01zLFxuICAgICAgbWF4UmVxdWVzdHM6IHRoaXMubWF4UmVxdWVzdHMsXG4gICAgICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzOiB0aGlzLnNraXBTdWNjZXNzZnVsUmVxdWVzdHNcbiAgICB9KTtcbiAgfVxuICBcbiAgYXN5bmMgY2hlY2tMaW1pdChzZXNzaW9uSWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgcmVxdWVzdHMgPSB0aGlzLnJlcXVlc3RzLmdldChzZXNzaW9uSWQpIHx8IFtdO1xuICAgIFxuICAgIC8vIFJlbW92ZSBvbGQgcmVxdWVzdHMgb3V0c2lkZSB3aW5kb3dcbiAgICBjb25zdCB2YWxpZFJlcXVlc3RzID0gcmVxdWVzdHMuZmlsdGVyKHRpbWUgPT4gbm93IC0gdGltZSA8IHRoaXMud2luZG93TXMpO1xuICAgIFxuICAgIGlmICh2YWxpZFJlcXVlc3RzLmxlbmd0aCA+PSB0aGlzLm1heFJlcXVlc3RzKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKCdSYXRlTGltaXRlcicsICdSYXRlIGxpbWl0IGV4Y2VlZGVkJywge1xuICAgICAgICBzZXNzaW9uSWQsXG4gICAgICAgIHJlcXVlc3RzOiB2YWxpZFJlcXVlc3RzLmxlbmd0aCxcbiAgICAgICAgd2luZG93OiB0aGlzLndpbmRvd01zLFxuICAgICAgICBtYXhSZXF1ZXN0czogdGhpcy5tYXhSZXF1ZXN0c1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIFxuICAgIC8vIERvbid0IGFkZCB0byBjb3VudCB5ZXQgLSB3YWl0IGZvciByZWNvcmRSZXF1ZXN0XG4gICAgdGhpcy5yZXF1ZXN0cy5zZXQoc2Vzc2lvbklkLCB2YWxpZFJlcXVlc3RzKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBcbiAgcmVjb3JkUmVxdWVzdChzZXNzaW9uSWQ6IHN0cmluZywgc3VjY2Vzc2Z1bDogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5za2lwU3VjY2Vzc2Z1bFJlcXVlc3RzICYmIHN1Y2Nlc3NmdWwpIHtcbiAgICAgIHJldHVybjsgLy8gRG9uJ3QgY291bnQgc3VjY2Vzc2Z1bCByZXF1ZXN0cyBpZiBjb25maWd1cmVkXG4gICAgfVxuICAgIFxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgcmVxdWVzdHMgPSB0aGlzLnJlcXVlc3RzLmdldChzZXNzaW9uSWQpIHx8IFtdO1xuICAgIFxuICAgIC8vIEFkZCBuZXcgcmVxdWVzdFxuICAgIHJlcXVlc3RzLnB1c2gobm93KTtcbiAgICBcbiAgICAvLyBLZWVwIG9ubHkgcmVxdWVzdHMgd2l0aGluIHdpbmRvd1xuICAgIGNvbnN0IHZhbGlkUmVxdWVzdHMgPSByZXF1ZXN0cy5maWx0ZXIodGltZSA9PiBub3cgLSB0aW1lIDwgdGhpcy53aW5kb3dNcyk7XG4gICAgdGhpcy5yZXF1ZXN0cy5zZXQoc2Vzc2lvbklkLCB2YWxpZFJlcXVlc3RzKTtcbiAgICBcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnUmF0ZUxpbWl0ZXInLCAnUmVxdWVzdCByZWNvcmRlZCcsIHtcbiAgICAgIHNlc3Npb25JZCxcbiAgICAgIHJlcXVlc3RDb3VudDogdmFsaWRSZXF1ZXN0cy5sZW5ndGgsXG4gICAgICBzdWNjZXNzZnVsXG4gICAgfSk7XG4gIH1cbiAgXG4gIGdldFJlbWFpbmluZ1JlcXVlc3RzKHNlc3Npb25JZDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHJlcXVlc3RzID0gdGhpcy5yZXF1ZXN0cy5nZXQoc2Vzc2lvbklkKSB8fCBbXTtcbiAgICBjb25zdCB2YWxpZFJlcXVlc3RzID0gcmVxdWVzdHMuZmlsdGVyKHRpbWUgPT4gbm93IC0gdGltZSA8IHRoaXMud2luZG93TXMpO1xuICAgIFxuICAgIHJldHVybiBNYXRoLm1heCgwLCB0aGlzLm1heFJlcXVlc3RzIC0gdmFsaWRSZXF1ZXN0cy5sZW5ndGgpO1xuICB9XG4gIFxuICByZXNldExpbWl0KHNlc3Npb25JZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5yZXF1ZXN0cy5kZWxldGUoc2Vzc2lvbklkKTtcbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdSYXRlTGltaXRlcicsICdSYXRlIGxpbWl0IHJlc2V0JywgeyBzZXNzaW9uSWQgfSk7XG4gIH1cbiAgXG4gIHByaXZhdGUgY2xlYW51cCgpOiB2b2lkIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGxldCBjbGVhbmVkID0gMDtcbiAgICBcbiAgICBmb3IgKGNvbnN0IFtzZXNzaW9uSWQsIHJlcXVlc3RzXSBvZiB0aGlzLnJlcXVlc3RzKSB7XG4gICAgICBjb25zdCB2YWxpZFJlcXVlc3RzID0gcmVxdWVzdHMuZmlsdGVyKHRpbWUgPT4gbm93IC0gdGltZSA8IHRoaXMud2luZG93TXMpO1xuICAgICAgXG4gICAgICBpZiAodmFsaWRSZXF1ZXN0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0cy5kZWxldGUoc2Vzc2lvbklkKTtcbiAgICAgICAgY2xlYW5lZCsrO1xuICAgICAgfSBlbHNlIGlmICh2YWxpZFJlcXVlc3RzLmxlbmd0aCA8IHJlcXVlc3RzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnJlcXVlc3RzLnNldChzZXNzaW9uSWQsIHZhbGlkUmVxdWVzdHMpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBpZiAoY2xlYW5lZCA+IDApIHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdSYXRlTGltaXRlcicsIGBDbGVhbmVkIHVwICR7Y2xlYW5lZH0gZXhwaXJlZCBzZXNzaW9uIGxpbWl0c2ApO1xuICAgIH1cbiAgfVxuICBcbiAgZ2V0U3RhdHMoKToge1xuICAgIGFjdGl2ZVNlc3Npb25zOiBudW1iZXI7XG4gICAgdG90YWxSZXF1ZXN0czogbnVtYmVyO1xuICAgIHRvcFNlc3Npb25zOiBBcnJheTx7IHNlc3Npb25JZDogc3RyaW5nOyByZXF1ZXN0czogbnVtYmVyIH0+O1xuICB9IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHN0YXRzID0ge1xuICAgICAgYWN0aXZlU2Vzc2lvbnM6IHRoaXMucmVxdWVzdHMuc2l6ZSxcbiAgICAgIHRvdGFsUmVxdWVzdHM6IDAsXG4gICAgICB0b3BTZXNzaW9uczogW10gYXMgQXJyYXk8eyBzZXNzaW9uSWQ6IHN0cmluZzsgcmVxdWVzdHM6IG51bWJlciB9PlxuICAgIH07XG4gICAgXG4gICAgY29uc3Qgc2Vzc2lvblJlcXVlc3RzOiBBcnJheTx7IHNlc3Npb25JZDogc3RyaW5nOyByZXF1ZXN0czogbnVtYmVyIH0+ID0gW107XG4gICAgXG4gICAgZm9yIChjb25zdCBbc2Vzc2lvbklkLCByZXF1ZXN0c10gb2YgdGhpcy5yZXF1ZXN0cykge1xuICAgICAgY29uc3QgdmFsaWRSZXF1ZXN0cyA9IHJlcXVlc3RzLmZpbHRlcih0aW1lID0+IG5vdyAtIHRpbWUgPCB0aGlzLndpbmRvd01zKTtcbiAgICAgIGNvbnN0IGNvdW50ID0gdmFsaWRSZXF1ZXN0cy5sZW5ndGg7XG4gICAgICBcbiAgICAgIHN0YXRzLnRvdGFsUmVxdWVzdHMgKz0gY291bnQ7XG4gICAgICBzZXNzaW9uUmVxdWVzdHMucHVzaCh7IHNlc3Npb25JZCwgcmVxdWVzdHM6IGNvdW50IH0pO1xuICAgIH1cbiAgICBcbiAgICAvLyBHZXQgdG9wIDUgc2Vzc2lvbnMgYnkgcmVxdWVzdCBjb3VudFxuICAgIHN0YXRzLnRvcFNlc3Npb25zID0gc2Vzc2lvblJlcXVlc3RzXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5yZXF1ZXN0cyAtIGEucmVxdWVzdHMpXG4gICAgICAuc2xpY2UoMCwgNSk7XG4gICAgXG4gICAgcmV0dXJuIHN0YXRzO1xuICB9XG4gIFxuICBzaHV0ZG93bigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jbGVhbnVwSW50ZXJ2YWwpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwSW50ZXJ2YWwpO1xuICAgICAgdGhpcy5jbGVhbnVwSW50ZXJ2YWwgPSBudWxsO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdSYXRlTGltaXRlcicsICdSYXRlIGxpbWl0ZXIgc2h1dCBkb3duJywge1xuICAgICAgYWN0aXZlU2Vzc2lvbnM6IHRoaXMucmVxdWVzdHMuc2l6ZVxuICAgIH0pO1xuICB9XG59Il0sInZlcnNpb24iOjN9