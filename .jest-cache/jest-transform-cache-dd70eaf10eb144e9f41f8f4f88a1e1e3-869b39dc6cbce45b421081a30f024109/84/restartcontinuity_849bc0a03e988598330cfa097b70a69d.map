{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/restart-continuity.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/restart-continuity.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport * as os from 'os';\nimport { LoggingService } from './logging';\nimport { MemoryService } from './memory';\nimport { TestOrchestrator } from '../testing/test-orchestrator';\n\nexport interface ContinuityState {\n  sessionId: string;\n  testInProgress: boolean;\n  currentTest?: {\n    name: string;\n    startTime: number;\n    scenario: any;\n    checkpoints: string[];\n  };\n  pendingActions: Array<{\n    type: string;\n    params: any;\n    timestamp: number;\n  }>;\n  lastActivity: number;\n  restartCount: number;\n}\n\nexport interface RestartEvent {\n  timestamp: number;\n  previousSessionId: string;\n  newSessionId: string;\n  stateRecovered: boolean;\n  testResumed: boolean;\n}\n\nexport class RestartContinuityManager {\n  private static instance: RestartContinuityManager;\n  private logger: LoggingService;\n  private memoryService: MemoryService;\n  private stateFile: string;\n  private lockFile: string;\n  private currentState: ContinuityState | null = null;\n  private checkInterval: NodeJS.Timeout | null = null;\n  private testOrchestrator: TestOrchestrator | null = null;\n  \n  private constructor() {\n    this.logger = LoggingService.getInstance();\n    this.memoryService = MemoryService.getInstance();\n    const baseDir = path.join(os.homedir(), '.claude-recall', 'continuity');\n    this.stateFile = path.join(baseDir, 'state.json');\n    this.lockFile = path.join(baseDir, 'lock.pid');\n    this.ensureDirectory(baseDir);\n    this.initialize();\n  }\n  \n  static getInstance(): RestartContinuityManager {\n    if (!RestartContinuityManager.instance) {\n      RestartContinuityManager.instance = new RestartContinuityManager();\n    }\n    return RestartContinuityManager.instance;\n  }\n  \n  private ensureDirectory(dir: string): void {\n    if (!fs.existsSync(dir)) {\n      fs.mkdirSync(dir, { recursive: true });\n    }\n  }\n  \n  private initialize(): void {\n    // Check for existing lock file (indicates a restart)\n    const wasRestarted = this.detectRestart();\n    \n    if (wasRestarted) {\n      this.handleRestart();\n    } else {\n      this.createNewSession();\n    }\n    \n    // Create new lock file with current PID\n    this.createLockFile();\n    \n    // Start monitoring for changes\n    this.startMonitoring();\n  }\n  \n  private detectRestart(): boolean {\n    try {\n      if (!fs.existsSync(this.lockFile)) {\n        return false;\n      }\n      \n      const lockData = fs.readFileSync(this.lockFile, 'utf-8');\n      const previousPid = parseInt(lockData.trim());\n      \n      // Check if previous process is still running\n      try {\n        process.kill(previousPid, 0);\n        // Process is still running, not a restart\n        return false;\n      } catch {\n        // Process is not running, this is a restart\n        this.logger.info('RestartContinuity', 'Restart detected', { \n          previousPid,\n          currentPid: process.pid \n        });\n        return true;\n      }\n    } catch (error) {\n      this.logger.error('RestartContinuity', 'Error detecting restart', error as Error);\n      return false;\n    }\n  }\n  \n  private createLockFile(): void {\n    fs.writeFileSync(this.lockFile, process.pid.toString());\n  }\n  \n  private handleRestart(): void {\n    try {\n      // Load previous state\n      if (fs.existsSync(this.stateFile)) {\n        const stateData = fs.readFileSync(this.stateFile, 'utf-8');\n        const previousState = JSON.parse(stateData) as ContinuityState;\n        \n        // Create restart event\n        const restartEvent: RestartEvent = {\n          timestamp: Date.now(),\n          previousSessionId: previousState.sessionId,\n          newSessionId: this.generateSessionId(),\n          stateRecovered: true,\n          testResumed: false\n        };\n        \n        // Store restart event in memory\n        this.memoryService.store({\n          key: `restart/event/${restartEvent.newSessionId}`,\n          value: restartEvent,\n          type: 'restart_event'\n        });\n        \n        // Update state with new session\n        previousState.sessionId = restartEvent.newSessionId;\n        previousState.restartCount++;\n        \n        // Check if test was in progress\n        if (previousState.testInProgress && previousState.currentTest) {\n          this.logger.info('RestartContinuity', 'Resuming test after restart', {\n            test: previousState.currentTest.name,\n            checkpoints: previousState.currentTest.checkpoints.length\n          });\n          \n          // Resume test\n          this.resumeTest(previousState.currentTest);\n          restartEvent.testResumed = true;\n        }\n        \n        // Process pending actions\n        if (previousState.pendingActions.length > 0) {\n          this.processPendingActions(previousState.pendingActions);\n        }\n        \n        this.currentState = previousState;\n        this.saveState();\n        \n        // Inject continuity information as memory\n        this.injectContinuityMemory(restartEvent);\n      }\n    } catch (error) {\n      this.logger.error('RestartContinuity', 'Error handling restart', error as Error);\n      this.createNewSession();\n    }\n  }\n  \n  private createNewSession(): void {\n    this.currentState = {\n      sessionId: this.generateSessionId(),\n      testInProgress: false,\n      pendingActions: [],\n      lastActivity: Date.now(),\n      restartCount: 0\n    };\n    this.saveState();\n  }\n  \n  private generateSessionId(): string {\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  }\n  \n  private saveState(): void {\n    if (this.currentState) {\n      try {\n        // Ensure directory exists before writing\n        const dir = path.dirname(this.stateFile);\n        if (!fs.existsSync(dir)) {\n          fs.mkdirSync(dir, { recursive: true });\n        }\n        fs.writeFileSync(this.stateFile, JSON.stringify(this.currentState, null, 2));\n      } catch (error) {\n        this.logger.error('RestartContinuity', 'Error saving state', error as Error);\n      }\n    }\n  }\n  \n  private startMonitoring(): void {\n    // Monitor state changes every 5 seconds\n    this.checkInterval = setInterval(() => {\n      if (this.currentState) {\n        this.currentState.lastActivity = Date.now();\n        this.saveState();\n      }\n    }, 5000);\n    \n    // Handle process exit\n    process.on('exit', () => this.cleanup());\n    process.on('SIGINT', () => this.cleanup());\n    process.on('SIGTERM', () => this.cleanup());\n  }\n  \n  private cleanup(): void {\n    if (this.checkInterval) {\n      clearInterval(this.checkInterval);\n    }\n    \n    // Mark session as ended\n    if (this.currentState) {\n      this.currentState.testInProgress = false;\n      this.saveState();\n    }\n    \n    // Remove lock file\n    if (fs.existsSync(this.lockFile)) {\n      fs.unlinkSync(this.lockFile);\n    }\n  }\n  \n  // Public methods for test management\n  \n  markTestStart(testName: string, scenario: any): void {\n    if (!this.currentState) return;\n    \n    this.currentState.testInProgress = true;\n    this.currentState.currentTest = {\n      name: testName,\n      startTime: Date.now(),\n      scenario,\n      checkpoints: []\n    };\n    this.saveState();\n    \n    this.logger.info('RestartContinuity', 'Test started', { \n      test: testName,\n      sessionId: this.currentState.sessionId \n    });\n  }\n  \n  addCheckpoint(checkpoint: string): void {\n    if (!this.currentState?.currentTest) return;\n    \n    this.currentState.currentTest.checkpoints.push(checkpoint);\n    this.saveState();\n    \n    this.logger.debug('RestartContinuity', 'Checkpoint added', { \n      checkpoint,\n      total: this.currentState.currentTest.checkpoints.length \n    });\n  }\n  \n  markTestComplete(result: any): void {\n    if (!this.currentState) return;\n    \n    // Store test result in memory\n    this.memoryService.store({\n      key: `test/result/${this.currentState.sessionId}/${Date.now()}`,\n      value: {\n        test: this.currentState.currentTest,\n        result,\n        sessionId: this.currentState.sessionId,\n        completedAt: Date.now()\n      },\n      type: 'test_result'\n    });\n    \n    this.currentState.testInProgress = false;\n    this.currentState.currentTest = undefined;\n    this.saveState();\n    \n    this.logger.info('RestartContinuity', 'Test completed', { \n      sessionId: this.currentState.sessionId \n    });\n  }\n  \n  addPendingAction(type: string, params: any): void {\n    if (!this.currentState) return;\n    \n    this.currentState.pendingActions.push({\n      type,\n      params,\n      timestamp: Date.now()\n    });\n    this.saveState();\n  }\n  \n  private async resumeTest(test: any): Promise<void> {\n    try {\n      // Inject memory about resumed test\n      this.memoryService.store({\n        key: `test/resumed/${this.currentState?.sessionId}`,\n        value: {\n          test: test.name,\n          checkpoints: test.checkpoints,\n          resumedAt: Date.now(),\n          originalStart: test.startTime\n        },\n        type: 'test_resumed'\n      });\n      \n      // If test orchestrator is available, resume the test\n      if (this.testOrchestrator) {\n        // Resume from last checkpoint\n        const lastCheckpoint = test.checkpoints[test.checkpoints.length - 1];\n        this.logger.info('RestartContinuity', 'Resuming from checkpoint', { \n          checkpoint: lastCheckpoint \n        });\n        \n        // Re-run the test scenario with checkpoint data\n        await this.testOrchestrator.runScenario({\n          name: test.name,\n          params: {\n            ...test.scenario.params,\n            resumeFrom: lastCheckpoint\n          },\n          sessionId: this.currentState?.sessionId\n        });\n      }\n    } catch (error) {\n      this.logger.error('RestartContinuity', 'Error resuming test', error as Error);\n    }\n  }\n  \n  private processPendingActions(actions: Array<any>): void {\n    this.logger.info('RestartContinuity', 'Processing pending actions', { \n      count: actions.length \n    });\n    \n    // Store pending actions as memories for visibility\n    actions.forEach(action => {\n      this.memoryService.store({\n        key: `pending/action/${this.currentState?.sessionId}/${action.timestamp}`,\n        value: action,\n        type: 'pending_action'\n      });\n    });\n    \n    // Clear processed actions\n    if (this.currentState) {\n      this.currentState.pendingActions = [];\n      this.saveState();\n    }\n  }\n  \n  private injectContinuityMemory(event: RestartEvent): void {\n    // Inject detailed continuity information\n    this.memoryService.store({\n      key: 'continuity/current_state',\n      value: {\n        event,\n        state: this.currentState,\n        message: 'Claude Code was restarted. Previous state has been recovered.',\n        recommendations: [\n          'Check test results from previous session',\n          'Review any pending actions',\n          'Continue with interrupted workflow'\n        ]\n      },\n      type: 'continuity_state'\n    });\n  }\n  \n  setTestOrchestrator(orchestrator: TestOrchestrator): void {\n    this.testOrchestrator = orchestrator;\n  }\n  \n  getCurrentState(): ContinuityState | null {\n    return this.currentState;\n  }\n  \n  getRestartCount(): number {\n    return this.currentState?.restartCount || 0;\n  }\n  \n  isTestInProgress(): boolean {\n    return this.currentState?.testInProgress || false;\n  }\n  \n  stopMonitoring(): void {\n    // Stop the monitoring interval to allow process to exit\n    if (this.checkInterval) {\n      clearInterval(this.checkInterval);\n      this.checkInterval = null;\n    }\n  }\n}"],"version":3}