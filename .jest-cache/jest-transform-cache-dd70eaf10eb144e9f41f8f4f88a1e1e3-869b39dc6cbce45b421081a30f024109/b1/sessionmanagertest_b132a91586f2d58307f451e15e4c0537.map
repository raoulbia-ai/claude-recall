{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/tests/mcp/session-manager.test.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/tests/mcp/session-manager.test.ts"],"sourcesContent":["import { SessionManager } from '../../src/mcp/session-manager';\nimport { LoggingService } from '../../src/services/logging';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as os from 'os';\n\n// Mock LoggingService\njest.mock('../../src/services/logging');\n\ndescribe('SessionManager', () => {\n  let sessionManager: SessionManager;\n  let mockLogger: jest.Mocked<LoggingService>;\n  const testSessionFile = path.join(os.homedir(), '.claude-recall', 'sessions.json');\n\n  beforeEach(() => {\n    // Clear any existing session file\n    if (fs.existsSync(testSessionFile)) {\n      fs.unlinkSync(testSessionFile);\n    }\n\n    mockLogger = {\n      info: jest.fn(),\n      debug: jest.fn(),\n      error: jest.fn(),\n      warn: jest.fn(),\n      logServiceError: jest.fn()\n    } as any;\n\n    sessionManager = new SessionManager(mockLogger);\n  });\n\n  afterEach(() => {\n    sessionManager.shutdown();\n    // Clean up session file\n    if (fs.existsSync(testSessionFile)) {\n      fs.unlinkSync(testSessionFile);\n    }\n  });\n\n  describe('createSession', () => {\n    it('should create a new session with correct properties', () => {\n      const sessionId = 'test-session-123';\n      const session = sessionManager.createSession(sessionId);\n\n      expect(session).toMatchObject({\n        id: sessionId,\n        toolCalls: 0,\n        memories: []\n      });\n      expect(session.startTime).toBeDefined();\n      expect(session.lastActivity).toBeDefined();\n      expect(mockLogger.info).toHaveBeenCalledWith(\n        'SessionManager',\n        'Session created',\n        { sessionId }\n      );\n    });\n\n    it('should persist session to disk', () => {\n      const sessionId = 'test-session-123';\n      sessionManager.createSession(sessionId);\n\n      // Check file exists\n      expect(fs.existsSync(testSessionFile)).toBe(true);\n      \n      // Verify content\n      const data = JSON.parse(fs.readFileSync(testSessionFile, 'utf-8'));\n      expect(data).toHaveLength(1);\n      expect(data[0][0]).toBe(sessionId);\n    });\n  });\n\n  describe('getSession', () => {\n    it('should return existing session', () => {\n      const sessionId = 'test-session-123';\n      const createdSession = sessionManager.createSession(sessionId);\n      const retrievedSession = sessionManager.getSession(sessionId);\n\n      expect(retrievedSession).toEqual(createdSession);\n    });\n\n    it('should return undefined for non-existent session', () => {\n      const session = sessionManager.getSession('non-existent');\n      expect(session).toBeUndefined();\n    });\n  });\n\n  describe('updateSession', () => {\n    it('should update session properties', () => {\n      const sessionId = 'test-session-123';\n      sessionManager.createSession(sessionId);\n\n      sessionManager.updateSession(sessionId, {\n        metadata: { key: 'value' }\n      });\n\n      const session = sessionManager.getSession(sessionId);\n      expect(session?.metadata).toEqual({ key: 'value' });\n      expect(mockLogger.debug).toHaveBeenCalledWith(\n        'SessionManager',\n        'Session updated',\n        expect.objectContaining({ sessionId })\n      );\n    });\n\n    it('should update lastActivity timestamp', async () => {\n      const sessionId = 'test-session-123';\n      const session = sessionManager.createSession(sessionId);\n      const originalActivity = session.lastActivity;\n\n      // Wait a bit to ensure timestamp changes\n      // Note: Using real timeout instead of fake timers since we're not using jest.useFakeTimers()\n      await new Promise(resolve => setTimeout(resolve, 10));\n\n      sessionManager.updateSession(sessionId, {});\n      const updatedSession = sessionManager.getSession(sessionId);\n      \n      expect(updatedSession?.lastActivity).toBeGreaterThan(originalActivity);\n    });\n  });\n\n  describe('incrementToolCalls', () => {\n    it('should increment tool call count', () => {\n      const sessionId = 'test-session-123';\n      sessionManager.createSession(sessionId);\n\n      sessionManager.incrementToolCalls(sessionId);\n      sessionManager.incrementToolCalls(sessionId);\n\n      const session = sessionManager.getSession(sessionId);\n      expect(session?.toolCalls).toBe(2);\n    });\n  });\n\n  describe('addMemory', () => {\n    it('should add memory ID to session', () => {\n      const sessionId = 'test-session-123';\n      sessionManager.createSession(sessionId);\n\n      sessionManager.addMemory(sessionId, 'memory-1');\n      sessionManager.addMemory(sessionId, 'memory-2');\n\n      const session = sessionManager.getSession(sessionId);\n      expect(session?.memories).toEqual(['memory-1', 'memory-2']);\n    });\n  });\n\n  describe('cleanupOldSessions', () => {\n    it('should remove sessions older than 24 hours', () => {\n      const oldSessionId = 'old-session';\n      const newSessionId = 'new-session';\n\n      // Create old session\n      sessionManager.createSession(oldSessionId);\n      const oldSession = sessionManager.getSession(oldSessionId)!;\n      // Manually set lastActivity to 25 hours ago\n      oldSession.lastActivity = Date.now() - (25 * 60 * 60 * 1000);\n\n      // Create new session\n      sessionManager.createSession(newSessionId);\n\n      expect(sessionManager.getAllSessions()).toHaveLength(2);\n\n      sessionManager.cleanupOldSessions();\n\n      expect(sessionManager.getAllSessions()).toHaveLength(1);\n      expect(sessionManager.getSession(oldSessionId)).toBeUndefined();\n      expect(sessionManager.getSession(newSessionId)).toBeDefined();\n    });\n  });\n\n  describe('getActiveSessionCount', () => {\n    it('should count only recently active sessions', () => {\n      const activeId = 'active-session';\n      const inactiveId = 'inactive-session';\n\n      sessionManager.createSession(activeId);\n      sessionManager.createSession(inactiveId);\n\n      // Make one session inactive (6 minutes old)\n      const inactiveSession = sessionManager.getSession(inactiveId)!;\n      inactiveSession.lastActivity = Date.now() - (6 * 60 * 1000);\n\n      expect(sessionManager.getActiveSessionCount()).toBe(1);\n    });\n  });\n\n  describe('persistence', () => {\n    it('should load sessions from disk on startup', () => {\n      // Create and save sessions\n      const sessionId = 'persisted-session';\n      sessionManager.createSession(sessionId);\n      sessionManager.shutdown();\n\n      // Create new instance\n      const newManager = new SessionManager(mockLogger);\n      const loadedSession = newManager.getSession(sessionId);\n\n      expect(loadedSession).toBeDefined();\n      expect(loadedSession?.id).toBe(sessionId);\n      expect(mockLogger.info).toHaveBeenCalledWith(\n        'SessionManager',\n        expect.stringContaining('Loaded 1 sessions from disk')\n      );\n\n      newManager.shutdown();\n    });\n  });\n});"],"version":3}