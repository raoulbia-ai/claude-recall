d4f3039a5b151af08cff9402702d0f0b
"use strict";
/**
 * Tests for ConversationContextManager
 * Phase 4: Duplicate detection and conversation context tracking
 */
Object.defineProperty(exports, "__esModule", { value: true });
const conversation_context_manager_1 = require("../../src/services/conversation-context-manager");
describe('ConversationContextManager', () => {
    let manager;
    beforeAll(() => {
        manager = conversation_context_manager_1.ConversationContextManager.getInstance();
    });
    beforeEach(() => {
        // Clear all sessions before each test to ensure isolation
        manager.clearAllSessions();
    });
    afterAll(() => {
        // Final cleanup
        manager.clearAllSessions();
    });
    describe('recordAction', () => {
        it('should record an action successfully', () => {
            const sessionId = 'test-session-1';
            const action = 'analyze_preferences';
            const input = { query: 'test' };
            const result = { preferences: [] };
            manager.recordAction(sessionId, action, input, result);
            const recentActions = manager.getRecentActions(sessionId);
            expect(recentActions).toHaveLength(1);
            expect(recentActions[0].action).toBe(action);
            expect(recentActions[0].sessionId).toBe(sessionId);
        });
        it('should maintain action order (most recent first)', () => {
            const sessionId = 'test-session-2';
            manager.recordAction(sessionId, 'action1', {}, { result: 1 });
            manager.recordAction(sessionId, 'action2', {}, { result: 2 });
            manager.recordAction(sessionId, 'action3', {}, { result: 3 });
            const recentActions = manager.getRecentActions(sessionId);
            expect(recentActions[0].action).toBe('action3'); // Most recent
            expect(recentActions[1].action).toBe('action2');
            expect(recentActions[2].action).toBe('action1');
        });
        it('should limit actions per session to prevent memory bloat', () => {
            const sessionId = 'test-session-3';
            // Record more than MAX_ACTIONS_PER_SESSION (50)
            for (let i = 0; i < 60; i++) {
                manager.recordAction(sessionId, `action${i}`, {}, { result: i });
            }
            const allActions = manager.getRecentActions(sessionId, 100);
            expect(allActions.length).toBeLessThanOrEqual(50);
        });
    });
    describe('checkForDuplicate', () => {
        it('should detect duplicate with identical action and input', () => {
            const sessionId = 'test-session-4';
            const action = 'analyze_preferences';
            const input = { conversation: 'Can you analyze our conversation for preferences?' };
            // First call - record it
            manager.recordAction(sessionId, action, input, { preferences: [] });
            // Second call - should detect duplicate
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(true);
            expect(duplicateCheck.previousAction).toBeDefined();
            expect(duplicateCheck.suggestion).toBeDefined();
            expect(duplicateCheck.turnsSince).toBeDefined();
        });
        it('should NOT detect duplicate with different action', () => {
            const sessionId = 'test-session-5';
            const input = { query: 'test' };
            manager.recordAction(sessionId, 'action1', input, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, 'action2', input);
            expect(duplicateCheck.isDuplicate).toBe(false);
        });
        it('should NOT detect duplicate with different input', () => {
            const sessionId = 'test-session-6';
            const action = 'search_memories';
            manager.recordAction(sessionId, action, { query: 'first query' }, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, { query: 'different query' });
            expect(duplicateCheck.isDuplicate).toBe(false);
        });
        it('should NOT detect duplicate if outside detection window', () => {
            const sessionId = 'test-session-7';
            const action = 'test_action';
            const input = { data: 'test' };
            // Record 5 actions to move the first one outside the window (window = 3)
            manager.recordAction(sessionId, action, input, {});
            manager.recordAction(sessionId, 'other1', {}, {});
            manager.recordAction(sessionId, 'other2', {}, {});
            manager.recordAction(sessionId, 'other3', {}, {});
            manager.recordAction(sessionId, 'other4', {}, {});
            // Now check for duplicate - should not find it (4 turns ago, outside window of 3)
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(false);
        });
        it('should provide helpful suggestion when duplicate detected', () => {
            const sessionId = 'test-session-8';
            const action = 'analyze_preferences';
            const input = { conversation: 'test' };
            manager.recordAction(sessionId, action, input, { preferences: [] });
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.suggestion).toContain('performed');
            expect(duplicateCheck.suggestion).toBeDefined();
        });
    });
    describe('getRecentActions', () => {
        it('should return empty array for non-existent session', () => {
            const actions = manager.getRecentActions('non-existent-session');
            expect(actions).toEqual([]);
        });
        it('should respect limit parameter', () => {
            const sessionId = 'test-session-9';
            for (let i = 0; i < 20; i++) {
                manager.recordAction(sessionId, `action${i}`, {}, {});
            }
            const actions = manager.getRecentActions(sessionId, 5);
            expect(actions).toHaveLength(5);
        });
    });
    describe('getRecentResult', () => {
        it('should return most recent result for given action', () => {
            const sessionId = 'test-session-10';
            const action = 'test_action';
            manager.recordAction(sessionId, action, {}, { value: 1 });
            manager.recordAction(sessionId, 'other_action', {}, { value: 99 });
            manager.recordAction(sessionId, action, {}, { value: 2 });
            const result = manager.getRecentResult(sessionId, action);
            expect(result).toEqual({ value: 2 }); // Most recent
        });
        it('should return null if action not found', () => {
            const sessionId = 'test-session-11';
            const result = manager.getRecentResult(sessionId, 'non_existent_action');
            expect(result).toBeNull();
        });
    });
    describe('clearSession', () => {
        it('should clear all data for a session', () => {
            const sessionId = 'test-session-12';
            manager.recordAction(sessionId, 'action1', {}, {});
            manager.recordAction(sessionId, 'action2', {}, {});
            expect(manager.getRecentActions(sessionId)).toHaveLength(2);
            manager.clearSession(sessionId);
            expect(manager.getRecentActions(sessionId)).toHaveLength(0);
        });
    });
    describe('cleanup', () => {
        it('should remove timed-out sessions', async () => {
            const sessionId = 'test-session-13';
            manager.recordAction(sessionId, 'action1', {}, {});
            const statsBefore = manager.getStats();
            expect(statsBefore.activeSessions).toBeGreaterThan(0);
            // Wait for session to timeout (this would take 30 minutes in production)
            // For testing, we'll just call cleanup and verify it works
            manager.cleanup();
            // In a real test, we'd mock the timestamp to simulate timeout
            // For now, just verify cleanup doesn't error
            const statsAfter = manager.getStats();
            expect(statsAfter.activeSessions).toBeGreaterThanOrEqual(0);
        });
    });
    describe('getStats', () => {
        it('should return correct statistics', () => {
            const session1 = 'test-session-14';
            const session2 = 'test-session-15';
            manager.recordAction(session1, 'action1', {}, {});
            manager.recordAction(session1, 'action2', {}, {});
            manager.recordAction(session2, 'action3', {}, {});
            const stats = manager.getStats();
            expect(stats.activeSessions).toBe(2);
            expect(stats.totalActions).toBe(3);
            expect(stats.averageActionsPerSession).toBe(1.5);
        });
    });
    describe('Edge cases', () => {
        it('should handle string input normalization', () => {
            const sessionId = 'test-session-16';
            const action = 'test_action';
            // Record with extra whitespace
            manager.recordAction(sessionId, action, '  Test   String  ', {});
            // Check with normalized string
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, 'Test String');
            expect(duplicateCheck.isDuplicate).toBe(true);
        });
        it('should handle case-insensitive action matching', () => {
            const sessionId = 'test-session-17';
            manager.recordAction(sessionId, 'ANALYZE_PREFERENCES', { query: 'test' }, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, 'analyze_preferences', { query: 'test' });
            expect(duplicateCheck.isDuplicate).toBe(true);
        });
        it('should handle object input with relevant fields', () => {
            const sessionId = 'test-session-18';
            const action = 'search';
            const input1 = { query: 'test query', irrelevant: 'data' };
            const input2 = { query: 'test query', differentIrrelevant: 'data' };
            manager.recordAction(sessionId, action, input1, {});
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input2);
            expect(duplicateCheck.isDuplicate).toBe(true);
        });
    });
    describe('Real-world scenario: Duplicate question detection', () => {
        it('should detect when user asks same question twice in a row', () => {
            const sessionId = 'user-session-1';
            const action = 'mcp__claude-recall__store_preferences';
            const input = {
                conversation: 'Can you analyze our conversation for preferences?'
            };
            const result = {
                stored: true,
                preferences: [
                    { key: 'testing_framework', value: 'jest' }
                ]
            };
            // User asks first time
            manager.recordAction(sessionId, action, input, result);
            // User asks same question immediately
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(true);
            expect(duplicateCheck.turnsSince).toBe(0);
            expect(duplicateCheck.suggestion).toContain('just performed');
            expect(duplicateCheck.previousAction?.result).toEqual(result);
        });
        it('should handle multiple different actions between duplicates', () => {
            const sessionId = 'user-session-2';
            const action = 'analyze';
            const input = { query: 'analyze this' };
            // First action
            manager.recordAction(sessionId, action, input, { result: 'first' });
            // Different actions in between
            manager.recordAction(sessionId, 'other1', {}, {});
            manager.recordAction(sessionId, 'other2', {}, {});
            // Duplicate within window
            const duplicateCheck = manager.checkForDuplicate(sessionId, action, input);
            expect(duplicateCheck.isDuplicate).toBe(true);
            expect(duplicateCheck.turnsSince).toBe(2);
            expect(duplicateCheck.suggestion).toContain('2 turns ago');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy91bml0L2NvbnZlcnNhdGlvbi1jb250ZXh0LW1hbmFnZXIudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQUVILGtHQUE2RjtBQUU3RixRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQzFDLElBQUksT0FBbUMsQ0FBQztJQUV4QyxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxHQUFHLHlEQUEwQixDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JELENBQUMsQ0FBQyxDQUFDO0lBRUgsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLDBEQUEwRDtRQUMxRCxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUM3QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDWixnQkFBZ0I7UUFDaEIsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUM1QixFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQzlDLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDO1lBQ25DLE1BQU0sTUFBTSxHQUFHLHFCQUFxQixDQUFDO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDO1lBQ2hDLE1BQU0sTUFBTSxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDO1lBRW5DLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFdkQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzFELE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMs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QUFDO1FBRUgsRUFBRSxDQUFDLDZEQUE2RCxFQUFFLEdBQUcsRUFBRTtZQUNyRSxNQUFNLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQztZQUNuQyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUM7WUFDekIsTUFBTSxLQUFLLEdBQUcsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLENBQUM7WUFFeEMsZUFBZTtZQUNmLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUVwRSwrQkFBK0I7WUFDL0IsT0FBTyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNsRCxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRWxELDBCQUEwQjtZQUMxQixNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztZQUUzRSxNQUFNLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5QyxNQUFNLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy91bml0L2NvbnZlcnNhdGlvbi1jb250ZXh0LW1hbmFnZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlc3RzIGZvciBDb252ZXJzYXRpb25Db250ZXh0TWFuYWdlclxuICogUGhhc2UgNDogRHVwbGljYXRlIGRldGVjdGlvbiBhbmQgY29udmVyc2F0aW9uIGNvbnRleHQgdHJhY2tpbmdcbiAqL1xuXG5pbXBvcnQgeyBDb252ZXJzYXRpb25Db250ZXh0TWFuYWdlciB9IGZyb20gJy4uLy4uL3NyYy9zZXJ2aWNlcy9jb252ZXJzYXRpb24tY29udGV4dC1tYW5hZ2VyJztcblxuZGVzY3JpYmUoJ0NvbnZlcnNhdGlvbkNvbnRleHRNYW5hZ2VyJywgKCkgPT4ge1xuICBsZXQgbWFuYWdlcjogQ29udmVyc2F0aW9uQ29udGV4dE1hbmFnZXI7XG5cbiAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICBtYW5hZ2VyID0gQ29udmVyc2F0aW9uQ29udGV4dE1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgLy8gQ2xlYXIgYWxsIHNlc3Npb25zIGJlZm9yZSBlYWNoIHRlc3QgdG8gZW5zdXJlIGlzb2xhdGlvblxuICAgIG1hbmFnZXIuY2xlYXJBbGxTZXNzaW9ucygpO1xuICB9KTtcblxuICBhZnRlckFsbCgoKSA9PiB7XG4gICAgLy8gRmluYWwgY2xlYW51cFxuICAgIG1hbmFnZXIuY2xlYXJBbGxTZXNzaW9ucygpO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVjb3JkQWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmVjb3JkIGFuIGFjdGlvbiBzdWNjZXNzZnVsbHknLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTEnO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ2FuYWx5emVfcHJlZmVyZW5jZXMnO1xuICAgICAgY29uc3QgaW5wdXQgPSB7IHF1ZXJ5OiAndGVzdCcgfTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHsgcHJlZmVyZW5jZXM6IFtdIH07XG5cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCwgcmVzdWx0KTtcblxuICAgICAgY29uc3QgcmVjZW50QWN0aW9ucyA9IG1hbmFnZXIuZ2V0UmVjZW50QWN0aW9ucyhzZXNzaW9uSWQpO1xuICAgICAgZXhwZWN0KHJlY2VudEFjdGlvbnMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChyZWNlbnRBY3Rpb25zWzBdLmFjdGlvbikudG9CZShhY3Rpb24pO1xuICAgICAgZXhwZWN0KHJlY2VudEFjdGlvbnNbMF0uc2Vzc2lvbklkKS50b0JlKHNlc3Npb25JZCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG1haW50YWluIGFjdGlvbiBvcmRlciAobW9zdCByZWNlbnQgZmlyc3QpJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0yJztcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnYWN0aW9uMScsIHt9LCB7IHJlc3VsdDogMSB9KTtcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ2FjdGlvbjInLCB7fSwgeyByZXN1bHQ6IDIgfSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdhY3Rpb24zJywge30sIHsgcmVzdWx0OiAzIH0pO1xuXG4gICAgICBjb25zdCByZWNlbnRBY3Rpb25zID0gbWFuYWdlci5nZXRSZWNlbnRBY3Rpb25zKHNlc3Npb25JZCk7XG4gICAgICBleHBlY3QocmVjZW50QWN0aW9uc1swXS5hY3Rpb24pLnRvQmUoJ2FjdGlvbjMnKTsgLy8gTW9zdCByZWNlbnRcbiAgICAgIGV4cGVjdChyZWNlbnRBY3Rpb25zWzFdLmFjdGlvbikudG9CZSgnYWN0aW9uMicpO1xuICAgICAgZXhwZWN0KHJlY2VudEFjdGlvbnNbMl0uYWN0aW9uKS50b0JlKCdhY3Rpb24xJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxpbWl0IGFjdGlvbnMgcGVyIHNlc3Npb24gdG8gcHJldmVudCBtZW1vcnkgYmxvYXQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTMnO1xuXG4gICAgICAvLyBSZWNvcmQgbW9yZSB0aGFuIE1BWF9BQ1RJT05TX1BFUl9TRVNTSU9OICg1MClcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjA7IGkrKykge1xuICAgICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGBhY3Rpb24ke2l9YCwge30sIHsgcmVzdWx0OiBpIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhbGxBY3Rpb25zID0gbWFuYWdlci5nZXRSZWNlbnRBY3Rpb25zKHNlc3Npb25JZCwgMTAwKTtcbiAgICAgIGV4cGVjdChhbGxBY3Rpb25zLmxlbmd0aCkudG9CZUxlc3NUaGFuT3JFcXVhbCg1MCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjaGVja0ZvckR1cGxpY2F0ZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRldGVjdCBkdXBsaWNhdGUgd2l0aCBpZGVudGljYWwgYWN0aW9uIGFuZCBpbnB1dCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tNCc7XG4gICAgICBjb25zdCBhY3Rpb24gPSAnYW5hbHl6ZV9wcmVmZXJlbmNlcyc7XG4gICAgICBjb25zdCBpbnB1dCA9IHsgY29udmVyc2F0aW9uOiAnQ2FuIHlvdSBhbmFseXplIG91ciBjb252ZXJzYXRpb24gZm9yIHByZWZlcmVuY2VzPycgfTtcblxuICAgICAgLy8gRmlyc3QgY2FsbCAtIHJlY29yZCBpdFxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIGlucHV0LCB7IHByZWZlcmVuY2VzOiBbXSB9KTtcblxuICAgICAgLy8gU2Vjb25kIGNhbGwgLSBzaG91bGQgZGV0ZWN0IGR1cGxpY2F0ZVxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5wcmV2aW91c0FjdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5zdWdnZXN0aW9uKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLnR1cm5zU2luY2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIE5PVCBkZXRlY3QgZHVwbGljYXRlIHdpdGggZGlmZmVyZW50IGFjdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tNSc7XG4gICAgICBjb25zdCBpbnB1dCA9IHsgcXVlcnk6ICd0ZXN0JyB9O1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdhY3Rpb24xJywgaW5wdXQsIHt9KTtcblxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgJ2FjdGlvbjInLCBpbnB1dCk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIE5PVCBkZXRlY3QgZHVwbGljYXRlIHdpdGggZGlmZmVyZW50IGlucHV0JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi02JztcbiAgICAgIGNvbnN0IGFjdGlvbiA9ICdzZWFyY2hfbWVtb3JpZXMnO1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwgeyBxdWVyeTogJ2ZpcnN0IHF1ZXJ5JyB9LCB7fSk7XG5cbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgeyBxdWVyeTogJ2RpZmZlcmVudCBxdWVyeScgfSk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIE5PVCBkZXRlY3QgZHVwbGljYXRlIGlmIG91dHNpZGUgZGV0ZWN0aW9uIHdpbmRvdycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tNyc7XG4gICAgICBjb25zdCBhY3Rpb24gPSAndGVzdF9hY3Rpb24nO1xuICAgICAgY29uc3QgaW5wdXQgPSB7IGRhdGE6ICd0ZXN0JyB9O1xuXG4gICAgICAvLyBSZWNvcmQgNSBhY3Rpb25zIHRvIG1vdmUgdGhlIGZpcnN0IG9uZSBvdXRzaWRlIHRoZSB3aW5kb3cgKHdpbmRvdyA9IDMpXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQsIHt9KTtcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ290aGVyMScsIHt9LCB7fSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdvdGhlcjInLCB7fSwge30pO1xuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCAnb3RoZXIzJywge30sIHt9KTtcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ290aGVyNCcsIHt9LCB7fSk7XG5cbiAgICAgIC8vIE5vdyBjaGVjayBmb3IgZHVwbGljYXRlIC0gc2hvdWxkIG5vdCBmaW5kIGl0ICg0IHR1cm5zIGFnbywgb3V0c2lkZSB3aW5kb3cgb2YgMylcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgaW5wdXQpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIGhlbHBmdWwgc3VnZ2VzdGlvbiB3aGVuIGR1cGxpY2F0ZSBkZXRlY3RlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tOCc7XG4gICAgICBjb25zdCBhY3Rpb24gPSAnYW5hbHl6ZV9wcmVmZXJlbmNlcyc7XG4gICAgICBjb25zdCBpbnB1dCA9IHsgY29udmVyc2F0aW9uOiAndGVzdCcgfTtcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIGlucHV0LCB7IHByZWZlcmVuY2VzOiBbXSB9KTtcblxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5zdWdnZXN0aW9uKS50b0NvbnRhaW4oJ3BlcmZvcm1lZCcpO1xuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLnN1Z2dlc3Rpb24pLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRSZWNlbnRBY3Rpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGVtcHR5IGFycmF5IGZvciBub24tZXhpc3RlbnQgc2Vzc2lvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGFjdGlvbnMgPSBtYW5hZ2VyLmdldFJlY2VudEFjdGlvbnMoJ25vbi1leGlzdGVudC1zZXNzaW9uJyk7XG4gICAgICBleHBlY3QoYWN0aW9ucykudG9FcXVhbChbXSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlc3BlY3QgbGltaXQgcGFyYW1ldGVyJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi05JztcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyMDsgaSsrKSB7XG4gICAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYGFjdGlvbiR7aX1gLCB7fSwge30pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhY3Rpb25zID0gbWFuYWdlci5nZXRSZWNlbnRBY3Rpb25zKHNlc3Npb25JZCwgNSk7XG4gICAgICBleHBlY3QoYWN0aW9ucykudG9IYXZlTGVuZ3RoKDUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0UmVjZW50UmVzdWx0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIG1vc3QgcmVjZW50IHJlc3VsdCBmb3IgZ2l2ZW4gYWN0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0xMCc7XG4gICAgICBjb25zdCBhY3Rpb24gPSAndGVzdF9hY3Rpb24nO1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwge30sIHsgdmFsdWU6IDEgfSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdvdGhlcl9hY3Rpb24nLCB7fSwgeyB2YWx1ZTogOTkgfSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsIGFjdGlvbiwge30sIHsgdmFsdWU6IDIgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIuZ2V0UmVjZW50UmVzdWx0KHNlc3Npb25JZCwgYWN0aW9uKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoeyB2YWx1ZTogMiB9KTsgLy8gTW9zdCByZWNlbnRcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgaWYgYWN0aW9uIG5vdCBmb3VuZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMTEnO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBtYW5hZ2VyLmdldFJlY2VudFJlc3VsdChzZXNzaW9uSWQsICdub25fZXhpc3RlbnRfYWN0aW9uJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2xlYXJTZXNzaW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2xlYXIgYWxsIGRhdGEgZm9yIGEgc2Vzc2lvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMTInO1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdhY3Rpb24xJywge30sIHt9KTtcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ2FjdGlvbjInLCB7fSwge30pO1xuXG4gICAgICBleHBlY3QobWFuYWdlci5nZXRSZWNlbnRBY3Rpb25zKHNlc3Npb25JZCkpLnRvSGF2ZUxlbmd0aCgyKTtcblxuICAgICAgbWFuYWdlci5jbGVhclNlc3Npb24oc2Vzc2lvbklkKTtcblxuICAgICAgZXhwZWN0KG1hbmFnZXIuZ2V0UmVjZW50QWN0aW9ucyhzZXNzaW9uSWQpKS50b0hhdmVMZW5ndGgoMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjbGVhbnVwJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmVtb3ZlIHRpbWVkLW91dCBzZXNzaW9ucycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9ICd0ZXN0LXNlc3Npb24tMTMnO1xuXG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdhY3Rpb24xJywge30sIHt9KTtcblxuICAgICAgY29uc3Qgc3RhdHNCZWZvcmUgPSBtYW5hZ2VyLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHNCZWZvcmUuYWN0aXZlU2Vzc2lvbnMpLnRvQmVHcmVhdGVyVGhhbigwKTtcblxuICAgICAgLy8gV2FpdCBmb3Igc2Vzc2lvbiB0byB0aW1lb3V0ICh0aGlzIHdvdWxkIHRha2UgMzAgbWludXRlcyBpbiBwcm9kdWN0aW9uKVxuICAgICAgLy8gRm9yIHRlc3RpbmcsIHdlJ2xsIGp1c3QgY2FsbCBjbGVhbnVwIGFuZCB2ZXJpZnkgaXQgd29ya3NcbiAgICAgIG1hbmFnZXIuY2xlYW51cCgpO1xuXG4gICAgICAvLyBJbiBhIHJlYWwgdGVzdCwgd2UnZCBtb2NrIHRoZSB0aW1lc3RhbXAgdG8gc2ltdWxhdGUgdGltZW91dFxuICAgICAgLy8gRm9yIG5vdywganVzdCB2ZXJpZnkgY2xlYW51cCBkb2Vzbid0IGVycm9yXG4gICAgICBjb25zdCBzdGF0c0FmdGVyID0gbWFuYWdlci5nZXRTdGF0cygpO1xuICAgICAgZXhwZWN0KHN0YXRzQWZ0ZXIuYWN0aXZlU2Vzc2lvbnMpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRTdGF0cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IHN0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uMSA9ICd0ZXN0LXNlc3Npb24tMTQnO1xuICAgICAgY29uc3Qgc2Vzc2lvbjIgPSAndGVzdC1zZXNzaW9uLTE1JztcblxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbjEsICdhY3Rpb24xJywge30sIHt9KTtcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb24xLCAnYWN0aW9uMicsIHt9LCB7fSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uMiwgJ2FjdGlvbjMnLCB7fSwge30pO1xuXG4gICAgICBjb25zdCBzdGF0cyA9IG1hbmFnZXIuZ2V0U3RhdHMoKTtcblxuICAgICAgZXhwZWN0KHN0YXRzLmFjdGl2ZVNlc3Npb25zKS50b0JlKDIpO1xuICAgICAgZXhwZWN0KHN0YXRzLnRvdGFsQWN0aW9ucykudG9CZSgzKTtcbiAgICAgIGV4cGVjdChzdGF0cy5hdmVyYWdlQWN0aW9uc1BlclNlc3Npb24pLnRvQmUoMS41KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0VkZ2UgY2FzZXMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyaW5nIGlucHV0IG5vcm1hbGl6YXRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndGVzdC1zZXNzaW9uLTE2JztcbiAgICAgIGNvbnN0IGFjdGlvbiA9ICd0ZXN0X2FjdGlvbic7XG5cbiAgICAgIC8vIFJlY29yZCB3aXRoIGV4dHJhIHdoaXRlc3BhY2VcbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYWN0aW9uLCAnICBUZXN0ICAgU3RyaW5nICAnLCB7fSk7XG5cbiAgICAgIC8vIENoZWNrIHdpdGggbm9ybWFsaXplZCBzdHJpbmdcbiAgICAgIGNvbnN0IGR1cGxpY2F0ZUNoZWNrID0gbWFuYWdlci5jaGVja0ZvckR1cGxpY2F0ZShzZXNzaW9uSWQsIGFjdGlvbiwgJ1Rlc3QgU3RyaW5nJyk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGNhc2UtaW5zZW5zaXRpdmUgYWN0aW9uIG1hdGNoaW5nJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0xNyc7XG5cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ0FOQUxZWkVfUFJFRkVSRU5DRVMnLCB7IHF1ZXJ5OiAndGVzdCcgfSwge30pO1xuXG4gICAgICBjb25zdCBkdXBsaWNhdGVDaGVjayA9IG1hbmFnZXIuY2hlY2tGb3JEdXBsaWNhdGUoc2Vzc2lvbklkLCAnYW5hbHl6ZV9wcmVmZXJlbmNlcycsIHsgcXVlcnk6ICd0ZXN0JyB9KTtcblxuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLmlzRHVwbGljYXRlKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgb2JqZWN0IGlucHV0IHdpdGggcmVsZXZhbnQgZmllbGRzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gJ3Rlc3Qtc2Vzc2lvbi0xOCc7XG4gICAgICBjb25zdCBhY3Rpb24gPSAnc2VhcmNoJztcblxuICAgICAgY29uc3QgaW5wdXQxID0geyBxdWVyeTogJ3Rlc3QgcXVlcnknLCBpcnJlbGV2YW50OiAnZGF0YScgfTtcbiAgICAgIGNvbnN0IGlucHV0MiA9IHsgcXVlcnk6ICd0ZXN0IHF1ZXJ5JywgZGlmZmVyZW50SXJyZWxldmFudDogJ2RhdGEnIH07XG5cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dDEsIHt9KTtcblxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dDIpO1xuXG4gICAgICBleHBlY3QoZHVwbGljYXRlQ2hlY2suaXNEdXBsaWNhdGUpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZWFsLXdvcmxkIHNjZW5hcmlvOiBEdXBsaWNhdGUgcXVlc3Rpb24gZGV0ZWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGV0ZWN0IHdoZW4gdXNlciBhc2tzIHNhbWUgcXVlc3Rpb24gdHdpY2UgaW4gYSByb3cnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndXNlci1zZXNzaW9uLTEnO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ21jcF9fY2xhdWRlLXJlY2FsbF9fc3RvcmVfcHJlZmVyZW5jZXMnO1xuICAgICAgY29uc3QgaW5wdXQgPSB7XG4gICAgICAgIGNvbnZlcnNhdGlvbjogJ0NhbiB5b3UgYW5hbHl6ZSBvdXIgY29udmVyc2F0aW9uIGZvciBwcmVmZXJlbmNlcz8nXG4gICAgICB9O1xuICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICBzdG9yZWQ6IHRydWUsXG4gICAgICAgIHByZWZlcmVuY2VzOiBbXG4gICAgICAgICAgeyBrZXk6ICd0ZXN0aW5nX2ZyYW1ld29yaycsIHZhbHVlOiAnamVzdCcgfVxuICAgICAgICBdXG4gICAgICB9O1xuXG4gICAgICAvLyBVc2VyIGFza3MgZmlyc3QgdGltZVxuICAgICAgbWFuYWdlci5yZWNvcmRBY3Rpb24oc2Vzc2lvbklkLCBhY3Rpb24sIGlucHV0LCByZXN1bHQpO1xuXG4gICAgICAvLyBVc2VyIGFza3Mgc2FtZSBxdWVzdGlvbiBpbW1lZGlhdGVseVxuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay50dXJuc1NpbmNlKS50b0JlKDApO1xuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLnN1Z2dlc3Rpb24pLnRvQ29udGFpbignanVzdCBwZXJmb3JtZWQnKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5wcmV2aW91c0FjdGlvbj8ucmVzdWx0KS50b0VxdWFsKHJlc3VsdCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtdWx0aXBsZSBkaWZmZXJlbnQgYWN0aW9ucyBiZXR3ZWVuIGR1cGxpY2F0ZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXNzaW9uSWQgPSAndXNlci1zZXNzaW9uLTInO1xuICAgICAgY29uc3QgYWN0aW9uID0gJ2FuYWx5emUnO1xuICAgICAgY29uc3QgaW5wdXQgPSB7IHF1ZXJ5OiAnYW5hbHl6ZSB0aGlzJyB9O1xuXG4gICAgICAvLyBGaXJzdCBhY3Rpb25cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCwgeyByZXN1bHQ6ICdmaXJzdCcgfSk7XG5cbiAgICAgIC8vIERpZmZlcmVudCBhY3Rpb25zIGluIGJldHdlZW5cbiAgICAgIG1hbmFnZXIucmVjb3JkQWN0aW9uKHNlc3Npb25JZCwgJ290aGVyMScsIHt9LCB7fSk7XG4gICAgICBtYW5hZ2VyLnJlY29yZEFjdGlvbihzZXNzaW9uSWQsICdvdGhlcjInLCB7fSwge30pO1xuXG4gICAgICAvLyBEdXBsaWNhdGUgd2l0aGluIHdpbmRvd1xuICAgICAgY29uc3QgZHVwbGljYXRlQ2hlY2sgPSBtYW5hZ2VyLmNoZWNrRm9yRHVwbGljYXRlKHNlc3Npb25JZCwgYWN0aW9uLCBpbnB1dCk7XG5cbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay5pc0R1cGxpY2F0ZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChkdXBsaWNhdGVDaGVjay50dXJuc1NpbmNlKS50b0JlKDIpO1xuICAgICAgZXhwZWN0KGR1cGxpY2F0ZUNoZWNrLnN1Z2dlc3Rpb24pLnRvQ29udGFpbignMiB0dXJucyBhZ28nKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==