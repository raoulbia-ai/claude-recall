6fe583d61124e9bd297ed0dea10b6a76
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObservableDatabase = void 0;
class ObservableDatabase {
    constructor(memoryService) {
        this.memoryService = memoryService;
        this.changes = [];
        this.isTracking = false;
        this.originalMethods = new Map();
    }
    startTracking() {
        if (this.isTracking) {
            return;
        }
        this.isTracking = true;
        this.changes = [];
        // Intercept memory service methods
        this.interceptMethod('store', this.trackStore.bind(this));
        this.interceptMethod('retrieve', this.trackRetrieve.bind(this));
        this.interceptMethod('search', this.trackSearch.bind(this));
        this.interceptMethod('update', this.trackUpdate.bind(this));
        this.interceptMethod('delete', this.trackDelete.bind(this));
    }
    stopTracking() {
        if (!this.isTracking) {
            return;
        }
        this.isTracking = false;
        // Restore original methods
        for (const [methodName, originalMethod] of this.originalMethods) {
            this.memoryService[methodName] = originalMethod;
        }
        this.originalMethods.clear();
    }
    getChanges() {
        return [...this.changes];
    }
    clearChanges() {
        this.changes = [];
    }
    getChangesSince(timestamp) {
        return this.changes.filter(change => change.timestamp >= timestamp);
    }
    getChangesByOperation(operation) {
        return this.changes.filter(change => change.operation === operation);
    }
    getChangesByTable(table) {
        return this.changes.filter(change => change.table === table);
    }
    interceptMethod(methodName, tracker) {
        const service = this.memoryService;
        if (!service[methodName]) {
            return;
        }
        // Store original method
        this.originalMethods.set(methodName, service[methodName]);
        // Replace with tracking wrapper
        service[methodName] = async (...args) => {
            const startTime = Date.now();
            const original = this.originalMethods.get(methodName);
            try {
                // Call original method
                const result = await original.apply(service, args);
                // Track the operation
                tracker(args, result, null);
                return result;
            }
            catch (error) {
                // Track the error
                tracker(args, null, error);
                throw error;
            }
        };
    }
    trackStore(args, result, error) {
        if (!this.isTracking)
            return;
        const [request] = args;
        this.changes.push({
            operation: 'INSERT',
            table: 'memories',
            recordId: request?.key,
            newValue: request?.value,
            timestamp: Date.now(),
            sessionId: request?.context?.sessionId
        });
    }
    trackRetrieve(args, result, error) {
        if (!this.isTracking)
            return;
        const [key] = args;
        this.changes.push({
            operation: 'SELECT',
            table: 'memories',
            recordId: key,
            newValue: result,
            timestamp: Date.now()
        });
    }
    trackSearch(args, result, error) {
        if (!this.isTracking)
            return;
        const [query] = args;
        this.changes.push({
            operation: 'SELECT',
            table: 'memories',
            newValue: {
                query,
                resultCount: result?.length || 0
            },
            timestamp: Date.now()
        });
    }
    trackUpdate(args, result, error) {
        if (!this.isTracking)
            return;
        const [key, updates] = args;
        this.changes.push({
            operation: 'UPDATE',
            table: 'memories',
            recordId: key,
            newValue: updates,
            timestamp: Date.now()
        });
    }
    trackDelete(args, result, error) {
        if (!this.isTracking)
            return;
        const [key] = args;
        this.changes.push({
            operation: 'DELETE',
            table: 'memories',
            recordId: key,
            oldValue: result,
            timestamp: Date.now()
        });
    }
    // Analysis methods
    getStatistics() {
        const stats = {
            totalChanges: this.changes.length,
            byOperation: {},
            byTable: {},
            averagePerMinute: 0
        };
        if (this.changes.length === 0) {
            return stats;
        }
        // Count by operation
        for (const change of this.changes) {
            stats.byOperation[change.operation] = (stats.byOperation[change.operation] || 0) + 1;
            stats.byTable[change.table] = (stats.byTable[change.table] || 0) + 1;
        }
        // Calculate average per minute
        const firstChange = this.changes[0].timestamp;
        const lastChange = this.changes[this.changes.length - 1].timestamp;
        const durationMinutes = (lastChange - firstChange) / 60000;
        if (durationMinutes > 0) {
            stats.averagePerMinute = this.changes.length / durationMinutes;
        }
        return stats;
    }
    exportChanges() {
        return JSON.stringify(this.changes, null, 2);
    }
    importChanges(json) {
        try {
            const imported = JSON.parse(json);
            if (Array.isArray(imported)) {
                this.changes = imported;
            }
        }
        catch (error) {
            console.error('Failed to import changes:', error);
        }
    }
}
exports.ObservableDatabase = ObservableDatabase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvdGVzdGluZy9vYnNlcnZhYmxlLWRhdGFiYXNlLnRzIiwibWFwcGluZ3MiOiI7OztBQVlBLE1BQWEsa0JBQWtCO0lBSzdCLFlBQW9CLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBSnhDLFlBQU8sR0FBcUIsRUFBRSxDQUFDO1FBQy9CLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFDbkIsb0JBQWUsR0FBMEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUVSLENBQUM7SUFFcEQsYUFBYTtRQUNYLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3BCLE9BQU87UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFFbEIsbUNBQW1DO1FBQ25DLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDNUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsWUFBWTtRQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFF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RjtBQW5ORCxnREFtTkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvdGVzdGluZy9vYnNlcnZhYmxlLWRhdGFiYXNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1lbW9yeVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9tZW1vcnknO1xuXG5leHBvcnQgaW50ZXJmYWNlIERhdGFiYXNlQ2hhbmdlIHtcbiAgb3BlcmF0aW9uOiAnSU5TRVJUJyB8ICdVUERBVEUnIHwgJ0RFTEVURScgfCAnU0VMRUNUJztcbiAgdGFibGU6IHN0cmluZztcbiAgcmVjb3JkSWQ/OiBzdHJpbmc7XG4gIG9sZFZhbHVlPzogYW55O1xuICBuZXdWYWx1ZT86IGFueTtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHNlc3Npb25JZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIE9ic2VydmFibGVEYXRhYmFzZSB7XG4gIHByaXZhdGUgY2hhbmdlczogRGF0YWJhc2VDaGFuZ2VbXSA9IFtdO1xuICBwcml2YXRlIGlzVHJhY2tpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBvcmlnaW5hbE1ldGhvZHM6IE1hcDxzdHJpbmcsIEZ1bmN0aW9uPiA9IG5ldyBNYXAoKTtcbiAgXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWVtb3J5U2VydmljZTogTWVtb3J5U2VydmljZSkge31cbiAgXG4gIHN0YXJ0VHJhY2tpbmcoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNUcmFja2luZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLmlzVHJhY2tpbmcgPSB0cnVlO1xuICAgIHRoaXMuY2hhbmdlcyA9IFtdO1xuICAgIFxuICAgIC8vIEludGVyY2VwdCBtZW1vcnkgc2VydmljZSBtZXRob2RzXG4gICAgdGhpcy5pbnRlcmNlcHRNZXRob2QoJ3N0b3JlJywgdGhpcy50cmFja1N0b3JlLmJpbmQodGhpcykpO1xuICAgIHRoaXMuaW50ZXJjZXB0TWV0aG9kKCdyZXRyaWV2ZScsIHRoaXMudHJhY2tSZXRyaWV2ZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmludGVyY2VwdE1ldGhvZCgnc2VhcmNoJywgdGhpcy50cmFja1NlYXJjaC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmludGVyY2VwdE1ldGhvZCgndXBkYXRlJywgdGhpcy50cmFja1VwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLmludGVyY2VwdE1ldGhvZCgnZGVsZXRlJywgdGhpcy50cmFja0RlbGV0ZS5iaW5kKHRoaXMpKTtcbiAgfVxuICBcbiAgc3RvcFRyYWNraW5nKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pc1RyYWNraW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIFxuICAgIHRoaXMuaXNUcmFja2luZyA9IGZhbHNlO1xuICAgIFxuICAgIC8vIFJlc3RvcmUgb3JpZ2luYWwgbWV0aG9kc1xuICAgIGZvciAoY29uc3QgW21ldGhvZE5hbWUsIG9yaWdpbmFsTWV0aG9kXSBvZiB0aGlzLm9yaWdpbmFsTWV0aG9kcykge1xuICAgICAgKHRoaXMubWVtb3J5U2VydmljZSBhcyBhbnkpW21ldGhvZE5hbWVdID0gb3JpZ2luYWxNZXRob2Q7XG4gICAgfVxuICAgIHRoaXMub3JpZ2luYWxNZXRob2RzLmNsZWFyKCk7XG4gIH1cbiAgXG4gIGdldENoYW5nZXMoKTogRGF0YWJhc2VDaGFuZ2VbXSB7XG4gICAgcmV0dXJuIFsuLi50aGlzLmNoYW5nZXNdO1xuICB9XG4gIFxuICBjbGVhckNoYW5nZXMoKTogdm9pZCB7XG4gICAgdGhpcy5jaGFuZ2VzID0gW107XG4gIH1cbiAgXG4gIGdldENoYW5nZXNTaW5jZSh0aW1lc3RhbXA6IG51bWJlcik6IERhdGFiYXNlQ2hhbmdlW10ge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZXMuZmlsdGVyKGNoYW5nZSA9PiBjaGFuZ2UudGltZXN0YW1wID49IHRpbWVzdGFtcCk7XG4gIH1cbiAgXG4gIGdldENoYW5nZXNCeU9wZXJhdGlvbihvcGVyYXRpb246IERhdGFiYXNlQ2hhbmdlWydvcGVyYXRpb24nXSk6IERhdGFiYXNlQ2hhbmdlW10ge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZXMuZmlsdGVyKGNoYW5nZSA9PiBjaGFuZ2Uub3BlcmF0aW9uID09PSBvcGVyYXRpb24pO1xuICB9XG4gIFxuICBnZXRDaGFuZ2VzQnlUYWJsZSh0YWJsZTogc3RyaW5nKTogRGF0YWJhc2VDaGFuZ2VbXSB7XG4gICAgcmV0dXJuIHRoaXMuY2hhbmdlcy5maWx0ZXIoY2hhbmdlID0+IGNoYW5nZS50YWJsZSA9PT0gdGFibGUpO1xuICB9XG4gIFxuICBwcml2YXRlIGludGVyY2VwdE1ldGhvZChtZXRob2ROYW1lOiBzdHJpbmcsIHRyYWNrZXI6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgY29uc3Qgc2VydmljZSA9IHRoaXMubWVtb3J5U2VydmljZSBhcyBhbnk7XG4gICAgXG4gICAgaWYgKCFzZXJ2aWNlW21ldGhvZE5hbWVdKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIFxuICAgIC8vIFN0b3JlIG9yaWdpbmFsIG1ldGhvZFxuICAgIHRoaXMub3JpZ2luYWxNZXRob2RzLnNldChtZXRob2ROYW1lLCBzZXJ2aWNlW21ldGhvZE5hbWVdKTtcbiAgICBcbiAgICAvLyBSZXBsYWNlIHdpdGggdHJhY2tpbmcgd3JhcHBlclxuICAgIHNlcnZpY2VbbWV0aG9kTmFtZV0gPSBhc3luYyAoLi4uYXJnczogYW55W10pID0+IHtcbiAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCBvcmlnaW5hbCA9IHRoaXMub3JpZ2luYWxNZXRob2RzLmdldChtZXRob2ROYW1lKSE7XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIENhbGwgb3JpZ2luYWwgbWV0aG9kXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9yaWdpbmFsLmFwcGx5KHNlcnZpY2UsIGFyZ3MpO1xuICAgICAgICBcbiAgICAgICAgLy8gVHJhY2sgdGhlIG9wZXJhdGlvblxuICAgICAgICB0cmFja2VyKGFyZ3MsIHJlc3VsdCwgbnVsbCk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gVHJhY2sgdGhlIGVycm9yXG4gICAgICAgIHRyYWNrZXIoYXJncywgbnVsbCwgZXJyb3IpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIHRyYWNrU3RvcmUoYXJnczogYW55W10sIHJlc3VsdDogYW55LCBlcnJvcjogYW55KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlzVHJhY2tpbmcpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCBbcmVxdWVzdF0gPSBhcmdzO1xuICAgIFxuICAgIHRoaXMuY2hhbmdlcy5wdXNoKHtcbiAgICAgIG9wZXJhdGlvbjogJ0lOU0VSVCcsXG4gICAgICB0YWJsZTogJ21lbW9yaWVzJyxcbiAgICAgIHJlY29yZElkOiByZXF1ZXN0Py5rZXksXG4gICAgICBuZXdWYWx1ZTogcmVxdWVzdD8udmFsdWUsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICBzZXNzaW9uSWQ6IHJlcXVlc3Q/LmNvbnRleHQ/LnNlc3Npb25JZFxuICAgIH0pO1xuICB9XG4gIFxuICBwcml2YXRlIHRyYWNrUmV0cmlldmUoYXJnczogYW55W10sIHJlc3VsdDogYW55LCBlcnJvcjogYW55KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlzVHJhY2tpbmcpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCBba2V5XSA9IGFyZ3M7XG4gICAgXG4gICAgdGhpcy5jaGFuZ2VzLnB1c2goe1xuICAgICAgb3BlcmF0aW9uOiAnU0VMRUNUJyxcbiAgICAgIHRhYmxlOiAnbWVtb3JpZXMnLFxuICAgICAgcmVjb3JkSWQ6IGtleSxcbiAgICAgIG5ld1ZhbHVlOiByZXN1bHQsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICB9KTtcbiAgfVxuICBcbiAgcHJpdmF0ZSB0cmFja1NlYXJjaChhcmdzOiBhbnlbXSwgcmVzdWx0OiBhbnksIGVycm9yOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaXNUcmFja2luZykgcmV0dXJuO1xuICAgIFxuICAgIGNvbnN0IFtxdWVyeV0gPSBhcmdzO1xuICAgIFxuICAgIHRoaXMuY2hhbmdlcy5wdXNoKHtcbiAgICAgIG9wZXJhdGlvbjogJ1NFTEVDVCcsXG4gICAgICB0YWJsZTogJ21lbW9yaWVzJyxcbiAgICAgIG5ld1ZhbHVlOiB7XG4gICAgICAgIHF1ZXJ5LFxuICAgICAgICByZXN1bHRDb3VudDogcmVzdWx0Py5sZW5ndGggfHwgMFxuICAgICAgfSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgIH0pO1xuICB9XG4gIFxuICBwcml2YXRlIHRyYWNrVXBkYXRlKGFyZ3M6IGFueVtdLCByZXN1bHQ6IGFueSwgZXJyb3I6IGFueSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pc1RyYWNraW5nKSByZXR1cm47XG4gICAgXG4gICAgY29uc3QgW2tleSwgdXBkYXRlc10gPSBhcmdzO1xuICAgIFxuICAgIHRoaXMuY2hhbmdlcy5wdXNoKHtcbiAgICAgIG9wZXJhdGlvbjogJ1VQREFURScsXG4gICAgICB0YWJsZTogJ21lbW9yaWVzJyxcbiAgICAgIHJlY29yZElkOiBrZXksXG4gICAgICBuZXdWYWx1ZTogdXBkYXRlcyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgIH0pO1xuICB9XG4gIFxuICBwcml2YXRlIHRyYWNrRGVsZXRlKGFyZ3M6IGFueVtdLCByZXN1bHQ6IGFueSwgZXJyb3I6IGFueSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5pc1RyYWNraW5nKSByZXR1cm47XG4gICAgXG4gICAgY29uc3QgW2tleV0gPSBhcmdzO1xuICAgIFxuICAgIHRoaXMuY2hhbmdlcy5wdXNoKHtcbiAgICAgIG9wZXJhdGlvbjogJ0RFTEVURScsXG4gICAgICB0YWJsZTogJ21lbW9yaWVzJyxcbiAgICAgIHJlY29yZElkOiBrZXksXG4gICAgICBvbGRWYWx1ZTogcmVzdWx0LFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgfSk7XG4gIH1cbiAgXG4gIC8vIEFuYWx5c2lzIG1ldGhvZHNcbiAgZ2V0U3RhdGlzdGljcygpOiB7XG4gICAgdG90YWxDaGFuZ2VzOiBudW1iZXI7XG4gICAgYnlPcGVyYXRpb246IFJlY29yZDxzdHJpbmcsIG51bWJlcj47XG4gICAgYnlUYWJsZTogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcbiAgICBhdmVyYWdlUGVyTWludXRlOiBudW1iZXI7XG4gIH0ge1xuICAgIGNvbnN0IHN0YXRzID0ge1xuICAgICAgdG90YWxDaGFuZ2VzOiB0aGlzLmNoYW5nZXMubGVuZ3RoLFxuICAgICAgYnlPcGVyYXRpb246IHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4sXG4gICAgICBieVRhYmxlOiB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+LFxuICAgICAgYXZlcmFnZVBlck1pbnV0ZTogMFxuICAgIH07XG4gICAgXG4gICAgaWYgKHRoaXMuY2hhbmdlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBzdGF0cztcbiAgICB9XG4gICAgXG4gICAgLy8gQ291bnQgYnkgb3BlcmF0aW9uXG4gICAgZm9yIChjb25zdCBjaGFuZ2Ugb2YgdGhpcy5jaGFuZ2VzKSB7XG4gICAgICBzdGF0cy5ieU9wZXJhdGlvbltjaGFuZ2Uub3BlcmF0aW9uXSA9IChzdGF0cy5ieU9wZXJhdGlvbltjaGFuZ2Uub3BlcmF0aW9uXSB8fCAwKSArIDE7XG4gICAgICBzdGF0cy5ieVRhYmxlW2NoYW5nZS50YWJsZV0gPSAoc3RhdHMuYnlUYWJsZVtjaGFuZ2UudGFibGVdIHx8IDApICsgMTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIGF2ZXJhZ2UgcGVyIG1pbnV0ZVxuICAgIGNvbnN0IGZpcnN0Q2hhbmdlID0gdGhpcy5jaGFuZ2VzWzBdLnRpbWVzdGFtcDtcbiAgICBjb25zdCBsYXN0Q2hhbmdlID0gdGhpcy5jaGFuZ2VzW3RoaXMuY2hhbmdlcy5sZW5ndGggLSAxXS50aW1lc3RhbXA7XG4gICAgY29uc3QgZHVyYXRpb25NaW51dGVzID0gKGxhc3RDaGFuZ2UgLSBmaXJzdENoYW5nZSkgLyA2MDAwMDtcbiAgICBcbiAgICBpZiAoZHVyYXRpb25NaW51dGVzID4gMCkge1xuICAgICAgc3RhdHMuYXZlcmFnZVBlck1pbnV0ZSA9IHRoaXMuY2hhbmdlcy5sZW5ndGggLyBkdXJhdGlvbk1pbnV0ZXM7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBzdGF0cztcbiAgfVxuICBcbiAgZXhwb3J0Q2hhbmdlcygpOiBzdHJpbmcge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLmNoYW5nZXMsIG51bGwsIDIpO1xuICB9XG4gIFxuICBpbXBvcnRDaGFuZ2VzKGpzb246IHN0cmluZyk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpbXBvcnRlZCA9IEpTT04ucGFyc2UoanNvbik7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShpbXBvcnRlZCkpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VzID0gaW1wb3J0ZWQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBpbXBvcnQgY2hhbmdlczonLCBlcnJvcik7XG4gICAgfVxuICB9XG59Il0sInZlcnNpb24iOjN9