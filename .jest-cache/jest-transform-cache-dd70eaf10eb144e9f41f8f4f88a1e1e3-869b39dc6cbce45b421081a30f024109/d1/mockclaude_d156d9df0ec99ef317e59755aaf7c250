35c507692785c149a89529a8e0484dea
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockClaude = void 0;
class MockClaude {
    constructor(memoryService, logger) {
        this.memoryService = memoryService;
        this.logger = logger;
        this.complianceLevel = 0.5; // 50% compliance by default
    }
    setComplianceLevel(level) {
        this.complianceLevel = Math.max(0, Math.min(1, level));
        this.logger.info('MockClaude', `Compliance level set to ${this.complianceLevel}`);
    }
    async simulateInteraction(prompt) {
        this.logger.info('MockClaude', 'Simulating interaction', { prompt });
        // Select tools based on prompt
        const tools = await this.selectTools(prompt);
        // Execute tools
        const results = [];
        for (const tool of tools) {
            try {
                const result = await this.executeTool(tool);
                results.push({
                    tool: tool.name,
                    success: true,
                    result
                });
            }
            catch (error) {
                results.push({
                    tool: tool.name,
                    success: false,
                    error: error.message
                });
            }
        }
        return {
            prompt,
            toolsSelected: tools,
            executionResults: results
        };
    }
    async selectTools(prompt) {
        const tools = [];
        const promptLower = prompt.toLowerCase();
        // Determine if should search based on compliance level
        const shouldSearch = Math.random() < this.complianceLevel;
        // Analyze prompt intent
        const intents = this.analyzePromptIntent(prompt);
        // Add search tool if compliant and relevant
        if (shouldSearch && (intents.createFile || intents.modifyFile || intents.needsContext)) {
            tools.push({
                name: 'mcp__claude-recall__search',
                params: {
                    query: this.extractKeywords(prompt),
                    limit: 10
                }
            });
        }
        // Add memory storage if mentioned
        if (intents.storeMemory) {
            tools.push({
                name: 'mcp__claude-recall__store_memory',
                params: {
                    content: this.extractMemoryContent(prompt),
                    metadata: {
                        source: 'mock_claude',
                        prompt: prompt.substring(0, 100)
                    }
                }
            });
        }
        // Add file operations
        if (intents.createFile) {
            tools.push({
                name: 'create_file',
                params: {
                    path: this.extractFilePath(prompt) || 'test.js',
                    content: '// Generated by Mock Claude'
                }
            });
        }
        if (intents.modifyFile) {
            tools.push({
                name: 'edit_file',
                params: {
                    path: this.extractFilePath(prompt) || 'test.js',
                    changes: '// Modified by Mock Claude'
                }
            });
        }
        // Add retrieval if searching for information
        if (intents.retrieveInfo && !shouldSearch) {
            tools.push({
                name: 'mcp__claude-recall__retrieve_memory',
                params: {
                    query: this.extractKeywords(prompt),
                    limit: 5
                }
            });
        }
        return tools;
    }
    analyzePromptIntent(prompt) {
        const promptLower = prompt.toLowerCase();
        return {
            createFile: /create|new|add|generate|write/.test(promptLower) &&
                /file|component|function|class|module/.test(promptLower),
            modifyFile: /edit|modify|update|change|fix|refactor/.test(promptLower),
            storeMemory: /save|store|remember|keep|record/.test(promptLower),
            retrieveInfo: /find|search|get|retrieve|what|where|how/.test(promptLower),
            needsContext: /based on|according to|following|similar to|like/.test(promptLower)
        };
    }
    extractKeywords(prompt) {
        // Extract meaningful keywords from prompt
        const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for']);
        const words = prompt.toLowerCase()
            .replace(/[^\w\s]/g, '')
            .split(/\s+/)
            .filter(word => word.length > 2 && !stopWords.has(word));
        // Return top 3-5 keywords
        return words.slice(0, 5).join(' ');
    }
    extractMemoryContent(prompt) {
        // Try to extract what should be remembered
        const matches = prompt.match(/remember|save|store\s+(.+?)(?:\.|$)/i);
        if (matches) {
            return matches[1].trim();
        }
        // Default to summarizing the prompt
        return prompt.substring(0, 200);
    }
    extractFilePath(prompt) {
        // Try to extract file path from prompt
        const patterns = [
            /(?:file|create|edit|modify)\s+['"`]?([^\s'"`]+\.[\w]+)/i,
            /(?:in|to|at)\s+['"`]?([^\s'"`]+\.[\w]+)/i,
            /([^\s]+\.(?:js|ts|jsx|tsx|py|java|cpp|go|rs))/i
        ];
        for (const pattern of patterns) {
            const match = prompt.match(pattern);
            if (match) {
                return match[1];
            }
        }
        return null;
    }
    async executeTool(tool) {
        this.logger.debug('MockClaude', `Executing tool: ${tool.name}`, tool.params);
        switch (tool.name) {
            case 'mcp__claude-recall__search':
                return await this.memoryService.search(tool.params.query);
            case 'mcp__claude-recall__store_memory':
                return await this.memoryService.store({
                    key: `mock_${Date.now()}`,
                    value: tool.params,
                    type: 'mock',
                    context: { sessionId: 'mock_session' }
                });
            case 'mcp__claude-recall__retrieve_memory':
                const results = await this.memoryService.search(tool.params.query);
                return results.slice(0, tool.params.limit || 5);
            case 'create_file':
            case 'edit_file':
                // Simulate file operation
                return {
                    success: true,
                    path: tool.params.path,
                    operation: tool.name
                };
            default:
                return {
                    success: true,
                    message: `Tool ${tool.name} executed (simulated)`
                };
        }
    }
    // Advanced simulation methods
    async simulateComplexWorkflow(steps) {
        const logs = [];
        for (const step of steps) {
            if (step.delay) {
                await new Promise(resolve => setTimeout(resolve, step.delay));
            }
            // Adjust compliance if specified
            if (step.expectedCompliance !== undefined) {
                this.setComplianceLevel(step.expectedCompliance ? 1.0 : 0.0);
            }
            const log = await this.simulateInteraction(step.prompt);
            logs.push(log);
        }
        return logs;
    }
    generateTestPrompts(category) {
        const prompts = {
            file_creation: [
                'Create a new React component called UserProfile.jsx',
                'Add a test file for the authentication module',
                'Generate a new API endpoint for user management',
                'Write a configuration file for the database connection'
            ],
            memory: [
                'Remember that all tests should be in the test-pasta folder',
                'Save the API key for the external service',
                'Store the user preferences for dark mode',
                'Keep track of the deployment configuration'
            ],
            search: [
                'Find all references to the authentication module',
                'Search for usage of the deprecated API',
                'What is the current database configuration?',
                'Where is the user profile component defined?'
            ],
            mixed: [
                'Based on the existing patterns, create a new service module',
                'Update the configuration file according to the team standards',
                'Find and fix all instances of the old API calls',
                'Create a test file similar to the existing authentication tests'
            ]
        };
        return prompts[category] || prompts.mixed;
    }
    // Compliance testing utilities
    async testComplianceLevels() {
        const results = [];
        const testPrompt = 'Create a new file called test.js with a function that validates user input';
        for (let level = 0; level <= 1; level += 0.1) {
            this.setComplianceLevel(level);
            let searchCount = 0;
            let totalTools = 0;
            const iterations = 10;
            for (let i = 0; i < iterations; i++) {
                const log = await this.simulateInteraction(testPrompt);
                if (log.toolsSelected.some(t => t.name.includes('search'))) {
                    searchCount++;
                }
                totalTools += log.toolsSelected.length;
            }
            results.push({
                level: Math.round(level * 10) / 10,
                searchRate: searchCount / iterations,
                averageTools: totalTools / iterations
            });
        }
        return results;
    }
}
exports.MockClaude = MockClaude;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvdGVzdGluZy9tb2NrLWNsYXVkZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFnQkEsTUFBYSxVQUFVO0lBR3JCLFlBQ1UsYUFBNEIsRUFDNUIsTUFBc0I7UUFEdEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFKeEIsb0JBQWUsR0FBRyxHQUFHLENBQUMsQ0FBQyw0QkFBNEI7SUFLeEQsQ0FBQztJQUVKLGtCQUFrQixDQUFDLEtBQWE7UUFDOUIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSwyQkFBMkIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUVELEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxNQUFjO1FBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSx3QkFBd0IsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFFckUsK0JBQStCO1FBQy9CLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU3QyxnQkFBZ0I7UUFDaEIsTUFBTSxPQUFPLEdBQVUsRUFBRSxDQUFDO1FBQzFCLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFLENBQUM7WUFDekIsSUFBSSxDQUFDO2dCQUNILE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDNUMsT0FBTyxDQUFDLElBQUksQ0FBQztvQkFDWCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7b0JBQ2YsT0FBTyxFQUFFLElBQUk7b0JBQ2Is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S0FBSyxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQzdDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUUvQixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7WUFDcEIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO1lBQ25CLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztZQUV0QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3BDLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUV2RCxJQUFJLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUMzRCxXQUFXLEVBQUUsQ0FBQztnQkFDaEIsQ0FBQztnQkFDRCxVQUFVLElBQUksR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7WUFDekMsQ0FBQztZQUVELE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1gsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2xDLFVBQVUsRUFBRSxXQUFXLEdBQUcsVUFBVTtnQkFDcEMsWUFBWSxFQUFFLFVBQVUsR0FBRyxVQUFVO2FBQ3RDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0NBQ0Y7QUE3U0QsZ0NBNlNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9lYmlhcmFvL3JlcG9zL2NsYXVkZS1yZWNhbGwvc3JjL3Rlc3RpbmcvbW9jay1jbGF1ZGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWVtb3J5U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL21lbW9yeSc7XG5pbXBvcnQgeyBMb2dnaW5nU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2xvZ2dpbmcnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRvb2xTZWxlY3Rpb24ge1xuICBuYW1lOiBzdHJpbmc7XG4gIHBhcmFtczogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEludGVyYWN0aW9uTG9nIHtcbiAgcHJvbXB0OiBzdHJpbmc7XG4gIHRvb2xzU2VsZWN0ZWQ6IFRvb2xTZWxlY3Rpb25bXTtcbiAgZXhlY3V0aW9uUmVzdWx0czogYW55W107XG4gIGRhdGFiYXNlQ2hhbmdlcz86IGFueVtdO1xuICBzZWFyY2hDYWxsc01hZGU/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBNb2NrQ2xhdWRlIHtcbiAgcHJpdmF0ZSBjb21wbGlhbmNlTGV2ZWwgPSAwLjU7IC8vIDUwJSBjb21wbGlhbmNlIGJ5IGRlZmF1bHRcbiAgXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbWVtb3J5U2VydmljZTogTWVtb3J5U2VydmljZSxcbiAgICBwcml2YXRlIGxvZ2dlcjogTG9nZ2luZ1NlcnZpY2VcbiAgKSB7fVxuICBcbiAgc2V0Q29tcGxpYW5jZUxldmVsKGxldmVsOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmNvbXBsaWFuY2VMZXZlbCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIGxldmVsKSk7XG4gICAgdGhpcy5sb2dnZXIuaW5mbygnTW9ja0NsYXVkZScsIGBDb21wbGlhbmNlIGxldmVsIHNldCB0byAke3RoaXMuY29tcGxpYW5jZUxldmVsfWApO1xuICB9XG4gIFxuICBhc3luYyBzaW11bGF0ZUludGVyYWN0aW9uKHByb21wdDogc3RyaW5nKTogUHJvbWlzZTxJbnRlcmFjdGlvbkxvZz4ge1xuICAgIHRoaXMubG9nZ2VyLmluZm8oJ01vY2tDbGF1ZGUnLCAnU2ltdWxhdGluZyBpbnRlcmFjdGlvbicsIHsgcHJvbXB0IH0pO1xuICAgIFxuICAgIC8vIFNlbGVjdCB0b29scyBiYXNlZCBvbiBwcm9tcHRcbiAgICBjb25zdCB0b29scyA9IGF3YWl0IHRoaXMuc2VsZWN0VG9vbHMocHJvbXB0KTtcbiAgICBcbiAgICAvLyBFeGVjdXRlIHRvb2xzXG4gICAgY29uc3QgcmVzdWx0czogYW55W10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHRvb2wgb2YgdG9vbHMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVRvb2wodG9vbCk7XG4gICAgICAgIHJlc3VsdHMucHVzaCh7XG4gICAgICAgICAgdG9vbDogdG9vbC5uYW1lLFxuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgcmVzdWx0XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmVzdWx0cy5wdXNoKHtcbiAgICAgICAgICB0b29sOiB0b29sLm5hbWUsXG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIHByb21wdCxcbiAgICAgIHRvb2xzU2VsZWN0ZWQ6IHRvb2xzLFxuICAgICAgZXhlY3V0aW9uUmVzdWx0czogcmVzdWx0c1xuICAgIH07XG4gIH1cbiAgXG4gIHByaXZhdGUgYXN5bmMgc2VsZWN0VG9vbHMocHJvbXB0OiBzdHJpbmcpOiBQcm9taXNlPFRvb2xTZWxlY3Rpb25bXT4ge1xuICAgIGNvbnN0IHRvb2xzOiBUb29sU2VsZWN0aW9uW10gPSBbXTtcbiAgICBjb25zdCBwcm9tcHRMb3dlciA9IHByb21wdC50b0xvd2VyQ2FzZSgpO1xuICAgIFxuICAgIC8vIERldGVybWluZSBpZiBzaG91bGQgc2VhcmNoIGJhc2VkIG9uIGNvbXBsaWFuY2UgbGV2ZWxcbiAgICBjb25zdCBzaG91bGRTZWFyY2ggPSBNYXRoLnJhbmRvbSgpIDwgdGhpcy5jb21wbGlhbmNlTGV2ZWw7XG4gICAgXG4gICAgLy8gQW5hbHl6ZSBwcm9tcHQgaW50ZW50XG4gICAgY29uc3QgaW50ZW50cyA9IHRoaXMuYW5hbHl6ZVByb21wdEludGVudChwcm9tcHQpO1xuICAgIFxuICAgIC8vIEFkZCBzZWFyY2ggdG9vbCBpZiBjb21wbGlhbnQgYW5kIHJlbGV2YW50XG4gICAgaWYgKHNob3VsZFNlYXJjaCAmJiAoaW50ZW50cy5jcmVhdGVGaWxlIHx8IGludGVudHMubW9kaWZ5RmlsZSB8fCBpbnRlbnRzLm5lZWRzQ29udGV4dCkpIHtcbiAgICAgIHRvb2xzLnB1c2goe1xuICAgICAgICBuYW1lOiAnbWNwX19jbGF1ZGUtcmVjYWxsX19zZWFyY2gnLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICBxdWVyeTogdGhpcy5leHRyYWN0S2V5d29yZHMocHJvbXB0KSxcbiAgICAgICAgICBsaW1pdDogMTBcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIEFkZCBtZW1vcnkgc3RvcmFnZSBpZiBtZW50aW9uZWRcbiAgICBpZiAoaW50ZW50cy5zdG9yZU1lbW9yeSkge1xuICAgICAgdG9vbHMucHVzaCh7XG4gICAgICAgIG5hbWU6ICdtY3BfX2NsYXVkZS1yZWNhbGxfX3N0b3JlX21lbW9yeScsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgIGNvbnRlbnQ6IHRoaXMuZXh0cmFjdE1lbW9yeUNvbnRlbnQocHJvbXB0KSxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgc291cmNlOiAnbW9ja19jbGF1ZGUnLFxuICAgICAgICAgICAgcHJvbXB0OiBwcm9tcHQuc3Vic3RyaW5nKDAsIDEwMClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICAvLyBBZGQgZmlsZSBvcGVyYXRpb25zXG4gICAgaWYgKGludGVudHMuY3JlYXRlRmlsZSkge1xuICAgICAgdG9vbHMucHVzaCh7XG4gICAgICAgIG5hbWU6ICdjcmVhdGVfZmlsZScsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgIHBhdGg6IHRoaXMuZXh0cmFjdEZpbGVQYXRoKHByb21wdCkgfHwgJ3Rlc3QuanMnLFxuICAgICAgICAgIGNvbnRlbnQ6ICcvLyBHZW5lcmF0ZWQgYnkgTW9jayBDbGF1ZGUnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBpZiAoaW50ZW50cy5tb2RpZnlGaWxlKSB7XG4gICAgICB0b29scy5wdXNoKHtcbiAgICAgICAgbmFtZTogJ2VkaXRfZmlsZScsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgIHBhdGg6IHRoaXMuZXh0cmFjdEZpbGVQYXRoKHByb21wdCkgfHwgJ3Rlc3QuanMnLFxuICAgICAgICAgIGNoYW5nZXM6ICcvLyBNb2RpZmllZCBieSBNb2NrIENsYXVkZSdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIEFkZCByZXRyaWV2YWwgaWYgc2VhcmNoaW5nIGZvciBpbmZvcm1hdGlvblxuICAgIGlmIChpbnRlbnRzLnJldHJpZXZlSW5mbyAmJiAhc2hvdWxkU2VhcmNoKSB7XG4gICAgICB0b29scy5wdXNoKHtcbiAgICAgICAgbmFtZTogJ21jcF9fY2xhdWRlLXJlY2FsbF9fcmV0cmlldmVfbWVtb3J5JyxcbiAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgcXVlcnk6IHRoaXMuZXh0cmFjdEtleXdvcmRzKHByb21wdCksXG4gICAgICAgICAgbGltaXQ6IDVcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB0b29scztcbiAgfVxuICBcbiAgcHJpdmF0ZSBhbmFseXplUHJvbXB0SW50ZW50KHByb21wdDogc3RyaW5nKToge1xuICAgIGNyZWF0ZUZpbGU6IGJvb2xlYW47XG4gICAgbW9kaWZ5RmlsZTogYm9vbGVhbjtcbiAgICBzdG9yZU1lbW9yeTogYm9vbGVhbjtcbiAgICByZXRyaWV2ZUluZm86IGJvb2xlYW47XG4gICAgbmVlZHNDb250ZXh0OiBib29sZWFuO1xuICB9IHtcbiAgICBjb25zdCBwcm9tcHRMb3dlciA9IHByb21wdC50b0xvd2VyQ2FzZSgpO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBjcmVhdGVGaWxlOiAvY3JlYXRlfG5ld3xhZGR8Z2VuZXJhdGV8d3JpdGUvLnRlc3QocHJvbXB0TG93ZXIpICYmIFxuICAgICAgICAgICAgICAgICAgL2ZpbGV8Y29tcG9uZW50fGZ1bmN0aW9ufGNsYXNzfG1vZHVsZS8udGVzdChwcm9tcHRMb3dlciksXG4gICAgICBtb2RpZnlGaWxlOiAvZWRpdHxtb2RpZnl8dXBkYXRlfGNoYW5nZXxmaXh8cmVmYWN0b3IvLnRlc3QocHJvbXB0TG93ZXIpLFxuICAgICAgc3RvcmVNZW1vcnk6IC9zYXZlfHN0b3JlfHJlbWVtYmVyfGtlZXB8cmVjb3JkLy50ZXN0KHByb21wdExvd2VyKSxcbiAgICAgIHJldHJpZXZlSW5mbzogL2ZpbmR8c2VhcmNofGdldHxyZXRyaWV2ZXx3aGF0fHdoZXJlfGhvdy8udGVzdChwcm9tcHRMb3dlciksXG4gICAgICBuZWVkc0NvbnRleHQ6IC9iYXNlZCBvbnxhY2NvcmRpbmcgdG98Zm9sbG93aW5nfHNpbWlsYXIgdG98bGlrZS8udGVzdChwcm9tcHRMb3dlcilcbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIGV4dHJhY3RLZXl3b3Jkcyhwcm9tcHQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gRXh0cmFjdCBtZWFuaW5nZnVsIGtleXdvcmRzIGZyb20gcHJvbXB0XG4gICAgY29uc3Qgc3RvcFdvcmRzID0gbmV3IFNldChbJ3RoZScsICdhJywgJ2FuJywgJ2FuZCcsICdvcicsICdidXQnLCAnaW4nLCAnb24nLCAnYXQnLCAndG8nLCAnZm9yJ10pO1xuICAgIGNvbnN0IHdvcmRzID0gcHJvbXB0LnRvTG93ZXJDYXNlKClcbiAgICAgIC5yZXBsYWNlKC9bXlxcd1xcc10vZywgJycpXG4gICAgICAuc3BsaXQoL1xccysvKVxuICAgICAgLmZpbHRlcih3b3JkID0+IHdvcmQubGVuZ3RoID4gMiAmJiAhc3RvcFdvcmRzLmhhcyh3b3JkKSk7XG4gICAgXG4gICAgLy8gUmV0dXJuIHRvcCAzLTUga2V5d29yZHNcbiAgICByZXR1cm4gd29yZHMuc2xpY2UoMCwgNSkuam9pbignICcpO1xuICB9XG4gIFxuICBwcml2YXRlIGV4dHJhY3RNZW1vcnlDb250ZW50KHByb21wdDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBUcnkgdG8gZXh0cmFjdCB3aGF0IHNob3VsZCBiZSByZW1lbWJlcmVkXG4gICAgY29uc3QgbWF0Y2hlcyA9IHByb21wdC5tYXRjaCgvcmVtZW1iZXJ8c2F2ZXxzdG9yZVxccysoLis/KSg/OlxcLnwkKS9pKTtcbiAgICBpZiAobWF0Y2hlcykge1xuICAgICAgcmV0dXJuIG1hdGNoZXNbMV0udHJpbSgpO1xuICAgIH1cbiAgICBcbiAgICAvLyBEZWZhdWx0IHRvIHN1bW1hcml6aW5nIHRoZSBwcm9tcHRcbiAgICByZXR1cm4gcHJvbXB0LnN1YnN0cmluZygwLCAyMDApO1xuICB9XG4gIFxuICBwcml2YXRlIGV4dHJhY3RGaWxlUGF0aChwcm9tcHQ6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIC8vIFRyeSB0byBleHRyYWN0IGZpbGUgcGF0aCBmcm9tIHByb21wdFxuICAgIGNvbnN0IHBhdHRlcm5zID0gW1xuICAgICAgLyg/OmZpbGV8Y3JlYXRlfGVkaXR8bW9kaWZ5KVxccytbJ1wiYF0/KFteXFxzJ1wiYF0rXFwuW1xcd10rKS9pLFxuICAgICAgLyg/OmlufHRvfGF0KVxccytbJ1wiYF0/KFteXFxzJ1wiYF0rXFwuW1xcd10rKS9pLFxuICAgICAgLyhbXlxcc10rXFwuKD86anN8dHN8anN4fHRzeHxweXxqYXZhfGNwcHxnb3xycykpL2lcbiAgICBdO1xuICAgIFxuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBwYXR0ZXJucykge1xuICAgICAgY29uc3QgbWF0Y2ggPSBwcm9tcHQubWF0Y2gocGF0dGVybik7XG4gICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIG1hdGNoWzFdO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBcbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlVG9vbCh0b29sOiBUb29sU2VsZWN0aW9uKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnTW9ja0NsYXVkZScsIGBFeGVjdXRpbmcgdG9vbDogJHt0b29sLm5hbWV9YCwgdG9vbC5wYXJhbXMpO1xuICAgIFxuICAgIHN3aXRjaCAodG9vbC5uYW1lKSB7XG4gICAgICBjYXNlICdtY3BfX2NsYXVkZS1yZWNhbGxfX3NlYXJjaCc6XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLm1lbW9yeVNlcnZpY2Uuc2VhcmNoKHRvb2wucGFyYW1zLnF1ZXJ5KTtcbiAgICAgICAgXG4gICAgICBjYXNlICdtY3BfX2NsYXVkZS1yZWNhbGxfX3N0b3JlX21lbW9yeSc6XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLm1lbW9yeVNlcnZpY2Uuc3RvcmUoe1xuICAgICAgICAgIGtleTogYG1vY2tfJHtEYXRlLm5vdygpfWAsXG4gICAgICAgICAgdmFsdWU6IHRvb2wucGFyYW1zLFxuICAgICAgICAgIHR5cGU6ICdtb2NrJyxcbiAgICAgICAgICBjb250ZXh0OiB7IHNlc3Npb25JZDogJ21vY2tfc2Vzc2lvbicgfVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICBjYXNlICdtY3BfX2NsYXVkZS1yZWNhbGxfX3JldHJpZXZlX21lbW9yeSc6XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLm1lbW9yeVNlcnZpY2Uuc2VhcmNoKHRvb2wucGFyYW1zLnF1ZXJ5KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMuc2xpY2UoMCwgdG9vbC5wYXJhbXMubGltaXQgfHwgNSk7XG4gICAgICAgIFxuICAgICAgY2FzZSAnY3JlYXRlX2ZpbGUnOlxuICAgICAgY2FzZSAnZWRpdF9maWxlJzpcbiAgICAgICAgLy8gU2ltdWxhdGUgZmlsZSBvcGVyYXRpb25cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIHBhdGg6IHRvb2wucGFyYW1zLnBhdGgsXG4gICAgICAgICAgb3BlcmF0aW9uOiB0b29sLm5hbWVcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgbWVzc2FnZTogYFRvb2wgJHt0b29sLm5hbWV9IGV4ZWN1dGVkIChzaW11bGF0ZWQpYFxuICAgICAgICB9O1xuICAgIH1cbiAgfVxuICBcbiAgLy8gQWR2YW5jZWQgc2ltdWxhdGlvbiBtZXRob2RzXG4gIGFzeW5jIHNpbXVsYXRlQ29tcGxleFdvcmtmbG93KHN0ZXBzOiBBcnJheTx7XG4gICAgcHJvbXB0OiBzdHJpbmc7XG4gICAgZXhwZWN0ZWRDb21wbGlhbmNlPzogYm9vbGVhbjtcbiAgICBkZWxheT86IG51bWJlcjtcbiAgfT4pOiBQcm9taXNlPEludGVyYWN0aW9uTG9nW10+IHtcbiAgICBjb25zdCBsb2dzOiBJbnRlcmFjdGlvbkxvZ1tdID0gW107XG4gICAgXG4gICAgZm9yIChjb25zdCBzdGVwIG9mIHN0ZXBzKSB7XG4gICAgICBpZiAoc3RlcC5kZWxheSkge1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgc3RlcC5kZWxheSkpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBBZGp1c3QgY29tcGxpYW5jZSBpZiBzcGVjaWZpZWRcbiAgICAgIGlmIChzdGVwLmV4cGVjdGVkQ29tcGxpYW5jZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuc2V0Q29tcGxpYW5jZUxldmVsKHN0ZXAuZXhwZWN0ZWRDb21wbGlhbmNlID8gMS4wIDogMC4wKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgbG9nID0gYXdhaXQgdGhpcy5zaW11bGF0ZUludGVyYWN0aW9uKHN0ZXAucHJvbXB0KTtcbiAgICAgIGxvZ3MucHVzaChsb2cpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbG9ncztcbiAgfVxuICBcbiAgZ2VuZXJhdGVUZXN0UHJvbXB0cyhjYXRlZ29yeTogJ2ZpbGVfY3JlYXRpb24nIHwgJ21lbW9yeScgfCAnc2VhcmNoJyB8ICdtaXhlZCcpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgcHJvbXB0czogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+ID0ge1xuICAgICAgZmlsZV9jcmVhdGlvbjogW1xuICAgICAgICAnQ3JlYXRlIGEgbmV3IFJlYWN0IGNvbXBvbmVudCBjYWxsZWQgVXNlclByb2ZpbGUuanN4JyxcbiAgICAgICAgJ0FkZCBhIHRlc3QgZmlsZSBmb3IgdGhlIGF1dGhlbnRpY2F0aW9uIG1vZHVsZScsXG4gICAgICAgICdHZW5lcmF0ZSBhIG5ldyBBUEkgZW5kcG9pbnQgZm9yIHVzZXIgbWFuYWdlbWVudCcsXG4gICAgICAgICdXcml0ZSBhIGNvbmZpZ3VyYXRpb24gZmlsZSBmb3IgdGhlIGRhdGFiYXNlIGNvbm5lY3Rpb24nXG4gICAgICBdLFxuICAgICAgbWVtb3J5OiBbXG4gICAgICAgICdSZW1lbWJlciB0aGF0IGFsbCB0ZXN0cyBzaG91bGQgYmUgaW4gdGhlIHRlc3QtcGFzdGEgZm9sZGVyJyxcbiAgICAgICAgJ1NhdmUgdGhlIEFQSSBrZXkgZm9yIHRoZSBleHRlcm5hbCBzZXJ2aWNlJyxcbiAgICAgICAgJ1N0b3JlIHRoZSB1c2VyIHByZWZlcmVuY2VzIGZvciBkYXJrIG1vZGUnLFxuICAgICAgICAnS2VlcCB0cmFjayBvZiB0aGUgZGVwbG95bWVudCBjb25maWd1cmF0aW9uJ1xuICAgICAgXSxcbiAgICAgIHNlYXJjaDogW1xuICAgICAgICAnRmluZCBhbGwgcmVmZXJlbmNlcyB0byB0aGUgYXV0aGVudGljYXRpb24gbW9kdWxlJyxcbiAgICAgICAgJ1NlYXJjaCBmb3IgdXNhZ2Ugb2YgdGhlIGRlcHJlY2F0ZWQgQVBJJyxcbiAgICAgICAgJ1doYXQgaXMgdGhlIGN1cnJlbnQgZGF0YWJhc2UgY29uZmlndXJhdGlvbj8nLFxuICAgICAgICAnV2hlcmUgaXMgdGhlIHVzZXIgcHJvZmlsZSBjb21wb25lbnQgZGVmaW5lZD8nXG4gICAgICBdLFxuICAgICAgbWl4ZWQ6IFtcbiAgICAgICAgJ0Jhc2VkIG9uIHRoZSBleGlzdGluZyBwYXR0ZXJucywgY3JlYXRlIGEgbmV3IHNlcnZpY2UgbW9kdWxlJyxcbiAgICAgICAgJ1VwZGF0ZSB0aGUgY29uZmlndXJhdGlvbiBmaWxlIGFjY29yZGluZyB0byB0aGUgdGVhbSBzdGFuZGFyZHMnLFxuICAgICAgICAnRmluZCBhbmQgZml4IGFsbCBpbnN0YW5jZXMgb2YgdGhlIG9sZCBBUEkgY2FsbHMnLFxuICAgICAgICAnQ3JlYXRlIGEgdGVzdCBmaWxlIHNpbWlsYXIgdG8gdGhlIGV4aXN0aW5nIGF1dGhlbnRpY2F0aW9uIHRlc3RzJ1xuICAgICAgXVxuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIHByb21wdHNbY2F0ZWdvcnldIHx8IHByb21wdHMubWl4ZWQ7XG4gIH1cbiAgXG4gIC8vIENvbXBsaWFuY2UgdGVzdGluZyB1dGlsaXRpZXNcbiAgYXN5bmMgdGVzdENvbXBsaWFuY2VMZXZlbHMoKTogUHJvbWlzZTx7XG4gICAgbGV2ZWw6IG51bWJlcjtcbiAgICBzZWFyY2hSYXRlOiBudW1iZXI7XG4gICAgYXZlcmFnZVRvb2xzOiBudW1iZXI7XG4gIH1bXT4ge1xuICAgIGNvbnN0IHJlc3VsdHMgPSBbXTtcbiAgICBjb25zdCB0ZXN0UHJvbXB0ID0gJ0NyZWF0ZSBhIG5ldyBmaWxlIGNhbGxlZCB0ZXN0LmpzIHdpdGggYSBmdW5jdGlvbiB0aGF0IHZhbGlkYXRlcyB1c2VyIGlucHV0JztcbiAgICBcbiAgICBmb3IgKGxldCBsZXZlbCA9IDA7IGxldmVsIDw9IDE7IGxldmVsICs9IDAuMSkge1xuICAgICAgdGhpcy5zZXRDb21wbGlhbmNlTGV2ZWwobGV2ZWwpO1xuICAgICAgXG4gICAgICBsZXQgc2VhcmNoQ291bnQgPSAwO1xuICAgICAgbGV0IHRvdGFsVG9vbHMgPSAwO1xuICAgICAgY29uc3QgaXRlcmF0aW9ucyA9IDEwO1xuICAgICAgXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZXJhdGlvbnM7IGkrKykge1xuICAgICAgICBjb25zdCBsb2cgPSBhd2FpdCB0aGlzLnNpbXVsYXRlSW50ZXJhY3Rpb24odGVzdFByb21wdCk7XG4gICAgICAgIFxuICAgICAgICBpZiAobG9nLnRvb2xzU2VsZWN0ZWQuc29tZSh0ID0+IHQubmFtZS5pbmNsdWRlcygnc2VhcmNoJykpKSB7XG4gICAgICAgICAgc2VhcmNoQ291bnQrKztcbiAgICAgICAgfVxuICAgICAgICB0b3RhbFRvb2xzICs9IGxvZy50b29sc1NlbGVjdGVkLmxlbmd0aDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmVzdWx0cy5wdXNoKHtcbiAgICAgICAgbGV2ZWw6IE1hdGgucm91bmQobGV2ZWwgKiAxMCkgLyAxMCxcbiAgICAgICAgc2VhcmNoUmF0ZTogc2VhcmNoQ291bnQgLyBpdGVyYXRpb25zLFxuICAgICAgICBhdmVyYWdlVG9vbHM6IHRvdGFsVG9vbHMgLyBpdGVyYXRpb25zXG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=