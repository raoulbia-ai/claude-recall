905f0ec62ef159ff5ddd62b3eeeaba81
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const retrieval_1 = require("../../src/core/retrieval");
const storage_1 = require("../../src/memory/storage");
describe('MemoryRetrieval', () => {
    let storage;
    let retrieval;
    beforeEach(() => {
        storage = new storage_1.MemoryStorage(':memory:');
        retrieval = new retrieval_1.MemoryRetrieval(storage);
    });
    afterEach(() => {
        storage.close();
    });
    describe('findRelevant', () => {
        it('should return memories sorted by relevance score', () => {
            // Create test memories
            storage.save({
                key: 'memory1',
                value: { data: 'test1' },
                type: 'preference',
                project_id: 'project1',
                file_path: 'file1.ts',
                relevance_score: 0.5
            });
            storage.save({
                key: 'memory2',
                value: { data: 'test2' },
                type: 'preference',
                project_id: 'project1',
                file_path: 'file2.ts',
                relevance_score: 0.8
            });
            storage.save({
                key: 'memory3',
                value: { data: 'test3' },
                type: 'preference',
                project_id: 'project2',
                file_path: 'file3.ts',
                relevance_score: 0.9
            });
            const context = {
                project_id: 'project1',
                file_path: 'file1.ts'
            };
            const results = retrieval.findRelevant(context);
            expect(results.length).toBeLessThanOrEqual(5);
            expect(results.length).toBeGreaterThan(0);
            if (results.length > 1) {
                expect(results[0].key).toBe('memory1'); // Highest score due to file match
                expect(results[0].score).toBeGreaterThan(results[1].score);
            }
        });
        it('should apply forgetting curve decay', () => {
            const oldTimestamp = Date.now() - (10 * 24 * 60 * 60 * 1000); // 10 days ago
            const recentTimestamp = Date.now() - (1 * 24 * 60 * 60 * 1000); // 1 day ago
            storage.save({
                key: 'old_memory',
                value: { data: 'old' },
                type: 'preference',
                timestamp: oldTimestamp,
                relevance_score: 1.0
            });
            storage.save({
                key: 'recent_memory',
                value: { data: 'recent' },
                type: 'preference',
                timestamp: recentTimestamp,
                relevance_score: 1.0
            });
            const results = retrieval.findRelevant({});
            const oldMemory = results.find(m => m.key === 'old_memory');
            const recentMemory = results.find(m => m.key === 'recent_memory');
            expect(oldMemory).toBeDefined();
            expect(recentMemory).toBeDefined();
            expect(recentMemory.score).toBeGreaterThan(oldMemory.score);
        });
        it('should boost frequently accessed memories', () => {
            storage.save({
                key: 'popular',
                value: { data: 'popular' },
                type: 'preference',
                access_count: 10,
                relevance_score: 0.5
            });
            storage.save({
                key: 'unpopular',
                value: { data: 'unpopular' },
                type: 'preference',
                access_count: 0,
                relevance_score: 0.5
            });
            const results = retrieval.findRelevant({});
            const popular = results.find(m => m.key === 'popular');
            const unpopular = results.find(m => m.key === 'unpopular');
            expect(popular).toBeDefined();
            expect(unpopular).toBeDefined();
            expect(popular.score).toBeGreaterThan(unpopular.score);
        });
        it('should boost recently accessed memories', () => {
            const recentAccess = Date.now() - (2 * 60 * 60 * 1000); // 2 hours ago
            const oldAccess = Date.now() - (48 * 60 * 60 * 1000); // 48 hours ago
            storage.save({
                key: 'recent_access',
                value: { data: 'recent' },
                type: 'preference',
                relevance_score: 0.5
            });
            storage.save({
                key: 'old_access',
                value: { data: 'old' },
                type: 'preference',
                relevance_score: 0.5
            });
            // Manually update last_accessed since it's set by retrieval
            const db = storage.db;
            db.prepare('UPDATE memories SET last_accessed = ? WHERE key = ?').run(recentAccess, 'recent_access');
            db.prepare('UPDATE memories SET last_accessed = ? WHERE key = ?').run(oldAccess, 'old_access');
            const results = retrieval.findRelevant({});
            const recent = results.find(m => m.key === 'recent_access');
            const old = results.find(m => m.key === 'old_access');
            expect(recent).toBeDefined();
            expect(old).toBeDefined();
            expect(recent.score).toBeGreaterThan(old.score);
        });
        it('should limit results to top 5', () => {
            // Create 10 memories
            for (let i = 0; i < 10; i++) {
                storage.save({
                    key: `memory${i}`,
                    value: { data: `test${i}` },
                    type: 'preference',
                    relevance_score: Math.random()
                });
            }
            const results = retrieval.findRelevant({});
            expect(results.length).toBe(5);
        });
    });
    describe('searchByKeyword', () => {
        it('should search memories by keyword and apply relevance scoring', () => {
            storage.save({
                key: 'auth_function',
                value: { name: 'authenticateUser', description: 'User authentication' },
                type: 'function',
                relevance_score: 0.8
            });
            storage.save({
                key: 'auth_pattern',
                value: { pattern: 'authentication flow' },
                type: 'pattern',
                relevance_score: 0.6
            });
            storage.save({
                key: 'unrelated',
                value: { data: 'something else' },
                type: 'other',
                relevance_score: 0.9
            });
            const results = retrieval.searchByKeyword('auth');
            expect(results.length).toBe(2);
            expect(results[0].key).toContain('auth');
            expect(results[1].key).toContain('auth');
            // Should be sorted by score
            expect(results[0].score).toBeGreaterThanOrEqual(results[1].score);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy91bml0L3JldHJpZXZhbC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsd0RBQTJEO0FBQzNELHNEQUF5RDtBQUV6RCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBc0IsQ0FBQztJQUMzQixJQUFJLFNBQTBCLENBQUM7SUFFL0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE9BQU8sR0FBRyxJQUFJLHVCQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDeEMsU0FBUyxHQUFHLElBQUksMkJBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUM1QixFQUFFLENBQUMsa0RBQWtELEVBQUUsR0FBRyxFQUFFO1lBQzFELHVCQUF1QjtZQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNYLEdBQUcsRUFBRSxTQUFTO2dCQUNkLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUU7Z0JBQ3hCLElBQUksRUFBRSxZQUFZO2dCQUNsQixVQUFVLEVBQUUsVUFBVTtnQkFDdEIsU0FBUyxFQUFFLFVBQVU7Z0JBQ3JCLGVBQWUsRUFBRSxHQUFHO2FBQ3JCLENBQUMsQ0FBQztZQUVILE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1gsR0FBRyxFQUFFLFNBQVM7Z0JBQ2QsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRTtnQkFDeEIsSUFBSSxFQUFFLFlBQVk7Z0JBQ2xCLFVBQVUsRUFBRSxVQUFVO2dCQUN0QixTQUFTLEVBQUUsVUFBVTtnQkFDckIsZUFBZSxFQUFFLEdBQUc7YUFDckIsQ0FBQyxDQUFDO1lBRUgsT0FBTyxDQUFD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WUFFSCxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNYLEdBQUcsRUFBRSxjQUFjO2dCQUNuQixLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUscUJBQXFCLEVBQUU7Z0JBQ3pDLElBQUksRUFBRSxTQUFTO2dCQUNmLGVBQWUsRUFBRSxHQUFHO2FBQ3JCLENBQUMsQ0FBQztZQUVILE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ1gsR0FBRyxFQUFFLFdBQVc7Z0JBQ2hCLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtnQkFDakMsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsZUFBZSxFQUFFLEdBQUc7YUFDckIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVsRCxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6QyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV6Qyw0QkFBNEI7WUFDNUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9lYmlhcmFvL3JlcG9zL2NsYXVkZS1yZWNhbGwvdGVzdHMvdW5pdC9yZXRyaWV2YWwudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZW1vcnlSZXRyaWV2YWwgfSBmcm9tICcuLi8uLi9zcmMvY29yZS9yZXRyaWV2YWwnO1xuaW1wb3J0IHsgTWVtb3J5U3RvcmFnZSB9IGZyb20gJy4uLy4uL3NyYy9tZW1vcnkvc3RvcmFnZSc7XG5cbmRlc2NyaWJlKCdNZW1vcnlSZXRyaWV2YWwnLCAoKSA9PiB7XG4gIGxldCBzdG9yYWdlOiBNZW1vcnlTdG9yYWdlO1xuICBsZXQgcmV0cmlldmFsOiBNZW1vcnlSZXRyaWV2YWw7XG4gIFxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBzdG9yYWdlID0gbmV3IE1lbW9yeVN0b3JhZ2UoJzptZW1vcnk6Jyk7XG4gICAgcmV0cmlldmFsID0gbmV3IE1lbW9yeVJldHJpZXZhbChzdG9yYWdlKTtcbiAgfSk7XG4gIFxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHN0b3JhZ2UuY2xvc2UoKTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnZmluZFJlbGV2YW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIG1lbW9yaWVzIHNvcnRlZCBieSByZWxldmFuY2Ugc2NvcmUnLCAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgdGVzdCBtZW1vcmllc1xuICAgICAgc3RvcmFnZS5zYXZlKHtcbiAgICAgICAga2V5OiAnbWVtb3J5MScsXG4gICAgICAgIHZhbHVlOiB7IGRhdGE6ICd0ZXN0MScgfSxcbiAgICAgICAgdHlwZTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICBwcm9qZWN0X2lkOiAncHJvamVjdDEnLFxuICAgICAgICBmaWxlX3BhdGg6ICdmaWxlMS50cycsXG4gICAgICAgIHJlbGV2YW5jZV9zY29yZTogMC41XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgc3RvcmFnZS5zYXZlKHtcbiAgICAgICAga2V5OiAnbWVtb3J5MicsXG4gICAgICAgIHZhbHVlOiB7IGRhdGE6ICd0ZXN0MicgfSxcbiAgICAgICAgdHlwZTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICBwcm9qZWN0X2lkOiAncHJvamVjdDEnLFxuICAgICAgICBmaWxlX3BhdGg6ICdmaWxlMi50cycsXG4gICAgICAgIHJlbGV2YW5jZV9zY29yZTogMC44XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgc3RvcmFnZS5zYXZlKHtcbiAgICAgICAga2V5OiAnbWVtb3J5MycsXG4gICAgICAgIHZhbHVlOiB7IGRhdGE6ICd0ZXN0MycgfSxcbiAgICAgICAgdHlwZTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICBwcm9qZWN0X2lkOiAncHJvamVjdDInLFxuICAgICAgICBmaWxlX3BhdGg6ICdmaWxlMy50cycsXG4gICAgICAgIHJlbGV2YW5jZV9zY29yZTogMC45XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgICAgcHJvamVjdF9pZDogJ3Byb2plY3QxJyxcbiAgICAgICAgZmlsZV9wYXRoOiAnZmlsZTEudHMnXG4gICAgICB9O1xuICAgICAgXG4gICAgICBjb25zdCByZXN1bHRzID0gcmV0cmlldmFsLmZpbmRSZWxldmFudChjb250ZXh0KTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHJlc3VsdHMubGVuZ3RoKS50b0JlTGVzc1RoYW5PckVxdWFsKDUpO1xuICAgICAgZXhwZWN0KHJlc3VsdHMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGV4cGVjdChyZXN1bHRzWzBdLmtleSkudG9CZSgnbWVtb3J5MScpOyAvLyBIaWdoZXN0IHNjb3JlIGR1ZSB0byBmaWxlIG1hdGNoXG4gICAgICAgIGV4cGVjdChyZXN1bHRzWzBdLnNjb3JlKS50b0JlR3JlYXRlclRoYW4ocmVzdWx0c1sxXS5zY29yZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCBhcHBseSBmb3JnZXR0aW5nIGN1cnZlIGRlY2F5JywgKCkgPT4ge1xuICAgICAgY29uc3Qgb2xkVGltZXN0YW1wID0gRGF0ZS5ub3coKSAtICgxMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyAxMCBkYXlzIGFnb1xuICAgICAgY29uc3QgcmVjZW50VGltZXN0YW1wID0gRGF0ZS5ub3coKSAtICgxICogMjQgKiA2MCAqIDYwICogMTAwMCk7IC8vIDEgZGF5IGFnb1xuICAgICAgXG4gICAgICBzdG9yYWdlLnNhdmUoe1xuICAgICAgICBrZXk6ICdvbGRfbWVtb3J5JyxcbiAgICAgICAgdmFsdWU6IHsgZGF0YTogJ29sZCcgfSxcbiAgICAgICAgdHlwZTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICB0aW1lc3RhbXA6IG9sZFRpbWVzdGFtcCxcbiAgICAgICAgcmVsZXZhbmNlX3Njb3JlOiAxLjBcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBzdG9yYWdlLnNhdmUoe1xuICAgICAgICBrZXk6ICdyZWNlbnRfbWVtb3J5JyxcbiAgICAgICAgdmFsdWU6IHsgZGF0YTogJ3JlY2VudCcgfSxcbiAgICAgICAgdHlwZTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICB0aW1lc3RhbXA6IHJlY2VudFRpbWVzdGFtcCxcbiAgICAgICAgcmVsZXZhbmNlX3Njb3JlOiAxLjBcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBjb25zdCByZXN1bHRzID0gcmV0cmlldmFsLmZpbmRSZWxldmFudCh7fSk7XG4gICAgICBcbiAgICAgIGNvbnN0IG9sZE1lbW9yeSA9IHJlc3VsdHMuZmluZChtID0+IG0ua2V5ID09PSAnb2xkX21lbW9yeScpO1xuICAgICAgY29uc3QgcmVjZW50TWVtb3J5ID0gcmVzdWx0cy5maW5kKG0gPT4gbS5rZXkgPT09ICdyZWNlbnRfbWVtb3J5Jyk7XG4gICAgICBcbiAgICAgIGV4cGVjdChvbGRNZW1vcnkpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVjZW50TWVtb3J5KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlY2VudE1lbW9yeSEuc2NvcmUpLnRvQmVHcmVhdGVyVGhhbihvbGRNZW1vcnkhLnNjb3JlKTtcbiAgICB9KTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIGJvb3N0IGZyZXF1ZW50bHkgYWNjZXNzZWQgbWVtb3JpZXMnLCAoKSA9PiB7XG4gICAgICBzdG9yYWdlLnNhdmUoe1xuICAgICAgICBrZXk6ICdwb3B1bGFyJyxcbiAgICAgICAgdmFsdWU6IHsgZGF0YTogJ3BvcHVsYXInIH0sXG4gICAgICAgIHR5cGU6ICdwcmVmZXJlbmNlJyxcbiAgICAgICAgYWNjZXNzX2NvdW50OiAxMCxcbiAgICAgICAgcmVsZXZhbmNlX3Njb3JlOiAwLjVcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBzdG9yYWdlLnNhdmUoe1xuICAgICAgICBrZXk6ICd1bnBvcHVsYXInLFxuICAgICAgICB2YWx1ZTogeyBkYXRhOiAndW5wb3B1bGFyJyB9LFxuICAgICAgICB0eXBlOiAncHJlZmVyZW5jZScsXG4gICAgICAgIGFjY2Vzc19jb3VudDogMCxcbiAgICAgICAgcmVsZXZhbmNlX3Njb3JlOiAwLjVcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBjb25zdCByZXN1bHRzID0gcmV0cmlldmFsLmZpbmRSZWxldmFudCh7fSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHBvcHVsYXIgPSByZXN1bHRzLmZpbmQobSA9PiBtLmtleSA9PT0gJ3BvcHVsYXInKTtcbiAgICAgIGNvbnN0IHVucG9wdWxhciA9IHJlc3VsdHMuZmluZChtID0+IG0ua2V5ID09PSAndW5wb3B1bGFyJyk7XG4gICAgICBcbiAgICAgIGV4cGVjdChwb3B1bGFyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHVucG9wdWxhcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChwb3B1bGFyIS5zY29yZSkudG9CZUdyZWF0ZXJUaGFuKHVucG9wdWxhciEuc2NvcmUpO1xuICAgIH0pO1xuICAgIFxuICAgIGl0KCdzaG91bGQgYm9vc3QgcmVjZW50bHkgYWNjZXNzZWQgbWVtb3JpZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCByZWNlbnRBY2Nlc3MgPSBEYXRlLm5vdygpIC0gKDIgKiA2MCAqIDYwICogMTAwMCk7IC8vIDIgaG91cnMgYWdvXG4gICAgICBjb25zdCBvbGRBY2Nlc3MgPSBEYXRlLm5vdygpIC0gKDQ4ICogNjAgKiA2MCAqIDEwMDApOyAvLyA0OCBob3VycyBhZ29cbiAgICAgIFxuICAgICAgc3RvcmFnZS5zYXZlKHtcbiAgICAgICAga2V5OiAncmVjZW50X2FjY2VzcycsXG4gICAgICAgIHZhbHVlOiB7IGRhdGE6ICdyZWNlbnQnIH0sXG4gICAgICAgIHR5cGU6ICdwcmVmZXJlbmNlJyxcbiAgICAgICAgcmVsZXZhbmNlX3Njb3JlOiAwLjVcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBzdG9yYWdlLnNhdmUoe1xuICAgICAgICBrZXk6ICdvbGRfYWNjZXNzJyxcbiAgICAgICAgdmFsdWU6IHsgZGF0YTogJ29sZCcgfSxcbiAgICAgICAgdHlwZTogJ3ByZWZlcmVuY2UnLFxuICAgICAgICByZWxldmFuY2Vfc2NvcmU6IDAuNVxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIC8vIE1hbnVhbGx5IHVwZGF0ZSBsYXN0X2FjY2Vzc2VkIHNpbmNlIGl0J3Mgc2V0IGJ5IHJldHJpZXZhbFxuICAgICAgY29uc3QgZGIgPSAoc3RvcmFnZSBhcyBhbnkpLmRiO1xuICAgICAgZGIucHJlcGFyZSgnVVBEQVRFIG1lbW9yaWVzIFNFVCBsYXN0X2FjY2Vzc2VkID0gPyBXSEVSRSBrZXkgPSA/JykucnVuKHJlY2VudEFjY2VzcywgJ3JlY2VudF9hY2Nlc3MnKTtcbiAgICAgIGRiLnByZXBhcmUoJ1VQREFURSBtZW1vcmllcyBTRVQgbGFzdF9hY2Nlc3NlZCA9ID8gV0hFUkUga2V5ID0gPycpLnJ1bihvbGRBY2Nlc3MsICdvbGRfYWNjZXNzJyk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSByZXRyaWV2YWwuZmluZFJlbGV2YW50KHt9KTtcbiAgICAgIFxuICAgICAgY29uc3QgcmVjZW50ID0gcmVzdWx0cy5maW5kKG0gPT4gbS5rZXkgPT09ICdyZWNlbnRfYWNjZXNzJyk7XG4gICAgICBjb25zdCBvbGQgPSByZXN1bHRzLmZpbmQobSA9PiBtLmtleSA9PT0gJ29sZF9hY2Nlc3MnKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHJlY2VudCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChvbGQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVjZW50IS5zY29yZSkudG9CZUdyZWF0ZXJUaGFuKG9sZCEuc2NvcmUpO1xuICAgIH0pO1xuICAgIFxuICAgIGl0KCdzaG91bGQgbGltaXQgcmVzdWx0cyB0byB0b3AgNScsICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSAxMCBtZW1vcmllc1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgICAgIHN0b3JhZ2Uuc2F2ZSh7XG4gICAgICAgICAga2V5OiBgbWVtb3J5JHtpfWAsXG4gICAgICAgICAgdmFsdWU6IHsgZGF0YTogYHRlc3Qke2l9YCB9LFxuICAgICAgICAgIHR5cGU6ICdwcmVmZXJlbmNlJyxcbiAgICAgICAgICByZWxldmFuY2Vfc2NvcmU6IE1hdGgucmFuZG9tKClcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSByZXRyaWV2YWwuZmluZFJlbGV2YW50KHt9KTtcbiAgICAgIGV4cGVjdChyZXN1bHRzLmxlbmd0aCkudG9CZSg1KTtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnc2VhcmNoQnlLZXl3b3JkJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc2VhcmNoIG1lbW9yaWVzIGJ5IGtleXdvcmQgYW5kIGFwcGx5IHJlbGV2YW5jZSBzY29yaW5nJywgKCkgPT4ge1xuICAgICAgc3RvcmFnZS5zYXZlKHtcbiAgICAgICAga2V5OiAnYXV0aF9mdW5jdGlvbicsXG4gICAgICAgIHZhbHVlOiB7IG5hbWU6ICdhdXRoZW50aWNhdGVVc2VyJywgZGVzY3JpcHRpb246ICdVc2VyIGF1dGhlbnRpY2F0aW9uJyB9LFxuICAgICAgICB0eXBlOiAnZnVuY3Rpb24nLFxuICAgICAgICByZWxldmFuY2Vfc2NvcmU6IDAuOFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHN0b3JhZ2Uuc2F2ZSh7XG4gICAgICAgIGtleTogJ2F1dGhfcGF0dGVybicsXG4gICAgICAgIHZhbHVlOiB7IHBhdHRlcm46ICdhdXRoZW50aWNhdGlvbiBmbG93JyB9LFxuICAgICAgICB0eXBlOiAncGF0dGVybicsXG4gICAgICAgIHJlbGV2YW5jZV9zY29yZTogMC42XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgc3RvcmFnZS5zYXZlKHtcbiAgICAgICAga2V5OiAndW5yZWxhdGVkJyxcbiAgICAgICAgdmFsdWU6IHsgZGF0YTogJ3NvbWV0aGluZyBlbHNlJyB9LFxuICAgICAgICB0eXBlOiAnb3RoZXInLFxuICAgICAgICByZWxldmFuY2Vfc2NvcmU6IDAuOVxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSByZXRyaWV2YWwuc2VhcmNoQnlLZXl3b3JkKCdhdXRoJyk7XG4gICAgICBcbiAgICAgIGV4cGVjdChyZXN1bHRzLmxlbmd0aCkudG9CZSgyKTtcbiAgICAgIGV4cGVjdChyZXN1bHRzWzBdLmtleSkudG9Db250YWluKCdhdXRoJyk7XG4gICAgICBleHBlY3QocmVzdWx0c1sxXS5rZXkpLnRvQ29udGFpbignYXV0aCcpO1xuICAgICAgXG4gICAgICAvLyBTaG91bGQgYmUgc29ydGVkIGJ5IHNjb3JlXG4gICAgICBleHBlY3QocmVzdWx0c1swXS5zY29yZSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbChyZXN1bHRzWzFdLnNjb3JlKTtcbiAgICB9KTtcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=