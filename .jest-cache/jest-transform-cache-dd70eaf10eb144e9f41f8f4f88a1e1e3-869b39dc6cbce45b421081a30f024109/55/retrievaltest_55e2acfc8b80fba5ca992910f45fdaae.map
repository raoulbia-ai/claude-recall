{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/tests/unit/retrieval.test.ts","mappings":";;AAAA,wDAA2D;AAC3D,sDAAyD;AAEzD,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;IAC/B,IAAI,OAAsB,CAAC;IAC3B,IAAI,SAA0B,CAAC;IAE/B,UAAU,CAAC,GAAG,EAAE;QACd,OAAO,GAAG,IAAI,uBAAa,CAAC,UAAU,CAAC,CAAC;QACxC,SAAS,GAAG,IAAI,2BAAe,CAAC,OAAO,CAAC,CAAC;IAC3C,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,OAAO,CAAC,KAAK,EAAE,CAAC;IAClB,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,cAAc,EAAE,GAAG,EAAE;QAC5B,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,uBAAuB;YACvB,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,SAAS;gBACd,KAAK,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;gBACxB,IAAI,EAAE,YAAY;gBAClB,UAAU,EAAE,UAAU;gBACtB,SAAS,EAAE,UAAU;gBACrB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,SAAS;gBACd,KAAK,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;gBACxB,IAAI,EAAE,YAAY;gBAClB,UAAU,EAAE,UAAU;gBACtB,SAAS,EAAE,UAAU;gBACrB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,SAAS;gBACd,KAAK,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;gBACxB,IAAI,EAAE,YAAY;gBAClB,UAAU,EAAE,UAAU;gBACtB,SAAS,EAAE,UAAU;gBACrB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG;gBACd,UAAU,EAAE,UAAU;gBACtB,SAAS,EAAE,UAAU;aACtB,CAAC;YAEF,MAAM,OAAO,GAAG,SAAS,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;YAEhD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC;YAC9C,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;YAC1C,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACvB,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,kCAAkC;gBAC1E,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;YAC7D,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qCAAqC,EAAE,GAAG,EAAE;YAC7C,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,CAAC,cAAc;YAC5E,MAAM,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,CAAC,YAAY;YAE5E,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,YAAY;gBACjB,KAAK,EAAE,EAAE,IAAI,EAAE,KAAK,EAAE;gBACtB,IAAI,EAAE,YAAY;gBAClB,SAAS,EAAE,YAAY;gBACvB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,eAAe;gBACpB,KAAK,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE;gBACzB,IAAI,EAAE,YAAY;gBAClB,SAAS,EAAE,eAAe;gBAC1B,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,SAAS,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;YAE3C,MAAM,SAAS,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,YAAY,CAAC,CAAC;YAC5D,MAAM,YAAY,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,eAAe,CAAC,CAAC;YAElE,MAAM,CAAC,SAAS,CAAC,CAAC,WAAW,EAAE,CAAC;YAChC,MAAM,CAAC,YAAY,CAAC,CAAC,WAAW,EAAE,CAAC;YACnC,MAAM,CAAC,YAAa,CAAC,KAAK,CAAC,CAAC,eAAe,CAAC,SAAU,CAAC,KAAK,CAAC,CAAC;QAChE,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,2CAA2C,EAAE,GAAG,EAAE;YACnD,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,SAAS;gBACd,KAAK,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE;gBAC1B,IAAI,EAAE,YAAY;gBAClB,YAAY,EAAE,EAAE;gBAChB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,WAAW;gBAChB,KAAK,EAAE,EAAE,IAAI,EAAE,WAAW,EAAE;gBAC5B,IAAI,EAAE,YAAY;gBAClB,YAAY,EAAE,CAAC;gBACf,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,SAAS,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;YAE3C,MAAM,OAAO,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,SAAS,CAAC,CAAC;YACvD,MAAM,SAAS,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,WAAW,CAAC,CAAC;YAE3D,MAAM,CAAC,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC;YAC9B,MAAM,CAAC,SAAS,CAAC,CAAC,WAAW,EAAE,CAAC;YAChC,MAAM,CAAC,OAAQ,CAAC,KAAK,CAAC,CAAC,eAAe,CAAC,SAAU,CAAC,KAAK,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yCAAyC,EAAE,GAAG,EAAE;YACjD,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,CAAC,cAAc;YACtE,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,CAAC,eAAe;YAErE,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,eAAe;gBACpB,KAAK,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE;gBACzB,IAAI,EAAE,YAAY;gBAClB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,YAAY;gBACjB,KAAK,EAAE,EAAE,IAAI,EAAE,KAAK,EAAE;gBACtB,IAAI,EAAE,YAAY;gBAClB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,4DAA4D;YAC5D,MAAM,EAAE,GAAI,OAAe,CAAC,EAAE,CAAC;YAC/B,EAAE,CAAC,OAAO,CAAC,qDAAqD,CAAC,CAAC,GAAG,CAAC,YAAY,EAAE,eAAe,CAAC,CAAC;YACrG,EAAE,CAAC,OAAO,CAAC,qDAAqD,CAAC,CAAC,GAAG,CAAC,SAAS,EAAE,YAAY,CAAC,CAAC;YAE/F,MAAM,OAAO,GAAG,SAAS,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;YAE3C,MAAM,MAAM,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,eAAe,CAAC,CAAC;YAC5D,MAAM,GAAG,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,YAAY,CAAC,CAAC;YAEtD,MAAM,CAAC,MAAM,CAAC,CAAC,WAAW,EAAE,CAAC;YAC7B,MAAM,CAAC,GAAG,CAAC,CAAC,WAAW,EAAE,CAAC;YAC1B,MAAM,CAAC,MAAO,CAAC,KAAK,CAAC,CAAC,eAAe,CAAC,GAAI,CAAC,KAAK,CAAC,CAAC;QACpD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,+BAA+B,EAAE,GAAG,EAAE;YACvC,qBAAqB;YACrB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC5B,OAAO,CAAC,IAAI,CAAC;oBACX,GAAG,EAAE,SAAS,CAAC,EAAE;oBACjB,KAAK,EAAE,EAAE,IAAI,EAAE,OAAO,CAAC,EAAE,EAAE;oBAC3B,IAAI,EAAE,YAAY;oBAClB,eAAe,EAAE,IAAI,CAAC,MAAM,EAAE;iBAC/B,CAAC,CAAC;YACL,CAAC;YAED,MAAM,OAAO,GAAG,SAAS,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;YAC3C,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QACjC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;QAC/B,EAAE,CAAC,+DAA+D,EAAE,GAAG,EAAE;YACvE,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,eAAe;gBACpB,KAAK,EAAE,EAAE,IAAI,EAAE,kBAAkB,EAAE,WAAW,EAAE,qBAAqB,EAAE;gBACvE,IAAI,EAAE,UAAU;gBAChB,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,cAAc;gBACnB,KAAK,EAAE,EAAE,OAAO,EAAE,qBAAqB,EAAE;gBACzC,IAAI,EAAE,SAAS;gBACf,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,OAAO,CAAC,IAAI,CAAC;gBACX,GAAG,EAAE,WAAW;gBAChB,KAAK,EAAE,EAAE,IAAI,EAAE,gBAAgB,EAAE;gBACjC,IAAI,EAAE,OAAO;gBACb,eAAe,EAAE,GAAG;aACrB,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,SAAS,CAAC,eAAe,CAAC,MAAM,CAAC,CAAC;YAElD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAC/B,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YACzC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YAEzC,4BAA4B;YAC5B,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,sBAAsB,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;QACpE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/tests/unit/retrieval.test.ts"],"sourcesContent":["import { MemoryRetrieval } from '../../src/core/retrieval';\nimport { MemoryStorage } from '../../src/memory/storage';\n\ndescribe('MemoryRetrieval', () => {\n  let storage: MemoryStorage;\n  let retrieval: MemoryRetrieval;\n  \n  beforeEach(() => {\n    storage = new MemoryStorage(':memory:');\n    retrieval = new MemoryRetrieval(storage);\n  });\n  \n  afterEach(() => {\n    storage.close();\n  });\n  \n  describe('findRelevant', () => {\n    it('should return memories sorted by relevance score', () => {\n      // Create test memories\n      storage.save({\n        key: 'memory1',\n        value: { data: 'test1' },\n        type: 'preference',\n        project_id: 'project1',\n        file_path: 'file1.ts',\n        relevance_score: 0.5\n      });\n      \n      storage.save({\n        key: 'memory2',\n        value: { data: 'test2' },\n        type: 'preference',\n        project_id: 'project1',\n        file_path: 'file2.ts',\n        relevance_score: 0.8\n      });\n      \n      storage.save({\n        key: 'memory3',\n        value: { data: 'test3' },\n        type: 'preference',\n        project_id: 'project2',\n        file_path: 'file3.ts',\n        relevance_score: 0.9\n      });\n      \n      const context = {\n        project_id: 'project1',\n        file_path: 'file1.ts'\n      };\n      \n      const results = retrieval.findRelevant(context);\n      \n      expect(results.length).toBeLessThanOrEqual(5);\n      expect(results.length).toBeGreaterThan(0);\n      if (results.length > 1) {\n        expect(results[0].key).toBe('memory1'); // Highest score due to file match\n        expect(results[0].score).toBeGreaterThan(results[1].score);\n      }\n    });\n    \n    it('should apply forgetting curve decay', () => {\n      const oldTimestamp = Date.now() - (10 * 24 * 60 * 60 * 1000); // 10 days ago\n      const recentTimestamp = Date.now() - (1 * 24 * 60 * 60 * 1000); // 1 day ago\n      \n      storage.save({\n        key: 'old_memory',\n        value: { data: 'old' },\n        type: 'preference',\n        timestamp: oldTimestamp,\n        relevance_score: 1.0\n      });\n      \n      storage.save({\n        key: 'recent_memory',\n        value: { data: 'recent' },\n        type: 'preference',\n        timestamp: recentTimestamp,\n        relevance_score: 1.0\n      });\n      \n      const results = retrieval.findRelevant({});\n      \n      const oldMemory = results.find(m => m.key === 'old_memory');\n      const recentMemory = results.find(m => m.key === 'recent_memory');\n      \n      expect(oldMemory).toBeDefined();\n      expect(recentMemory).toBeDefined();\n      expect(recentMemory!.score).toBeGreaterThan(oldMemory!.score);\n    });\n    \n    it('should boost frequently accessed memories', () => {\n      storage.save({\n        key: 'popular',\n        value: { data: 'popular' },\n        type: 'preference',\n        access_count: 10,\n        relevance_score: 0.5\n      });\n      \n      storage.save({\n        key: 'unpopular',\n        value: { data: 'unpopular' },\n        type: 'preference',\n        access_count: 0,\n        relevance_score: 0.5\n      });\n      \n      const results = retrieval.findRelevant({});\n      \n      const popular = results.find(m => m.key === 'popular');\n      const unpopular = results.find(m => m.key === 'unpopular');\n      \n      expect(popular).toBeDefined();\n      expect(unpopular).toBeDefined();\n      expect(popular!.score).toBeGreaterThan(unpopular!.score);\n    });\n    \n    it('should boost recently accessed memories', () => {\n      const recentAccess = Date.now() - (2 * 60 * 60 * 1000); // 2 hours ago\n      const oldAccess = Date.now() - (48 * 60 * 60 * 1000); // 48 hours ago\n      \n      storage.save({\n        key: 'recent_access',\n        value: { data: 'recent' },\n        type: 'preference',\n        relevance_score: 0.5\n      });\n      \n      storage.save({\n        key: 'old_access',\n        value: { data: 'old' },\n        type: 'preference',\n        relevance_score: 0.5\n      });\n      \n      // Manually update last_accessed since it's set by retrieval\n      const db = (storage as any).db;\n      db.prepare('UPDATE memories SET last_accessed = ? WHERE key = ?').run(recentAccess, 'recent_access');\n      db.prepare('UPDATE memories SET last_accessed = ? WHERE key = ?').run(oldAccess, 'old_access');\n      \n      const results = retrieval.findRelevant({});\n      \n      const recent = results.find(m => m.key === 'recent_access');\n      const old = results.find(m => m.key === 'old_access');\n      \n      expect(recent).toBeDefined();\n      expect(old).toBeDefined();\n      expect(recent!.score).toBeGreaterThan(old!.score);\n    });\n    \n    it('should limit results to top 5', () => {\n      // Create 10 memories\n      for (let i = 0; i < 10; i++) {\n        storage.save({\n          key: `memory${i}`,\n          value: { data: `test${i}` },\n          type: 'preference',\n          relevance_score: Math.random()\n        });\n      }\n      \n      const results = retrieval.findRelevant({});\n      expect(results.length).toBe(5);\n    });\n  });\n  \n  describe('searchByKeyword', () => {\n    it('should search memories by keyword and apply relevance scoring', () => {\n      storage.save({\n        key: 'auth_function',\n        value: { name: 'authenticateUser', description: 'User authentication' },\n        type: 'function',\n        relevance_score: 0.8\n      });\n      \n      storage.save({\n        key: 'auth_pattern',\n        value: { pattern: 'authentication flow' },\n        type: 'pattern',\n        relevance_score: 0.6\n      });\n      \n      storage.save({\n        key: 'unrelated',\n        value: { data: 'something else' },\n        type: 'other',\n        relevance_score: 0.9\n      });\n      \n      const results = retrieval.searchByKeyword('auth');\n      \n      expect(results.length).toBe(2);\n      expect(results[0].key).toContain('auth');\n      expect(results[1].key).toContain('auth');\n      \n      // Should be sorted by score\n      expect(results[0].score).toBeGreaterThanOrEqual(results[1].score);\n    });\n  });\n});"],"version":3}