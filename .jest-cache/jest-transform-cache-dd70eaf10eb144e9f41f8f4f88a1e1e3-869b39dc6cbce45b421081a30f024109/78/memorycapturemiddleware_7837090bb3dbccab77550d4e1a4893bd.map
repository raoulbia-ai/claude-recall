{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/mcp/memory-capture-middleware.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/mcp/memory-capture-middleware.ts"],"sourcesContent":["import { MCPRequest, MCPResponse } from './server';\nimport { PreferenceExtractor } from '../services/preference-extractor';\nimport { ActionPatternDetector } from '../services/action-pattern-detector';\nimport { MemoryService } from '../services/memory';\nimport { LoggingService } from '../services/logging';\nimport { KeywordExtractor } from '../services/keyword-extractor';\nimport { MemoryUsageTracker } from '../services/memory-usage-tracker';\nimport { FailureExtractor } from '../services/failure-extractor';\nimport { MemoryEvolution } from '../services/memory-evolution';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\ninterface MemoryPattern {\n  pattern: string;\n  type: string;\n  confidence: number;\n  extractionMode: string;\n}\n\ninterface MemoryPatternConfig {\n  preferencePatterns: MemoryPattern[];\n  actionPatterns: MemoryPattern[];\n  contextTriggers: {\n    highConfidenceWords: string[];\n    decisionIndicators: string[];\n    futureTense: string[];\n  };\n  captureSettings: {\n    minConfidence: number;\n    requireExplicitConfirmation: boolean;\n    batchProcessingDelay: number;\n    maxMemoriesPerSession: number;\n    deduplicationWindow: number;\n  };\n}\n\nexport class MemoryCaptureMiddleware {\n  private preferenceExtractor: PreferenceExtractor;\n  private actionDetector: ActionPatternDetector;\n  private memoryService: MemoryService;\n  private logger: LoggingService;\n  private keywordExtractor: KeywordExtractor;\n  private usageTracker: MemoryUsageTracker;\n  private failureExtractor: FailureExtractor;\n  private memoryEvolution: MemoryEvolution;\n  private config!: MemoryPatternConfig;\n  private recentCaptures: Map<string, number> = new Map();\n  private sessionMemoryCount: Map<string, number> = new Map();\n\n  constructor() {\n    this.preferenceExtractor = new PreferenceExtractor();\n    this.actionDetector = new ActionPatternDetector();\n    this.memoryService = MemoryService.getInstance();\n    this.logger = LoggingService.getInstance();\n    this.keywordExtractor = KeywordExtractor.getInstance();\n    this.usageTracker = MemoryUsageTracker.getInstance();\n    this.failureExtractor = FailureExtractor.getInstance();\n    this.memoryEvolution = MemoryEvolution.getInstance();\n    this.loadConfig();\n  }\n\n  private loadConfig(): void {\n    try {\n      // First try custom config location\n      const customConfigPath = process.env.CLAUDE_RECALL_PATTERNS_CONFIG;\n      const defaultConfigPath = path.join(__dirname, '../../config/memory-patterns.json');\n      \n      const configPath = customConfigPath && fs.existsSync(customConfigPath) \n        ? customConfigPath \n        : defaultConfigPath;\n\n      if (fs.existsSync(configPath)) {\n        const configContent = fs.readFileSync(configPath, 'utf-8');\n        this.config = JSON.parse(configContent);\n        this.logger.info('MemoryCaptureMiddleware', 'Loaded memory patterns config', { configPath });\n      } else {\n        // Use default config if file doesn't exist\n        this.config = this.getDefaultConfig();\n        this.logger.warn('MemoryCaptureMiddleware', 'Using default config, no config file found');\n      }\n    } catch (error) {\n      this.logger.error('MemoryCaptureMiddleware', 'Failed to load config, using defaults', error as Error);\n      this.config = this.getDefaultConfig();\n    }\n  }\n\n  private getDefaultConfig(): MemoryPatternConfig {\n    return {\n      preferencePatterns: [\n        {\n          pattern: \"(?:I prefer|prefer)\\\\s+([\\\\w\\\\s]+)\\\\s+(?:over|instead of)\\\\s+([\\\\w\\\\s]+)\",\n          type: \"preference\",\n          confidence: 0.9,\n          extractionMode: \"comparison\"\n        }\n      ],\n      actionPatterns: [],\n      contextTriggers: {\n        highConfidenceWords: [\"always\", \"never\", \"must\", \"prefer\"],\n        decisionIndicators: [\"decided\", \"choosing\", \"selected\"],\n        futureTense: [\"will\", \"going to\", \"from now on\"]\n      },\n      captureSettings: {\n        minConfidence: 0.5,\n        requireExplicitConfirmation: false,\n        batchProcessingDelay: 1000,\n        maxMemoriesPerSession: 50,\n        deduplicationWindow: 3600000\n      }\n    };\n  }\n\n  /**\n   * Process a request/response pair for automatic memory capture\n   */\n  async processForMemoryCapture(\n    request: MCPRequest,\n    response: MCPResponse,\n    sessionId: string\n  ): Promise<void> {\n    try {\n      // Don't capture from memory-related tools to avoid loops\n      if (request.method === 'tools/call' && \n          request.params?.name?.includes('memory')) {\n        return;\n      }\n\n      // Extract content to analyze\n      const contentToAnalyze = this.extractContent(request, response);\n      if (!contentToAnalyze) return;\n\n      // Check session memory limit\n      const sessionCount = this.sessionMemoryCount.get(sessionId) || 0;\n      if (sessionCount >= this.config.captureSettings.maxMemoriesPerSession) {\n        this.logger.debug('MemoryCaptureMiddleware', 'Session memory limit reached', { sessionId, count: sessionCount });\n        return;\n      }\n\n      // Analyze for patterns\n      const detectedMemories = await this.analyzeContent(contentToAnalyze, sessionId);\n\n      // Store unique memories\n      for (const memory of detectedMemories) {\n        if (this.shouldCapture(memory, sessionId)) {\n          await this.captureMemory(memory, sessionId);\n        }\n      }\n    } catch (error) {\n      this.logger.error('MemoryCaptureMiddleware', 'Error in memory capture', error as Error);\n    }\n  }\n\n  private extractContent(request: MCPRequest, response: MCPResponse): string | null {\n    let content = '';\n\n    // Extract from request\n    if (request.params?.arguments?.content) {\n      content += request.params.arguments.content + '\\n';\n    }\n\n    // Extract from response\n    if (response.result?.content) {\n      if (Array.isArray(response.result.content)) {\n        response.result.content.forEach((item: any) => {\n          if (item.text) content += item.text + '\\n';\n        });\n      } else if (typeof response.result.content === 'string') {\n        content += response.result.content + '\\n';\n      }\n    }\n\n    return content.trim() || null;\n  }\n\n  private async analyzeContent(content: string, sessionId: string): Promise<any[]> {\n    const memories: any[] = [];\n\n    // PRIORITY 0: Extract DevOps patterns (HIGHEST - project-specific workflows)\n    const devopsPreferences = this.preferenceExtractor.extractPreferences(content)\n      .filter(pref => pref.key.startsWith('devops_'));\n\n    for (const devops of devopsPreferences) {\n      if (devops.confidence >= this.config.captureSettings.minConfidence) {\n        // Handle both string and object value types\n        const data = typeof devops.value === 'object'\n          ? {\n              ...devops.value,\n              key: devops.key,\n              confidence: devops.confidence,\n              isOverride: devops.isOverride\n            }\n          : {\n              value: devops.value,\n              key: devops.key,\n              confidence: devops.confidence,\n              isOverride: devops.isOverride\n            };\n\n        memories.push({\n          type: 'devops',\n          content: devops.raw,\n          data,\n          confidence: devops.confidence,\n          priority: 0  // HIGHEST priority\n        });\n      }\n    }\n\n    // PRIORITY 1: Check for explicit \"remember\" or \"recall\" commands\n    const explicitMemoryRegex = /(?:remember|Remember|recall|Recall)\\s+(?:that\\s+)?(.+?)(?:[.!?]|$)/gi;\n    const explicitMemoryMatches = content.matchAll(explicitMemoryRegex);\n\n    for (const match of explicitMemoryMatches) {\n      const memoryContent = match[1].trim();\n      if (memoryContent) {\n        memories.push({\n          type: 'explicit_memory',\n          content: memoryContent,\n          data: {\n            raw: memoryContent,\n            source: 'explicit_memory_command',\n            confidence: 1.0\n          },\n          confidence: 1.0,  // Always highest confidence\n          priority: 1  // Second highest priority\n        });\n      }\n    }\n\n    // PRIORITY 1.5: Check for user corrections and failures (counterfactual learning)\n    const failureMemory = this.failureExtractor.extractFromUserCorrection(\n      content,\n      'previous_action',  // TODO: Track actual previous action in session\n      {\n        query: content,\n        timestamp: Date.now()\n      }\n    );\n\n    if (failureMemory) {\n      memories.push({\n        type: 'failure',\n        content: JSON.stringify(failureMemory.value),\n        data: failureMemory.value,\n        confidence: failureMemory.confidence_score || 0.9,\n        priority: 1.5  // High priority - learn from failures\n      });\n    }\n\n    // PRIORITY 2: Use configured preference patterns\n    for (const pattern of this.config.preferencePatterns) {\n      const regex = new RegExp(pattern.pattern, 'gi');\n      const matches = content.matchAll(regex);\n\n      for (const match of matches) {\n        // Skip if this was already captured as explicit memory\n        const lower = match[0].toLowerCase();\n        if (lower.includes('remember') || lower.includes('recall')) continue;\n\n        memories.push({\n          type: pattern.type,\n          content: match[0],\n          data: {\n            pattern: pattern.type,\n            captured: match.slice(1),\n            confidence: pattern.confidence,\n            extractionMode: pattern.extractionMode\n          },\n          confidence: pattern.confidence,\n          priority: 2\n        });\n      }\n    }\n\n    // PRIORITY 3: Use existing PreferenceExtractor (non-devops preferences)\n    const preferences = this.preferenceExtractor.extractPreferences(content)\n      .filter(pref => !pref.key.startsWith('devops_')); // Skip devops, already handled\n\n    for (const pref of preferences) {\n      if (pref.confidence >= this.config.captureSettings.minConfidence) {\n        // Skip if already captured as explicit memory or devops\n        if (pref.raw.toLowerCase().includes('remember')) continue;\n\n        memories.push({\n          type: 'preference',\n          content: pref.raw,\n          data: {\n            key: pref.key,\n            value: pref.value,\n            confidence: pref.confidence\n          },\n          confidence: pref.confidence,\n          priority: 3\n        });\n      }\n    }\n\n    // Check for action patterns using configured patterns\n    for (const pattern of this.config.actionPatterns) {\n      const regex = new RegExp(pattern.pattern, 'gi');\n      const matches = content.matchAll(regex);\n      \n      for (const match of matches) {\n        memories.push({\n          type: pattern.type,\n          content: match[0],\n          data: {\n            pattern: pattern.type,\n            captured: match.slice(1),\n            confidence: pattern.confidence\n          },\n          confidence: pattern.confidence\n        });\n      }\n    }\n\n    // Check for high-confidence context triggers\n    const hasHighConfidenceContext = this.config.contextTriggers.highConfidenceWords.some(\n      word => content.toLowerCase().includes(word.toLowerCase())\n    );\n\n    if (hasHighConfidenceContext) {\n      // Boost confidence for all found patterns\n      memories.forEach(m => m.confidence = Math.min(1.0, m.confidence * 1.1));\n    }\n\n    return memories;\n  }\n\n  private shouldCapture(memory: any, sessionId: string): boolean {\n    // ALWAYS capture explicit \"remember\" commands\n    if (memory.type === 'explicit_memory' || memory.priority === 1) {\n      return true;\n    }\n\n    // Check confidence threshold for other types\n    if (memory.confidence < this.config.captureSettings.minConfidence) {\n      return false;\n    }\n\n    // Check for duplicates within deduplication window\n    const memoryKey = `${memory.type}:${memory.content}`;\n    const lastCapture = this.recentCaptures.get(memoryKey);\n    const now = Date.now();\n\n    if (lastCapture && (now - lastCapture) < this.config.captureSettings.deduplicationWindow) {\n      return false;\n    }\n\n    return true;\n  }\n\n  private async captureMemory(memory: any, sessionId: string): Promise<void> {\n    try {\n      // Store using MemoryService\n      const stored = this.memoryService.store({\n        key: `auto_${memory.type}_${Date.now()}`,\n        value: memory.data,\n        type: memory.type,\n        context: {\n          projectId: sessionId,\n          type: 'auto_capture',\n          timestamp: Date.now()\n        }\n      });\n\n      // Update tracking\n      const memoryKey = `${memory.type}:${memory.content}`;\n      this.recentCaptures.set(memoryKey, Date.now());\n      \n      const currentCount = this.sessionMemoryCount.get(sessionId) || 0;\n      this.sessionMemoryCount.set(sessionId, currentCount + 1);\n\n      this.logger.info('MemoryCaptureMiddleware', 'Auto-captured memory', {\n        type: memory.type,\n        confidence: memory.confidence,\n        sessionId\n      });\n    } catch (error) {\n      this.logger.error('MemoryCaptureMiddleware', 'Failed to capture memory', error as Error);\n    }\n  }\n\n  /**\n   * Get hints about recently captured memories (for LLM context injection)\n   * This helps the LLM be aware of what has been automatically stored\n   */\n  getCaptureHints(sessionId: string, maxCount: number = 5): string | null {\n    try {\n      // Get recent captures for this session\n      const sessionCount = this.sessionMemoryCount.get(sessionId) || 0;\n\n      if (sessionCount === 0) {\n        return null; // No captures yet\n      }\n\n      // Search for recent memories from this session\n      // Use timestamp sorting to get most recent\n      const recentMemories = this.memoryService.search('', 'timestamp').slice(0, maxCount);\n\n      if (recentMemories.length === 0) {\n        return null;\n      }\n\n      // Format as system hint\n      const lines: string[] = [\n        `[System: ${recentMemories.length} memories automatically captured in this session:]`\n      ];\n\n      for (const memory of recentMemories) {\n        const formatted = this.formatMemoryForHint(memory);\n        if (formatted) {\n          lines.push(`  - ${formatted}`);\n        }\n      }\n\n      lines.push('[Tip: Consider storing additional project details mentioned by the user]');\n\n      return lines.join('\\n');\n    } catch (error) {\n      this.logger.error('MemoryCaptureMiddleware', 'Failed to generate capture hints', error as Error);\n      return null;\n    }\n  }\n\n  /**\n   * Format a memory for hint display\n   */\n  private formatMemoryForHint(memory: any): string | null {\n    try {\n      const value = memory.value;\n\n      // Handle different value formats\n      if (typeof value === 'string') {\n        return `${memory.type}: ${value}`;\n      }\n\n      if (typeof value === 'object' && value !== null) {\n        // Extract meaningful information\n        if (value.raw) return `${memory.type}: ${value.raw}`;\n        if (value.content) return `${memory.type}: ${value.content}`;\n        if (value.message) return `${memory.type}: ${value.message}`;\n        if (value.key && value.value) {\n          return `${memory.type}: ${value.key} = ${typeof value.value === 'object' ? JSON.stringify(value.value) : value.value}`;\n        }\n\n        // Fallback: show memory key\n        return `${memory.type}: ${memory.key}`;\n      }\n\n      return null;\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * Clean up old session data\n   */\n  cleanupSessions(): void {\n    // Clean up old captures\n    const now = Date.now();\n    const cutoff = now - this.config.captureSettings.deduplicationWindow;\n\n    for (const [key, timestamp] of this.recentCaptures) {\n      if (timestamp < cutoff) {\n        this.recentCaptures.delete(key);\n      }\n    }\n\n    // Reset session counts periodically\n    if (this.sessionMemoryCount.size > 100) {\n      this.sessionMemoryCount.clear();\n    }\n  }\n\n  /**\n   * Reload configuration (useful for hot-reloading)\n   */\n  reloadConfig(): void {\n    this.loadConfig();\n    this.logger.info('MemoryCaptureMiddleware', 'Configuration reloaded');\n  }\n\n  /**\n   * Phase 3B: Proactively retrieve and inject relevant memories\n   * Call this BEFORE executing tool to inject memory context\n   */\n  async enhanceRequestWithMemories(request: MCPRequest): Promise<MCPRequest> {\n    try {\n      // Only enhance tool calls\n      if (request.method !== 'tools/call') {\n        return request;\n      }\n\n      // Don't enhance memory-related tools to avoid loops\n      if (request.params?.name?.includes('memory')) {\n        return request;\n      }\n\n      // Extract keywords from tool arguments\n      const toolArgs = request.params?.arguments || {};\n      const searchQuery = this.keywordExtractor.extractAsQuery(toolArgs);\n\n      if (!searchQuery) {\n        return request; // No keywords found\n      }\n\n      // Search for relevant memories\n      const memories = this.memoryService.search(searchQuery);\n\n      // Filter to top 3 most relevant\n      const topMemories = memories.slice(0, 3);\n\n      if (topMemories.length === 0) {\n        return request; // No relevant memories\n      }\n\n      // Format memories as context\n      const memoryContext = this.formatMemoriesForContext(topMemories);\n\n      // Add capture hints to help LLM be aware of what was stored\n      const sessionId = request.params?.sessionId || 'unknown';\n      const captureHints = this.getCaptureHints(sessionId, 3);\n\n      // Combine memory context and capture hints\n      let fullContext = memoryContext;\n      if (captureHints) {\n        fullContext += '\\n\\n' + captureHints;\n      }\n\n      // Inject into request\n      // Store in a special field that tools can access\n      if (!request.params) {\n        request.params = {};\n      }\n\n      request.params._memoryContext = fullContext;\n      request.params._injectedMemories = topMemories.map(m => ({\n        key: m.key,\n        type: m.type,\n        confidence: this.extractConfidence(m)\n      }));\n\n      // Phase 3C: Track memory injections\n      for (const memory of topMemories) {\n        this.usageTracker.recordInjection(memory.key, request.params.name, sessionId);\n      }\n\n      this.logger.info('MemoryCaptureMiddleware', 'Injected memories into request', {\n        toolName: request.params.name,\n        memoryCount: topMemories.length,\n        keywords: searchQuery\n      });\n\n      return request;\n\n    } catch (error) {\n      this.logger.error('MemoryCaptureMiddleware', 'Failed to enhance request', error);\n      return request; // Return original on error\n    }\n  }\n\n  /**\n   * Format memories as readable context string\n   */\n  private formatMemoriesForContext(memories: any[]): string {\n    const lines: string[] = ['üìù Relevant Memories:'];\n\n    for (const memory of memories) {\n      const formatted = this.formatSingleMemoryForContext(memory);\n      if (formatted) {\n        lines.push(`- ${formatted}`);\n      }\n    }\n\n    return lines.join('\\n');\n  }\n\n  /**\n   * Format a single memory for context injection\n   */\n  private formatSingleMemoryForContext(memory: any): string | null {\n    try {\n      const value = memory.value;\n\n      // Handle different value formats\n      if (typeof value === 'string') {\n        return value;\n      }\n\n      if (typeof value === 'object' && value !== null) {\n        // Extract meaningful information\n        if (value.preference) return value.preference;\n        if (value.value) {\n          const val = value.value;\n          if (typeof val === 'string') return val;\n          if (typeof val === 'object' && val.framework) {\n            return `Use ${val.framework}`;\n          }\n        }\n        if (value.content) return value.content;\n        if (value.message) return value.message;\n        if (value.raw) return value.raw;\n\n        // Fallback: extract key info from memory key\n        return this.extractKeyInfo(memory.key, value);\n      }\n\n      return null;\n\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * Extract key information from memory\n   */\n  private extractKeyInfo(key: string, value: any): string {\n    const cleanKey = key\n      .replace(/auto_|pref_/g, '')\n      .replace(/_\\d+$/g, '')\n      .replace(/_/g, ' ');\n\n    if (value.framework) return `${cleanKey}: ${value.framework}`;\n    if (value.location) return `${cleanKey}: ${value.location}`;\n    if (value.style) return `${cleanKey}: ${value.style}`;\n\n    return cleanKey;\n  }\n\n  /**\n   * Extract confidence from memory value\n   */\n  private extractConfidence(memory: any): number {\n    if (typeof memory.value === 'object' && memory.value !== null) {\n      return (memory.value as any).confidence || 0.5;\n    }\n    return 0.5;\n  }\n}"],"version":3}