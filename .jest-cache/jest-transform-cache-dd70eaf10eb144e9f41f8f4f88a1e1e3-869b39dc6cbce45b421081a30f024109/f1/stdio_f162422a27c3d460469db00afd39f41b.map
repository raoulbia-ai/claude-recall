{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/mcp/transports/stdio.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/mcp/transports/stdio.ts"],"sourcesContent":["import { createInterface, Interface } from 'node:readline';\nimport { stdin, stdout } from 'node:process';\n\nexport interface MCPRequest {\n  jsonrpc: \"2.0\";\n  id: string | number;\n  method: string;\n  params?: any;\n}\n\nexport interface MCPResponse {\n  jsonrpc: \"2.0\";\n  id: string | number;\n  result?: any;\n  error?: {\n    code: number;\n    message: string;\n    data?: any;\n  };\n}\n\nexport interface MCPNotification {\n  jsonrpc: \"2.0\";\n  method: string;\n  params?: any;\n}\n\nexport type RequestHandler = (request: MCPRequest) => Promise<MCPResponse>;\nexport type NotificationHandler = (notification: MCPNotification) => Promise<void>;\n\nexport class StdioTransport {\n  private requestHandler?: RequestHandler;\n  private notificationHandler?: NotificationHandler;\n  private readline?: Interface;\n  private running = false;\n  private messageBuffer = '';\n  private expectedLength = 0;\n  \n  // Claude-flow pattern: Reconnection handling\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 3;\n  private reconnectDelay = 1000;\n  private isShuttingDown = false;\n\n  constructor() {}\n\n  async start(): Promise<void> {\n    if (this.running) {\n      throw new Error('Transport already running');\n    }\n\n    try {\n      // Create readline interface for stdin\n      this.readline = createInterface({\n        input: stdin,\n        output: stdout,\n        terminal: false,\n      });\n\n      // Set up line handler\n      this.readline.on('line', (line: string) => {\n        try {\n          this.processLine(line);\n        } catch (error) {\n          console.error('Error processing line:', error);\n        }\n      });\n\n      this.readline.on('close', () => {\n        const wasRunning = this.running;\n        this.running = false;\n        // Claude-flow pattern: Attempt reconnection on unexpected close\n        // Only attempt reconnection if we were running and not shutting down\n        if (wasRunning && !this.isShuttingDown && this.reconnectAttempts < this.maxReconnectAttempts) {\n          this.handleTransportError(new Error('Transport closed unexpectedly'));\n        }\n      });\n\n      this.readline.on('error', (error: Error) => {\n        console.error('Readline error:', error);\n        this.handleTransportError(error);\n      });\n\n      this.running = true;\n      this.reconnectAttempts = 0; // Reset on successful start\n    } catch (error) {\n      await this.handleTransportError(error as Error);\n    }\n  }\n\n  async stop(): Promise<void> {\n    if (!this.running) {\n      return;\n    }\n\n    this.isShuttingDown = true;\n    this.running = false;\n\n    if (this.readline) {\n      this.readline.close();\n      this.readline = undefined;\n    }\n    \n    this.isShuttingDown = false;\n  }\n\n  onRequest(handler: RequestHandler): void {\n    this.requestHandler = handler;\n  }\n\n  onNotification(handler: NotificationHandler): void {\n    this.notificationHandler = handler;\n  }\n\n  private processLine(line: string): void {\n    // Handle Content-Length header\n    if (line.startsWith('Content-Length: ')) {\n      this.expectedLength = parseInt(line.substring(16), 10);\n      return;\n    }\n\n    // Skip empty lines\n    if (line.trim() === '') {\n      return;\n    }\n\n    // If we're not expecting a specific length, try to parse as JSON directly\n    if (this.expectedLength === 0) {\n      this.processMessage(line).catch(error => {\n        console.error('Error processing message:', error);\n      });\n      return;\n    }\n\n    // Add to buffer\n    this.messageBuffer += line;\n\n    // Check if we have the complete message\n    if (this.messageBuffer.length >= this.expectedLength) {\n      const message = this.messageBuffer.substring(0, this.expectedLength);\n      this.messageBuffer = this.messageBuffer.substring(this.expectedLength);\n      this.expectedLength = 0;\n\n      this.processMessage(message).catch(error => {\n        console.error('Error processing message:', error);\n      });\n    }\n  }\n\n  private async processMessage(messageStr: string): Promise<void> {\n    let message: any;\n\n    try {\n      message = JSON.parse(messageStr.trim());\n      \n      // Use Claude-flow pattern validation\n      this.validateMessage(message);\n    } catch (error) {\n      // Send error response if we can extract an ID\n      let id = 'unknown';\n      try {\n        const parsed = JSON.parse(messageStr);\n        if (parsed.id !== undefined) {\n          id = parsed.id;\n        }\n      } catch {\n        // Ignore parse error for ID extraction\n      }\n\n      await this.sendResponse({\n        jsonrpc: '2.0',\n        id,\n        error: {\n          code: -32700,\n          message: 'Parse error',\n        },\n      });\n      return;\n    }\n\n    // Check if this is a notification (no id field) or a request\n    if (message.id === undefined) {\n      // This is a notification\n      await this.handleNotification(message as MCPNotification);\n    } else {\n      // This is a request\n      await this.handleRequest(message as MCPRequest);\n    }\n  }\n\n  private async handleRequest(request: MCPRequest): Promise<void> {\n    if (!this.requestHandler) {\n      await this.sendResponse({\n        jsonrpc: '2.0',\n        id: request.id,\n        error: {\n          code: -32603,\n          message: 'No request handler registered',\n        },\n      });\n      return;\n    }\n\n    try {\n      const response = await this.requestHandler(request);\n      await this.sendResponse(response);\n    } catch (error) {\n      await this.sendResponse({\n        jsonrpc: '2.0',\n        id: request.id,\n        error: {\n          code: -32603,\n          message: 'Internal error',\n          data: error instanceof Error ? error.message : String(error),\n        },\n      });\n    }\n  }\n\n  private async handleNotification(notification: MCPNotification): Promise<void> {\n    if (!this.notificationHandler) {\n      // Notifications don't send error responses\n      return;\n    }\n\n    try {\n      await this.notificationHandler(notification);\n    } catch (error) {\n      // Notifications don't send error responses\n      console.error('Notification handler error:', error);\n    }\n  }\n\n  private async sendResponse(response: MCPResponse): Promise<void> {\n    try {\n      const json = JSON.stringify(response);\n      stdout.write(json + '\\n');\n    } catch (error) {\n      console.error('Failed to send response:', error);\n    }\n  }\n\n  async sendNotification(notification: MCPNotification): Promise<void> {\n    try {\n      const json = JSON.stringify(notification);\n      stdout.write(json + '\\n');\n    } catch (error) {\n      throw error;\n    }\n  }\n\n  // Claude-flow pattern: Transport error handling with reconnection\n  private async handleTransportError(error: Error): Promise<void> {\n    console.error('StdioTransport error:', error);\n    \n    if (this.reconnectAttempts < this.maxReconnectAttempts) {\n      this.reconnectAttempts++;\n      console.log(`Attempting reconnection ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);\n      \n      await new Promise(resolve => setTimeout(resolve, this.reconnectDelay));\n      \n      try {\n        await this.restart();\n        this.reconnectAttempts = 0;\n        console.log('Reconnection successful');\n      } catch (restartError) {\n        await this.handleTransportError(restartError as Error);\n      }\n    } else {\n      console.error('Max reconnection attempts reached, giving up');\n      process.exit(1);\n    }\n  }\n\n  private async restart(): Promise<void> {\n    await this.stop();\n    await this.start();\n  }\n\n  // Claude-flow pattern: Message validation\n  private validateMessage(message: any): void {\n    if (!message.jsonrpc || message.jsonrpc !== '2.0') {\n      throw new Error('Invalid JSON-RPC version');\n    }\n    \n    if (message.id !== undefined) {\n      // Request validation\n      if (!message.method || typeof message.method !== 'string') {\n        throw new Error('Invalid request: missing method');\n      }\n    } else {\n      // Notification validation\n      if (!message.method || typeof message.method !== 'string') {\n        throw new Error('Invalid notification: missing method');\n      }\n    }\n  }\n}"],"version":3}