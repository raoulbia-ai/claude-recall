155aaebb98f069f31d92200049072def
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const stdio_1 = require("../../src/mcp/transports/stdio");
const stream_1 = require("stream");
describe('StdioTransport Resilience', () => {
    let transport;
    let mockStdin;
    let mockStdout;
    let originalStdin;
    let originalStdout;
    beforeEach(() => {
        // Save original stdin/stdout
        originalStdin = process.stdin;
        originalStdout = process.stdout;
        // Create mock streams
        mockStdin = new stream_1.Readable({
            read() { }
        });
        mockStdout = new stream_1.Writable({
            write(chunk, encoding, callback) {
                if (callback)
                    callback();
                return true;
            }
        });
        // Replace process streams
        Object.defineProperty(process, 'stdin', {
            value: mockStdin,
            configurable: true
        });
        Object.defineProperty(process, 'stdout', {
            value: mockStdout,
            configurable: true
        });
        transport = new stdio_1.StdioTransport();
    });
    afterEach(async () => {
        await transport.stop();
        // Restore original streams
        Object.defineProperty(process, 'stdin', {
            value: originalStdin,
            configurable: true
        });
        Object.defineProperty(process, 'stdout', {
            value: originalStdout,
            configurable: true
        });
    });
    describe('Message Validation', () => {
        it('should validate JSON-RPC version', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    responses.push(JSON.parse(data));
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            transport.onRequest(async (request) => ({
                jsonrpc: "2.0",
                id: request.id,
                result: { success: true }
            }));
            // Send invalid JSON-RPC version
            mockStdin.push(JSON.stringify({
                jsonrpc: "1.0",
                id: 1,
                method: "test"
            }) + '\n');
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 50));
            expect(responses).toHaveLength(1);
            expect(responses[0].error).toBeDefined();
            expect(responses[0].error.code).toBe(-32700);
            expect(responses[0].error.message).toBe('Parse error');
        });
        it('should validate request has method', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    responses.push(JSON.parse(data));
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            // Send request without method
            mockStdin.push(JSON.stringify({
                jsonrpc: "2.0",
                id: 1
            }) + '\n');
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 50));
            expect(responses).toHaveLength(1);
            expect(responses[0].error).toBeDefined();
            expect(responses[0].error.code).toBe(-32700);
        });
    });
    describe('Error Handling', () => {
        it('should handle malformed JSON gracefully', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    try {
                        responses.push(JSON.parse(data));
                    }
                    catch (e) {
                        // Ignore parse errors in test
                    }
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            // Send various malformed inputs
            mockStdin.push('not json at all\n');
            mockStdin.push('{"incomplete": \n');
            mockStdin.push('{]\n');
            // Then send valid request
            mockStdin.push(JSON.stringify({
                jsonrpc: "2.0",
                id: 2,
                method: "test"
            }) + '\n');
            // Set up request handler
            transport.onRequest(async (request) => ({
                jsonrpc: "2.0",
                id: request.id,
                result: { received: true }
            }));
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 100));
            // Should have error responses for malformed JSON
            const errorResponses = responses.filter(r => r.error && r.error.code === -32700);
            expect(errorResponses.length).toBeGreaterThan(0);
            // Should still process valid request
            const validResponse = responses.find(r => r.id === 2 && r.result);
            expect(validResponse).toBeDefined();
            expect(validResponse.result.received).toBe(true);
        });
        it('should handle request handler errors', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    responses.push(JSON.parse(data));
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            // Set up failing request handler
            transport.onRequest(async (request) => {
                throw new Error('Handler error');
            });
            mockStdin.push(JSON.stringify({
                jsonrpc: "2.0",
                id: 1,
                method: "test"
            }) + '\n');
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 50));
            expect(responses).toHaveLength(1);
            expect(responses[0].error).toBeDefined();
            expect(responses[0].error.code).toBe(-32603);
            expect(responses[0].error.message).toBe('Internal error');
            expect(responses[0].error.data).toBe('Handler error');
        });
    });
    describe('Content-Length Handling', () => {
        it('should handle Content-Length headers', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    responses.push(JSON.parse(data));
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            transport.onRequest(async (request) => ({
                jsonrpc: "2.0",
                id: request.id,
                result: { method: request.method }
            }));
            const message = JSON.stringify({
                jsonrpc: "2.0",
                id: 1,
                method: "test"
            });
            // Send with Content-Length header
            mockStdin.push(`Content-Length: ${message.length}\n`);
            mockStdin.push('\n');
            mockStdin.push(message + '\n'); // Add newline for readline to process
            // Wait for processing - increase timeout for reliability
            await new Promise(resolve => setTimeout(resolve, 200));
            expect(responses).toHaveLength(1);
            expect(responses[0].result).toBeDefined();
            expect(responses[0].result.method).toBe('test');
        });
        it('should handle messages without Content-Length', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    responses.push(JSON.parse(data));
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            transport.onRequest(async (request) => ({
                jsonrpc: "2.0",
                id: request.id,
                result: { method: request.method }
            }));
            // Send without Content-Length header
            mockStdin.push(JSON.stringify({
                jsonrpc: "2.0",
                id: 1,
                method: "direct"
            }) + '\n');
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 50));
            expect(responses).toHaveLength(1);
            expect(responses[0].result).toBeDefined();
            expect(responses[0].result.method).toBe('direct');
        });
    });
    describe('Notification Handling', () => {
        it('should handle notifications (no id field)', async () => {
            const notifications = [];
            await transport.start();
            transport.onNotification(async (notification) => {
                notifications.push(notification);
            });
            // Send notification (no id field)
            mockStdin.push(JSON.stringify({
                jsonrpc: "2.0",
                method: "notification/test",
                params: { data: "test" }
            }) + '\n');
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 50));
            expect(notifications).toHaveLength(1);
            expect(notifications[0].method).toBe('notification/test');
            expect(notifications[0].params.data).toBe('test');
        });
        it('should not send response for notifications', async () => {
            const responses = [];
            const mockWrite = jest.fn((chunk) => {
                const data = chunk.toString();
                if (data.trim()) {
                    responses.push(JSON.parse(data));
                }
                return true;
            });
            mockStdout.write = mockWrite;
            await transport.start();
            transport.onNotification(async (notification) => {
                // Process notification
            });
            // Send notification
            mockStdin.push(JSON.stringify({
                jsonrpc: "2.0",
                method: "notification/test"
            }) + '\n');
            // Wait for processing
            await new Promise(resolve => setTimeout(resolve, 50));
            // Should not send any response for notifications
            expect(responses).toHaveLength(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy9tY3Avc3RkaW8tdHJhbnNwb3J0LnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwwREFBZ0U7QUFDaEUsbUNBQTRDO0FBRTVDLFFBQVEsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7SUFDekMsSUFBSSxTQUF5QixDQUFDO0lBQzlCLElBQUksU0FBbUIsQ0FBQztJQUN4QixJQUFJLFVBQW9CLENBQUM7SUFDekIsSUFBSSxhQUFrQixDQUFDO0lBQ3ZCLElBQUksY0FBbUIsQ0FBQztJQUV4QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsNkJBQTZCO1FBQzdCLGFBQWEsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQzlCLGNBQWMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBRWhDLHNCQUFzQjtRQUN0QixTQUFTLEdBQUcsSUFBSSxpQkFBUSxDQUFDO1lBQ3ZCLElBQUksS0FBSSxDQUFDO1NBQ1YsQ0FBQyxDQUFDO1FBQ0gsVUFBVSxHQUFHLElBQUksaUJBQVEsQ0FBQztZQUN4QixLQUFLLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRO2dCQUM3QixJQUFJLFFBQVE7b0JBQUUsUUFBUSxFQUFFLENBQUM7Z0JBQ3pCLE9BQU8sSUFBSSxDQUFDO1lBQ2QsQ0FBQztTQUNGLENBQUMsQ0FBQztRQUVILDBCQUEwQjtRQUMxQixNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUU7WUFDdEMsS0FBSyxFQUFFLFNBQVM7WUFDaEIsWUFBWSxFQUFFLElBQUk7U0FDbkIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFO1lBQ3ZDLEtBQUssRUFBRSxVQUFVO1lBQ2pCLFlBQVksRUFBRSxJQUFJO1NBQ25CLENBQUMsQ0FBQztRQUVILFNBQVMsR0FBRyxJQUFJLHNCQUFjLEVBQUUsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQztJQUVI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Q2QsTUFBTSxFQUFFLG1CQUFtQjthQUM1QixDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFFWCxzQkFBc0I7WUFDdEIsTUFBTSxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUV0RCxpREFBaUQ7WUFDakQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC90ZXN0cy9tY3Avc3RkaW8tdHJhbnNwb3J0LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3RkaW9UcmFuc3BvcnQgfSBmcm9tICcuLi8uLi9zcmMvbWNwL3RyYW5zcG9ydHMvc3RkaW8nO1xuaW1wb3J0IHsgUmVhZGFibGUsIFdyaXRhYmxlIH0gZnJvbSAnc3RyZWFtJztcblxuZGVzY3JpYmUoJ1N0ZGlvVHJhbnNwb3J0IFJlc2lsaWVuY2UnLCAoKSA9PiB7XG4gIGxldCB0cmFuc3BvcnQ6IFN0ZGlvVHJhbnNwb3J0O1xuICBsZXQgbW9ja1N0ZGluOiBSZWFkYWJsZTtcbiAgbGV0IG1vY2tTdGRvdXQ6IFdyaXRhYmxlO1xuICBsZXQgb3JpZ2luYWxTdGRpbjogYW55O1xuICBsZXQgb3JpZ2luYWxTdGRvdXQ6IGFueTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBTYXZlIG9yaWdpbmFsIHN0ZGluL3N0ZG91dFxuICAgIG9yaWdpbmFsU3RkaW4gPSBwcm9jZXNzLnN0ZGluO1xuICAgIG9yaWdpbmFsU3Rkb3V0ID0gcHJvY2Vzcy5zdGRvdXQ7XG5cbiAgICAvLyBDcmVhdGUgbW9jayBzdHJlYW1zXG4gICAgbW9ja1N0ZGluID0gbmV3IFJlYWRhYmxlKHtcbiAgICAgIHJlYWQoKSB7fVxuICAgIH0pO1xuICAgIG1vY2tTdGRvdXQgPSBuZXcgV3JpdGFibGUoe1xuICAgICAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjaykge1xuICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gUmVwbGFjZSBwcm9jZXNzIHN0cmVhbXNcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvY2VzcywgJ3N0ZGluJywge1xuICAgICAgdmFsdWU6IG1vY2tTdGRpbixcbiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxuICAgIH0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9jZXNzLCAnc3Rkb3V0Jywge1xuICAgICAgdmFsdWU6IG1vY2tTdGRvdXQsXG4gICAgICBjb25maWd1cmFibGU6IHRydWVcbiAgICB9KTtcblxuICAgIHRyYW5zcG9ydCA9IG5ldyBTdGRpb1RyYW5zcG9ydCgpO1xuICB9KTtcblxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRyYW5zcG9ydC5zdG9wKCk7XG4gICAgXG4gICAgLy8gUmVzdG9yZSBvcmlnaW5hbCBzdHJlYW1zXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb2Nlc3MsICdzdGRpbicsIHtcbiAgICAgIHZhbHVlOiBvcmlnaW5hbFN0ZGluLFxuICAgICAgY29uZmlndXJhYmxlOiB0cnVlXG4gICAgfSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb2Nlc3MsICdzdGRvdXQnLCB7XG4gICAgICB2YWx1ZTogb3JpZ2luYWxTdGRvdXQsXG4gICAgICBjb25maWd1cmFibGU6IHRydWVcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ01lc3NhZ2UgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIEpTT04tUlBDIHZlcnNpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZXM6IGFueVtdID0gW107XG4gICAgICBjb25zdCBtb2NrV3JpdGUgPSBqZXN0LmZuKChjaHVuaykgPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0gY2h1bmsudG9TdHJpbmcoKTtcbiAgICAgICAgaWYgKGRhdGEudHJpbSgpKSB7XG4gICAgICAgICAgcmVzcG9uc2VzLnB1c2goSlNPTi5wYXJzZShkYXRhKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KTtcbiAgICAgIG1vY2tTdGRvdXQud3JpdGUgPSBtb2NrV3JpdGUgYXMgYW55O1xuXG4gICAgICBhd2FpdCB0cmFuc3BvcnQuc3RhcnQoKTtcbiAgICAgIHRyYW5zcG9ydC5vblJlcXVlc3QoYXN5bmMgKHJlcXVlc3QpID0+ICh7XG4gICAgICAgIGpzb25ycGM6IFwiMi4wXCIsXG4gICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICByZXN1bHQ6IHsgc3VjY2VzczogdHJ1ZSB9XG4gICAgICB9KSk7XG5cbiAgICAgIC8vIFNlbmQgaW52YWxpZCBKU09OLVJQQyB2ZXJzaW9uXG4gICAgICBtb2NrU3RkaW4ucHVzaChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGpzb25ycGM6IFwiMS4wXCIsXG4gICAgICAgIGlkOiAxLFxuICAgICAgICBtZXRob2Q6IFwidGVzdFwiXG4gICAgICB9KSArICdcXG4nKTtcblxuICAgICAgLy8gV2FpdCBmb3IgcHJvY2Vzc2luZ1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwKSk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZXMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZXNbMF0uZXJyb3IpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzcG9uc2VzWzBdLmVycm9yLmNvZGUpLnRvQmUoLTMyNzAwKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZXNbMF0uZXJyb3IubWVzc2FnZSkudG9CZSgnUGFyc2UgZXJyb3InKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgcmVxdWVzdCBoYXMgbWV0aG9kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2VzOiBhbnlbXSA9IFtdO1xuICAgICAgY29uc3QgbW9ja1dyaXRlID0gamVzdC5mbigoY2h1bmspID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IGNodW5rLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmIChkYXRhLnRyaW0oKSkge1xuICAgICAgICAgIHJlc3BvbnNlcy5wdXNoKEpTT04ucGFyc2UoZGF0YSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSk7XG4gICAgICBtb2NrU3Rkb3V0LndyaXRlID0gbW9ja1dyaXRlIGFzIGFueTtcblxuICAgICAgYXdhaXQgdHJhbnNwb3J0LnN0YXJ0KCk7XG5cbiAgICAgIC8vIFNlbmQgcmVxdWVzdCB3aXRob3V0IG1ldGhvZFxuICAgICAgbW9ja1N0ZGluLnB1c2goSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBqc29ucnBjOiBcIjIuMFwiLFxuICAgICAgICBpZDogMVxuICAgICAgfSkgKyAnXFxuJyk7XG5cbiAgICAgIC8vIFdhaXQgZm9yIHByb2Nlc3NpbmdcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MCkpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2VzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QocmVzcG9uc2VzWzBdLmVycm9yKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlc1swXS5lcnJvci5jb2RlKS50b0JlKC0zMjcwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFcnJvciBIYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtYWxmb3JtZWQgSlNPTiBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2VzOiBhbnlbXSA9IFtdO1xuICAgICAgY29uc3QgbW9ja1dyaXRlID0gamVzdC5mbigoY2h1bmspID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IGNodW5rLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmIChkYXRhLnRyaW0oKSkge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXNwb25zZXMucHVzaChKU09OLnBhcnNlKGRhdGEpKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBJZ25vcmUgcGFyc2UgZXJyb3JzIGluIHRlc3RcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KTtcbiAgICAgIG1vY2tTdGRvdXQud3JpdGUgPSBtb2NrV3JpdGUgYXMgYW55O1xuXG4gICAgICBhd2FpdCB0cmFuc3BvcnQuc3RhcnQoKTtcblxuICAgICAgLy8gU2VuZCB2YXJpb3VzIG1hbGZvcm1lZCBpbnB1dHNcbiAgICAgIG1vY2tTdGRpbi5wdXNoKCdub3QganNvbiBhdCBhbGxcXG4nKTtcbiAgICAgIG1vY2tTdGRpbi5wdXNoKCd7XCJpbmNvbXBsZXRlXCI6IFxcbicpO1xuICAgICAgbW9ja1N0ZGluLnB1c2goJ3tdXFxuJyk7XG4gICAgICBcbiAgICAgIC8vIFRoZW4gc2VuZCB2YWxpZCByZXF1ZXN0XG4gICAgICBtb2NrU3RkaW4ucHVzaChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGpzb25ycGM6IFwiMi4wXCIsXG4gICAgICAgIGlkOiAyLFxuICAgICAgICBtZXRob2Q6IFwidGVzdFwiXG4gICAgICB9KSArICdcXG4nKTtcblxuICAgICAgLy8gU2V0IHVwIHJlcXVlc3QgaGFuZGxlclxuICAgICAgdHJhbnNwb3J0Lm9uUmVxdWVzdChhc3luYyAocmVxdWVzdCkgPT4gKHtcbiAgICAgICAganNvbnJwYzogXCIyLjBcIixcbiAgICAgICAgaWQ6IHJlcXVlc3QuaWQsXG4gICAgICAgIHJlc3VsdDogeyByZWNlaXZlZDogdHJ1ZSB9XG4gICAgICB9KSk7XG5cbiAgICAgIC8vIFdhaXQgZm9yIHByb2Nlc3NpbmdcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcblxuICAgICAgLy8gU2hvdWxkIGhhdmUgZXJyb3IgcmVzcG9uc2VzIGZvciBtYWxmb3JtZWQgSlNPTlxuICAgICAgY29uc3QgZXJyb3JSZXNwb25zZXMgPSByZXNwb25zZXMuZmlsdGVyKHIgPT4gci5lcnJvciAmJiByLmVycm9yLmNvZGUgPT09IC0zMjcwMCk7XG4gICAgICBleHBlY3QoZXJyb3JSZXNwb25zZXMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG5cbiAgICAgIC8vIFNob3VsZCBzdGlsbCBwcm9jZXNzIHZhbGlkIHJlcXVlc3RcbiAgICAgIGNvbnN0IHZhbGlkUmVzcG9uc2UgPSByZXNwb25zZXMuZmluZChyID0+IHIuaWQgPT09IDIgJiYgci5yZXN1bHQpO1xuICAgICAgZXhwZWN0KHZhbGlkUmVzcG9uc2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QodmFsaWRSZXNwb25zZS5yZXN1bHQucmVjZWl2ZWQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSByZXF1ZXN0IGhhbmRsZXIgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2VzOiBhbnlbXSA9IFtdO1xuICAgICAgY29uc3QgbW9ja1dyaXRlID0gamVzdC5mbigoY2h1bmspID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IGNodW5rLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmIChkYXRhLnRyaW0oKSkge1xuICAgICAgICAgIHJlc3BvbnNlcy5wdXNoKEpTT04ucGFyc2UoZGF0YSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSk7XG4gICAgICBtb2NrU3Rkb3V0LndyaXRlID0gbW9ja1dyaXRlIGFzIGFueTtcblxuICAgICAgYXdhaXQgdHJhbnNwb3J0LnN0YXJ0KCk7XG5cbiAgICAgIC8vIFNldCB1cCBmYWlsaW5nIHJlcXVlc3QgaGFuZGxlclxuICAgICAgdHJhbnNwb3J0Lm9uUmVxdWVzdChhc3luYyAocmVxdWVzdCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhbmRsZXIgZXJyb3InKTtcbiAgICAgIH0pO1xuXG4gICAgICBtb2NrU3RkaW4ucHVzaChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGpzb25ycGM6IFwiMi4wXCIsXG4gICAgICAgIGlkOiAxLFxuICAgICAgICBtZXRob2Q6IFwidGVzdFwiXG4gICAgICB9KSArICdcXG4nKTtcblxuICAgICAgLy8gV2FpdCBmb3IgcHJvY2Vzc2luZ1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwKSk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZXMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZXNbMF0uZXJyb3IpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzcG9uc2VzWzBdLmVycm9yLmNvZGUpLnRvQmUoLTMyNjAzKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZXNbMF0uZXJyb3IubWVzc2FnZSkudG9CZSgnSW50ZXJuYWwgZXJyb3InKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZXNbMF0uZXJyb3IuZGF0YSkudG9CZSgnSGFuZGxlciBlcnJvcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ29udGVudC1MZW5ndGggSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgQ29udGVudC1MZW5ndGggaGVhZGVycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlczogYW55W10gPSBbXTtcbiAgICAgIGNvbnN0IG1vY2tXcml0ZSA9IGplc3QuZm4oKGNodW5rKSA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBjaHVuay50b1N0cmluZygpO1xuICAgICAgICBpZiAoZGF0YS50cmltKCkpIHtcbiAgICAgICAgICByZXNwb25zZXMucHVzaChKU09OLnBhcnNlKGRhdGEpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuICAgICAgbW9ja1N0ZG91dC53cml0ZSA9IG1vY2tXcml0ZSBhcyBhbnk7XG5cbiAgICAgIGF3YWl0IHRyYW5zcG9ydC5zdGFydCgpO1xuICAgICAgdHJhbnNwb3J0Lm9uUmVxdWVzdChhc3luYyAocmVxdWVzdCkgPT4gKHtcbiAgICAgICAganNvbnJwYzogXCIyLjBcIixcbiAgICAgICAgaWQ6IHJlcXVlc3QuaWQsXG4gICAgICAgIHJlc3VsdDogeyBtZXRob2Q6IHJlcXVlc3QubWV0aG9kIH1cbiAgICAgIH0pKTtcblxuICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAganNvbnJwYzogXCIyLjBcIixcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIG1ldGhvZDogXCJ0ZXN0XCJcbiAgICAgIH0pO1xuXG4gICAgICAvLyBTZW5kIHdpdGggQ29udGVudC1MZW5ndGggaGVhZGVyXG4gICAgICBtb2NrU3RkaW4ucHVzaChgQ29udGVudC1MZW5ndGg6ICR7bWVzc2FnZS5sZW5ndGh9XFxuYCk7XG4gICAgICBtb2NrU3RkaW4ucHVzaCgnXFxuJyk7XG4gICAgICBtb2NrU3RkaW4ucHVzaChtZXNzYWdlICsgJ1xcbicpOyAvLyBBZGQgbmV3bGluZSBmb3IgcmVhZGxpbmUgdG8gcHJvY2Vzc1xuXG4gICAgICAvLyBXYWl0IGZvciBwcm9jZXNzaW5nIC0gaW5jcmVhc2UgdGltZW91dCBmb3IgcmVsaWFiaWxpdHlcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAyMDApKTtcblxuICAgICAgZXhwZWN0KHJlc3BvbnNlcykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlc1swXS5yZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzcG9uc2VzWzBdLnJlc3VsdC5tZXRob2QpLnRvQmUoJ3Rlc3QnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1lc3NhZ2VzIHdpdGhvdXQgQ29udGVudC1MZW5ndGgnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZXM6IGFueVtdID0gW107XG4gICAgICBjb25zdCBtb2NrV3JpdGUgPSBqZXN0LmZuKChjaHVuaykgPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0gY2h1bmsudG9TdHJpbmcoKTtcbiAgICAgICAgaWYgKGRhdGEudHJpbSgpKSB7XG4gICAgICAgICAgcmVzcG9uc2VzLnB1c2goSlNPTi5wYXJzZShkYXRhKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KTtcbiAgICAgIG1vY2tTdGRvdXQud3JpdGUgPSBtb2NrV3JpdGUgYXMgYW55O1xuXG4gICAgICBhd2FpdCB0cmFuc3BvcnQuc3RhcnQoKTtcbiAgICAgIHRyYW5zcG9ydC5vblJlcXVlc3QoYXN5bmMgKHJlcXVlc3QpID0+ICh7XG4gICAgICAgIGpzb25ycGM6IFwiMi4wXCIsXG4gICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICByZXN1bHQ6IHsgbWV0aG9kOiByZXF1ZXN0Lm1ldGhvZCB9XG4gICAgICB9KSk7XG5cbiAgICAgIC8vIFNlbmQgd2l0aG91dCBDb250ZW50LUxlbmd0aCBoZWFkZXJcbiAgICAgIG1vY2tTdGRpbi5wdXNoKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAganNvbnJwYzogXCIyLjBcIixcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIG1ldGhvZDogXCJkaXJlY3RcIlxuICAgICAgfSkgKyAnXFxuJyk7XG5cbiAgICAgIC8vIFdhaXQgZm9yIHByb2Nlc3NpbmdcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MCkpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2VzKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgICBleHBlY3QocmVzcG9uc2VzWzBdLnJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZXNbMF0ucmVzdWx0Lm1ldGhvZCkudG9CZSgnZGlyZWN0Jyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdOb3RpZmljYXRpb24gSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbm90aWZpY2F0aW9ucyAobm8gaWQgZmllbGQpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgbm90aWZpY2F0aW9uczogYW55W10gPSBbXTtcbiAgICAgIFxuICAgICAgYXdhaXQgdHJhbnNwb3J0LnN0YXJ0KCk7XG4gICAgICB0cmFuc3BvcnQub25Ob3RpZmljYXRpb24oYXN5bmMgKG5vdGlmaWNhdGlvbikgPT4ge1xuICAgICAgICBub3RpZmljYXRpb25zLnB1c2gobm90aWZpY2F0aW9uKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBTZW5kIG5vdGlmaWNhdGlvbiAobm8gaWQgZmllbGQpXG4gICAgICBtb2NrU3RkaW4ucHVzaChKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGpzb25ycGM6IFwiMi4wXCIsXG4gICAgICAgIG1ldGhvZDogXCJub3RpZmljYXRpb24vdGVzdFwiLFxuICAgICAgICBwYXJhbXM6IHsgZGF0YTogXCJ0ZXN0XCIgfVxuICAgICAgfSkgKyAnXFxuJyk7XG5cbiAgICAgIC8vIFdhaXQgZm9yIHByb2Nlc3NpbmdcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MCkpO1xuXG4gICAgICBleHBlY3Qobm90aWZpY2F0aW9ucykudG9IYXZlTGVuZ3RoKDEpO1xuICAgICAgZXhwZWN0KG5vdGlmaWNhdGlvbnNbMF0ubWV0aG9kKS50b0JlKCdub3RpZmljYXRpb24vdGVzdCcpO1xuICAgICAgZXhwZWN0KG5vdGlmaWNhdGlvbnNbMF0ucGFyYW1zLmRhdGEpLnRvQmUoJ3Rlc3QnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IHNlbmQgcmVzcG9uc2UgZm9yIG5vdGlmaWNhdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZXM6IGFueVtdID0gW107XG4gICAgICBjb25zdCBtb2NrV3JpdGUgPSBqZXN0LmZuKChjaHVuaykgPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0gY2h1bmsudG9TdHJpbmcoKTtcbiAgICAgICAgaWYgKGRhdGEudHJpbSgpKSB7XG4gICAgICAgICAgcmVzcG9uc2VzLnB1c2goSlNPTi5wYXJzZShkYXRhKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KTtcbiAgICAgIG1vY2tTdGRvdXQud3JpdGUgPSBtb2NrV3JpdGUgYXMgYW55O1xuXG4gICAgICBhd2FpdCB0cmFuc3BvcnQuc3RhcnQoKTtcbiAgICAgIHRyYW5zcG9ydC5vbk5vdGlmaWNhdGlvbihhc3luYyAobm90aWZpY2F0aW9uKSA9PiB7XG4gICAgICAgIC8vIFByb2Nlc3Mgbm90aWZpY2F0aW9uXG4gICAgICB9KTtcblxuICAgICAgLy8gU2VuZCBub3RpZmljYXRpb25cbiAgICAgIG1vY2tTdGRpbi5wdXNoKEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAganNvbnJwYzogXCIyLjBcIixcbiAgICAgICAgbWV0aG9kOiBcIm5vdGlmaWNhdGlvbi90ZXN0XCJcbiAgICAgIH0pICsgJ1xcbicpO1xuXG4gICAgICAvLyBXYWl0IGZvciBwcm9jZXNzaW5nXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTApKTtcblxuICAgICAgLy8gU2hvdWxkIG5vdCBzZW5kIGFueSByZXNwb25zZSBmb3Igbm90aWZpY2F0aW9uc1xuICAgICAgZXhwZWN0KHJlc3BvbnNlcykudG9IYXZlTGVuZ3RoKDApO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==