{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/database-manager.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/database-manager.ts"],"sourcesContent":["import Database from 'better-sqlite3';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { ConfigService } from './config';\nimport { LoggingService } from './logging';\n\nexport interface CompactionConfig {\n  autoCompact: boolean;\n  compactThreshold: number;\n  maxMemories: number;\n  retention: {\n    toolUse: number;\n    corrections: number;\n    preferences: number;\n    projectKnowledge: number;\n  };\n}\n\nexport interface CompactionResult {\n  beforeSize: number;\n  afterSize: number;\n  removedCount: number;\n  deduplicatedCount: number;\n  duration: number;\n  backupPath?: string;\n}\n\nexport class DatabaseManager {\n  private static instance: DatabaseManager;\n  private config = ConfigService.getInstance();\n  private logger = LoggingService.getInstance();\n  \n  private constructor() {\n    this.logger.info('DatabaseManager', 'Initialized database manager');\n  }\n  \n  static getInstance(): DatabaseManager {\n    if (!DatabaseManager.instance) {\n      DatabaseManager.instance = new DatabaseManager();\n    }\n    return DatabaseManager.instance;\n  }\n  \n  /**\n   * Check if compaction is needed based on thresholds\n   */\n  async shouldCompact(): Promise<boolean> {\n    const dbPath = this.config.getDatabasePath();\n    const config = this.getCompactionConfig();\n    \n    if (!config.autoCompact) {\n      return false;\n    }\n    \n    try {\n      const stats = fs.statSync(dbPath);\n      const sizeInBytes = stats.size;\n      \n      // Check size threshold\n      if (sizeInBytes > config.compactThreshold) {\n        this.logger.info('DatabaseManager', `Database size (${sizeInBytes} bytes) exceeds threshold (${config.compactThreshold} bytes)`);\n        return true;\n      }\n      \n      // Check memory count threshold\n      const db = new Database(dbPath, { readonly: true });\n      const countResult = db.prepare('SELECT COUNT(*) as count FROM memories').get() as any;\n      db.close();\n      \n      if (countResult.count > config.maxMemories) {\n        this.logger.info('DatabaseManager', `Memory count (${countResult.count}) exceeds threshold (${config.maxMemories})`);\n        return true;\n      }\n      \n      return false;\n    } catch (error) {\n      this.logger.error('DatabaseManager', 'Error checking compaction need', error);\n      return false;\n    }\n  }\n  \n  /**\n   * Perform database compaction\n   */\n  async compact(dryRun: boolean = false): Promise<CompactionResult> {\n    const startTime = Date.now();\n    const dbPath = this.config.getDatabasePath();\n    const config = this.getCompactionConfig();\n    \n    // Get initial size\n    const beforeStats = fs.statSync(dbPath);\n    const beforeSize = beforeStats.size;\n    \n    let backupPath: string | undefined;\n    let removedCount = 0;\n    let deduplicatedCount = 0;\n    \n    try {\n      // Create backup if not dry run\n      if (!dryRun) {\n        backupPath = await this.createBackup();\n        this.logger.info('DatabaseManager', `Created backup at ${backupPath}`);\n        console.log(`ðŸ”„ Created backup at ${backupPath}`);\n      }\n      \n      const db = new Database(dbPath, { readonly: dryRun });\n      \n      if (!dryRun) {\n        db.pragma('journal_mode = WAL');\n      }\n      \n      // 1. Deduplicate identical memories\n      const dedupeResult = this.deduplicateMemories(db, dryRun);\n      deduplicatedCount = dedupeResult;\n      \n      // 2. Prune old tool-use memories\n      const toolUseResult = this.pruneOldToolUse(db, config.retention.toolUse, dryRun);\n      removedCount += toolUseResult;\n      \n      // 3. Prune old corrections\n      const correctionsResult = this.pruneOldCorrections(db, config.retention.corrections, dryRun);\n      removedCount += correctionsResult;\n      \n      // 4. Run VACUUM to reclaim space (only if not dry run)\n      if (!dryRun) {\n        this.logger.info('DatabaseManager', 'Running VACUUM to reclaim space...');\n        console.log('ðŸ—œï¸  Compacting database...');\n        db.exec('VACUUM');\n      }\n      \n      db.close();\n      \n      // Get final size\n      const afterStats = fs.statSync(dbPath);\n      const afterSize = afterStats.size;\n      \n      const result: CompactionResult = {\n        beforeSize,\n        afterSize,\n        removedCount,\n        deduplicatedCount,\n        duration: Date.now() - startTime,\n        backupPath\n      };\n      \n      // Log results\n      const savedBytes = beforeSize - afterSize;\n      const savedMB = (savedBytes / 1024 / 1024).toFixed(2);\n      this.logger.info('DatabaseManager', `Compaction ${dryRun ? '(dry run) ' : ''}completed`, {\n        removedCount,\n        deduplicatedCount,\n        savedMB,\n        duration: `${result.duration}ms`\n      });\n      \n      if (!dryRun && savedBytes > 0) {\n        console.log(`âœ… Database compacted, saved ${savedMB}MB`);\n      }\n      \n      return result;\n      \n    } catch (error) {\n      this.logger.error('DatabaseManager', 'Error during compaction', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * Create a backup of the database\n   */\n  private async createBackup(): Promise<string> {\n    const dbPath = this.config.getDatabasePath();\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n    const backupDir = path.join(path.dirname(dbPath), '.claude-recall-backups');\n    \n    // Create backup directory if it doesn't exist\n    if (!fs.existsSync(backupDir)) {\n      fs.mkdirSync(backupDir, { recursive: true });\n    }\n    \n    const backupPath = path.join(backupDir, `claude-recall-${timestamp}.db`);\n    \n    // Copy database file\n    fs.copyFileSync(dbPath, backupPath);\n    \n    // Clean up old backups (keep last 3)\n    this.cleanupOldBackups(backupDir, 3);\n    \n    return backupPath;\n  }\n  \n  /**\n   * Clean up old backup files\n   */\n  private cleanupOldBackups(backupDir: string, keepCount: number): void {\n    try {\n      const files = fs.readdirSync(backupDir)\n        .filter(f => f.startsWith('claude-recall-') && f.endsWith('.db'))\n        .map(f => ({\n          name: f,\n          path: path.join(backupDir, f),\n          mtime: fs.statSync(path.join(backupDir, f)).mtime\n        }))\n        .sort((a, b) => b.mtime.getTime() - a.mtime.getTime());\n      \n      // Remove old backups\n      for (let i = keepCount; i < files.length; i++) {\n        fs.unlinkSync(files[i].path);\n        this.logger.info('DatabaseManager', `Removed old backup: ${files[i].name}`);\n      }\n    } catch (error) {\n      this.logger.error('DatabaseManager', 'Error cleaning up old backups', error);\n    }\n  }\n  \n  /**\n   * Deduplicate identical memories\n   */\n  private deduplicateMemories(db: Database.Database, dryRun: boolean): number {\n    try {\n      // Find duplicates\n      const duplicates = db.prepare(`\n        SELECT type, key, value, COUNT(*) as count, GROUP_CONCAT(id) as ids\n        FROM memories\n        GROUP BY type, key, value\n        HAVING COUNT(*) > 1\n      `).all() as any[];\n      \n      let totalRemoved = 0;\n      \n      for (const dup of duplicates) {\n        const ids = dup.ids.split(',').map((id: string) => parseInt(id));\n        const keepId = Math.min(...ids); // Keep the oldest\n        const removeIds = ids.filter((id: number) => id !== keepId);\n        \n        if (!dryRun) {\n          const stmt = db.prepare('DELETE FROM memories WHERE id = ?');\n          for (const id of removeIds) {\n            stmt.run(id);\n          }\n        }\n        \n        totalRemoved += removeIds.length;\n      }\n      \n      this.logger.info('DatabaseManager', `Deduplicated ${totalRemoved} memories`);\n      if (totalRemoved > 0 && !dryRun) {\n        console.log(`ðŸ”„ Deduplicated ${totalRemoved} identical memories`);\n      }\n      return totalRemoved;\n      \n    } catch (error) {\n      this.logger.error('DatabaseManager', 'Error deduplicating memories', error);\n      return 0;\n    }\n  }\n  \n  /**\n   * Prune old tool-use memories\n   */\n  private pruneOldToolUse(db: Database.Database, keepCount: number, dryRun: boolean): number {\n    if (keepCount < 0) return 0; // Keep all\n    \n    try {\n      // Find tool-use memories to remove\n      const toRemove = db.prepare(`\n        SELECT id FROM memories\n        WHERE type = 'tool-use'\n        ORDER BY timestamp DESC\n        LIMIT -1 OFFSET ?\n      `).all(keepCount) as any[];\n      \n      if (!dryRun && toRemove.length > 0) {\n        const ids = toRemove.map(r => r.id).join(',');\n        db.exec(`DELETE FROM memories WHERE id IN (${ids})`);\n      }\n      \n      this.logger.info('DatabaseManager', `Pruned ${toRemove.length} old tool-use memories`);\n      if (toRemove.length > 0 && !dryRun) {\n        console.log(`ðŸ”„ Pruned ${toRemove.length} old tool-use memories`);\n      }\n      return toRemove.length;\n      \n    } catch (error) {\n      this.logger.error('DatabaseManager', 'Error pruning tool-use memories', error);\n      return 0;\n    }\n  }\n  \n  /**\n   * Prune old corrections\n   */\n  private pruneOldCorrections(db: Database.Database, keepPerPattern: number, dryRun: boolean): number {\n    if (keepPerPattern < 0) return 0; // Keep all\n    \n    try {\n      // Get all correction patterns\n      const patterns = db.prepare(`\n        SELECT DISTINCT preference_key\n        FROM memories\n        WHERE type = 'correction-pattern'\n        AND preference_key IS NOT NULL\n      `).all() as any[];\n      \n      let totalRemoved = 0;\n      \n      for (const pattern of patterns) {\n        // Find corrections to remove for this pattern\n        const toRemove = db.prepare(`\n          SELECT id FROM memories\n          WHERE type = 'correction-pattern'\n          AND preference_key = ?\n          ORDER BY timestamp DESC\n          LIMIT -1 OFFSET ?\n        `).all(pattern.preference_key, keepPerPattern) as any[];\n        \n        if (!dryRun && toRemove.length > 0) {\n          const ids = toRemove.map(r => r.id).join(',');\n          db.exec(`DELETE FROM memories WHERE id IN (${ids})`);\n        }\n        \n        totalRemoved += toRemove.length;\n      }\n      \n      this.logger.info('DatabaseManager', `Pruned ${totalRemoved} old corrections`);\n      if (totalRemoved > 0 && !dryRun) {\n        console.log(`ðŸ”„ Pruned ${totalRemoved} old correction memories`);\n      }\n      return totalRemoved;\n      \n    } catch (error) {\n      this.logger.error('DatabaseManager', 'Error pruning corrections', error);\n      return 0;\n    }\n  }\n  \n  /**\n   * Get compaction configuration\n   */\n  private getCompactionConfig(): CompactionConfig {\n    const config = this.config.getConfig();\n    \n    // Default configuration if not specified\n    return (config as any).database?.compaction || {\n      autoCompact: true,\n      compactThreshold: 10 * 1024 * 1024, // 10MB\n      maxMemories: 10000,\n      retention: {\n        toolUse: 1000,\n        corrections: 100,\n        preferences: -1, // Keep forever\n        projectKnowledge: -1 // Keep forever\n      }\n    };\n  }\n  \n  /**\n   * Get database statistics\n   */\n  async getStats(): Promise<{\n    sizeBytes: number;\n    sizeMB: number;\n    totalMemories: number;\n    memoryTypes: Record<string, number>;\n  }> {\n    const dbPath = this.config.getDatabasePath();\n    const stats = fs.statSync(dbPath);\n    \n    const db = new Database(dbPath, { readonly: true });\n    \n    const totalResult = db.prepare('SELECT COUNT(*) as count FROM memories').get() as any;\n    const typeResults = db.prepare('SELECT type, COUNT(*) as count FROM memories GROUP BY type').all() as any[];\n    \n    db.close();\n    \n    const memoryTypes: Record<string, number> = {};\n    for (const result of typeResults) {\n      memoryTypes[result.type] = result.count;\n    }\n    \n    return {\n      sizeBytes: stats.size,\n      sizeMB: stats.size / (1024 * 1024),\n      totalMemories: totalResult.count,\n      memoryTypes\n    };\n  }\n  \n  /**\n   * Close database connections\n   * Note: This is a no-op as DatabaseManager doesn't maintain persistent connections\n   */\n  close(): void {\n    // DatabaseManager doesn't maintain persistent database connections\n    // Each operation opens and closes its own connection\n    // This method exists for API compatibility with tests\n    this.logger.info('DatabaseManager', 'Close called (no-op - connections are per-operation)');\n  }\n}"],"version":3}