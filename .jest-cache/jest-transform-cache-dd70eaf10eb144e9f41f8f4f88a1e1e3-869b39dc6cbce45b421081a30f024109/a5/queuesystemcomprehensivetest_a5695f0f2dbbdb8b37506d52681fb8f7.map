{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/tests/unit/queue-system-comprehensive.test.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/tests/unit/queue-system-comprehensive.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach, jest } from '@jest/globals';\nimport Database from 'better-sqlite3';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { QueueSystem, QueueProcessor, QueueMessage } from '../../src/services/queue-system';\n\ndescribe('QueueSystem Comprehensive Test Suite', () => {\n  let testDbPath: string;\n  let queueSystem: QueueSystem;\n\n  beforeEach(() => {\n    // Create unique database file for each test using timestamp + random string\n    const uniqueId = `${Date.now()}-${Math.random().toString(36).substring(7)}`;\n    testDbPath = path.join(__dirname, `test-queue-${uniqueId}.db`);\n\n    // Reset singleton for test isolation\n    (QueueSystem as any).instance = null;\n\n    // Mock dependencies\n    jest.mock('../../src/services/config', () => ({\n      ConfigService: {\n        getInstance: () => ({\n          getDatabasePath: () => testDbPath\n        })\n      }\n    }));\n\n    jest.mock('../../src/services/logging', () => ({\n      LoggingService: {\n        getInstance: () => ({\n          info: jest.fn(),\n          warn: jest.fn(),\n          error: jest.fn(),\n          debug: jest.fn()\n        })\n      }\n    }));\n\n    queueSystem = QueueSystem.getInstance();\n  });\n\n  afterEach(() => {\n    try {\n      if (queueSystem) {\n        queueSystem.close();\n      }\n    } catch (error) {\n      // Already closed\n    }\n\n    // Clean up test database file\n    try {\n      if (fs.existsSync(testDbPath)) {\n        fs.unlinkSync(testDbPath);\n      }\n      // Also clean up WAL files\n      const walPath = `${testDbPath}-wal`;\n      const shmPath = `${testDbPath}-shm`;\n      if (fs.existsSync(walPath)) fs.unlinkSync(walPath);\n      if (fs.existsSync(shmPath)) fs.unlinkSync(shmPath);\n    } catch (error) {\n      // File might not exist\n    }\n\n    jest.clearAllMocks();\n  });\n\n  describe('Race Condition Prevention', () => {\n    it('should prevent duplicate message processing with concurrent dequeues', async () => {\n      const queueName = 'concurrent-test';\n      const messageCount = 50;\n      const workerCount = 10;\n      \n      // Enqueue messages\n      const messageIds = new Set<number>();\n      for (let i = 0; i < messageCount; i++) {\n        const id = queueSystem.enqueue(queueName, 'test', { index: i });\n        messageIds.add(id);\n      }\n      \n      // Simulate concurrent workers\n      const processedMessages = new Set<number>();\n      const workers = Array.from({ length: workerCount }, async () => {\n        const messages = queueSystem.dequeue(queueName, 5);\n        messages.forEach(msg => {\n          if (msg.id) processedMessages.add(msg.id);\n        });\n        return messages;\n      });\n      \n      await Promise.all(workers);\n      \n      // Verify no duplicates\n      const processedArray = Array.from(processedMessages);\n      expect(new Set(processedArray).size).toBe(processedArray.length);\n      \n      // Verify all processed messages are valid\n      processedArray.forEach(id => {\n        expect(messageIds.has(id)).toBe(true);\n      });\n    });\n\n    it('should handle race conditions in mark completed operations', async () => {\n      const queueName = 'completion-race';\n      const messageId = queueSystem.enqueue(queueName, 'test', { data: 'test' });\n      \n      // Dequeue the message\n      const [message] = queueSystem.dequeue(queueName, 1);\n      expect(message.id).toBe(messageId);\n      \n      // Try to mark completed multiple times concurrently\n      const completions = Array.from({ length: 5 }, () => \n        queueSystem.markCompleted(messageId)\n      );\n      \n      await Promise.all(completions);\n      \n      // Verify message is completed only once\n      const stats = queueSystem.getQueueStats(queueName);\n      expect(stats.completed).toBe(1);\n    });\n  });\n\n  describe('Payload Size Validation', () => {\n    it('should reject payloads exceeding 1MB limit', () => {\n      const queueName = 'size-test';\n      const largePayload = {\n        data: 'x'.repeat(1048577) // Just over 1MB\n      };\n      \n      expect(() => {\n        queueSystem.enqueue(queueName, 'large', largePayload);\n      }).toThrow('Payload size exceeds 1MB limit');\n    });\n\n    it('should accept payloads at the 1MB boundary', () => {\n      const queueName = 'size-boundary-test';\n      // Create payload that's exactly at the limit when stringified\n      const maxSize = 1048576 - '{\"data\":\"\"}'.length;\n      const boundaryPayload = {\n        data: 'x'.repeat(maxSize)\n      };\n      \n      const messageId = queueSystem.enqueue(queueName, 'boundary', boundaryPayload);\n      expect(messageId).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Exponential Backoff Behavior', () => {\n    it('should apply exponential backoff with jitter on failures', () => {\n      const queueName = 'backoff-test';\n      const messageId = queueSystem.enqueue(queueName, 'test', { data: 'test' });\n      \n      // Dequeue and fail the message multiple times\n      const retryDelays: number[] = [];\n      \n      for (let i = 0; i < 3; i++) {\n        const [message] = queueSystem.dequeue(queueName, 1);\n        if (message) {\n          const beforeFail = Date.now();\n          queueSystem.markFailed(message.id!, `Failure ${i + 1}`);\n          \n          // Check the next retry time\n          const result = queueSystem.executeQuerySingle<{next_retry_at: number}>(\n            'SELECT next_retry_at FROM queue_messages WHERE id = ?',\n            [messageId]\n          );\n          \n          if (result?.next_retry_at) {\n            const delay = result.next_retry_at - beforeFail;\n            retryDelays.push(delay);\n          }\n        }\n      }\n      \n      // Verify exponential growth\n      expect(retryDelays[1]).toBeGreaterThan(retryDelays[0]);\n      expect(retryDelays[2]).toBeGreaterThan(retryDelays[1]);\n      \n      // Verify jitter is applied (delays shouldn't be exact powers of 2)\n      const baseDelay = 1000;\n      retryDelays.forEach((delay, index) => {\n        const expectedBase = baseDelay * Math.pow(2, index);\n        expect(delay).toBeGreaterThan(expectedBase);\n        expect(delay).toBeLessThan(expectedBase + 2000); // Allow up to 2s jitter\n      });\n    });\n\n    it('should cap retry delay at maximum', () => {\n      const queueName = 'max-delay-test';\n      const messageId = queueSystem.enqueue(queueName, 'test', { data: 'test' });\n      \n      // Fail the message many times to reach max delay\n      for (let i = 0; i < 10; i++) {\n        const [message] = queueSystem.dequeue(queueName, 1);\n        if (message) {\n          queueSystem.markFailed(message.id!, `Failure ${i + 1}`);\n        }\n      }\n      \n      // Check the retry delay is capped\n      const result = queueSystem.executeQuerySingle<{next_retry_at: number, retry_count: number}>(\n        'SELECT next_retry_at, retry_count FROM queue_messages WHERE id = ?',\n        [messageId]\n      );\n      \n      if (result?.next_retry_at) {\n        const delay = result.next_retry_at - Date.now();\n        expect(delay).toBeLessThanOrEqual(300000 + 1000); // Max 5 minutes + jitter\n      }\n    });\n  });\n\n  describe('Memory Leak Prevention', () => {\n    it('should properly clean up resources on close', () => {\n      const queueName = 'cleanup-test';\n      \n      // Create some activity\n      queueSystem.enqueue(queueName, 'test', { data: 'test' });\n      \n      // Register a mock processor\n      const mockProcessor = {\n        start: jest.fn(),\n        stop: jest.fn()\n      } as unknown as QueueProcessor;\n      \n      queueSystem.registerProcessor(queueName, mockProcessor);\n      \n      // Close the system\n      queueSystem.close();\n      \n      // Verify processor was stopped\n      expect(mockProcessor.stop).toHaveBeenCalled();\n      \n      // Verify cleanup interval is cleared\n      expect((queueSystem as any).cleanupInterval).toBeUndefined();\n      \n      // Verify database is closed\n      expect(() => {\n        queueSystem.enqueue(queueName, 'test', {});\n      }).toThrow();\n    });\n\n    it('should handle errors during shutdown gracefully', () => {\n      const queueName = 'error-shutdown-test';\n      \n      // Register a processor that throws on stop\n      const faultyProcessor = {\n        start: jest.fn(),\n        stop: jest.fn(() => { throw new Error('Stop failed'); })\n      } as unknown as QueueProcessor;\n      \n      queueSystem.registerProcessor(queueName, faultyProcessor);\n      \n      // Close should not throw despite processor error\n      expect(() => queueSystem.close()).not.toThrow();\n      expect(faultyProcessor.stop).toHaveBeenCalled();\n    });\n  });\n\n  describe('Queue Configuration Management', () => {\n    it('should store and retrieve queue configurations', () => {\n      const queueName = 'config-test';\n      const config = {\n        maxRetries: 5,\n        baseDelayMs: 2000,\n        batchSize: 20,\n        processingTimeout: 1000,\n        retentionPeriod: 86400000\n      };\n      \n      queueSystem.configureQueue(queueName, config);\n      \n      const retrieved = queueSystem.getQueueConfig(queueName);\n      expect(retrieved).not.toBeNull();\n      expect(retrieved?.maxRetries).toBe(5);\n      expect(retrieved?.baseDelayMs).toBe(2000);\n      expect(retrieved?.batchSize).toBe(20);\n    });\n\n    it('should use queue configuration for retry logic', () => {\n      const queueName = 'config-retry-test';\n      \n      // Configure queue with custom retry settings\n      queueSystem.configureQueue(queueName, {\n        maxRetries: 2,\n        baseDelayMs: 500\n      });\n      \n      const messageId = queueSystem.enqueue(queueName, 'test', { data: 'test' });\n      \n      // Fail the message beyond configured max retries\n      for (let i = 0; i < 3; i++) {\n        const [message] = queueSystem.dequeue(queueName, 1);\n        if (message) {\n          queueSystem.markFailed(message.id!, `Failure ${i + 1}`);\n        }\n      }\n      \n      // Check message moved to dead letter queue after 2 retries\n      const dlqResult = queueSystem.executeQuerySingle<{original_message_id: number}>(\n        'SELECT original_message_id FROM dead_letter_queue WHERE original_message_id = ?',\n        [messageId]\n      );\n      \n      expect(dlqResult).not.toBeNull();\n      expect(dlqResult?.original_message_id).toBe(messageId);\n    });\n  });\n\n  describe('Database Access API', () => {\n    it('should provide safe read-only query access', () => {\n      const queueName = 'query-test';\n      \n      // Enqueue some messages\n      for (let i = 0; i < 5; i++) {\n        queueSystem.enqueue(queueName, 'test', { index: i });\n      }\n      \n      // Use executeQuery for multiple results\n      const results = queueSystem.executeQuery<{queue_name: string, status: string}>(\n        'SELECT queue_name, status FROM queue_messages WHERE queue_name = ?',\n        [queueName]\n      );\n      \n      expect(results).toHaveLength(5);\n      results.forEach(r => {\n        expect(r.queue_name).toBe(queueName);\n        expect(r.status).toBe('pending');\n      });\n    });\n\n    it('should provide single row query access', () => {\n      const queueName = 'single-query-test';\n      const messageId = queueSystem.enqueue(queueName, 'test', { data: 'unique' });\n      \n      const result = queueSystem.executeQuerySingle<{id: number, payload: string}>(\n        'SELECT id, payload FROM queue_messages WHERE id = ?',\n        [messageId]\n      );\n      \n      expect(result).not.toBeUndefined();\n      expect(result?.id).toBe(messageId);\n      expect(JSON.parse(result?.payload || '{}')).toEqual({ data: 'unique' });\n    });\n\n    it('should provide transaction support', () => {\n      const queueName = 'transaction-test';\n      \n      // Execute multiple operations in a transaction\n      const results = queueSystem.executeTransaction((db) => {\n        const stmt1 = db.prepare(\n          'INSERT INTO queue_messages (queue_name, message_type, payload, status, created_at, scheduled_at, retry_count, max_retries) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n        );\n        \n        const ids = [];\n        for (let i = 0; i < 3; i++) {\n          const result = stmt1.run(\n            queueName, 'batch', JSON.stringify({ index: i }), \n            'pending', Date.now(), Date.now(), 0, 3\n          );\n          ids.push(result.lastInsertRowid);\n        }\n        \n        return ids;\n      });\n      \n      expect(results).toHaveLength(3);\n      \n      // Verify all were inserted\n      const count = queueSystem.executeQuerySingle<{count: number}>(\n        'SELECT COUNT(*) as count FROM queue_messages WHERE queue_name = ?',\n        [queueName]\n      );\n      expect(count?.count).toBe(3);\n    });\n  });\n\n  describe('Edge Cases and Error Handling', () => {\n    it('should handle malformed JSON in message payload gracefully', () => {\n      const queueName = 'malformed-json-test';\n      \n      // Directly insert a message with invalid JSON\n      queueSystem.executeTransaction((db) => {\n        const stmt = db.prepare(\n          'INSERT INTO queue_messages (queue_name, message_type, payload, status, created_at, scheduled_at, retry_count, max_retries) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n        );\n        stmt.run(queueName, 'test', '{invalid json}', 'pending', Date.now(), Date.now(), 0, 3);\n      });\n      \n      // Dequeue should handle the malformed JSON\n      const messages = queueSystem.dequeue(queueName, 1);\n      expect(messages).toHaveLength(1);\n      \n      // Payload should remain as string if parsing fails\n      expect(typeof messages[0].payload).toBe('string');\n      expect(messages[0].payload).toBe('{invalid json}');\n    });\n\n    it('should handle queue overflow scenarios', () => {\n      const queueName = 'overflow-test';\n      const messageCount = 100; // Reduced from 10000 for local development\n      \n      // Enqueue a large number of messages\n      const start = Date.now();\n      for (let i = 0; i < messageCount; i++) {\n        queueSystem.enqueue(queueName, 'bulk', { index: i }, { priority: i % 10 });\n      }\n      const enqueueDuration = Date.now() - start;\n      \n      // Should complete in reasonable time (< 1 second for 100 messages)\n      expect(enqueueDuration).toBeLessThan(1000);\n      \n      // Verify all messages were enqueued\n      const stats = queueSystem.getQueueStats(queueName);\n      expect(stats.pending).toBe(messageCount);\n    });\n\n    it('should handle missing queue names gracefully', () => {\n      const stats = queueSystem.getQueueStats('non-existent-queue');\n      \n      expect(stats.queueName).toBe('non-existent-queue');\n      expect(stats.pending).toBe(0);\n      expect(stats.processing).toBe(0);\n      expect(stats.completed).toBe(0);\n      expect(stats.failed).toBe(0);\n    });\n\n    it('should handle concurrent configuration updates', async () => {\n      const queueName = 'concurrent-config-test';\n      \n      // Attempt concurrent configuration updates\n      const updates = Array.from({ length: 10 }, (_, i) => \n        queueSystem.configureQueue(queueName, {\n          maxRetries: i + 1,\n          batchSize: (i + 1) * 10\n        })\n      );\n      \n      await Promise.all(updates);\n      \n      // Verify final configuration is consistent\n      const config = queueSystem.getQueueConfig(queueName);\n      expect(config).not.toBeNull();\n      expect(config?.maxRetries).toBeGreaterThan(0);\n      expect(config?.batchSize).toBeGreaterThan(0);\n    });\n  });\n\n  describe('Dead Letter Queue Management', () => {\n    it('should move messages to DLQ after max retries', () => {\n      const queueName = 'dlq-test';\n      const messageId = queueSystem.enqueue(queueName, 'test', { data: 'fail' }, { maxRetries: 1 });\n      \n      // Fail the message twice (exceeding max retries of 1)\n      for (let i = 0; i < 2; i++) {\n        const [message] = queueSystem.dequeue(queueName, 1);\n        if (message) {\n          queueSystem.markFailed(message.id!, `Failure ${i + 1}`);\n        }\n      }\n      \n      // Verify message is in DLQ\n      const dlqMessages = queueSystem.executeQuery<{original_message_id: number}>(\n        'SELECT original_message_id FROM dead_letter_queue'\n      );\n      \n      expect(dlqMessages).toHaveLength(1);\n      expect(dlqMessages[0].original_message_id).toBe(messageId);\n      \n      // Verify message status is failed\n      const messageStatus = queueSystem.executeQuerySingle<{status: string}>(\n        'SELECT status FROM queue_messages WHERE id = ?',\n        [messageId]\n      );\n      expect(messageStatus?.status).toBe('failed');\n    });\n\n    it('should preserve message metadata in DLQ', () => {\n      const queueName = 'dlq-metadata-test';\n      const correlationId = 'test-correlation-123';\n      const metadata = { source: 'test', timestamp: Date.now() };\n      \n      const messageId = queueSystem.enqueue(\n        queueName, \n        'test', \n        { data: 'fail' }, \n        { maxRetries: 0, correlationId, metadata }\n      );\n      \n      // Fail the message once (exceeding max retries of 0)\n      const [message] = queueSystem.dequeue(queueName, 1);\n      if (message) {\n        queueSystem.markFailed(message.id!, 'Immediate failure');\n      }\n      \n      // Check DLQ entry preserves all data\n      const dlqEntry = queueSystem.executeQuerySingle<{\n        correlation_id: string,\n        metadata: string,\n        error_message: string\n      }>(\n        'SELECT correlation_id, metadata, error_message FROM dead_letter_queue WHERE original_message_id = ?',\n        [messageId]\n      );\n      \n      expect(dlqEntry?.correlation_id).toBe(correlationId);\n      expect(JSON.parse(dlqEntry?.metadata || '{}')).toEqual(metadata);\n      expect(dlqEntry?.error_message).toBe('Immediate failure');\n    });\n  });\n\n  describe('Performance and Cleanup', () => {\n    it('should cleanup old completed messages', () => {\n      const queueName = 'cleanup-test';\n      \n      // Insert old completed messages\n      const oldTime = Date.now() - (8 * 24 * 60 * 60 * 1000); // 8 days ago\n      \n      queueSystem.executeTransaction((db) => {\n        const stmt = db.prepare(\n          'INSERT INTO queue_messages (queue_name, message_type, payload, status, created_at, scheduled_at, processed_at, retry_count, max_retries) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)'\n        );\n        \n        // Insert old completed messages\n        for (let i = 0; i < 5; i++) {\n          stmt.run(queueName, 'old', '{}', 'completed', oldTime, oldTime, oldTime, 0, 3);\n        }\n        \n        // Insert recent completed messages\n        const recentTime = Date.now() - (1 * 24 * 60 * 60 * 1000); // 1 day ago\n        for (let i = 0; i < 3; i++) {\n          stmt.run(queueName, 'recent', '{}', 'completed', recentTime, recentTime, recentTime, 0, 3);\n        }\n      });\n      \n      // Trigger cleanup\n      (queueSystem as any).cleanupOldMessages();\n      \n      // Verify old messages were deleted\n      const remaining = queueSystem.executeQuery<{created_at: number}>(\n        'SELECT created_at FROM queue_messages WHERE queue_name = ? AND status = ?',\n        [queueName, 'completed']\n      );\n      \n      expect(remaining).toHaveLength(3);\n      remaining.forEach(msg => {\n        expect(msg.created_at).toBeGreaterThan(oldTime);\n      });\n    });\n  });\n});"],"version":3}