3df3ef842c0fa5368a7a1e17d991ede3
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryStorage = void 0;
const better_sqlite3_1 = __importDefault(require("better-sqlite3"));
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
class MemoryStorage {
    constructor(dbPath) {
        this.db = new better_sqlite3_1.default(dbPath);
        // Enable WAL mode for better concurrency and to ensure writes are visible
        this.db.pragma('journal_mode = WAL');
        // Ensure changes are synced to disk
        this.db.pragma('synchronous = NORMAL');
        this.initialize();
    }
    initialize() {
        // Check if the database is already initialized
        try {
            const tableExists = this.db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='memories'").get();
            if (tableExists) {
                // Database is already initialized, skip schema execution
                return;
            }
        }
        catch (error) {
            // If checking fails, proceed with initialization
        }
        // Initialize the database schema
        try {
            const schemaPath = path.join(__dirname, 'schema.sql');
            const schema = fs.readFileSync(schemaPath, 'utf-8');
            this.db.exec(schema);
        }
        catch (error) {
            // Log error but don't throw - database might already be initialized
            console.error('Error initializing database schema:', error);
            // Verify that the memories table exists
            const tableExists = this.db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='memories'").get();
            if (!tableExists) {
                // Re-throw the error if the table doesn't exist
                throw new Error(`Failed to initialize database: ${error}`);
            }
        }
    }
    save(memory) {
        const stmt = this.db.prepare(`
      INSERT OR REPLACE INTO memories
      (key, value, type, project_id, file_path, timestamp, relevance_score, access_count,
       preference_key, is_active, superseded_by, superseded_at, confidence_score, sophistication_level, scope)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);
        stmt.run(memory.key, JSON.stringify(memory.value), memory.type, memory.project_id || null, memory.file_path || null, memory.timestamp || Date.now(), memory.relevance_score || 1.0, memory.access_count || 0, memory.preference_key || null, memory.is_active !== undefined ? (memory.is_active ? 1 : 0) : 1, memory.superseded_by || null, memory.superseded_at || null, memory.confidence_score || null, memory.sophistication_level || 1, memory.scope || null);
        // Force a WAL checkpoint to ensure the data is written to the main database file
        // This ensures that other processes (like CLI) can see the changes immediately
        this.db.pragma('wal_checkpoint(TRUNCATE)');
    }
    retrieve(key) {
        const stmt = this.db.prepare('SELECT * FROM memories WHERE key = ?');
        const row = stmt.get(key);
        if (row) {
            this.updateAccessCount(key);
            // Fetch updated row after incrementing access count
            const updatedRow = stmt.get(key);
            return this.rowToMemory(updatedRow);
        }
        return null;
    }
    updateAccessCount(key) {
        const stmt = this.db.prepare(`
      UPDATE memories 
      SET access_count = access_count + 1, 
          last_accessed = ? 
      WHERE key = ?
    `);
        stmt.run(Date.now(), key);
    }
    rowToMemory(row) {
        return {
            id: row.id,
            key: row.key,
            value: JSON.parse(row.value),
            type: row.type,
            project_id: row.project_id,
            file_path: row.file_path,
            timestamp: row.timestamp,
            access_count: row.access_count,
            last_accessed: row.last_accessed,
            relevance_score: row.relevance_score,
            preference_key: row.preference_key,
            is_active: row.is_active === 1,
            superseded_by: row.superseded_by,
            superseded_at: row.superseded_at,
            confidence_score: row.confidence_score
        };
    }
    searchByContext(context) {
        let query = 'SELECT * FROM memories WHERE 1=1';
        const params = [];
        if (context.project_id) {
            // Include project-specific OR universal OR unscoped (NULL) memories
            query += ' AND (project_id = ? OR scope = ? OR project_id IS NULL)';
            params.push(context.project_id, 'universal');
        }
        if (context.file_path) {
            query += ' AND file_path = ?';
            params.push(context.file_path);
        }
        if (context.type) {
            query += ' AND type = ?';
            params.push(context.type);
        }
        // Add keyword search in value field
        if (context.keywords && context.keywords.length > 0) {
            const keywordConditions = context.keywords.map(() => 'value LIKE ?').join(' OR ');
            query += ` AND (${keywordConditions})`;
            // Add parameters for each keyword
            for (const keyword of context.keywords) {
                params.push(`%${keyword}%`);
            }
        }
        // Order by type priority and relevance
        query += ` ORDER BY 
      CASE type 
        WHEN 'project-knowledge' THEN 1 
        WHEN 'preference' THEN 2 
        WHEN 'tool-use' THEN 3 
        ELSE 4 
      END,
      relevance_score DESC,
      timestamp DESC`;
        const stmt = this.db.prepare(query);
        const rows = stmt.all(...params);
        return rows.map(row => this.rowToMemory(row));
    }
    clear(type) {
        let stmt;
        let result;
        if (type) {
            // Clear specific type
            stmt = this.db.prepare('DELETE FROM memories WHERE type = ?');
            result = stmt.run(type);
        }
        else {
            // Clear all memories
            stmt = this.db.prepare('DELETE FROM memories');
            result = stmt.run();
        }
        // Force checkpoint to ensure deletion is persisted
        this.db.pragma('wal_checkpoint(TRUNCATE)');
        return result.changes;
    }
    search(query) {
        const stmt = this.db.prepare(`
      SELECT * FROM memories 
      WHERE key LIKE ? OR value LIKE ?
      ORDER BY relevance_score DESC
      LIMIT 20
    `);
        const searchPattern = `%${query}%`;
        const rows = stmt.all(searchPattern, searchPattern);
        return rows.map(row => this.rowToMemory(row));
    }
    getStats() {
        const totalStmt = this.db.prepare('SELECT COUNT(*) as count FROM memories');
        const total = totalStmt.get().count;
        const byTypeStmt = this.db.prepare('SELECT type, COUNT(*) as count FROM memories GROUP BY type');
        const byTypeRows = byTypeStmt.all();
        const byType = {};
        for (const row of byTypeRows) {
            byType[row.type] = row.count;
        }
        return { total, byType };
    }
    /**
     * Update a memory record by key
     */
    update(key, updates) {
        const fields = Object.keys(updates).filter(k => k !== 'key'); // Don't update key
        const setClause = fields.map(field => `${field} = ?`).join(', ');
        const values = fields.map(field => {
            const value = updates[field];
            if (field === 'value') {
                return JSON.stringify(value);
            }
            else if (field === 'is_active') {
                return value ? 1 : 0;
            }
            else {
                return value;
            }
        });
        const stmt = this.db.prepare(`UPDATE memories SET ${setClause} WHERE key = ?`);
        stmt.run(...values, key);
    }
    /**
     * Get preferences by preference key
     */
    getByPreferenceKey(preferenceKey, projectId) {
        let query = 'SELECT * FROM memories WHERE preference_key = ? AND type = ?';
        const params = [preferenceKey, 'preference'];
        if (projectId) {
            query += ' AND project_id = ?';
            params.push(projectId);
        }
        query += ' ORDER BY timestamp DESC';
        const stmt = this.db.prepare(query);
        const rows = stmt.all(...params);
        return rows.map(row => this.rowToMemory(row));
    }
    /**
     * Get preferences by context with active filtering
     */
    getPreferencesByContext(context) {
        let query = 'SELECT * FROM memories WHERE type = ?';
        const params = ['preference'];
        if (context.project_id) {
            query += ' AND project_id = ?';
            params.push(context.project_id);
        }
        if (context.file_path) {
            query += ' AND file_path = ?';
            params.push(context.file_path);
        }
        // Order by preference key, then by timestamp desc to get latest per key
        query += ' ORDER BY preference_key, timestamp DESC';
        const stmt = this.db.prepare(query);
        const rows = stmt.all(...params);
        return rows.map(row => this.rowToMemory(row));
    }
    /**
     * Mark a memory as superseded
     */
    markSuperseded(key, supersededBy) {
        const stmt = this.db.prepare(`
      UPDATE memories 
      SET is_active = 0, superseded_by = ?, superseded_at = ?
      WHERE key = ?
    `);
        stmt.run(supersededBy, Date.now(), key);
    }
    /**
     * Get active preferences only
     */
    getActivePreferences(projectId) {
        let query = 'SELECT * FROM memories WHERE type = ? AND is_active = 1';
        const params = ['preference'];
        if (projectId) {
            query += ' AND project_id = ?';
            params.push(projectId);
        }
        query += ' ORDER BY preference_key, timestamp DESC';
        const stmt = this.db.prepare(query);
        const rows = stmt.all(...params);
        return rows.map(row => this.rowToMemory(row));
    }
    getDatabase() {
        return this.db;
    }
    close() {
        this.db.close();
    }
}
exports.MemoryStorage = MemoryStorage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvbWVtb3J5L3N0b3JhZ2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsb0VBQXNDO0FBQ3RDLHVDQUF5QjtBQUN6QiwyQ0FBNkI7QUE2QjdCLE1BQWEsYUFBYTtJQUd4QixZQUFZLE1BQWM7UUFDeEIsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLHdCQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDL0IsMEVBQTBFO1FBQzFFLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDckMsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFTyxVQUFVO1FBQ2hCLCtDQUErQztRQUMvQyxJQUFJLENBQUM7WUFDSCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FDakMsdUVBQXVFLENBQ3hFLENBQUMsR0FBRyxFQUFFLENBQUM7WUFFUixJQUFJLFdBQVcsRUFBRSxDQUFDO2dCQUNoQix5REFBeUQ7Z0JBQ3pELE9BQU87WUFDVCxDQUFDO1FBQ0gsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixpREFBaUQ7UUFDbkQsQ0FBQztRQUVELGlDQUFpQztRQUNqQyxJQUFJLENBQUM7WUFDSCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUN0RCxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2QixDQUFDO1FBQUMsT0FBTyxL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Q0FBQztDQUNGO0FBdFVELHNDQXNVQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvbW50L2MvVXNlcnMvZWJpYXJhby9yZXBvcy9jbGF1ZGUtcmVjYWxsL3NyYy9tZW1vcnkvc3RvcmFnZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRGF0YWJhc2UgZnJvbSAnYmV0dGVyLXNxbGl0ZTMnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuLy8gU3RydWN0dXJlZCBtZW1vcnkgdmFsdWUgZm9ybWF0ICh2MC43LjArKVxuZXhwb3J0IGludGVyZmFjZSBTdHJ1Y3R1cmVkTWVtb3J5VmFsdWUge1xuICB0aXRsZT86IHN0cmluZzsgIC8vIENvbmNpc2UgaWRlbnRpZmllclxuICBkZXNjcmlwdGlvbj86IHN0cmluZzsgIC8vIE9uZS1zZW50ZW5jZSBzdW1tYXJ5XG4gIGNvbnRlbnQ6IGFueTsgIC8vIEFjdHVhbCBtZW1vcnkgZGF0YVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1lbW9yeSB7XG4gIGlkPzogbnVtYmVyO1xuICBrZXk6IHN0cmluZztcbiAgdmFsdWU6IGFueSB8IFN0cnVjdHVyZWRNZW1vcnlWYWx1ZTsgIC8vIFN1cHBvcnRzIGJvdGggb2xkIGFuZCBuZXcgZm9ybWF0XG4gIHR5cGU6IHN0cmluZztcbiAgcHJvamVjdF9pZD86IHN0cmluZztcbiAgZmlsZV9wYXRoPzogc3RyaW5nO1xuICB0aW1lc3RhbXA/OiBudW1iZXI7XG4gIGFjY2Vzc19jb3VudD86IG51bWJlcjtcbiAgbGFzdF9hY2Nlc3NlZD86IG51bWJlcjtcbiAgcmVsZXZhbmNlX3Njb3JlPzogbnVtYmVyO1xuICBwcmVmZXJlbmNlX2tleT86IHN0cmluZztcbiAgaXNfYWN0aXZlPzogYm9vbGVhbjtcbiAgc3VwZXJzZWRlZF9ieT86IHN0cmluZztcbiAgc3VwZXJzZWRlZF9hdD86IG51bWJlcjtcbiAgY29uZmlkZW5jZV9zY29yZT86IG51bWJlcjtcbiAgc29waGlzdGljYXRpb25fbGV2ZWw/OiBudW1iZXI7ICAvLyAxLTQ6IFByb2NlZHVyYWwg4oaSIENvbXBvc2l0aW9uYWxcbiAgc2NvcGU/OiAndW5pdmVyc2FsJyB8ICdwcm9qZWN0JyB8IG51bGw7ICAvLyB2MC44LjA6IE1lbW9yeSBzY29wZVxufVxuXG5leHBvcnQgY2xhc3MgTWVtb3J5U3RvcmFnZSB7XG4gIHByaXZhdGUgZGI6IERhdGFiYXNlLkRhdGFiYXNlO1xuICBcbiAgY29uc3RydWN0b3IoZGJQYXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLmRiID0gbmV3IERhdGFiYXNlKGRiUGF0aCk7XG4gICAgLy8gRW5hYmxlIFdBTCBtb2RlIGZvciBiZXR0ZXIgY29uY3VycmVuY3kgYW5kIHRvIGVuc3VyZSB3cml0ZXMgYXJlIHZpc2libGVcbiAgICB0aGlzLmRiLnByYWdtYSgnam91cm5hbF9tb2RlID0gV0FMJyk7XG4gICAgLy8gRW5zdXJlIGNoYW5nZXMgYXJlIHN5bmNlZCB0byBkaXNrXG4gICAgdGhpcy5kYi5wcmFnbWEoJ3N5bmNocm9ub3VzID0gTk9STUFMJyk7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG4gIH1cbiAgXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSgpOiB2b2lkIHtcbiAgICAvLyBDaGVjayBpZiB0aGUgZGF0YWJhc2UgaXMgYWxyZWFkeSBpbml0aWFsaXplZFxuICAgIHRyeSB7XG4gICAgICBjb25zdCB0YWJsZUV4aXN0cyA9IHRoaXMuZGIucHJlcGFyZShcbiAgICAgICAgXCJTRUxFQ1QgbmFtZSBGUk9NIHNxbGl0ZV9tYXN0ZXIgV0hFUkUgdHlwZT0ndGFibGUnIEFORCBuYW1lPSdtZW1vcmllcydcIlxuICAgICAgKS5nZXQoKTtcbiAgICAgIFxuICAgICAgaWYgKHRhYmxlRXhpc3RzKSB7XG4gICAgICAgIC8vIERhdGFiYXNlIGlzIGFscmVhZHkgaW5pdGlhbGl6ZWQsIHNraXAgc2NoZW1hIGV4ZWN1dGlvblxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIElmIGNoZWNraW5nIGZhaWxzLCBwcm9jZWVkIHdpdGggaW5pdGlhbGl6YXRpb25cbiAgICB9XG4gICAgXG4gICAgLy8gSW5pdGlhbGl6ZSB0aGUgZGF0YWJhc2Ugc2NoZW1hXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNjaGVtYVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc2NoZW1hLnNxbCcpO1xuICAgICAgY29uc3Qgc2NoZW1hID0gZnMucmVhZEZpbGVTeW5jKHNjaGVtYVBhdGgsICd1dGYtOCcpO1xuICAgICAgdGhpcy5kYi5leGVjKHNjaGVtYSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIExvZyBlcnJvciBidXQgZG9uJ3QgdGhyb3cgLSBkYXRhYmFzZSBtaWdodCBhbHJlYWR5IGJlIGluaXRpYWxpemVkXG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbml0aWFsaXppbmcgZGF0YWJhc2Ugc2NoZW1hOicsIGVycm9yKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhlIG1lbW9yaWVzIHRhYmxlIGV4aXN0c1xuICAgICAgY29uc3QgdGFibGVFeGlzdHMgPSB0aGlzLmRiLnByZXBhcmUoXG4gICAgICAgIFwiU0VMRUNUIG5hbWUgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGU9J3RhYmxlJyBBTkQgbmFtZT0nbWVtb3JpZXMnXCJcbiAgICAgICkuZ2V0KCk7XG4gICAgICBcbiAgICAgIGlmICghdGFibGVFeGlzdHMpIHtcbiAgICAgICAgLy8gUmUtdGhyb3cgdGhlIGVycm9yIGlmIHRoZSB0YWJsZSBkb2Vzbid0IGV4aXN0XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGluaXRpYWxpemUgZGF0YWJhc2U6ICR7ZXJyb3J9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIFxuICBzYXZlKG1lbW9yeTogTWVtb3J5KTogdm9pZCB7XG4gICAgY29uc3Qgc3RtdCA9IHRoaXMuZGIucHJlcGFyZShgXG4gICAgICBJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIG1lbW9yaWVzXG4gICAgICAoa2V5LCB2YWx1ZSwgdHlwZSwgcHJvamVjdF9pZCwgZmlsZV9wYXRoLCB0aW1lc3RhbXAsIHJlbGV2YW5jZV9zY29yZSwgYWNjZXNzX2NvdW50LFxuICAgICAgIHByZWZlcmVuY2Vfa2V5LCBpc19hY3RpdmUsIHN1cGVyc2VkZWRfYnksIHN1cGVyc2VkZWRfYXQsIGNvbmZpZGVuY2Vfc2NvcmUsIHNvcGhpc3RpY2F0aW9uX2xldmVsLCBzY29wZSlcbiAgICAgIFZBTFVFUyAoPywgPywgPywgPywgPywgPywgPywgPywgPywgPywgPywgPywgPywgPywgPylcbiAgICBgKTtcblxuICAgIHN0bXQucnVuKFxuICAgICAgbWVtb3J5LmtleSxcbiAgICAgIEpTT04uc3RyaW5naWZ5KG1lbW9yeS52YWx1ZSksXG4gICAgICBtZW1vcnkudHlwZSxcbiAgICAgIG1lbW9yeS5wcm9qZWN0X2lkIHx8IG51bGwsXG4gICAgICBtZW1vcnkuZmlsZV9wYXRoIHx8IG51bGwsXG4gICAgICBtZW1vcnkudGltZXN0YW1wIHx8IERhdGUubm93KCksXG4gICAgICBtZW1vcnkucmVsZXZhbmNlX3Njb3JlIHx8IDEuMCxcbiAgICAgIG1lbW9yeS5hY2Nlc3NfY291bnQgfHwgMCxcbiAgICAgIG1lbW9yeS5wcmVmZXJlbmNlX2tleSB8fCBudWxsLFxuICAgICAgbWVtb3J5LmlzX2FjdGl2ZSAhPT0gdW5kZWZpbmVkID8gKG1lbW9yeS5pc19hY3RpdmUgPyAxIDogMCkgOiAxLFxuICAgICAgbWVtb3J5LnN1cGVyc2VkZWRfYnkgfHwgbnVsbCxcbiAgICAgIG1lbW9yeS5zdXBlcnNlZGVkX2F0IHx8IG51bGwsXG4gICAgICBtZW1vcnkuY29uZmlkZW5jZV9zY29yZSB8fCBudWxsLFxuICAgICAgbWVtb3J5LnNvcGhpc3RpY2F0aW9uX2xldmVsIHx8IDEsXG4gICAgICBtZW1vcnkuc2NvcGUgfHwgbnVsbFxuICAgICk7XG5cbiAgICAvLyBGb3JjZSBhIFdBTCBjaGVja3BvaW50IHRvIGVuc3VyZSB0aGUgZGF0YSBpcyB3cml0dGVuIHRvIHRoZSBtYWluIGRhdGFiYXNlIGZpbGVcbiAgICAvLyBUaGlzIGVuc3VyZXMgdGhhdCBvdGhlciBwcm9jZXNzZXMgKGxpa2UgQ0xJKSBjYW4gc2VlIHRoZSBjaGFuZ2VzIGltbWVkaWF0ZWx5XG4gICAgdGhpcy5kYi5wcmFnbWEoJ3dhbF9jaGVja3BvaW50KFRSVU5DQVRFKScpO1xuICB9XG4gIFxuICByZXRyaWV2ZShrZXk6IHN0cmluZyk6IE1lbW9yeSB8IG51bGwge1xuICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoJ1NFTEVDVCAqIEZST00gbWVtb3JpZXMgV0hFUkUga2V5ID0gPycpO1xuICAgIGNvbnN0IHJvdyA9IHN0bXQuZ2V0KGtleSkgYXMgYW55O1xuICAgIFxuICAgIGlmIChyb3cpIHtcbiAgICAgIHRoaXMudXBkYXRlQWNjZXNzQ291bnQoa2V5KTtcbiAgICAgIC8vIEZldGNoIHVwZGF0ZWQgcm93IGFmdGVyIGluY3JlbWVudGluZyBhY2Nlc3MgY291bnRcbiAgICAgIGNvbnN0IHVwZGF0ZWRSb3cgPSBzdG10LmdldChrZXkpIGFzIGFueTtcbiAgICAgIHJldHVybiB0aGlzLnJvd1RvTWVtb3J5KHVwZGF0ZWRSb3cpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBcbiAgcHJpdmF0ZSB1cGRhdGVBY2Nlc3NDb3VudChrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgVVBEQVRFIG1lbW9yaWVzIFxuICAgICAgU0VUIGFjY2Vzc19jb3VudCA9IGFjY2Vzc19jb3VudCArIDEsIFxuICAgICAgICAgIGxhc3RfYWNjZXNzZWQgPSA/IFxuICAgICAgV0hFUkUga2V5ID0gP1xuICAgIGApO1xuICAgIHN0bXQucnVuKERhdGUubm93KCksIGtleSk7XG4gIH1cbiAgXG4gIHByaXZhdGUgcm93VG9NZW1vcnkocm93OiBhbnkpOiBNZW1vcnkge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogcm93LmlkLFxuICAgICAga2V5OiByb3cua2V5LFxuICAgICAgdmFsdWU6IEpTT04ucGFyc2Uocm93LnZhbHVlKSxcbiAgICAgIHR5cGU6IHJvdy50eXBlLFxuICAgICAgcHJvamVjdF9pZDogcm93LnByb2plY3RfaWQsXG4gICAgICBmaWxlX3BhdGg6IHJvdy5maWxlX3BhdGgsXG4gICAgICB0aW1lc3RhbXA6IHJvdy50aW1lc3RhbXAsXG4gICAgICBhY2Nlc3NfY291bnQ6IHJvdy5hY2Nlc3NfY291bnQsXG4gICAgICBsYXN0X2FjY2Vzc2VkOiByb3cubGFzdF9hY2Nlc3NlZCxcbiAgICAgIHJlbGV2YW5jZV9zY29yZTogcm93LnJlbGV2YW5jZV9zY29yZSxcbiAgICAgIHByZWZlcmVuY2Vfa2V5OiByb3cucHJlZmVyZW5jZV9rZXksXG4gICAgICBpc19hY3RpdmU6IHJvdy5pc19hY3RpdmUgPT09IDEsXG4gICAgICBzdXBlcnNlZGVkX2J5OiByb3cuc3VwZXJzZWRlZF9ieSxcbiAgICAgIHN1cGVyc2VkZWRfYXQ6IHJvdy5zdXBlcnNlZGVkX2F0LFxuICAgICAgY29uZmlkZW5jZV9zY29yZTogcm93LmNvbmZpZGVuY2Vfc2NvcmVcbiAgICB9O1xuICB9XG4gIFxuICBzZWFyY2hCeUNvbnRleHQoY29udGV4dDogeyBwcm9qZWN0X2lkPzogc3RyaW5nOyBmaWxlX3BhdGg/OiBzdHJpbmc7IHR5cGU/OiBzdHJpbmc7IGtleXdvcmRzPzogc3RyaW5nW10gfSk6IE1lbW9yeVtdIHtcbiAgICBsZXQgcXVlcnkgPSAnU0VMRUNUICogRlJPTSBtZW1vcmllcyBXSEVSRSAxPTEnO1xuICAgIGNvbnN0IHBhcmFtczogYW55W10gPSBbXTtcblxuICAgIGlmIChjb250ZXh0LnByb2plY3RfaWQpIHtcbiAgICAgIC8vIEluY2x1ZGUgcHJvamVjdC1zcGVjaWZpYyBPUiB1bml2ZXJzYWwgT1IgdW5zY29wZWQgKE5VTEwpIG1lbW9yaWVzXG4gICAgICBxdWVyeSArPSAnIEFORCAocHJvamVjdF9pZCA9ID8gT1Igc2NvcGUgPSA/IE9SIHByb2plY3RfaWQgSVMgTlVMTCknO1xuICAgICAgcGFyYW1zLnB1c2goY29udGV4dC5wcm9qZWN0X2lkLCAndW5pdmVyc2FsJyk7XG4gICAgfVxuXG4gICAgaWYgKGNvbnRleHQuZmlsZV9wYXRoKSB7XG4gICAgICBxdWVyeSArPSAnIEFORCBmaWxlX3BhdGggPSA/JztcbiAgICAgIHBhcmFtcy5wdXNoKGNvbnRleHQuZmlsZV9wYXRoKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGNvbnRleHQudHlwZSkge1xuICAgICAgcXVlcnkgKz0gJyBBTkQgdHlwZSA9ID8nO1xuICAgICAgcGFyYW1zLnB1c2goY29udGV4dC50eXBlKTtcbiAgICB9XG4gICAgXG4gICAgLy8gQWRkIGtleXdvcmQgc2VhcmNoIGluIHZhbHVlIGZpZWxkXG4gICAgaWYgKGNvbnRleHQua2V5d29yZHMgJiYgY29udGV4dC5rZXl3b3Jkcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBrZXl3b3JkQ29uZGl0aW9ucyA9IGNvbnRleHQua2V5d29yZHMubWFwKCgpID0+ICd2YWx1ZSBMSUtFID8nKS5qb2luKCcgT1IgJyk7XG4gICAgICBxdWVyeSArPSBgIEFORCAoJHtrZXl3b3JkQ29uZGl0aW9uc30pYDtcbiAgICAgIFxuICAgICAgLy8gQWRkIHBhcmFtZXRlcnMgZm9yIGVhY2gga2V5d29yZFxuICAgICAgZm9yIChjb25zdCBrZXl3b3JkIG9mIGNvbnRleHQua2V5d29yZHMpIHtcbiAgICAgICAgcGFyYW1zLnB1c2goYCUke2tleXdvcmR9JWApO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBPcmRlciBieSB0eXBlIHByaW9yaXR5IGFuZCByZWxldmFuY2VcbiAgICBxdWVyeSArPSBgIE9SREVSIEJZIFxuICAgICAgQ0FTRSB0eXBlIFxuICAgICAgICBXSEVOICdwcm9qZWN0LWtub3dsZWRnZScgVEhFTiAxIFxuICAgICAgICBXSEVOICdwcmVmZXJlbmNlJyBUSEVOIDIgXG4gICAgICAgIFdIRU4gJ3Rvb2wtdXNlJyBUSEVOIDMgXG4gICAgICAgIEVMU0UgNCBcbiAgICAgIEVORCxcbiAgICAgIHJlbGV2YW5jZV9zY29yZSBERVNDLFxuICAgICAgdGltZXN0YW1wIERFU0NgO1xuICAgIFxuICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUocXVlcnkpO1xuICAgIGNvbnN0IHJvd3MgPSBzdG10LmFsbCguLi5wYXJhbXMpIGFzIGFueVtdO1xuICAgIFxuICAgIHJldHVybiByb3dzLm1hcChyb3cgPT4gdGhpcy5yb3dUb01lbW9yeShyb3cpKTtcbiAgfVxuICBcbiAgY2xlYXIodHlwZT86IHN0cmluZyk6IG51bWJlciB7XG4gICAgbGV0IHN0bXQ7XG4gICAgbGV0IHJlc3VsdDtcbiAgICBcbiAgICBpZiAodHlwZSkge1xuICAgICAgLy8gQ2xlYXIgc3BlY2lmaWMgdHlwZVxuICAgICAgc3RtdCA9IHRoaXMuZGIucHJlcGFyZSgnREVMRVRFIEZST00gbWVtb3JpZXMgV0hFUkUgdHlwZSA9ID8nKTtcbiAgICAgIHJlc3VsdCA9IHN0bXQucnVuKHR5cGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDbGVhciBhbGwgbWVtb3JpZXNcbiAgICAgIHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoJ0RFTEVURSBGUk9NIG1lbW9yaWVzJyk7XG4gICAgICByZXN1bHQgPSBzdG10LnJ1bigpO1xuICAgIH1cbiAgICBcbiAgICAvLyBGb3JjZSBjaGVja3BvaW50IHRvIGVuc3VyZSBkZWxldGlvbiBpcyBwZXJzaXN0ZWRcbiAgICB0aGlzLmRiLnByYWdtYSgnd2FsX2NoZWNrcG9pbnQoVFJVTkNBVEUpJyk7XG4gICAgXG4gICAgcmV0dXJuIHJlc3VsdC5jaGFuZ2VzO1xuICB9XG4gIFxuICBzZWFyY2gocXVlcnk6IHN0cmluZyk6IE1lbW9yeVtdIHtcbiAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKGBcbiAgICAgIFNFTEVDVCAqIEZST00gbWVtb3JpZXMgXG4gICAgICBXSEVSRSBrZXkgTElLRSA/IE9SIHZhbHVlIExJS0UgP1xuICAgICAgT1JERVIgQlkgcmVsZXZhbmNlX3Njb3JlIERFU0NcbiAgICAgIExJTUlUIDIwXG4gICAgYCk7XG4gICAgXG4gICAgY29uc3Qgc2VhcmNoUGF0dGVybiA9IGAlJHtxdWVyeX0lYDtcbiAgICBjb25zdCByb3dzID0gc3RtdC5hbGwoc2VhcmNoUGF0dGVybiwgc2VhcmNoUGF0dGVybikgYXMgYW55W107XG4gICAgXG4gICAgcmV0dXJuIHJvd3MubWFwKHJvdyA9PiB0aGlzLnJvd1RvTWVtb3J5KHJvdykpO1xuICB9XG4gIFxuICBnZXRTdGF0cygpOiB7IHRvdGFsOiBudW1iZXI7IGJ5VHlwZTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiB9IHtcbiAgICBjb25zdCB0b3RhbFN0bXQgPSB0aGlzLmRiLnByZXBhcmUoJ1NFTEVDVCBDT1VOVCgqKSBhcyBjb3VudCBGUk9NIG1lbW9yaWVzJyk7XG4gICAgY29uc3QgdG90YWwgPSAodG90YWxTdG10LmdldCgpIGFzIGFueSkuY291bnQ7XG4gICAgXG4gICAgY29uc3QgYnlUeXBlU3RtdCA9IHRoaXMuZGIucHJlcGFyZSgnU0VMRUNUIHR5cGUsIENPVU5UKCopIGFzIGNvdW50IEZST00gbWVtb3JpZXMgR1JPVVAgQlkgdHlwZScpO1xuICAgIGNvbnN0IGJ5VHlwZVJvd3MgPSBieVR5cGVTdG10LmFsbCgpIGFzIGFueVtdO1xuICAgIFxuICAgIGNvbnN0IGJ5VHlwZTogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuICAgIGZvciAoY29uc3Qgcm93IG9mIGJ5VHlwZVJvd3MpIHtcbiAgICAgIGJ5VHlwZVtyb3cudHlwZV0gPSByb3cuY291bnQ7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7IHRvdGFsLCBieVR5cGUgfTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIFVwZGF0ZSBhIG1lbW9yeSByZWNvcmQgYnkga2V5XG4gICAqL1xuICB1cGRhdGUoa2V5OiBzdHJpbmcsIHVwZGF0ZXM6IFBhcnRpYWw8TWVtb3J5Pik6IHZvaWQge1xuICAgIGNvbnN0IGZpZWxkcyA9IE9iamVjdC5rZXlzKHVwZGF0ZXMpLmZpbHRlcihrID0+IGsgIT09ICdrZXknKTsgLy8gRG9uJ3QgdXBkYXRlIGtleVxuICAgIGNvbnN0IHNldENsYXVzZSA9IGZpZWxkcy5tYXAoZmllbGQgPT4gYCR7ZmllbGR9ID0gP2ApLmpvaW4oJywgJyk7XG4gICAgY29uc3QgdmFsdWVzID0gZmllbGRzLm1hcChmaWVsZCA9PiB7XG4gICAgICBjb25zdCB2YWx1ZSA9ICh1cGRhdGVzIGFzIGFueSlbZmllbGRdO1xuICAgICAgaWYgKGZpZWxkID09PSAndmFsdWUnKSB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgICB9IGVsc2UgaWYgKGZpZWxkID09PSAnaXNfYWN0aXZlJykge1xuICAgICAgICByZXR1cm4gdmFsdWUgPyAxIDogMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKGBVUERBVEUgbWVtb3JpZXMgU0VUICR7c2V0Q2xhdXNlfSBXSEVSRSBrZXkgPSA/YCk7XG4gICAgc3RtdC5ydW4oLi4udmFsdWVzLCBrZXkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBwcmVmZXJlbmNlcyBieSBwcmVmZXJlbmNlIGtleVxuICAgKi9cbiAgZ2V0QnlQcmVmZXJlbmNlS2V5KHByZWZlcmVuY2VLZXk6IHN0cmluZywgcHJvamVjdElkPzogc3RyaW5nKTogTWVtb3J5W10ge1xuICAgIGxldCBxdWVyeSA9ICdTRUxFQ1QgKiBGUk9NIG1lbW9yaWVzIFdIRVJFIHByZWZlcmVuY2Vfa2V5ID0gPyBBTkQgdHlwZSA9ID8nO1xuICAgIGNvbnN0IHBhcmFtczogYW55W10gPSBbcHJlZmVyZW5jZUtleSwgJ3ByZWZlcmVuY2UnXTtcbiAgICBcbiAgICBpZiAocHJvamVjdElkKSB7XG4gICAgICBxdWVyeSArPSAnIEFORCBwcm9qZWN0X2lkID0gPyc7XG4gICAgICBwYXJhbXMucHVzaChwcm9qZWN0SWQpO1xuICAgIH1cbiAgICBcbiAgICBxdWVyeSArPSAnIE9SREVSIEJZIHRpbWVzdGFtcCBERVNDJztcbiAgICBcbiAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKHF1ZXJ5KTtcbiAgICBjb25zdCByb3dzID0gc3RtdC5hbGwoLi4ucGFyYW1zKSBhcyBhbnlbXTtcbiAgICBcbiAgICByZXR1cm4gcm93cy5tYXAocm93ID0+IHRoaXMucm93VG9NZW1vcnkocm93KSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHByZWZlcmVuY2VzIGJ5IGNvbnRleHQgd2l0aCBhY3RpdmUgZmlsdGVyaW5nXG4gICAqL1xuICBnZXRQcmVmZXJlbmNlc0J5Q29udGV4dChjb250ZXh0OiB7IHByb2plY3RfaWQ/OiBzdHJpbmc7IGZpbGVfcGF0aD86IHN0cmluZyB9KTogTWVtb3J5W10ge1xuICAgIGxldCBxdWVyeSA9ICdTRUxFQ1QgKiBGUk9NIG1lbW9yaWVzIFdIRVJFIHR5cGUgPSA/JztcbiAgICBjb25zdCBwYXJhbXM6IGFueVtdID0gWydwcmVmZXJlbmNlJ107XG4gICAgXG4gICAgaWYgKGNvbnRleHQucHJvamVjdF9pZCkge1xuICAgICAgcXVlcnkgKz0gJyBBTkQgcHJvamVjdF9pZCA9ID8nO1xuICAgICAgcGFyYW1zLnB1c2goY29udGV4dC5wcm9qZWN0X2lkKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGNvbnRleHQuZmlsZV9wYXRoKSB7XG4gICAgICBxdWVyeSArPSAnIEFORCBmaWxlX3BhdGggPSA/JztcbiAgICAgIHBhcmFtcy5wdXNoKGNvbnRleHQuZmlsZV9wYXRoKTtcbiAgICB9XG4gICAgXG4gICAgLy8gT3JkZXIgYnkgcHJlZmVyZW5jZSBrZXksIHRoZW4gYnkgdGltZXN0YW1wIGRlc2MgdG8gZ2V0IGxhdGVzdCBwZXIga2V5XG4gICAgcXVlcnkgKz0gJyBPUkRFUiBCWSBwcmVmZXJlbmNlX2tleSwgdGltZXN0YW1wIERFU0MnO1xuICAgIFxuICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUocXVlcnkpO1xuICAgIGNvbnN0IHJvd3MgPSBzdG10LmFsbCguLi5wYXJhbXMpIGFzIGFueVtdO1xuICAgIFxuICAgIHJldHVybiByb3dzLm1hcChyb3cgPT4gdGhpcy5yb3dUb01lbW9yeShyb3cpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXJrIGEgbWVtb3J5IGFzIHN1cGVyc2VkZWRcbiAgICovXG4gIG1hcmtTdXBlcnNlZGVkKGtleTogc3RyaW5nLCBzdXBlcnNlZGVkQnk6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHN0bXQgPSB0aGlzLmRiLnByZXBhcmUoYFxuICAgICAgVVBEQVRFIG1lbW9yaWVzIFxuICAgICAgU0VUIGlzX2FjdGl2ZSA9IDAsIHN1cGVyc2VkZWRfYnkgPSA/LCBzdXBlcnNlZGVkX2F0ID0gP1xuICAgICAgV0hFUkUga2V5ID0gP1xuICAgIGApO1xuICAgIHN0bXQucnVuKHN1cGVyc2VkZWRCeSwgRGF0ZS5ub3coKSwga2V5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWN0aXZlIHByZWZlcmVuY2VzIG9ubHlcbiAgICovXG4gIGdldEFjdGl2ZVByZWZlcmVuY2VzKHByb2plY3RJZD86IHN0cmluZyk6IE1lbW9yeVtdIHtcbiAgICBsZXQgcXVlcnkgPSAnU0VMRUNUICogRlJPTSBtZW1vcmllcyBXSEVSRSB0eXBlID0gPyBBTkQgaXNfYWN0aXZlID0gMSc7XG4gICAgY29uc3QgcGFyYW1zOiBhbnlbXSA9IFsncHJlZmVyZW5jZSddO1xuICAgIFxuICAgIGlmIChwcm9qZWN0SWQpIHtcbiAgICAgIHF1ZXJ5ICs9ICcgQU5EIHByb2plY3RfaWQgPSA/JztcbiAgICAgIHBhcmFtcy5wdXNoKHByb2plY3RJZCk7XG4gICAgfVxuICAgIFxuICAgIHF1ZXJ5ICs9ICcgT1JERVIgQlkgcHJlZmVyZW5jZV9rZXksIHRpbWVzdGFtcCBERVNDJztcbiAgICBcbiAgICBjb25zdCBzdG10ID0gdGhpcy5kYi5wcmVwYXJlKHF1ZXJ5KTtcbiAgICBjb25zdCByb3dzID0gc3RtdC5hbGwoLi4ucGFyYW1zKSBhcyBhbnlbXTtcbiAgICBcbiAgICByZXR1cm4gcm93cy5tYXAocm93ID0+IHRoaXMucm93VG9NZW1vcnkocm93KSk7XG4gIH1cblxuICBnZXREYXRhYmFzZSgpOiBEYXRhYmFzZS5EYXRhYmFzZSB7XG4gICAgcmV0dXJuIHRoaXMuZGI7XG4gIH1cbiAgXG4gIGNsb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuZGIuY2xvc2UoKTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==