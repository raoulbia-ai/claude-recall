64a74e603bdfbe4b5711dd2b9dae7a51
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryRetrieval = void 0;
class MemoryRetrieval {
    constructor(storage) {
        this.storage = storage;
    }
    // Extract keywords from user query for better semantic search
    extractKeywords(query) {
        if (!query)
            return [];
        // Common database-related keywords
        const dbKeywords = ['database', 'db', 'postgres', 'postgresql', 'mysql', 'sqlite',
            'mongodb', 'redis', 'sql', 'nosql', 'storage'];
        // Convert query to lowercase for matching
        const lowerQuery = query.toLowerCase();
        // Extract matching database keywords
        const keywords = dbKeywords.filter(keyword => lowerQuery.includes(keyword));
        // Also extract significant words (3+ chars, not common words)
        const commonWords = ['the', 'what', 'which', 'how', 'when', 'where', 'are', 'is',
            'do', 'we', 'use', 'using', 'for', 'and', 'or', 'in', 'to'];
        const words = lowerQuery.split(/\s+/)
            .filter(word => word.length >= 3 && !commonWords.includes(word));
        // Combine keywords and significant words
        return [...new Set([...keywords, ...words])];
    }
    findRelevant(context) {
        // Extract keywords from query if provided
        if (context.query && !context.keywords) {
            context.keywords = this.extractKeywords(context.query);
        }
        // Use enhanced search that looks for keywords in memory values
        const candidates = this.storage.searchByContext(context);
        // Score and prioritize by memory type
        const scored = candidates
            .map(memory => ({
            ...memory,
            score: this.calculateRelevance(memory, context)
        }))
            .sort((a, b) => {
            // First priority: memory type (project-knowledge > preference > tool-use)
            const typeOrder = { 'project-knowledge': 3, 'preference': 2, 'tool-use': 1 };
            const aTypeScore = typeOrder[a.type] || 0;
            const bTypeScore = typeOrder[b.type] || 0;
            if (aTypeScore !== bTypeScore) {
                return bTypeScore - aTypeScore;
            }
            // Second priority: relevance score
            return b.score - a.score;
        });
        // Return top 5 most relevant memories
        return scored.slice(0, 5);
    }
    calculateRelevance(memory, context) {
        let score = memory.relevance_score || 1.0;
        // Boost for keyword matches in memory value
        if (context.keywords && context.keywords.length > 0) {
            const memoryStr = JSON.stringify(memory.value).toLowerCase();
            let keywordMatches = 0;
            for (const keyword of context.keywords) {
                if (memoryStr.includes(keyword.toLowerCase())) {
                    keywordMatches++;
                    score *= 2.0; // Double score for each keyword match
                }
            }
            // Extra boost if all keywords match
            if (keywordMatches === context.keywords.length) {
                score *= 1.5;
            }
        }
        // Decay over time (forgetting curve) - less aggressive for project-knowledge
        const timestamp = memory.timestamp || Date.now();
        const daysSince = (Date.now() - timestamp) / (1000 * 60 * 60 * 24);
        const decayFactor = memory.type === 'project-knowledge' ? 0.9 : 0.5;
        const halfLife = memory.type === 'project-knowledge' ? 30 : 7;
        score *= Math.pow(decayFactor, daysSince / halfLife);
        // Boost for same project/file
        if (memory.project_id && context.project_id && memory.project_id === context.project_id) {
            score *= 1.5;
        }
        if (memory.file_path && context.file_path && memory.file_path === context.file_path) {
            score *= 2.0;
        }
        // Boost for frequently accessed memories
        if (memory.access_count && memory.access_count > 0) {
            score *= 1 + Math.log10(memory.access_count) * 0.1;
        }
        // Boost for recent access
        if (memory.last_accessed) {
            const hoursSinceAccess = (Date.now() - memory.last_accessed) / (1000 * 60 * 60);
            if (hoursSinceAccess < 24) {
                score *= 1.2;
            }
        }
        return score;
    }
    searchByKeyword(keyword) {
        const results = this.storage.search(keyword);
        const context = { timestamp: Date.now() };
        return results
            .map(memory => ({
            ...memory,
            score: this.calculateRelevance(memory, context)
        }))
            .sort((a, b) => b.score - a.score);
    }
}
exports.MemoryRetrieval = MemoryRetrieval;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL21udC9jL1VzZXJzL2ViaWFyYW8vcmVwb3MvY2xhdWRlLXJlY2FsbC9zcmMvY29yZS9yZXRyaWV2YWwudHMiLCJtYXBwaW5ncyI6Ijs7O0FBZ0JBLE1BQWEsZUFBZTtJQUMxQixZQUFvQixPQUFzQjtRQUF0QixZQUFPLEdBQVAsT0FBTyxDQUFlO0lBQUcsQ0FBQztJQUU5Qyw4REFBOEQ7SUFDdEQsZUFBZSxDQUFDLEtBQWE7UUFDbkMsSUFBSSxDQUFDLEtBQUs7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUV0QixtQ0FBbUM7UUFDbkMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFFBQVE7WUFDN0QsU0FBUyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRW5FLDBDQUEwQztRQUMxQyxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFdkMscUNBQXFDO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFNUUsOERBQThEO1FBQzlELE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUk7WUFDM0QsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVqRixNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQzthQUNsQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLFdB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Q0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDaEYsSUFBSSxnQkFBZ0IsR0FBRyxFQUFFLEVBQUUsQ0FBQztnQkFDMUIsS0FBSyxJQUFJLEdBQUcsQ0FBQztZQUNmLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsZUFBZSxDQUFDLE9BQWU7UUFDN0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0MsTUFBTSxPQUFPLEdBQVksRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFFbkQsT0FBTyxPQUFPO2FBQ1gsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNkLEdBQUcsTUFBTTtZQUNULEtBQUssRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQztTQUNoRCxDQUFDLENBQUM7YUFDRixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUE1SEQsMENBNEhDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9tbnQvYy9Vc2Vycy9lYmlhcmFvL3JlcG9zL2NsYXVkZS1yZWNhbGwvc3JjL2NvcmUvcmV0cmlldmFsLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1lbW9yeVN0b3JhZ2UsIE1lbW9yeSB9IGZyb20gJy4uL21lbW9yeS9zdG9yYWdlJztcblxuZXhwb3J0IGludGVyZmFjZSBDb250ZXh0IHtcbiAgcHJvamVjdF9pZD86IHN0cmluZztcbiAgZmlsZV9wYXRoPzogc3RyaW5nO1xuICB0b29sPzogc3RyaW5nO1xuICB0eXBlPzogc3RyaW5nO1xuICB0aW1lc3RhbXA/OiBudW1iZXI7XG4gIHF1ZXJ5Pzogc3RyaW5nOyAgLy8gVXNlcidzIGFjdHVhbCBxdWVyeSBjb250ZW50XG4gIGtleXdvcmRzPzogc3RyaW5nW107ICAvLyBFeHRyYWN0ZWQga2V5d29yZHMgZnJvbSBxdWVyeVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNjb3JlZE1lbW9yeSBleHRlbmRzIE1lbW9yeSB7XG4gIHNjb3JlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBNZW1vcnlSZXRyaWV2YWwge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0b3JhZ2U6IE1lbW9yeVN0b3JhZ2UpIHt9XG4gIFxuICAvLyBFeHRyYWN0IGtleXdvcmRzIGZyb20gdXNlciBxdWVyeSBmb3IgYmV0dGVyIHNlbWFudGljIHNlYXJjaFxuICBwcml2YXRlIGV4dHJhY3RLZXl3b3JkcyhxdWVyeTogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGlmICghcXVlcnkpIHJldHVybiBbXTtcbiAgICBcbiAgICAvLyBDb21tb24gZGF0YWJhc2UtcmVsYXRlZCBrZXl3b3Jkc1xuICAgIGNvbnN0IGRiS2V5d29yZHMgPSBbJ2RhdGFiYXNlJywgJ2RiJywgJ3Bvc3RncmVzJywgJ3Bvc3RncmVzcWwnLCAnbXlzcWwnLCAnc3FsaXRlJywgXG4gICAgICAgICAgICAgICAgICAgICAgICAnbW9uZ29kYicsICdyZWRpcycsICdzcWwnLCAnbm9zcWwnLCAnc3RvcmFnZSddO1xuICAgIFxuICAgIC8vIENvbnZlcnQgcXVlcnkgdG8gbG93ZXJjYXNlIGZvciBtYXRjaGluZ1xuICAgIGNvbnN0IGxvd2VyUXVlcnkgPSBxdWVyeS50b0xvd2VyQ2FzZSgpO1xuICAgIFxuICAgIC8vIEV4dHJhY3QgbWF0Y2hpbmcgZGF0YWJhc2Uga2V5d29yZHNcbiAgICBjb25zdCBrZXl3b3JkcyA9IGRiS2V5d29yZHMuZmlsdGVyKGtleXdvcmQgPT4gbG93ZXJRdWVyeS5pbmNsdWRlcyhrZXl3b3JkKSk7XG4gICAgXG4gICAgLy8gQWxzbyBleHRyYWN0IHNpZ25pZmljYW50IHdvcmRzICgzKyBjaGFycywgbm90IGNvbW1vbiB3b3JkcylcbiAgICBjb25zdCBjb21tb25Xb3JkcyA9IFsndGhlJywgJ3doYXQnLCAnd2hpY2gnLCAnaG93JywgJ3doZW4nLCAnd2hlcmUnLCAnYXJlJywgJ2lzJywgXG4gICAgICAgICAgICAgICAgICAgICAgICAgJ2RvJywgJ3dlJywgJ3VzZScsICd1c2luZycsICdmb3InLCAnYW5kJywgJ29yJywgJ2luJywgJ3RvJ107XG4gICAgXG4gICAgY29uc3Qgd29yZHMgPSBsb3dlclF1ZXJ5LnNwbGl0KC9cXHMrLylcbiAgICAgIC5maWx0ZXIod29yZCA9PiB3b3JkLmxlbmd0aCA+PSAzICYmICFjb21tb25Xb3Jkcy5pbmNsdWRlcyh3b3JkKSk7XG4gICAgXG4gICAgLy8gQ29tYmluZSBrZXl3b3JkcyBhbmQgc2lnbmlmaWNhbnQgd29yZHNcbiAgICByZXR1cm4gWy4uLm5ldyBTZXQoWy4uLmtleXdvcmRzLCAuLi53b3Jkc10pXTtcbiAgfVxuICBcbiAgZmluZFJlbGV2YW50KGNvbnRleHQ6IENvbnRleHQpOiBTY29yZWRNZW1vcnlbXSB7XG4gICAgLy8gRXh0cmFjdCBrZXl3b3JkcyBmcm9tIHF1ZXJ5IGlmIHByb3ZpZGVkXG4gICAgaWYgKGNvbnRleHQucXVlcnkgJiYgIWNvbnRleHQua2V5d29yZHMpIHtcbiAgICAgIGNvbnRleHQua2V5d29yZHMgPSB0aGlzLmV4dHJhY3RLZXl3b3Jkcyhjb250ZXh0LnF1ZXJ5KTtcbiAgICB9XG4gICAgXG4gICAgLy8gVXNlIGVuaGFuY2VkIHNlYXJjaCB0aGF0IGxvb2tzIGZvciBrZXl3b3JkcyBpbiBtZW1vcnkgdmFsdWVzXG4gICAgY29uc3QgY2FuZGlkYXRlcyA9IHRoaXMuc3RvcmFnZS5zZWFyY2hCeUNvbnRleHQoY29udGV4dCk7XG4gICAgXG4gICAgLy8gU2NvcmUgYW5kIHByaW9yaXRpemUgYnkgbWVtb3J5IHR5cGVcbiAgICBjb25zdCBzY29yZWQgPSBjYW5kaWRhdGVzXG4gICAgICAubWFwKG1lbW9yeSA9PiAoe1xuICAgICAgICAuLi5tZW1vcnksXG4gICAgICAgIHNjb3JlOiB0aGlzLmNhbGN1bGF0ZVJlbGV2YW5jZShtZW1vcnksIGNvbnRleHQpXG4gICAgICB9KSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgIC8vIEZpcnN0IHByaW9yaXR5OiBtZW1vcnkgdHlwZSAocHJvamVjdC1rbm93bGVkZ2UgPiBwcmVmZXJlbmNlID4gdG9vbC11c2UpXG4gICAgICAgIGNvbnN0IHR5cGVPcmRlcjogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHsgJ3Byb2plY3Qta25vd2xlZGdlJzogMywgJ3ByZWZlcmVuY2UnOiAyLCAndG9vbC11c2UnOiAxIH07XG4gICAgICAgIGNvbnN0IGFUeXBlU2NvcmUgPSB0eXBlT3JkZXJbYS50eXBlXSB8fCAwO1xuICAgICAgICBjb25zdCBiVHlwZVNjb3JlID0gdHlwZU9yZGVyW2IudHlwZV0gfHwgMDtcbiAgICAgICAgXG4gICAgICAgIGlmIChhVHlwZVNjb3JlICE9PSBiVHlwZVNjb3JlKSB7XG4gICAgICAgICAgcmV0dXJuIGJUeXBlU2NvcmUgLSBhVHlwZVNjb3JlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBTZWNvbmQgcHJpb3JpdHk6IHJlbGV2YW5jZSBzY29yZVxuICAgICAgICByZXR1cm4gYi5zY29yZSAtIGEuc2NvcmU7XG4gICAgICB9KTtcbiAgICBcbiAgICAvLyBSZXR1cm4gdG9wIDUgbW9zdCByZWxldmFudCBtZW1vcmllc1xuICAgIHJldHVybiBzY29yZWQuc2xpY2UoMCwgNSk7XG4gIH1cbiAgXG4gIHByaXZhdGUgY2FsY3VsYXRlUmVsZXZhbmNlKG1lbW9yeTogTWVtb3J5LCBjb250ZXh0OiBDb250ZXh0KTogbnVtYmVyIHtcbiAgICBsZXQgc2NvcmUgPSBtZW1vcnkucmVsZXZhbmNlX3Njb3JlIHx8IDEuMDtcbiAgICBcbiAgICAvLyBCb29zdCBmb3Iga2V5d29yZCBtYXRjaGVzIGluIG1lbW9yeSB2YWx1ZVxuICAgIGlmIChjb250ZXh0LmtleXdvcmRzICYmIGNvbnRleHQua2V5d29yZHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgbWVtb3J5U3RyID0gSlNPTi5zdHJpbmdpZnkobWVtb3J5LnZhbHVlKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgbGV0IGtleXdvcmRNYXRjaGVzID0gMDtcbiAgICAgIFxuICAgICAgZm9yIChjb25zdCBrZXl3b3JkIG9mIGNvbnRleHQua2V5d29yZHMpIHtcbiAgICAgICAgaWYgKG1lbW9yeVN0ci5pbmNsdWRlcyhrZXl3b3JkLnRvTG93ZXJDYXNlKCkpKSB7XG4gICAgICAgICAga2V5d29yZE1hdGNoZXMrKztcbiAgICAgICAgICBzY29yZSAqPSAyLjA7ICAvLyBEb3VibGUgc2NvcmUgZm9yIGVhY2gga2V5d29yZCBtYXRjaFxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEV4dHJhIGJvb3N0IGlmIGFsbCBrZXl3b3JkcyBtYXRjaFxuICAgICAgaWYgKGtleXdvcmRNYXRjaGVzID09PSBjb250ZXh0LmtleXdvcmRzLmxlbmd0aCkge1xuICAgICAgICBzY29yZSAqPSAxLjU7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8vIERlY2F5IG92ZXIgdGltZSAoZm9yZ2V0dGluZyBjdXJ2ZSkgLSBsZXNzIGFnZ3Jlc3NpdmUgZm9yIHByb2plY3Qta25vd2xlZGdlXG4gICAgY29uc3QgdGltZXN0YW1wID0gbWVtb3J5LnRpbWVzdGFtcCB8fCBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGRheXNTaW5jZSA9IChEYXRlLm5vdygpIC0gdGltZXN0YW1wKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KTtcbiAgICBjb25zdCBkZWNheUZhY3RvciA9IG1lbW9yeS50eXBlID09PSAncHJvamVjdC1rbm93bGVkZ2UnID8gMC45IDogMC41O1xuICAgIGNvbnN0IGhhbGZMaWZlID0gbWVtb3J5LnR5cGUgPT09ICdwcm9qZWN0LWtub3dsZWRnZScgPyAzMCA6IDc7XG4gICAgc2NvcmUgKj0gTWF0aC5wb3coZGVjYXlGYWN0b3IsIGRheXNTaW5jZSAvIGhhbGZMaWZlKTtcbiAgICBcbiAgICAvLyBCb29zdCBmb3Igc2FtZSBwcm9qZWN0L2ZpbGVcbiAgICBpZiAobWVtb3J5LnByb2plY3RfaWQgJiYgY29udGV4dC5wcm9qZWN0X2lkICYmIG1lbW9yeS5wcm9qZWN0X2lkID09PSBjb250ZXh0LnByb2plY3RfaWQpIHtcbiAgICAgIHNjb3JlICo9IDEuNTtcbiAgICB9XG4gICAgaWYgKG1lbW9yeS5maWxlX3BhdGggJiYgY29udGV4dC5maWxlX3BhdGggJiYgbWVtb3J5LmZpbGVfcGF0aCA9PT0gY29udGV4dC5maWxlX3BhdGgpIHtcbiAgICAgIHNjb3JlICo9IDIuMDtcbiAgICB9XG4gICAgXG4gICAgLy8gQm9vc3QgZm9yIGZyZXF1ZW50bHkgYWNjZXNzZWQgbWVtb3JpZXNcbiAgICBpZiAobWVtb3J5LmFjY2Vzc19jb3VudCAmJiBtZW1vcnkuYWNjZXNzX2NvdW50ID4gMCkge1xuICAgICAgc2NvcmUgKj0gMSArIE1hdGgubG9nMTAobWVtb3J5LmFjY2Vzc19jb3VudCkgKiAwLjE7XG4gICAgfVxuICAgIFxuICAgIC8vIEJvb3N0IGZvciByZWNlbnQgYWNjZXNzXG4gICAgaWYgKG1lbW9yeS5sYXN0X2FjY2Vzc2VkKSB7XG4gICAgICBjb25zdCBob3Vyc1NpbmNlQWNjZXNzID0gKERhdGUubm93KCkgLSBtZW1vcnkubGFzdF9hY2Nlc3NlZCkgLyAoMTAwMCAqIDYwICogNjApO1xuICAgICAgaWYgKGhvdXJzU2luY2VBY2Nlc3MgPCAyNCkge1xuICAgICAgICBzY29yZSAqPSAxLjI7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBzY29yZTtcbiAgfVxuICBcbiAgc2VhcmNoQnlLZXl3b3JkKGtleXdvcmQ6IHN0cmluZyk6IFNjb3JlZE1lbW9yeVtdIHtcbiAgICBjb25zdCByZXN1bHRzID0gdGhpcy5zdG9yYWdlLnNlYXJjaChrZXl3b3JkKTtcbiAgICBjb25zdCBjb250ZXh0OiBDb250ZXh0ID0geyB0aW1lc3RhbXA6IERhdGUubm93KCkgfTtcbiAgICBcbiAgICByZXR1cm4gcmVzdWx0c1xuICAgICAgLm1hcChtZW1vcnkgPT4gKHtcbiAgICAgICAgLi4ubWVtb3J5LFxuICAgICAgICBzY29yZTogdGhpcy5jYWxjdWxhdGVSZWxldmFuY2UobWVtb3J5LCBjb250ZXh0KVxuICAgICAgfSkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpO1xuICB9XG59Il0sInZlcnNpb24iOjN9