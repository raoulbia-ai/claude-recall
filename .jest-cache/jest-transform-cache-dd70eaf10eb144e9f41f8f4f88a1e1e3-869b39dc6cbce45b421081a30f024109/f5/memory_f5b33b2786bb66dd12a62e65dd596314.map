{"file":"/mnt/c/Users/ebiarao/repos/claude-recall/src/services/memory.ts","mappings":"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","names":[],"sources":["/mnt/c/Users/ebiarao/repos/claude-recall/src/services/memory.ts"],"sourcesContent":["import { MemoryStorage, Memory } from '../memory/storage';\nimport { MemoryRetrieval, Context, ScoredMemory } from '../core/retrieval';\nimport { ConfigService } from './config';\nimport { LoggingService } from './logging';\nimport { ExtractedPreference } from './preference-extractor';\n\nexport interface MemoryServiceContext {\n  projectId?: string;\n  filePath?: string;\n  tool?: string;\n  type?: string;\n  timestamp?: number;\n  query?: string;\n  keywords?: string[];\n  sessionId?: string;\n}\n\nexport interface MemoryStoreRequest {\n  key: string;\n  value: any;\n  type: string;\n  context?: MemoryServiceContext;\n  relevanceScore?: number;\n}\n\nexport class MemoryService {\n  private static instance: MemoryService;\n  private storage: MemoryStorage;\n  private retrieval: MemoryRetrieval;\n  private config = ConfigService.getInstance();\n  private logger = LoggingService.getInstance();\n  \n  private constructor() {\n    const dbPath = this.config.getDatabasePath();\n    this.storage = new MemoryStorage(dbPath);\n    this.retrieval = new MemoryRetrieval(this.storage);\n    \n    this.logger.info('MemoryService', `Initialized with database: ${dbPath}`);\n  }\n  \n  static getInstance(): MemoryService {\n    if (!MemoryService.instance) {\n      MemoryService.instance = new MemoryService();\n    }\n    return MemoryService.instance;\n  }\n  \n  /**\n   * Store a memory with proper context and logging\n   */\n  store(request: MemoryStoreRequest): void {\n    try {\n      // Check memory limits and notify if approaching\n      const stats = this.getStats();\n      const config = this.config.getConfig();\n      const maxMemories = config.database.compaction?.maxMemories || 10000;\n      \n      if (stats.total >= maxMemories * 0.8) {\n        const percent = ((stats.total / maxMemories) * 100).toFixed(0);\n        console.log(`⚠️  Memory usage at ${percent}% (${stats.total}/${maxMemories})`);\n      }\n      \n      const memory: Memory = {\n        key: request.key,\n        value: request.value,\n        type: request.type,\n        project_id: request.context?.projectId || this.config.getProjectId(),\n        file_path: request.context?.filePath,\n        timestamp: request.context?.timestamp || Date.now(),\n        relevance_score: request.relevanceScore || 1.0\n      };\n      \n      this.storage.save(memory);\n      \n      this.logger.logMemoryOperation('STORE', {\n        key: request.key,\n        type: request.type,\n        projectId: memory.project_id,\n        filePath: memory.file_path\n      });\n      \n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'store', error as Error, {\n        key: request.key,\n        type: request.type\n      });\n      throw error;\n    }\n  }\n  \n  /**\n   * Retrieve a specific memory by key\n   */\n  retrieve(key: string): Memory | null {\n    try {\n      const memory = this.storage.retrieve(key);\n      \n      this.logger.logMemoryOperation('RETRIEVE', {\n        key,\n        found: !!memory,\n        accessCount: memory?.access_count\n      });\n      \n      return memory;\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'retrieve', error as Error, { key });\n      throw error;\n    }\n  }\n  \n  /**\n   * Find relevant memories based on context\n   */\n  findRelevant(context: MemoryServiceContext): ScoredMemory[] {\n    try {\n      const retrievalContext: Context = {\n        project_id: context.projectId || this.config.getProjectId(),\n        file_path: context.filePath,\n        tool: context.tool,\n        type: context.type,\n        timestamp: context.timestamp || Date.now(),\n        query: context.query,\n        keywords: context.keywords\n      };\n      \n      const memories = this.retrieval.findRelevant(retrievalContext);\n      \n      this.logger.logRetrieval(\n        context.query || 'context-based',\n        memories.length,\n        {\n          projectId: retrievalContext.project_id,\n          filePath: retrievalContext.file_path,\n          tool: retrievalContext.tool,\n          keywords: retrievalContext.keywords\n        }\n      );\n      \n      return memories;\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'findRelevant', error as Error, context);\n      throw error;\n    }\n  }\n  \n  /**\n   * Search memories by keyword\n   */\n  search(query: string): ScoredMemory[] {\n    try {\n      // Use findRelevant with query context for better semantic matching\n      const context = {\n        query: query,\n        timestamp: Date.now()\n      };\n      \n      const results = this.retrieval.findRelevant(context);\n      \n      this.logger.logRetrieval(query, results.length, {\n        searchType: 'contextual'\n      });\n      \n      return results;\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'search', error as Error, { query });\n      throw error;\n    }\n  }\n  \n  /**\n   * Get memory storage statistics\n   */\n  getStats(): { total: number; byType: Record<string, number> } {\n    try {\n      const stats = this.storage.getStats();\n      \n      this.logger.debug('MemoryService', 'Retrieved stats', stats);\n      \n      return stats;\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'getStats', error as Error);\n      throw error;\n    }\n  }\n  \n  /**\n   * Store a tool use event\n   */\n  storeToolUse(toolName: string, toolInput: any, context: MemoryServiceContext): void {\n    const key = `tool_use_${toolName}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    \n    this.store({\n      key,\n      value: {\n        tool_name: toolName,\n        tool_input: toolInput,\n        session_id: context.sessionId,\n        timestamp: Date.now()\n      },\n      type: 'tool-use',\n      context,\n      relevanceScore: 1.0\n    });\n  }\n  \n  /**\n   * Clear memories\n   */\n  clear(type?: string): number {\n    try {\n      const count = this.storage.clear(type);\n      \n      this.logger.logMemoryOperation('CLEAR', {\n        type: type || 'all',\n        count\n      });\n      \n      return count;\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'clear', error as Error, { type });\n      throw error;\n    }\n  }\n  \n  /**\n   * Store a user preference\n   */\n  storePreference(preference: any, context: MemoryServiceContext): void {\n    const key = `preference_${preference.pattern}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    \n    this.store({\n      key,\n      value: {\n        ...preference,\n        session_id: context.sessionId\n      },\n      type: 'preference',\n      context,\n      relevanceScore: 1.0\n    });\n  }\n  \n  /**\n   * Store project knowledge\n   */\n  storeProjectKnowledge(knowledge: any, context: MemoryServiceContext): void {\n    const key = `project_knowledge_${Date.now()}`;\n    \n    this.store({\n      key,\n      value: knowledge,\n      type: 'project-knowledge',\n      context,\n      relevanceScore: 0.8\n    });\n  }\n  \n  /**\n   * Store a preference with override handling\n   */\n  storePreferenceWithOverride(preference: ExtractedPreference, context: MemoryServiceContext): void {\n    try {\n      const key = `preference_${preference.key}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      \n      // Handle override logic\n      if (preference.isOverride) {\n        this.markSupersededPreferences(preference.key, key, context);\n      }\n      \n      const memory: Memory = {\n        key,\n        value: {\n          ...preference,\n          session_id: context.sessionId,\n          preference_key: preference.key\n        },\n        type: 'preference',\n        project_id: context.projectId || this.config.getProjectId(),\n        file_path: context.filePath,\n        timestamp: context.timestamp || Date.now(),\n        relevance_score: preference.confidence,\n        preference_key: preference.key,\n        is_active: true,\n        confidence_score: preference.confidence\n      };\n      \n      this.storage.save(memory);\n      \n      this.logger.logMemoryOperation('STORE_PREFERENCE', {\n        key,\n        preferenceKey: preference.key,\n        value: preference.value,\n        isOverride: preference.isOverride,\n        confidence: preference.confidence,\n        projectId: memory.project_id\n      });\n      \n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'storePreferenceWithOverride', error as Error, {\n        preferenceKey: preference.key,\n        value: preference.value\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Mark existing preferences as superseded\n   */\n  private markSupersededPreferences(preferenceKey: string, newPreferenceKey: string, context: MemoryServiceContext): void {\n    try {\n      const existingPreferences = this.getPreferencesByKey(preferenceKey, context);\n      \n      for (const existingPref of existingPreferences) {\n        if (existingPref.is_active) {\n          // Mark as superseded\n          this.storage.markSuperseded(existingPref.key, newPreferenceKey);\n          \n          this.logger.debug('MemoryService', `Marked preference as superseded: ${existingPref.key}`, {\n            preferenceKey,\n            supersededBy: newPreferenceKey\n          });\n        }\n      }\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'markSupersededPreferences', error as Error);\n    }\n  }\n\n  /**\n   * Get preferences by key\n   */\n  getPreferencesByKey(preferenceKey: string, context?: MemoryServiceContext): Memory[] {\n    try {\n      return this.storage.getByPreferenceKey(preferenceKey, context?.projectId);\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'getPreferencesByKey', error as Error);\n      return [];\n    }\n  }\n\n  /**\n   * Get only active preferences\n   */\n  getActivePreferences(context: MemoryServiceContext): Memory[] {\n    try {\n      const allPreferences = this.storage.getPreferencesByContext({\n        project_id: context.projectId || this.config.getProjectId(),\n        file_path: context.filePath\n      });\n      \n      // Group by preference key and return only active ones\n      const activeByKey = new Map<string, Memory>();\n      \n      for (const pref of allPreferences) {\n        const prefKey = pref.preference_key;\n        if (!prefKey || !pref.is_active) continue;\n        \n        const current = activeByKey.get(prefKey);\n        \n        // If no current preference or this one is more recent\n        if (!current || pref.timestamp! > current.timestamp!) {\n          activeByKey.set(prefKey, pref);\n        }\n      }\n      \n      const activePreferences = Array.from(activeByKey.values());\n      \n      this.logger.debug('MemoryService', `Retrieved ${activePreferences.length} active preferences`, {\n        preferenceKeys: activePreferences.map(p => p.preference_key),\n        projectId: context.projectId\n      });\n      \n      return activePreferences;\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'getActivePreferences', error as Error);\n      return [];\n    }\n  }\n\n  /**\n   * Mark a preference as superseded\n   */\n  markSuperseded(key: string, supersededBy: string): void {\n    try {\n      this.storage.markSuperseded(key, supersededBy);\n      \n      this.logger.logMemoryOperation('SUPERSEDE', {\n        key,\n        supersededBy\n      });\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'markSuperseded', error as Error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get direct database access (for CLI operations)\n   */\n  getDatabase() {\n    return this.storage.getDatabase();\n  }\n  \n  /**\n   * Check if database is connected\n   */\n  isConnected(): boolean {\n    try {\n      // Try to get stats as a connection check\n      this.storage.getStats();\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n  \n  /**\n   * Close database connection\n   */\n  close(): void {\n    try {\n      this.storage.close();\n      this.logger.info('MemoryService', 'Database connection closed');\n    } catch (error) {\n      this.logger.logServiceError('MemoryService', 'close', error as Error);\n    }\n  }\n}"],"version":3}